<!DOCTYPE html>

<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sistem Informasi Laporan Kemajuan Siswa - Bimbel Gambar Villa Merah</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Supabase UMD client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script type="module">
  const SUPABASE_URL = 'https://xopxgeexxptomzvegvmf.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvcHhnZWV4eHB0b216dmVndm1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDAyNjMsImV4cCI6MjA3ODYxNjI2M30.GLUEjYeqaDwyl21uds2t58RYVqNez-4onbbtPyVXZ0w';
  window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>
<style>
        body {
            box-sizing: border-box;
        }
        
        * {
            box-sizing: border-box;
        }

        .sidebar-active {
            background-color: #1e40af;
            color: white;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .editable-image {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .editable-image:hover {
            transform: scale(1.05);
        }

        table {
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #e5e7eb;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .success { background-color: #10b981; }
        .error { background-color: #ef4444; }

        .student-card {
            transition: all 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            height: 8px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        /* Custom colors for Super Admin Home */
        .super-admin-card-1 { background: linear-gradient(135deg, #F97316 0%, #EA580C 100%); } /* Orange */
        .super-admin-card-2 { background: linear-gradient(135deg, #10B981 0%, #059669 100%); } /* Green */
        .super-admin-card-3 { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); } /* Blue */
    </style>
<style>@view-transition { navigation: auto; }</style>
<script src="/_sdk/data_sdk.js" type="text/javascript"></script>
<script src="/_sdk/element_sdk.js" type="text/javascript"></script>
</head>
<body class="bg-white">
<style>
.login-bg {
  background: url('FSRD.jpeg') no-repeat center center fixed;
  background-size: cover;
  position: relative;
  
}
.login-overlay {
  position: absolute;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.5);
}
.login-container {
  position: relative;
  z-index: 10;
}
</style>
<div class="login-bg min-h-screen flex items-center justify-center py-15 px-4 relative" id="loginPage">
<div class="login-overlay"></div>
<div class="login-container max-w-md w-full space-y-8 bg-white/90 p-8 rounded-2xl shadow-2xl backdrop-blur-md">
<div class="max-w-md w-full space-y-8">
<div class="text-center">
<div class="bg-white-600 w-24 h-24 mx-auto rounded-lg flex items-center justify-center mb-4 shadow-lg">
<img alt="Logo Bimbel Gambar Villa Merah" class="w-50 h-20 p-2" src="https://www.villamerah.com/assets/images/logo/logo-2.png"/>
</div>
<h2 class="text-2xl text-center font-bold text-gray-900 mb-2" style="color: red;">Bimbel Gambar Villa Merah</h2>
<h3 class="text-1xl text-center font-semibold text-blue-600">Laporan Kemajuan Siswa</h3>
</div>
<form class="mt-8 space-y-6" id="loginForm">
<div class="space-y-4">
<div><label class="block text-sm font-medium text-gray-700 mb-1" for="username">Username</label> <input class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="username" name="username" placeholder="Masukkan username" required="" type="text"/>
</div>
<div><label class="block text-sm font-medium text-gray-700 mb-1" for="password">Password</label> <input class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="password" name="password" placeholder="Masukkan password" required="" type="password"/>
</div>
</div>
<div><button class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors" type="submit"> Masuk </button>
</div>
</form>
</div>
</div>
<div class="mt-4 text-center text-sm text-gray-600">
</div>
</div>

<div class="hidden min-h-full" id="dashboardPage">
<header class="bg-white border-b border-gray-200 fixed w-full top-0 z-10 shadow-sm">
<div class="flex items-center justify-between px-6 py-4">
<div class="flex items-center space-x-4">
<div class="bg-white-600 w-12 h-12 rounded-lg flex items-center justify-center shadow-lg">
<img alt="Logo Bimbel Gambar Villa Merah" class="w-10 h-10 p-1" src="https://bimbelgambar.id/wp-content/uploads/2023/06/favicon-20200601113259.png"/>
</div>
<div>
<h1 class="text-xl font-bold text-red-600">Bimbel Gambar Villa Merah</h1>
<p class="text-sm text-gray-600" id="userRole"></p>
<p class="text-xs text-blue-600" id="userRegion"></p>
</div>
</div>
<button class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow-sm" onclick="logout()"> Keluar </button>
</div>
</header>
<div class="flex pt-20">
<aside class="w-64 fixed left-0 min-h-full text-white bg-gradient-to-b from-blue-700 to-blue-900 shadow-xl border-r border-blue-950/20 transition-all duration-300">
<nav class="p-4 space-y-2" id="sidebarMenu"></nav>
</aside>
<main class="ml-64 flex-1 p-8 w-full">
<div class="fade-in" id="contentArea"></div>
</main>
</div>
</div>
<div class="hidden fixed inset-0 z-50 overflow-y-auto" id="modal">
<div class="flex items-center justify-center min-h-full p-4">
<div class="modal-backdrop fixed inset-0" onclick="closeModal()"></div>
<div class="bg-white rounded-lg shadow-xl relative z-10 max-w-4xl w-full max-h-full overflow-y-auto">
<div class="p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-bold text-gray-900" id="modalTitle"></h3><button class="text-gray-400 hover:text-gray-600" onclick="closeModal()"> <span class="text-2xl">√ó</span> </button>
</div>
<div id="modalContent"></div>
</div>
</div>
</div>
</div>
<script type="module">

function saveAllData() {
  localStorage.setItem("studentsData", JSON.stringify(studentsData));
  localStorage.setItem("regionalAdmins", JSON.stringify(regionalAdmins));
  localStorage.setItem("availableClasses", JSON.stringify(availableClasses));
  localStorage.setItem("educationInfo", JSON.stringify(educationInfo));
  localStorage.setItem("scheduleData", JSON.stringify(scheduleData));
  localStorage.setItem("activityScheduleData", JSON.stringify(activityScheduleData));
  localStorage.setItem("classMaterials", JSON.stringify(classMaterials));
  localStorage.setItem("availableSchools", JSON.stringify(availableSchools));

  // üîÅ Auto Refresh Dashboard jika di halaman Home (Super Admin / Admin)
  if (currentUser && currentModule === 'home' && (currentUser.role === 'Admin' || currentUser.role === 'Super Admin')) {
      loadHome();
  }
}

function loadAllData() {
  const sd = localStorage.getItem("studentsData");
  const ra = localStorage.getItem("regionalAdmins");
  const ac = localStorage.getItem("availableClasses");
  const ei = localStorage.getItem("educationInfo");
  const sch = localStorage.getItem("scheduleData");
  if (sd) studentsData = JSON.parse(sd);
  if (ra) regionalAdmins = JSON.parse(ra);
  if (ac) availableClasses = JSON.parse(ac);
  if (ei) educationInfo = JSON.parse(ei);
  if (sch) scheduleData = JSON.parse(sch);
  const act = localStorage.getItem("activityScheduleData");
  if (act) activityScheduleData = JSON.parse(act);
  const cm = localStorage.getItem('classMaterials');
  const sc = localStorage.getItem('availableSchools');
  if (cm) classMaterials = JSON.parse(cm);
  if (sc) availableSchools = JSON.parse(sc);
}
function saveSession() {
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
}
function loadSession() {
  const cu = localStorage.getItem("currentUser");
  if (cu) {
    currentUser = JSON.parse(cu);
    showDashboard();
                // üî• Record login activity (except Super Admin itself)
                try {
                    let logs = JSON.parse(localStorage.getItem('loginActivityLogs') || '[]');
                    const now = new Date().toLocaleString('id-ID', { hour12: false });
                    const allUsers = await loadAllData();
                    if (allUsers[username] && allUsers[username].role !== 'Super Admin') {
                        logs.unshift({
                            name: users[username].name,
                            role: users[username].role,
                            region: users[username].region || '-',
                            time: now
                        });
                        localStorage.setItem('loginActivityLogs', JSON.stringify(logs.slice(0, 100)));
                    }
                } catch (err) { console.error('Gagal menyimpan log aktivitas:', err); }
  }
}
window.addEventListener("DOMContentLoaded", () => {
  loadAllData();
  loadSession();
});
document.addEventListener("DOMContentLoaded", () => {
  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', async function(e) {
      setTimeout(() => {
        if (currentUser) saveSession();
      }, 200);
    });
  }
});
const originalLogout = logout;
logout = function() {
  saveAllData();
  localStorage.removeItem("currentUser");
  originalLogout();
};
window.saveAllData = saveAllData;

        // Data Storage (migrated to Supabase)
        let currentUser = null;
        let currentModule = 'home';
        let selectedClass = 'all';
        let selectedClassMaterial = 'all';
        let selectedClassSchedule = 'all';
        let selectedAdminRegion = 'all';

        // Data arrays (initially empty) ‚Äî will be loaded from Supabase on app start
        let regionalAdmins = [];
        let availableClasses = [];
        let studentsData = [];
        let educationInfo = [];
        let classMaterials = [];
        let scheduleData = [];
        let activityScheduleData = [];
        let availableSchools = [];

        // Remove local dummy data and localStorage keys to make system pure-online
        (function clearLocalDummyData() {
            try {
                localStorage.removeItem('studentsData');
                localStorage.removeItem('regionalAdmins');
                localStorage.removeItem('availableClasses');
                localStorage.removeItem('educationInfo');
                localStorage.removeItem('scheduleData');
                localStorage.removeItem('activityScheduleData');
                localStorage.removeItem('classMaterials');
                localStorage.removeItem('availableSchools');
                localStorage.removeItem('bm_currentUser');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('loginActivityLogs');
                console.log('Local dummy data cleared (pure online mode).');
            } catch (e) { console.warn('Failed to clear local dummy data', e); }
        })();

        // Helper: get Supabase client
        function sb() {
            return window.supabaseClient;
        }

        // Load all data from Supabase (full sync)
        async function loadAllData() {
            try {
                // admins
                const { data: admins, error: aErr } = await sb().from('admins').select('*');
                if (aErr) console.warn('admins load error', aErr); else regionalAdmins = admins || [];

                // students
                const { data: students, error: sErr } = await sb().from('students').select('*');
                if (sErr) console.warn('students load error', sErr); else studentsData = students || [];

                // classes
                const { data: classes, error: cErr } = await sb().from('classes').select('*');
                if (cErr) console.warn('classes load error', cErr); else availableClasses = classes || [];

                // education info
                const { data: edu, error: eiErr } = await sb().from('education_info').select('*');
                if (eiErr) console.warn('education_info load error', eiErr); else educationInfo = edu || [];

                // class materials
                const { data: mats, error: mErr } = await sb().from('class_materials').select('*');
                if (mErr) console.warn('class_materials load error', mErr); else classMaterials = mats || [];

                // schedules
                const { data: sch, error: schErr } = await sb().from('schedules').select('*');
                if (schErr) console.warn('schedules load error', schErr); else scheduleData = sch || [];

                // activity schedules
                const { data: acts, error: actErr } = await sb().from('activity_schedules').select('*');
                if (actErr) console.warn('activity_schedules load error', actErr); else activityScheduleData = acts || [];

                // available schools (derive from students table if no separate table)
                const schools = [...new Set((studentsData || []).map(s => s.school).filter(Boolean))];
                availableSchools = schools;

                console.log('Loaded all data from Supabase.');
            } catch (err) {
                console.error('Failed to load data from Supabase, app may be offline', err);
            }
        }

        // Save functions: upsert to Supabase (best-effort)
        async function saveAllData() {
            try {
                // upsert students
                for (const s of studentsData) {
                    const payload = { ...s };
                    await sb().from('students').upsert(payload, { onConflict: 'id' });
                }
                // upsert admins
                for (const a of regionalAdmins) {
                    await sb().from('admins').upsert(a, { onConflict: 'username' });
                }
                // upsert classes
                for (const c of availableClasses) {
                    await sb().from('classes').upsert(c, { onConflict: 'id' });
                }
                // upsert education info
                for (const e of educationInfo) {
                    await sb().from('education_info').upsert(e, { onConflict: 'id' });
                }
                // upsert materials
                for (const m of classMaterials) {
                    await sb().from('class_materials').upsert(m, { onConflict: 'id' });
                }
                // upsert schedules
                for (const s of scheduleData) {
                    await sb().from('schedules').upsert(s, { onConflict: 'id' });
                }
                // upsert activities
                for (const a of activityScheduleData) {
                    await sb().from('activity_schedules').upsert(a, { onConflict: 'id' });
                }
                console.log('saveAllData: attempted upserts to Supabase.');
            } catch (err) {
                console.error('saveAllData error', err);
            }
        }

        // Login check against Supabase (admins then students)
        async function checkCredentials(username, password) {
            try {
                const { data: admin } = await sb().from('admins').select('*').eq('username', username).eq('password', password).maybeSingle();
                if (admin) return { ...admin, role: admin.role || 'Admin' };

                const { data: student } = await sb().from('students').select('*').eq('username', username).eq('password', password).maybeSingle();
                if (student) return { ...student, role: 'Siswa' };

                return null;
            } catch (err) {
                console.error('checkCredentials failed', err);
                return null;
            }
        }

        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const users = await loadAllData();

            if (users[username] && users[username].password === password) {
                currentUser = { username, ...users[username] };
                showDashboard();
                // üî• Record login activity (except Super Admin itself)
                try {
                    let logs = JSON.parse(localStorage.getItem('loginActivityLogs') || '[]');
                    const now = new Date().toLocaleString('id-ID', { hour12: false });
                    const allUsers = await loadAllData();
                    if (allUsers[username] && allUsers[username].role !== 'Super Admin') {
                        logs.unshift({
                            name: users[username].name,
                            role: users[username].role,
                            region: users[username].region || '-',
                            time: now
                        });
                        localStorage.setItem('loginActivityLogs', JSON.stringify(logs.slice(0, 100)));
                    }
                } catch (err) { console.error('Gagal menyimpan log aktivitas:', err); }
            } else {
                showNotification('Username atau password salah!', 'error');
            }
        });

        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            
            // NEW: Menambahkan Sub-Header Universal dan Menghilangkan Role/Region di sini
            const headerInfoDiv = document.querySelector('#dashboardPage header .flex.items-center.space-x-4 div:nth-child(2)');
            
            let subHeader = document.getElementById('bimbelSubHeader');
            if (!subHeader) {
                subHeader = document.createElement('p');
                subHeader.id = 'bimbelSubHeader';
                // PERUBAHAN WARNA TEKS LAPORAN KEMAJUAN SISWA: text-blue-600
                subHeader.className = 'text-lg text-blue-600 font-semibold mb-1'; 
                // Menyisipkan tepat setelah H1
                const h1Element = headerInfoDiv.querySelector('h1');
                headerInfoDiv.insertBefore(subHeader, h1Element.nextSibling); 
            }
            subHeader.textContent = 'Laporan Kemajuan Siswa';
            
            // 1. HILANGKAN ROLE DAN REGION DARI HEADER
            document.getElementById('userRole').textContent = ''; 
            document.getElementById('userRegion').textContent = ''; 
            
            loadSidebar();
            loadHome();
        }

        function logout() {
            currentUser = null;
            currentModule = 'home';
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('loginForm').reset();
        }

        function loadSidebar() {
            const sidebar = document.getElementById('sidebarMenu');
            let menuItems = [
                { id: 'home', label: 'Home', icon: 'üè†' },
                { id: 'artProgress', label: 'Kemajuan Gambar', icon: 'üé®' },
                { id: 'skolastikProgress', label: 'Kemajuan Tes Skolastik', icon: 'üìä' },
                // PERUBAHAN NAMA MODUL: 'Kemajuan TKA'
                { id: 'tkaProgress', label: 'Kemajuan TKA', icon: 'üìà' }, 
                { id: 'schedule', label: 'Jadwal Belajar', icon: 'üìÖ' }, 
                { id: 'activitySchedule', label: 'Jadwal Kegiatan', icon: 'üìÜ' },
                { id: 'materials', label: 'Materi Kelas', icon: 'üìö' },
                { id: 'educationInfo', label: 'Informasi Pendidikan', icon: 'üì∞' }
            ];

            if (currentUser.role === 'Admin') {
                menuItems.push({ id: 'addStudent', label: 'Tambah Siswa', icon: 'üë§' });
                menuItems.push({ id: 'manageClasses', label: 'Kelola Kelas', icon: 'üè´' });
            } else if (currentUser.role === 'Super Admin') {
        menuItems = [
            { id: 'home', label: 'Home', icon: 'üè†' },
            { id: 'manageAdmins', label: 'Kelola Admin Regional', icon: 'üõ°Ô∏è' },
            { id: 'addStudent', label: 'Tambah Siswa (Global)', icon: 'üë§' },
            { id: 'manageClasses', label: 'Kelola Kelas (Global)', icon: 'üè´' },
            { id: 'logActivity', label: 'Log Activity', icon: 'üìú' }
        ];
    }
    sidebar.innerHTML = menuItems.map(item => `
                <button onclick="loadModule('${item.id}')" id="menu-${item.id}" class="w-full text-left px-5 py-3 rounded-xl hover:bg-blue-800 hover:shadow-lg hover:shadow-blue-900/30 transition-all duration-300 flex items-center space-x-3 tracking-wide font-medium" style="text-shadow: 0 1px 2px rgba(0,0,0,0.4);">
                    <span class="text-xl">${item.icon}</span>
                    <span>${item.label}</span>
                </button>
            `).join('');

            setActiveMenu('home');
        }

        function setActiveMenu(moduleId) {
            document.querySelectorAll('[id^="menu-"]').forEach(btn => {
                btn.classList.remove('sidebar-active');
            });
            const activeBtn = document.getElementById('menu-' + moduleId);
            if (activeBtn) {
                activeBtn.classList.add('sidebar-active');
            }
        }

        function loadModule(moduleId) {
            currentModule = moduleId;
            setActiveMenu(moduleId);
            
            // Reset filters when changing modules (especially Super Admin's class filter for performance)
            if (currentUser.role === 'Super Admin' || currentUser.role === 'Admin') {
                selectedClass = 'all'; // Reset class filter for progress modules
            }
            // Retain material/schedule filters as they are used to render student view as well
            
            switch(moduleId) {
                case 'home':
                    loadHome();
                    break;
                case 'artProgress':
                    loadArtProgress();
                    break;
                case 'skolastikProgress':
                    loadSkolastikProgress();
                    break;
                case 'tkaProgress':
                    loadTkaProgress();
                    break;
                case 'educationInfo':
                    loadEducationInfo();
                    break;
                case 'materials':
                    loadMaterials();
                    break;
                case 'activitySchedule':
                    loadActivitySchedule();
                    break;
                case 'schedule':
                    loadSchedule();
                    break;
                case 'addStudent':
                    loadAddStudent();
                    break;
                case 'manageClasses':
                    loadManageClasses();
                    break;
                case 'logActivity': loadLogActivity(); break;
                case 'manageAdmins': // MODUL BARU
                    loadManageAdmins();
                    break;
            }
        }

        function loadHome() {
            const content = document.getElementById('contentArea');
            const role = currentUser.role;

            







if (role === 'Super Admin') {
    const regions = [...new Set(studentsData.map(s => s.region))];

    // Daftar kelas utama default
    const baseClasses = ['SR GOLD', 'SR ADVANCE', 'MINAT SENI', 'ARSITEKTUR', 'MINAT ARSITEKTUR'];

    // Ambil kelas tambahan dari semua regional yang tidak termasuk default
    const dynamicClasses = [...new Set(
        studentsData.map(s => s.class?.trim())
        .filter(c => c && !baseClasses.some(b => new RegExp(b, 'i').test(c)))
    )].map(c => c.toUpperCase()).sort();

    const allClasses = [...baseClasses, ...dynamicClasses];

    const totalStudents = studentsData.length;
    const seniRupaCount = studentsData.filter(s => /sr|minat seni/i.test(s.class)).length;
    const arsitekturCount = studentsData.filter(s => /arsitektur|minat arsitektur/i.test(s.class)).length;

    // Sekolah dengan siswa terbanyak di seluruh regional
    const schoolCount = {};
    studentsData.forEach(st => {
        if (st.school) {
            if (!schoolCount[st.school]) schoolCount[st.school] = { count: 0, region: st.region };
            schoolCount[st.school].count++;
        }
    });
    const topSchoolEntry = Object.entries(schoolCount).sort((a,b)=>b[1].count - a[1].count)[0];
    const topSchoolName = topSchoolEntry ? topSchoolEntry[0] : '-';
    const topSchoolRegion = topSchoolEntry ? topSchoolEntry[1].region : '-';
    const topSchoolCount = topSchoolEntry ? topSchoolEntry[1].count : 0;

    content.innerHTML = `
        <div class="fade-in ml-6 mr-6">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg p-6 mb-6 text-white shadow-lg">
                <h2 class="text-4xl font-bold mb-2">Selamat Datang, ${currentUser.name}!</h2>
                <p class="text-blue-100 text-lg">Dashboard Kontrol Pusat - Semua Regional</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
                <div class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-blue-500 to-blue-700 border border-blue-200 text-center">
                    <h4 class="font-semibold text-white mb-2 text-lg">üìò Total Siswa</h4>
                    <p class="text-4xl font-extrabold text-white">${totalStudents}</p>
                    <p class="text-sm text-blue-100 mt-2">Total seluruh regional</p>
                </div>

                <div class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-green-500 to-green-700 border border-green-200 text-white text-center">
                    <h4 class="font-semibold mb-2 text-lg">üè´ Sekolah Terbanyak</h4>
                    <p class="text-2xl font-bold text-white mb-1">${topSchoolName}</p>
                    <p class="text-md text-green-100">${topSchoolRegion}</p>
                    <p class="text-sm text-green-100 mt-2">Total ${topSchoolCount} siswa</p>
                </div>

                <div class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-purple-500 to-purple-700 border border-purple-200 text-center text-white">
                    <h4 class="font-semibold text-lg mb-2">üé® Siswa Seni Rupa</h4>
                    <p class="text-4xl font-extrabold text-white">${seniRupaCount}</p>
                    <p class="text-sm text-white mt-2">Total seluruh regional</p>
                </div>

                <div class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-orange-500 to-orange-700 border border-orange-200 text-center text-white">
                    <h4 class="font-semibold text-lg mb-2">üèóÔ∏è Siswa Arsitektur</h4>
                    <p class="text-4xl font-extrabold text-white">${arsitekturCount}</p>
                    <p class="text-sm text-white mt-2">Total seluruh regional</p>
                </div>
            </div>

            <div class="bg-white/80 backdrop-blur-sm border border-gray-200 rounded-2xl shadow-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-gray-900">üìã Data Kelas Aktif</h3>
                    
                </div>

                <div class="overflow-x-auto mt-4">
                    <table id="superAdminClassesTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-800 text-white">
                            <tr>
                                <th class="px-6 py-4 text-center text-xs font-semibold uppercase tracking-wider">No</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">Nama Kelas</th>
                                <th class="px-6 py-4 text-center text-xs font-semibold uppercase tracking-wider">Jumlah Siswa</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">Sekolah Terbanyak</th>
                                <th class="px-6 py-4 text-center text-xs font-semibold uppercase tracking-wider">Status Kelas</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100" id="superAdminClassesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>`;

    function renderClassesTable(regionFilter) {
        let filteredStudents = regionFilter === 'all' ? studentsData : studentsData.filter(s => s.region === regionFilter);

        // Tentukan daftar kelas aktif di region
        let classList;
        if (regionFilter === 'all') {
            classList = allClasses;
        } else {
            const localClasses = [...new Set(filteredStudents.map(s => s.class?.trim()).filter(Boolean))]
                .map(c => c.toUpperCase())
                .sort();
            classList = [...new Set([...baseClasses, ...localClasses])];
        }

        const tbody = document.getElementById('superAdminClassesBody');
        tbody.innerHTML = '';
        let idx = 1;

        classList.forEach(clsName => {
            // Cocokkan juga kelas turunan (SR GOLD A -> SR GOLD)
            const pattern = new RegExp('^' + clsName.replace(/ /g, '.*'), 'i');
            const list = filteredStudents.filter(s => pattern.test(s.class || ''));
            const jumlah = list.length;
            let sekolahTerbanyak = '-';
            if (jumlah > 0) {
                const scount = {};
                list.forEach(st => {
                    if (st.school) scount[st.school] = (scount[st.school] || 0) + 1;
                });
                sekolahTerbanyak = Object.entries(scount).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
            }
            const status = jumlah > 0 ? 'Aktif' : 'Tidak Aktif';
            const color = status === 'Aktif' ? 'text-green-600' : 'text-red-500';
            const icon = status === 'Aktif' ? 'üü¢' : 'üî¥';

            tbody.innerHTML += `
                <tr class='hover:bg-blue-50 transition-colors'>
                    <td class='px-6 py-3 text-sm text-gray-600 text-center font-medium'>${idx}</td>
                    <td class='px-6 py-3 text-sm font-semibold text-gray-900'>${clsName}</td>
                    <td class='px-6 py-3 text-sm text-center text-gray-700'>${jumlah}</td>
                    <td class='px-6 py-3 text-sm text-gray-600'>${sekolahTerbanyak}</td>
                    <td class='px-6 py-3 text-sm text-center font-semibold ${color}'><span class='text-lg mr-1'>${icon}</span>${status}</td>
                </tr>`;
            idx++;
        });
    }

    renderClassesTable('all');
    }

else if (role === 'Admin') {

    let adminStudents = studentsData.filter(s => s.region === currentUser.region);

    const groupsDef = [
        { key: 'SR GOLD', match: name => /sr gold/i.test(name) },
        { key: 'SR ADVANCE', match: name => /sr advance/i.test(name) },
        { key: 'MINAT SENI', match: name => /minat seni/i.test(name) },
        { key: 'ARSITEKTUR', match: name => /arsitektur/i.test(name) && !/minat arsitektur/i.test(name) },
        { key: 'MINAT ARSITEKTUR', match: name => /minat arsitektur/i.test(name) }
    ];

    const classNamesInRegion = [...new Set(adminStudents.map(s => s.class).filter(Boolean))];
    let grouped = {};
    groupsDef.forEach(g => grouped[g.key] = []);
    let remainingClassNames = new Set(classNamesInRegion);

    adminStudents.forEach(s => {
        const className = (s.class || '').toString();
        let assigned = false;
        for (const g of groupsDef) {
            if (g.match(className)) {
                grouped[g.key].push(s);
                assigned = true;
                break;
            }
        }
        if (!assigned) remainingClassNames.add(className);
        else remainingClassNames.delete(className);
    });
    remainingClassNames.forEach(cname => {
        if (!cname) return;
        grouped[cname] = adminStudents.filter(s => s.class === cname);
    });

    let tableRows = [];
    let idx = 1;
    Object.keys(grouped).forEach(key => {
        const studentsInGroup = grouped[key] || [];
        const jumlah = studentsInGroup.length;
        let sekolahTerbanyak = '-';
        if (jumlah > 0) {
            const schoolCount = {};
            studentsInGroup.forEach(st => {
                if (st.school) schoolCount[st.school] = (schoolCount[st.school] || 0) + 1;
            });
            sekolahTerbanyak = Object.entries(schoolCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
        }
        const status = jumlah > 0 ? 'Aktif' : 'Tidak Aktif';
        tableRows.push(`
          <tr class='hover:bg-blue-50 transition-colors'>
            <td class='px-6 py-3 text-sm text-gray-600 text-center font-medium'>${idx}</td>
            <td class='px-6 py-3 text-sm font-semibold text-gray-900'>${key}</td>
            <td class='px-6 py-3 text-sm text-center text-gray-700'>${jumlah}</td>
            <td class='px-6 py-3 text-sm text-gray-600'>${sekolahTerbanyak}</td>
            <td class='px-6 py-3 text-sm text-center font-semibold ${status === 'Aktif' ? 'text-green-600' : 'text-red-500'}'>
              <span class='text-lg mr-1'>${status === 'Aktif' ? 'üü¢' : 'üî¥'}</span>${status}
            </td>
          </tr>
        `);
        idx++;
    });

    const totalStudents = adminStudents.length;
    const schoolCount = {};
    adminStudents.forEach(s => {
        if (s.school) schoolCount[s.school] = (schoolCount[s.school] || 0) + 1;
    });
    const topSchool = Object.entries(schoolCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'Tidak ada data';
    const seniRupaCount = adminStudents.filter(s => /sr|minat seni/i.test(s.class)).length;
    const arsitekturCount = adminStudents.filter(s => /arsitektur|minat arsitektur/i.test(s.class)).length;

    const content = document.getElementById('contentArea');
    content.innerHTML = `
      <main class='max-w-8xl mx-auto py-4 px-8 fade-in ml-1 mr-8'>
        <div class='bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-8 mb-5 text-white shadow-lg'>
          <h2 class='text-3xl font-bold mb-2'>Selamat Datang, ${currentUser.name}!</h2>
          <p class='text-blue-100'>Informasi Laporan Kemajuan Siswa - ${currentUser.region}</p>
        </div>

        <div class='grid grid-cols-1 md:grid-cols-4 gap-6 mb-8'>
          <div class='rounded-xl p-6 shadow-md text-white bg-gradient-to-br from-blue-500 to-blue-700'>
            <p class='text-sm text-center text-blue-100 mb-1'>Total Siswa</p>
            <p class='text-3xl text-center font-bold text-white'>${totalStudents}</p>
          </div>
          <div class='rounded-xl p-6 shadow-md text-white bg-gradient-to-br from-green-500 to-green-700'>
            <p class='text-sm text-center text-green-100 mb-1'>Sekolah Terbanyak</p>
            <p class='text-2xl text-center font-semibold text-white'>${topSchool}</p>
          </div>
          <div class='rounded-xl p-6 shadow-md text-white bg-gradient-to-br from-purple-500 to-purple-700'>
            <p class='text-sm text-center text-purple-100 mb-1'>Siswa Seni Rupa</p>
            <p class='text-3xl text-center font-bold text-white'>${seniRupaCount}</p>
          </div>
          <div class='rounded-xl p-6 shadow-md text-white bg-gradient-to-br from-orange-500 to-orange-700'>
            <p class='text-sm text-center text-orange-100 mb-1'>Siswa Arsitektur</p>
            <p class='text-3xl text-center font-bold text-white'>${arsitekturCount}</p>
          </div>
        </div>

        <h3 class='text-2xl font-bold text-gray-900 mb-4 flex items-center'>
          <span class='text-2xl text-center mr-2'>üìã</span> Data Kelas Aktif
        </h3>

        <div class='bg-white/80 backdrop-blur-sm border border-gray-200 rounded-2xl shadow-xl overflow-hidden'>
          <div class='overflow-x-auto'>
            <table class='min-w-full divide-y divide-gray-200'>
              <thead class='bg-blue-800 text-white'>
                <tr>
                  <th class='px-6 py-4 text-center text-xs font-semibold text-white-700 uppercase tracking-wider'>No</th>
                  <th class='px-6 py-4 text-left text-xs font-semibold text-white-700 uppercase tracking-wider'>Nama Kelas</th>
                  <th class='px-6 py-4 text-center text-xs font-semibold text-white-700 uppercase tracking-wider'>Jumlah Siswa</th>
                  <th class='px-6 py-4 text-left text-xs font-semibold text-white-700 uppercase tracking-wider'>Sekolah Terbanyak</th>
                  <th class='px-6 py-4 text-center text-xs font-semibold text-white-700 uppercase tracking-wider'>Status Kelas</th>
                </tr>
              </thead>
              <tbody class='bg-white divide-y divide-gray-100'>
                ${tableRows.join('')}
              </tbody>
            </table>
          </div>
        </div>
      </main>`;
}
 else {
    // Student Home (Fixed UI) - UPDATED with 3 realtime statistic cards above the original 3 cards
    const studentData = studentsData.find(s => s.name === currentUser.name);
    if (!studentData) {
        content.innerHTML = '<div class="text-center text-gray-500">Data siswa tidak ditemukan</div>';
        return;
    }

    // realtime calculations
    const totalAttendance = (studentData.attendance || []).length;
    const hadirCount = (studentData.attendance || []).filter(a => a.status === 'Hadir').length;
    const hadirPercent = totalAttendance > 0 ? Math.round((hadirCount / totalAttendance) * 100) : 0;

    const skolastikScores = (studentData.skolastikTests || []).map(t => t.score);
    const avgSkolastik = skolastikScores.length > 0 ? Math.round(skolastikScores.reduce((a,b)=>a+b,0) / skolastikScores.length) : 0;

    const tkaScores = (studentData.tkaTests || []).map(t => t.score);
    const avgTKA = tkaScores.length > 0 ? Math.round(tkaScores.reduce((a,b)=>a+b,0) / tkaScores.length) : 0;

    content.innerHTML = `
    <div class="fade-in ml-6 mr-6">
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg p-6 mb-4 text-white shadow-lg">
            <h2 class="text-4xl font-bold mb-3">Selamat Datang, ${currentUser.name}!</h2>
            <p class="text-blue-100 text-2xl mt-1">Pantau terus perkembangan belajar Anda</p>
        </div>

        <!-- ===== Top: 3 Realtime Statistic Cards (Kehadiran, Skolastik, TKA) ===== -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
            <div class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 text-center hover:shadow-2xl transition-all">
                <h4 class="font-semibold text-center text-gray-900 mb-2 text-lg">üìò Kehadiran</h4>
                <p class="text-5xl font-extrabold text-center text-blue-600">${hadirPercent}%</p>
                <p class="text-sm text-center text-gray-600 mt-2">${hadirCount} dari ${totalAttendance} pertemuan</p>
            </div>

            <div class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-green-50 to-green-100 border border-green-200 text-center hover:shadow-2xl transition-all">
                <h4 class="font-semibold text-center text-gray-900 mb-2 text-lg">üìä Tes Skolastik</h4>
                <p class="text-5xl text-center font-extrabold text-green-600">${avgSkolastik}</p>
                <p class="text-sm text-center text-gray-600 mt-2">Rata-rata skor</p>
            </div>

            <div class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 text-center hover:shadow-2xl transition-all">
                <h4 class="font-semibold text-center text-gray-900 mb-2 text-lg">üìà Kemajuan TKA</h4>
                <p class="text-5xl text-center font-extrabold text-purple-600">${avgTKA}</p>
                <p class="text-sm text-center text-gray-600 mt-2">Rata-rata skor</p>
            </div>
        </div>

        <!-- ===== Bottom: original 3 cards (kept intact) ===== -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10 mb-12">
            <div class="text-center p-8 rounded-2xl shadow-md bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 hover:shadow-2xl transition-all duration-300 min-h-[380px] flex flex-col justify-center items-center space-y-4">
                <div class="bg-blue-500 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4 shadow-md">
                    <span class="text-4xl text-white">üé®</span>
                </div>
                <h4 class="font-semibold text-center text-gray-900 mb-2 text-xl">Total Karya</h4>
                <p class="text-5xl text-center font-extrabold text-blue-600">${studentData.artworks.length}</p>
            </div>

            <div class="text-center p-8 rounded-2xl shadow-md bg-gradient-to-br from-green-50 to-green-100 border border-green-200 hover:shadow-2xl transition-all duration-300 min-h-[380px] flex flex-col justify-center items-center space-y-4">
                <div class="bg-green-500 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4 shadow-md">
                    <span class="text-4xl text-center text-white">üìÖ</span>
                </div>
                <h4 class="font-semibold text-center text-gray-900 mb-2 text-xl">Karya Terbaru</h4>
                ${studentData.artworks.length > 0 ? `
                    <p class="text-2xl font-bold text-green-600">${studentData.artworks[studentData.artworks.length - 1].title}</p>
                    <p class="text-sm text-gray-600 mt-1">${studentData.artworks[studentData.artworks.length - 1].date}</p>
                ` : `<p class="text-2xl font-bold text-gray-500">Belum ada</p>`}
            </div>

            <div class="text-center p-8 rounded-2xl shadow-md bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 hover:shadow-2xl transition-all duration-300 min-h-[380px] flex flex-col justify-center items-center space-y-4">
                <div class="bg-purple-500 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4 shadow-md">
                    <span class="text-4xl text-white">üèÜ</span>
                </div>
                <h4 class="font-semibold text-gray-900 mb-2 text-xl">Kelas Saat Ini</h4>
                <p class="text-5xl font-extrabold text-purple-600">${studentData.class}</p>
            </div>
        </div>
    </div>`;
}}

        // FUNGSI HELPER BARU: untuk toggle input regional di Super Admin
        window.toggleNewRegionInput = function(selectedValue) {
            const newRegionContainer = document.getElementById('newRegionInputContainer');
            if (newRegionContainer) {
                if (selectedValue === 'NEW_REGION') {
                    newRegionContainer.classList.remove('hidden');
                    document.getElementById('adminRegionInput').setAttribute('required', 'required'); 
                } else {
                    newRegionContainer.classList.add('hidden');
                    document.getElementById('adminRegionInput').removeAttribute('required');
                }
            }
        }

        // --- FUNGSI BARU: MODUL KELOLA ADMIN REGIONAL ---
        function loadManageAdmins() {
            const content = document.getElementById('contentArea');
            if (currentUser.role !== 'Super Admin') {
                content.innerHTML = '<div class="fade-in text-center text-red-600 text-xl font-bold p-10">Akses Ditolak. Hanya Super Admin yang dapat mengakses modul ini.</div>';
                return;
            }

        // === NEW MODULE: LOG ACTIVITY ===
        window.loadLogActivity = function() {
            const content = document.getElementById('contentArea');
            if (currentUser.role !== 'Super Admin') {
                content.innerHTML = '<div class="fade-in text-center text-red-600 text-xl font-bold p-10">Akses Ditolak. Hanya Super Admin yang dapat mengakses modul ini.</div>';
                return;
            }

            let logs = JSON.parse(localStorage.getItem('loginActivityLogs') || '[]');

            content.innerHTML = `
                <div class='fade-in'>
                    <div class='flex justify-between items-center mb-6'>
                        <h2 class='text-2xl font-bold text-gray-900'>üìú Log Aktivitas Login</h2>
                        <button onclick='clearActivityLogs()' class='px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all shadow-md'>Hapus Log</button>
                    </div>

                    <div class='bg-white border border-gray-200 rounded-xl shadow-md overflow-hidden'>
                        <table class='min-w-full divide-y divide-gray-200'>
                            <thead class='bg-blue-800 text-white'>
                                <tr>
                                    <th class='px-6 py-3 text-center text-xs font-semibold text-white-700 uppercase tracking-wider'>No</th>
                                    <th class='px-6 py-3 text-center text-xs font-semibold text-white-700 uppercase tracking-wider'>Nama</th>
                                    <th class='px-6 py-3 text-center text-xs font-semibold text-white-700 uppercase tracking-wider'>Role</th>
                                    <th class='px-6 py-3 text-center text-xs font-semibold text-white-700 uppercase tracking-wider'>Regional</th>
                                    <th class='px-6 py-3 text-center text-xs font-semibold text-white-700 uppercase tracking-wider'>Waktu Login</th>
                                </tr>
                            </thead>
                            <tbody class='bg-white divide-y divide-gray-100'>
                                ${logs.length > 0 ? logs.map((log, i) => `
                                    <tr class='hover:bg-blue-50 transition-all'>
                                        <td class='px-6 py-3 text-sm text-gray-700'>${i + 1}</td>
                                        <td class='px-6 py-3 text-sm font-medium text-gray-900'>${log.name}</td>
                                        <td class='px-6 py-3 text-sm text-blue-600 font-semibold'>${log.role}</td>
                                        <td class='px-6 py-3 text-sm text-gray-700'>${log.region}</td>
                                        <td class='px-6 py-3 text-sm text-gray-500'>${log.time}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan='5' class='text-center py-6 text-gray-500'>Belum ada aktivitas login.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        window.clearActivityLogs = function() {
            localStorage.removeItem('loginActivityLogs');
            showNotification('Log aktivitas berhasil dihapus!', 'success');
            loadLogActivity();
        }


            content.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üõ°Ô∏è Kelola Admin Regional</h2>
                        <button onclick="addRegionalAdmin()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">+ Tambah Admin Regional</button>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Daftar Akun Admin Regional (${regionalAdmins.length})</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-blue-800 text-white">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nama Admin</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Username</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Regional</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Jml Siswa</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${regionalAdmins.map(admin => {
                                        const studentsInRegion = studentsData.filter(s => s.region === admin.region).length;
                                        return `
                                            <tr class="border-t border-gray-200 hover:bg-red-50">
                                                <td class="px-4 py-3 text-sm font-medium text-gray-900">${admin.name}</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">${admin.username}</td>
                                                <td class="px-4 py-3 text-sm text-red-600 font-medium">${admin.region}</td>
                                                <td class="px-4 py-3 text-sm text-blue-600 font-bold">${studentsInRegion}</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <button onclick="editRegionalAdmin('${admin.username}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                                    <button onclick="deleteRegionalAdmin('${admin.username}')" class="text-red-600 hover:text-red-800">Hapus</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function addRegionalAdmin() {
            // Dapatkan daftar regional yang sudah ada dan unik
            const studentRegions = studentsData.map(s => s.region).filter(r => r);
            const adminRegions = regionalAdmins.map(a => a.region).filter(r => r);
            const existingRegions = [...new Set([...studentRegions, ...adminRegions])];

            openModal('Tambah Admin Regional Baru', `
                <form id="addAdminForm" class="space-y-4">
                    <div>
                        <label for="adminName" class="block text-sm font-medium text-gray-700 mb-1">Nama Admin</label>
                        <input type="text" id="adminName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label for="adminUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="adminUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="adminPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    
                    <div>
                        <label for="adminRegionSelect" class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
                        <select id="adminRegionSelect" onchange="toggleNewRegionInput(this.value)" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                            <option value="">--- Pilih Regional yang Sudah Ada ---</option>
                            ${existingRegions.sort().map(regionName => `
                                <option value="${regionName}">${regionName}</option>
                            `).join('')}
                            <option value="NEW_REGION">--- Tambah Regional Baru ---</option>
                        </select>
                    </div>

                    <div id="newRegionInputContainer" class="hidden">
                        <label for="adminRegionInput" class="block text-sm font-medium text-gray-700 mb-1">Regional Baru</label>
                        <input type="text" id="adminRegionInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Contoh: Jakarta Pusat">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Tambah Admin</button>
                </form>
            `);

            document.getElementById('addAdminForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('adminUsername').value;
                const name = document.getElementById('adminName').value;
                const password = document.getElementById('adminPassword').value;

                const selectedRegion = document.getElementById('adminRegionSelect').value;
                let region = '';

                if (selectedRegion === 'NEW_REGION') {
                    region = document.getElementById('adminRegionInput').value.trim();
                } else if (selectedRegion) {
                    region = selectedRegion;
                }
                
                if (!region) {
                    showNotification('Silakan pilih atau masukkan Regional!', 'error');
                    return;
                }

                if (await loadAllData()[username]) {
                    showNotification('Username sudah digunakan!', 'error');
                    return;
                }
                
                // Cek konflik regional
                if (regionalAdmins.some(admin => admin.region.toLowerCase() === region.toLowerCase())) {
                     showNotification('Regional ini sudah memiliki Admin. Harap gunakan nama Regional yang berbeda.', 'error');
                    return;
                }

                const newAdmin = { username, password, role: 'Admin', name, region };
                regionalAdmins.push(newAdmin);

                showNotification('Admin Regional berhasil ditambahkan!');
                this.reset();
                closeModal();
                loadManageAdmins();
            });
        }

        function editRegionalAdmin(username) {
            const admin = regionalAdmins.find(a => a.username === username);
            
            openModal('Edit Admin Regional', `
                <form id="editAdminForm" class="space-y-4">
                    <div>
                        <label for="editAdminName" class="block text-sm font-medium text-gray-700 mb-1">Nama Admin</label>
                        <input type="text" id="editAdminName" value="${admin.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label for="editAdminRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
                        <input type="text" id="editAdminRegion" value="${admin.region}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label for="editAdminPassword" class="block text-sm font-medium text-gray-700 mb-1">Password Baru (Opsional)</label>
                        <input type="password" id="editAdminPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <p class="text-xs text-gray-500 mt-1">Kosongkan jika tidak ingin mengubah password</p>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Update Admin</button>
                </form>
            `);

            document.getElementById('editAdminForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const newName = document.getElementById('editAdminName').value;
                const newRegion = document.getElementById('editAdminRegion').value;
                const newPassword = document.getElementById('editAdminPassword').value;

                const oldRegion = admin.region;

                // Check if new region conflicts with other regions
                if (regionalAdmins.some(a => a.username !== username && a.region.toLowerCase() === newRegion.toLowerCase())) {
                     showNotification('Regional ini sudah memiliki Admin. Harap gunakan nama Regional yang berbeda.', 'error');
                    return;
                }

                admin.name = newName;
                if (newPassword) {
                    admin.password = newPassword;
                }
                admin.region = newRegion;

                // Update students' region if the region name changed
                if (oldRegion !== newRegion) {
                    studentsData.forEach(student => {
                        if (student.region === oldRegion) {
                            student.region = newRegion;
                        }
                    });
                }
                
                closeModal();
                loadManageAdmins();
                try { saveAllData(); } catch(e) { console.warn(e); }
showNotification('Data Admin Regional berhasil diupdate!');
            });
        }

        
function deleteRegionalAdmin(username) {
    const admin = regionalAdmins.find(a => a.username === username);
    if (!admin) return;

    openModal('Konfirmasi Hapus Admin', `
        <div class="text-center">
            <div class="mb-4">
                <span class="text-6xl">‚ö†Ô∏è</span>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Hapus Admin Regional</h3>
            <p class="text-gray-700 mb-4">
                Apakah Anda yakin ingin menghapus Admin 
                <strong>${admin.name}</strong> dari regional 
                <strong>${admin.region}</strong>?<br>
                <span class="text-sm text-gray-500">(Data siswa di regional ini akan tetap tersimpan)</span>
            </p>
            <div class="flex space-x-3">
                <button onclick="confirmDeleteRegionalAdmin('${username}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
            </div>
        </div>
    `);
}

function confirmDeleteRegionalAdmin(username) {
    regionalAdmins = regionalAdmins.filter(a => a.username !== username);
    try { saveAllData(); } catch(e) { console.warn(e); }
    closeModal();
    loadManageAdmins();
    showNotification('Admin berhasil dihapus tanpa menghapus data siswa!', 'success');
}


        // --- END FUNGSI BARU: MODUL KELOLA ADMIN REGIONAL ---

        // --- FUNGSI LAMA DARI FILE ASLI (disimpan untuk kompatibilitas modul admin) ---

        // --- FUNGSI BARU: PDF GENERATOR ---
        function generatePDF(elementId, filename) {
            const element = document.getElementById(elementId);
            
            if (!element) {
                showNotification('Area konten tidak ditemukan!', 'error');
                return;
            }

            // Konfigurasi untuk html2pdf (untuk hasil A4 portrait yang optimal)
            const opt = {
                margin: 0.5, // Margin (dalam inci)
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'in', format: 'A4', orientation: 'portrait' }
            };
            
            // Gunakan fungsi html2pdf untuk membuat dan menyimpan PDF
            html2pdf().set(opt).from(element).save();
            showNotification('PDF sedang dibuat dan akan segera diunduh!', 'success');
        }

        // --- NEW: Helper function to render Region Dropdown for Super Admin ---
        function renderRegionDropdown(currentRegionFilter, filterFunctionName) {
            const regions = [...new Set([
    ...availableClasses.map(c => c.region),
    ...studentsData.map(s => s.region),
    ...regionalAdmins.map(a => a.region)
].filter(Boolean))];
            
            // Pastikan regions mencakup semua regional yang ada di studentsData, meskipun adminnya sudah dihapus
            studentsData.forEach(student => {
                if (!regions.includes(student.region) && student.region) {
                    regions.push(student.region);
                }
            });

            return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">Filter Regional</h4>
                    <select onchange="${filterFunctionName}(this.value)" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="all" ${currentRegionFilter === 'all' ? 'selected' : ''}>Semua Regional</option>
                        ${regions.sort().map(regionName => `
                            <option value="${regionName}" ${currentRegionFilter === regionName ? 'selected' : ''}>${regionName}</option>
                        `).join('')}
                    </select>
                </div>
            `;
        }

        // --- NEW: Detail Modal Render Functions ---

        function showStudentArtDetail(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            // Re-use existing render logic for clarity, stripping outer div from renderArtProgressStudent
            const detailContent = renderArtProgressStudent([student], currentUser.role === 'Admin' || currentUser.role === 'Super Admin')
                .replace(/<div class="mb-6">/, '')
                .replace(/<\/div>$/, '');

            openModal(`Detail Kemajuan Gambar: ${student.name}`, detailContent);
        }

        function showStudentSkolastikDetail(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            // Re-use existing render logic, stripping outer div from renderSkolastikProgressStudent
            const detailContent = renderSkolastikProgressStudent([student], isAdminOrSuperAdmin)
                .replace(/<div class="mb-4">/, '') 
                .replace(/<\/div>$/, '');
            
            // Tambahkan judul dan tombol Add Test (yang sudah ada di dalam render function, tapi kita rapikan)
            const finalContent = `
                <div class="mb-4">
                    <h4 class="text-xl font-bold text-gray-900 mb-4">Hasil Tes Skolastik: ${student.name}</h4>
                    <p class="text-sm text-blue-600 font-medium mb-4">Sekolah: ${student.school || 'Belum ditentukan'} ${isAdminOrSuperAdmin ? `| Regional: ${student.region}` : ''}</p>
                </div>
                ${detailContent}`;

            openModal(`Detail Tes Skolastik: ${student.name}`, finalContent);
        }

        function showStudentTkaDetail(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';

            // Re-use existing render logic, stripping outer div from renderTkaProgressStudent
            const detailContent = renderTkaProgressStudent([student], isAdminOrSuperAdmin)
                .replace(/<div class="mb-4">/, '')
                .replace(/<\/div>$/, '');

            // Tambahkan judul dan tombol Add Test (yang sudah ada di dalam render function, tapi kita rapikan)
            const finalContent = `
                <div class="mb-4">
                    <h4 class="text-xl font-bold text-gray-900 mb-4">Hasil Tes TKA: ${student.name}</h4>
                    <p class="text-sm text-blue-600 font-medium mb-4">Sekolah: ${student.school || 'Belum ditentukan'} ${isAdminOrSuperAdmin ? `| Regional: ${student.region}` : ''}</p>
                </div>
                ${detailContent}`;
                
            openModal(`Detail Tes TKA: ${student.name}`, finalContent);
        }

        // NEW: Function to render student list grouped by class
        function renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, currentModule) {
            if (displayData.length === 0) {
                return `<div class="text-center p-6 text-gray-500">Tidak ada data siswa yang ditemukan di regional ini atau filter kelas yang dipilih.</div>`;
            }

            // Get available classes for the current region
            const regionalClasses = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? (selectedAdminRegion === 'all' || c.region === selectedAdminRegion) : c.region === currentUser.region
            );

            // Group students by class
            const groupedStudents = regionalClasses.reduce((groups, classItem) => {
                const students = displayData.filter(s => s.class === classItem.name);
                if (students.length > 0) {
                    groups[classItem.name] = students;
                }
                return groups;
            }, {});

            if (Object.keys(groupedStudents).length === 0) {
                 return `<div class="text-center p-6 text-gray-500">Tidak ada siswa yang terdaftar di kelas yang tersedia atau filter kelas yang dipilih.</div>`;
            }

            let contentHtml = '';

            const detailFunction = currentModule === 'artProgress' 
                ? 'showStudentArtDetail' 
                : currentModule === 'skolastikProgress' 
                ? 'showStudentSkolastikDetail' 
                : 'showStudentTkaDetail';

            for (const className in groupedStudents) {
                const studentsInClass = groupedStudents[className];
                
                // Get overall class stats for the module (if relevant)
                let classStatHtml = '';
                if (currentModule === 'artProgress') {
                    const totalArtworks = studentsInClass.reduce((total, student) => total + student.artworks.length, 0);
                    const totalAttendance = studentsInClass.reduce((total, student) => total + student.attendance.length, 0);
                    const totalHadir = studentsInClass.reduce((total, student) => total + student.attendance.filter(a => a.status === 'Hadir').length, 0);
                    const avgAttendance = totalAttendance > 0 ? ((totalHadir / totalAttendance) * 100).toFixed(1) : 0;
                    classStatHtml = `<p class="text-sm text-gray-600 mt-2">Total Karya: ${totalArtworks} | Rata-rata Kehadiran: ${avgAttendance}%</p>`;
                } else if (currentModule === 'skolastikProgress') {
                    const allScores = studentsInClass.flatMap(s => s.skolastikTests.map(t => t.score));
                    const avgScore = allScores.length > 0 ? (allScores.reduce((sum, score) => sum + score, 0) / allScores.length).toFixed(1) : 0;
                    classStatHtml = `<p class="text-sm text-gray-600 mt-2">Total Tes Skolastik: ${allScores.length} | Rata-rata Nilai: <span class="font-bold text-blue-600">${avgScore}</span></p>`;
                } else if (currentModule === 'tkaProgress') {
                     const allScores = studentsInClass.flatMap(s => s.tkaTests.map(t => t.score));
                    const avgScore = allScores.length > 0 ? (allScores.reduce((sum, score) => sum + score, 0) / allScores.length).toFixed(1) : 0;
                    classStatHtml = `<p class="text-sm text-gray-600 mt-2">Total Tes TKA: ${allScores.length} | Rata-rata Nilai: <span class="font-bold text-purple-600">${avgScore}</span></p>`;
                }

                contentHtml += `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6 shadow-md">
                        <h3 class="text-xl font-bold text-blue-800 mb-2">Kelas ${className} (${studentsInClass.length} Siswa)</h3>
                        ${classStatHtml}
                        <div class="mt-4 space-y-3">
                            ${studentsInClass.map(student => `
                                <div class="flex justify-between items-center p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                                    <div>
                                        <p class="font-semibold text-gray-900">${student.name}</p>
                                        <p class="text-sm text-gray-600">${student.school || 'Sekolah belum ditentukan'}</p>
                                    </div>
                                    <button onclick="${detailFunction}(${student.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                        Lihat Detail
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return contentHtml;
        }

        // Helper function: Groups artworks by Month and Year
        function groupArtworksByMonth(artworks) {
            return artworks.reduce((groups, artwork) => {
                // Get YYYY-MM format from date
                const monthYear = artwork.date.substring(0, 7); 
                if (!groups[monthYear]) {
                    groups[monthYear] = [];
                }
                groups[monthYear].push(artwork);
                return groups;
            }, {});
        }

        // NEW: Helper function to render Art Progress for one student (to be reused) - MODIFIED FOR FOLDER BULAN
        function renderArtProgressStudent(students, isAdminOrSuperAdmin) {
             
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            return students.map(student => {
                const groupedArtworks = groupArtworksByMonth(student.artworks);
                // Sort months in descending order (newest first)
                const sortedMonths = Object.keys(groupedArtworks).sort().reverse();
                
                return `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">${student.name}</h3>
                                <p class="text-sm text-blue-600 font-medium">Sekolah: ${student.school || 'Belum ditentukan'} ${currentUser.role === 'Super Admin' ? `| Regional: ${student.region}` : ''}</p>
                            </div>
                            ${isAdminOrSuperAdmin && currentUser.role !== 'Siswa' ? `<button onclick="addArtwork(${student.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm text-sm">+ Tambah Karya</button>` : ''}
                        </div>

                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">üñºÔ∏è Karya Siswa (${student.artworks.length})</h4>
                            
                            ${student.artworks.length > 0 ? `
                                <div class="space-y-4">
                                ${sortedMonths.map(monthYear => {
                                    const year = monthYear.substring(0, 4);
                                    const monthIndex = parseInt(monthYear.substring(5, 7)) - 1;
                                    const monthName = monthNames[monthIndex];
                                    const artworksInMonth = groupedArtworks[monthYear];
                                    
                                    return `
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm">
                                            <details>
                                                <summary class="font-bold text-gray-800 cursor-pointer p-2 -m-2">
                                                    üìÅ ${monthName} ${year} (${artworksInMonth.length} Karya)
                                                </summary>
                                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                    ${artworksInMonth.map(art => `
                                                        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                                                            <img src="${art.image}" alt="${art.title}" class="w-full h-48 object-cover ${isAdminOrSuperAdmin ? 'editable-image cursor-pointer' : ''}" ${isAdminOrSuperAdmin ? `onclick="editArtworkImage(${student.id}, ${art.id})"` : ''}>
                                                            <div class="p-4">
                                                                <h5 class="font-semibold text-gray-900">${art.title}</h5>
                                                                <p class="text-sm text-gray-600 mt-1">${art.description}</p>
                                                                <p class="text-sm text-gray-500 mt-1">üìÖ ${art.date}</p>
                                                                <div class="mt-2 p-2 bg-yellow-50 rounded border-l-4 border-yellow-400">
                                                                    <p class="text-sm text-gray-700"><strong>Komentar:</strong> ${art.comment}</p>
                                                                </div>
                                                                ${isAdminOrSuperAdmin ? `
                                                                    <div class="mt-3 flex space-x-2">
                                                                        <button onclick="editArtwork(${student.id}, ${art.id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Edit</button>
                                                                        <button onclick="deleteArtwork(${student.id}, ${art.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Hapus</button>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </details>
                                        </div>
                                    `;
                                }).join('')}
                                </div>
                            ` : '<p class="text-gray-500">Belum ada karya yang dibuat</p>'}
                        </div>

                        <div>
                            <div class="flex justify-between items-center">
                                <h4 class="font-semibold text-gray-900 mb-3">üìã Data Kehadiran (${student.attendance.length})</h4>
                                ${isAdminOrSuperAdmin && currentUser.role !== 'Siswa' ? `<button onclick="addAttendance(${student.id})" class="mb-3 px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-sm text-sm">+ Tambah</button>` : ''}
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-blue-800 text-white">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Tanggal</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Status</th>
                                            ${isAdminOrSuperAdmin ? '<th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        ${student.attendance.map((att, idx) => `
                                            <tr class="border-t border-gray-200">
                                                <td class="px-4 py-3 text-sm text-gray-900">${att.date}</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <span class="px-2 py-1 rounded ${att.status === 'Hadir' ? 'bg-green-100 text-green-800' : att.status === 'Izin' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${att.status}</span>
                                                </td>
                                                ${isAdminOrSuperAdmin ? `
                                                    <td class="px-4 py-3 text-sm">
                                                        <button onclick="editAttendance(${student.id}, ${idx})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                                        <button onclick="deleteAttendance(${student.id}, ${idx})" class="text-red-600 hover:text-red-800">Hapus</button>
                                                    </td>
                                                ` : ''}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }).join(''); // Join back the outer array
        }

        // NEW: Helper function to render Skolastik Progress for one student (to be reused)
        function renderSkolastikProgressStudent(students, isAdminOrSuperAdmin) {
            return students.map(student => `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">${student.name}</h3>
                            <p class="text-sm text-blue-600 font-medium">Sekolah: ${student.school || 'Belum ditentukan'} ${currentUser.role === 'Super Admin' ? `| Regional: ${student.region}` : ''}</p>
                        </div>
                        ${isAdminOrSuperAdmin && currentUser.role !== 'Siswa' ? `<button onclick="addSkolastikTest(${student.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm text-sm">+ Tambah Tes</button>` : ''}
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-blue-800 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Tanggal Tes</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Materi</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nilai</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Keterangan</th>
                                    ${isAdminOrSuperAdmin ? '<th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white">
                                ${student.skolastikTests.map((test, idx) => `
                                    <tr class="border-t border-gray-200">
                                        <td class="px-4 py-3 text-sm text-gray-900">${test.date}</td>
                                        <td class="px-4 py-3 text-sm text-gray-900">${test.subject}</td>
                                        <td class="px-4 py-3 text-sm">
                                            <span class="px-2 py-1 rounded ${test.score >= 85 ? 'bg-green-100 text-green-800' : test.score >= 70 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${test.score}</span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${test.comment}</td>
                                        ${isAdminOrSuperAdmin ? `
                                            <td class="px-4 py-3 text-sm">
                                                <button onclick="editSkolastikTest(${student.id}, ${idx})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                                <button onclick="deleteSkolastikTest(${student.id}, ${idx})" class="text-red-600 hover:text-red-800">Hapus</button>
                                            </td>
                                        ` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }

        // NEW: Helper function to render TKA Progress for one student (to be reused)
        function renderTkaProgressStudent(students, isAdminOrSuperAdmin) {
            return students.map(student => `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">${student.name}</h3>
                            <p class="text-sm text-blue-600 font-medium">Sekolah: ${student.school || 'Belum ditentukan'} ${currentUser.role === 'Super Admin' ? `| Regional: ${student.region}` : ''}</p>
                        </div>
                        ${isAdminOrSuperAdmin && currentUser.role !== 'Siswa' ? `<button onclick="addTkaTest(${student.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm text-sm">+ Tambah Tes</button>` : ''}
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-blue-800 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Tanggal Tes</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Materi</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nilai</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Keterangan</th>
                                    ${isAdminOrSuperAdmin ? '<th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white">
                                ${student.tkaTests.map((test, idx) => `
                                    <tr class="border-t border-gray-200">
                                        <td class="px-4 py-3 text-sm text-gray-900">${test.date}</td>
                                        <td class="px-4 py-3 text-sm text-gray-900">${test.subject}</td>
                                        <td class="px-4 py-3 text-sm">
                                            <span class="px-2 py-1 rounded ${test.score >= 85 ? 'bg-green-100 text-green-800' : test.score >= 70 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${test.score}</span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${test.comment}</td>
                                        ${isAdminOrSuperAdmin ? `
                                            <td class="px-4 py-3 text-sm">
                                                <button onclick="editTkaTest(${student.id}, ${idx})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                                <button onclick="deleteTkaTest(${student.id}, ${idx})" class="text-red-600 hover:text-red-800">Hapus</button>
                                            </td>
                                        ` : ''}
                            </tr>
                        `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }
        
        // --- MODIFIED FUNCTION 1: Kemajuan Gambar (Super Admin shows Summary, Admin Regional shows Grouped by Class) ---
        function loadArtProgress() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            let displayData = studentsData;
            let displayTitle = 'Global';
            
            if (currentUser.role === 'Siswa') {
                displayData = studentsData.filter(s => s.name === currentUser.name);
                displayTitle = currentUser.name;
            } else if (currentUser.role === 'Admin') {
                displayData = studentsData.filter(s => s.region === currentUser.region);
                displayTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin') {
                if (selectedAdminRegion !== 'all') {
                     displayData = studentsData.filter(s => s.region === selectedAdminRegion);
                     displayTitle = `Regional ${selectedAdminRegion}`;
                } else {
                     displayTitle = 'Global (Semua Regional)';
                }
            }

            // Apply class filter if any (only applies to Admin Regional view)
            if (currentUser.role === 'Admin' && selectedClass !== 'all') {
                displayData = displayData.filter(s => s.class === selectedClass);
            }
             
            // Calculate Global/Regional Stats
            const totalStudents = displayData.length;
            const totalArtworks = displayData.reduce((total, student) => total + student.artworks.length, 0);
            const totalAttendance = displayData.reduce((total, student) => total + student.attendance.length, 0);
            const totalHadir = displayData.reduce((total, student) => total + student.attendance.filter(a => a.status === 'Hadir').length, 0);
            const avgAttendanceRate = totalAttendance > 0 ? ((totalHadir / totalAttendance) * 100).toFixed(1) : 0;

            const pdfFilename = `Kemajuan_Gambar_${currentUser.name.replace(/\s/g, '_')}.pdf`;
            
            let moduleContent;

            if (currentUser.role === 'Super Admin') {
                // --- SUPER ADMIN VIEW: SUMMARY ONLY ---
                moduleContent = `
                    <div class="bg-gradient-to-r from-red-600 to-red-800 rounded-lg p-6 mb-8 text-white shadow-lg">
                        <h3 class="text-xl font-bold">Ringkasan Kemajuan Gambar ${displayTitle}</h3>
                        <p class="text-sm text-red-100 mt-1">Status terbaru dari karya siswa di seluruh regional/regional terpilih</p>
                    </div>

                    ${renderRegionDropdown(selectedAdminRegion, 'filterArtProgressByRegion')}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
                        <div class="super-admin-card-3 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-blue-100">Total Siswa</p>
                            <p class="text-4xl font-bold">${totalStudents}</p>
                        </div>
                        <div class="bg-green-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-green-100">Total Karya Seni</p>
                            <p class="text-4xl font-bold">${totalArtworks}</p>
                        </div>
                        <div class="bg-yellow-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-yellow-100">Rata-rata Kehadiran</p>
                            <p class="text-4xl font-bold">${avgAttendanceRate}%</p>
                        </div>
                    </div>

                    ${selectedAdminRegion !== 'all' ? `
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Detail Per Kelas (${displayTitle})</h3>
                        <div class="space-y-6">
                             ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'artProgress')}
                        </div>
                    ` : `
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-xl font-bold text-gray-900 mb-3">Update Terbaru Karya Siswa</h4>
                            <p class="text-gray-600">Fitur ini menampilkan ringkasan data global. Untuk detail siswa, silakan filter berdasarkan regional di atas.</p>
                            </div>
                    `}
                `;
            } else if (currentUser.role === 'Admin') {
                // Get available classes for the current region
                const regionalClasses = availableClasses.filter(c => c.region === currentUser.region);

                // --- ADMIN REGIONAL VIEW: GROUPED BY CLASS ---
                moduleContent = `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Filter Kelas</h3>
                        
<!-- Filter Kelas (Dropdown versi clean) -->
<div class="mt-3 mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
  <select onchange="filterArtProgressByClass(this.value)" 
    class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="all">Semua Kelas</option>
    ${availableClasses
      .filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region)
      .map(c => `<option value="${c.name}">${c.name}</option>`)
      .join('')}
  </select>
</div>

                    </div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Data Siswa ${displayTitle} (${displayData.length} siswa)</h3>
                         ${selectedClass === 'all' ? `
                            <button onclick="addArtwork(null)" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Karya</button>
                         ` : ''}
                    </div>

                    <div id="artProgressContent">
                        ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'artProgress')}
                    </div>
                `;
            } else {
                 // --- SISWA VIEW: ORIGINAL VIEW ---
                 moduleContent = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üé® Kemajuan Gambar</h2>
                        <button onclick="generatePDF('artProgressContent', '${pdfFilename}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">
                            <span class="text-lg mr-2">‚¨áÔ∏è</span> Download PDF
                        </button>
                    </div>
                    <div id="artProgressContent">
                         ${renderArtProgressStudent(displayData, isAdminOrSuperAdmin)}
                    </div>
                `;
            }

            content.innerHTML = `<div class="fade-in">${moduleContent}</div>`;
        }

        // --- MODIFIED FUNCTION 2: Kemajuan Tes Skolastik (Super Admin shows Summary, Admin Regional shows Grouped by Class) ---
        function loadSkolastikProgress() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            let displayData = studentsData;
            let displayTitle = 'Global';
            
            if (currentUser.role === 'Siswa') {
                displayData = studentsData.filter(s => s.name === currentUser.name);
                displayTitle = currentUser.name;
            } else if (currentUser.role === 'Admin') {
                displayData = studentsData.filter(s => s.region === currentUser.region);
                displayTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin') {
                if (selectedAdminRegion !== 'all') {
                     displayData = studentsData.filter(s => s.region === selectedAdminRegion);
                     displayTitle = `Regional ${selectedAdminRegion}`;
                } else {
                     displayTitle = 'Global (Semua Regional)';
                }
            }

            // Apply class filter if any
            if (currentUser.role === 'Admin' && selectedClass !== 'all') {
                displayData = displayData.filter(s => s.class === selectedClass);
            }
            
            // Calculate Global/Regional Stats
            const totalStudents = displayData.length;
            const allSkolastikScores = displayData.flatMap(s => s.skolastikTests.map(t => t.score));
            const totalTests = allSkolastikScores.length;
            const avgScore = totalTests > 0 ? (allSkolastikScores.reduce((sum, score) => sum + score, 0) / totalTests).toFixed(1) : 0;
            const latestTestDate = displayData.flatMap(s => s.skolastikTests.map(t => t.date)).sort().pop() || 'N/A';

            const pdfFilename = `Kemajuan_Skolastik_${currentUser.name.replace(/\s/g, '_')}.pdf`;

            let moduleContent;

            if (currentUser.role === 'Super Admin') {
                // --- SUPER ADMIN VIEW: SUMMARY ONLY ---
                moduleContent = `
                    <div class="bg-gradient-to-r from-red-600 to-red-800 rounded-lg p-6 mb-8 text-white shadow-lg">
                        <h3 class="text-xl font-bold">Ringkasan Kemajuan Tes Skolastik ${displayTitle}</h3>
                        <p class="text-sm text-red-100 mt-1">Status terbaru dari tes skolastik siswa di seluruh regional/regional terpilih</p>
                    </div>

                    ${renderRegionDropdown(selectedAdminRegion, 'filterSkolastikByRegion')}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
                        <div class="super-admin-card-3 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-blue-100">Total Siswa</p>
                            <p class="text-4xl font-bold">${totalStudents}</p>
                        </div>
                        <div class="bg-purple-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-purple-100">Total Tes Dilakukan</p>
                            <p class="text-4xl font-bold">${totalTests}</p>
                        </div>
                        <div class="bg-blue-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-blue-100">Rata-rata Nilai Skolastik</p>
                            <p class="text-4xl font-bold">${avgScore}</p>
                        </div>
                    </div>

                    ${selectedAdminRegion !== 'all' ? `
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Detail Per Kelas (${displayTitle})</h3>
                        <div class="space-y-6">
                             ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'skolastikProgress')}
                        </div>
                    ` : `
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-xl font-bold text-gray-900 mb-3">Update Terbaru Tes Skolastik</h4>
                            <p class="text-gray-600">Fitur ini menampilkan ringkasan data global. Untuk detail siswa, silakan filter berdasarkan regional di atas.</p>
                            <p class="text-sm text-gray-500 mt-2">Tes Terbaru: ${latestTestDate}</p>
                        </div>
                    `}
                `;
            } else if (currentUser.role === 'Admin') {
                // Get available classes for the current region
                const regionalClasses = availableClasses.filter(c => c.region === currentUser.region);

                 // --- ADMIN REGIONAL VIEW: GROUPED BY CLASS ---
                 moduleContent = `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Filter Kelas</h3>
                        
<!-- Filter Kelas (Dropdown versi clean) -->
<div class="mt-3 mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
  <select onchange="filterSkolastikByClass(this.value)" 
    class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="all">Semua Kelas</option>
    ${availableClasses
      .filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region)
      .map(c => `<option value="${c.name}">${c.name}</option>`)
      .join('')}
  </select>
</div>

                    </div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Data Siswa ${displayTitle} (${displayData.length} siswa)</h3>
                    </div>

                    <div id="skolastikContent">
                        ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'skolastikProgress')}
                    </div>
                `;
            } else {
                 // --- SISWA VIEW: ORIGINAL VIEW ---
                 moduleContent = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üìä Kemajuan Tes Skolastik</h2>
                        <button onclick="generatePDF('skolastikContent', '${pdfFilename}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">
                            <span class="text-lg mr-2">‚¨áÔ∏è</span> Download PDF
                        </button>
                    </div>
                    <div id="skolastikContent">
                        ${renderSkolastikProgressStudent(displayData, isAdminOrSuperAdmin)}
                    </div>
                `;
            }
            
            content.innerHTML = `<div class="fade-in">${moduleContent}</div>`;
        }

        // --- MODIFIED FUNCTION 3: Kemajuan Tes TKA (Super Admin shows Summary, Admin Regional shows Grouped by Class) ---
        function loadTkaProgress() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            let displayData = studentsData;
            let displayTitle = 'Global';
            
            if (currentUser.role === 'Siswa') {
                displayData = studentsData.filter(s => s.name === currentUser.name);
                displayTitle = currentUser.name;
            } else if (currentUser.role === 'Admin') {
                displayData = studentsData.filter(s => s.region === currentUser.region);
                displayTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin') {
                if (selectedAdminRegion !== 'all') {
                     displayData = studentsData.filter(s => s.region === selectedAdminRegion);
                     displayTitle = `Regional ${selectedAdminRegion}`;
                } else {
                     displayTitle = 'Global (Semua Regional)';
                }
            }

            // Apply class filter if any
            if (currentUser.role === 'Admin' && selectedClass !== 'all') {
                displayData = displayData.filter(s => s.class === selectedClass);
            }
            
            // Calculate Global/Regional Stats
            const totalStudents = displayData.length;
            const allTkaScores = displayData.flatMap(s => s.tkaTests.map(t => t.score));
            const totalTests = allTkaScores.length;
            const avgScore = totalTests > 0 ? (allTkaScores.reduce((sum, score) => sum + score, 0) / totalTests).toFixed(1) : 0;
            const latestTestDate = displayData.flatMap(s => s.tkaTests.map(t => t.date)).sort().pop() || 'N/A';

            const pdfFilename = `Kemajuan_TKA_${currentUser.name.replace(/\s/g, '_')}.pdf`;

            let moduleContent;

            if (currentUser.role === 'Super Admin') {
                // --- SUPER ADMIN VIEW: SUMMARY ONLY ---
                moduleContent = `
                    <div class="bg-gradient-to-r from-red-600 to-red-800 rounded-lg p-6 mb-8 text-white shadow-lg">
                        <h3 class="text-xl font-bold">Ringkasan Kemajuan Tes TKA ${displayTitle}</h3>
                        <p class="text-sm text-red-100 mt-1">Status terbaru dari tes TKA siswa di seluruh regional/regional terpilih</p>
                    </div>

                    ${renderRegionDropdown(selectedAdminRegion, 'filterTkaByRegion')}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
                        <div class="super-admin-card-3 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-blue-100">Total Siswa</p>
                            <p class="text-4xl font-bold">${totalStudents}</p>
                        </div>
                        <div class="bg-purple-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-purple-100">Total Tes Dilakukan</p>
                            <p class="text-4xl font-bold">${totalTests}</p>
                        </div>
                        <div class="bg-blue-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-blue-100">Rata-rata Nilai TKA</p>
                            <p class="text-4xl font-bold">${avgScore}</p>
                        </div>
                    </div>

                    ${selectedAdminRegion !== 'all' ? `
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Detail Per Kelas (${displayTitle})</h3>
                        <div class="space-y-6">
                             ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'tkaProgress')}
                        </div>
                    ` : `
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-xl font-bold text-gray-900 mb-3">Update Terbaru Tes TKA</h4>
                            <p class="text-gray-600">Fitur ini menampilkan ringkasan data global. Untuk detail siswa, silakan filter berdasarkan regional di atas.</p>
                            <p class="text-sm text-gray-500 mt-2">Tes Terbaru: ${latestTestDate}</p>
                        </div>
                    `}
                `;
            } else if (currentUser.role === 'Admin') {
                // Get available classes for the current region
                const regionalClasses = availableClasses.filter(c => c.region === currentUser.region);

                // --- ADMIN REGIONAL VIEW: GROUPED BY CLASS ---
                 moduleContent = `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Filter Kelas</h3>
                        
<!-- Filter Kelas (Dropdown versi clean) -->
<div class="mt-3 mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
  <select onchange="filterTkaByClass(this.value)" 
    class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="all">Semua Kelas</option>
    ${availableClasses
      .filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region)
      .map(c => `<option value="${c.name}">${c.name}</option>`)
      .join('')}
  </select>
</div>

                    </div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Data Siswa ${displayTitle} (${displayData.length} siswa)</h3>
                    </div>

                    <div id="tkaContent">
                        ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'tkaProgress')}
                    </div>
                `;
            } else {
                 // --- SISWA VIEW: ORIGINAL VIEW ---
                 moduleContent = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üìà Kemajuan TKA</h2>
                        <button onclick="generatePDF('tkaContent', '${pdfFilename}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">
                            <span class="text-lg mr-2">‚¨áÔ∏è</span> Download PDF
                        </button>
                    </div>
                    <div id="tkaContent">
                        ${renderTkaProgressStudent(displayData, isAdminOrSuperAdmin)}
                    </div>
                `;
            }

            content.innerHTML = `<div class="fade-in">${moduleContent}</div>`;
        }

        function loadEducationInfo() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            let infoTitle = currentUser.role === 'Super Admin' ? 'Global' : currentUser.role === 'Admin' ? `Regional ${currentUser.region}` : 'Anda';

            content.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üì∞ Informasi Pendidikan (${infoTitle})</h2>
                        ${isAdminOrSuperAdmin ? '<button onclick="addEducationInfo()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Informasi</button>' : ''}
                    </div>

                    <div class="space-y-6">
                        ${educationInfo.map(info => `
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${info.title}</h3>
                                        <p class="text-gray-700 mb-3 leading-relaxed">${info.content}</p>
                                        <p class="text-sm text-gray-500">üìÖ ${info.date}</p>
                                    </div>
                                    ${isAdminOrSuperAdmin ? `
                                        <div class="flex space-x-2 ml-4">
                                            <button onclick="editEducationInfo(${info.id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Edit</button>
                                            <button onclick="deleteEducationInfo(${info.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Hapus</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- MODIFIED FUNCTION 4: Materi Kelas (Ditambahkan Filter Berbasis Kelas dan Regional) ---
        function loadMaterials() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            // Filter kelas yang tersedia di regional Admin saat ini
            const regionalAvailableClasses = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? (selectedAdminRegion === 'all' || c.region === selectedAdminRegion) : c.region === currentUser.region
            );

            // START: MODIFIKASI REGIONALISASI DATA
            let regionalMaterials = classMaterials;
            let regionFilterTitle = '';

            if (currentUser.role === 'Admin') {
                regionalMaterials = classMaterials.filter(m => m.region === currentUser.region);
                regionFilterTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin' && selectedAdminRegion !== 'all') {
                regionalMaterials = classMaterials.filter(m => m.region === selectedAdminRegion);
                regionFilterTitle = `Regional ${selectedAdminRegion}`;
            } else if (currentUser.role === 'Super Admin') {
                regionalMaterials = classMaterials; // Global view for Super Admin default
                regionFilterTitle = 'Semua Regional';
            }
            // END: MODIFIKASI REGIONALISASI DATA
            
            let filteredMaterials = regionalMaterials; // Gunakan data yang sudah difilter regional
            const studentClass = studentsData.find(s => s.name === currentUser.name)?.class;
            
            // Jika siswa, activeClassFilter adalah kelasnya. Jika admin, menggunakan filter yang dipilih (default 'all').
            const activeClassFilter = isAdminOrSuperAdmin ? selectedClassMaterial : (studentClass || 'all');
            
            if (activeClassFilter !== 'all') {
                // Filter material yang memiliki nama kelas di dalam array 'classes' mereka
                filteredMaterials = regionalMaterials.filter(material => 
                    material.classes && material.classes.includes(activeClassFilter)
                );
            }
            
            content.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üìö Materi Kelas ${currentUser.role !== 'Siswa' ? `(${regionFilterTitle})` : ''}</h2>
                        ${currentUser.role === 'Siswa' ? `
                            <button onclick="generatePDF('materialsContent', 'Materi_Kelas_Villa_Merah.pdf')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">
                                <span class="text-lg mr-2">‚¨áÔ∏è</span> Download PDF
                            </button>
                        ` : ''}
                        ${isAdminOrSuperAdmin ? '<button onclick="addMaterial()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Materi</button>' : ''}
                    </div>

                    <div id="materialsContent">

                    ${currentUser.role === 'Super Admin' ? renderRegionDropdown(selectedAdminRegion, 'filterMaterialByRegion') : ''}

                    ${isAdminOrSuperAdmin ? `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Filter Kelas</h3>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="filterMaterialByClass('all')" class="px-4 py-2 rounded-lg transition-colors ${activeClassFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    Semua Materi
                                </button>
                                ${regionalAvailableClasses.map(classItem => `
                                    <button onclick="filterMaterialByClass('${classItem.name}')" class="px-4 py-2 rounded-lg transition-colors ${activeClassFilter === classItem.name ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                        Kelas ${classItem.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="bg-blue-600 text-white px-6 py-3">
                            <h3 class="text-lg font-semibold bg-blue-600">Daftar Materi Pembelajaran ${!isAdminOrSuperAdmin && studentClass ? `(Kelas ${studentClass})` : ''}</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-blue-800 text-white">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-white-700">Topik</th>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-white-700">Penjelasan Materi</th>
                                        ${currentUser.role === 'Super Admin' ? '<th class="px-6 py-3 text-left text-sm font-semibold text-white-700">Regional</th>' : ''}
                                        ${isAdminOrSuperAdmin ? '<th class="px-6 py-3 text-left text-sm font-semibold text-white-700">Kelas Target</th>' : ''}
                                        ${isAdminOrSuperAdmin ? '<th class="px-6 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${filteredMaterials.length > 0 ? filteredMaterials.map(material => `
                                        <tr class="border-t border-gray-200 hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${material.topic}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${material.description}</td>
                                            ${currentUser.role === 'Super Admin' ? `<td class="px-6 py-4 text-sm text-red-600 font-medium">${material.region}</td>` : ''}
                                            ${isAdminOrSuperAdmin ? `<td class="px-6 py-4 text-sm text-blue-600 font-medium">${material.classes.join(', ')}</td>` : ''}
                                            ${isAdminOrSuperAdmin ? `
                                                <td class="px-6 py-4 text-sm">
                                                    <button onclick="editMaterial(${material.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                                    <button onclick="deleteMaterial(${material.id})" class="text-red-600 hover:text-red-800">Hapus</button>
                                                </td>
                                            ` : ''}
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="${isAdminOrSuperAdmin ? 4 : 2}" class="px-6 py-4 text-center text-gray-500">
                                                Tidak ada materi yang tersedia untuk regional atau filter kelas ini.
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    </div> </div>
            `;
        }

        // --- MODIFIED FUNCTION 5: Jadwal Belajar (Ditambahkan Filter Berbasis Kelas dan Regional) ---
        function loadSchedule() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            // Filter kelas yang tersedia di regional Admin saat ini
            const regionalAvailableClasses = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? (selectedAdminRegion === 'all' || c.region === selectedAdminRegion) : c.region === currentUser.region
            );

            // START: MODIFIKASI REGIONALISASI DATA
            let regionalSchedule = scheduleData;
            let regionFilterTitle = '';

            if (currentUser.role === 'Admin') {
                regionalSchedule = scheduleData.filter(s => s.region === currentUser.region);
                regionFilterTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin' && selectedAdminRegion !== 'all') {
                regionalSchedule = scheduleData.filter(s => s.region === selectedAdminRegion);
                regionFilterTitle = `Regional ${selectedAdminRegion}`;
            } else if (currentUser.role === 'Super Admin') {
                regionalSchedule = scheduleData; // Global view for Super Admin default
                regionFilterTitle = 'Semua Regional';
            }
            // END: MODIFIKASI REGIONALISASI DATA

            let filteredSchedule = regionalSchedule; // Gunakan data yang sudah difilter regional
            const studentClass = studentsData.find(s => s.name === currentUser.name)?.class;
            // Jika siswa, activeClassFilter adalah kelasnya. Jika admin, menggunakan filter yang dipilih (default 'all').
            const activeClassFilter = isAdminOrSuperAdmin ? selectedClassSchedule : (studentClass || 'all');

            if (activeClassFilter !== 'all') {
                // Filter jadwal yang memiliki nama kelas di dalam array 'classes' mereka
                filteredSchedule = regionalSchedule.filter(schedule => 
                    schedule.classes && schedule.classes.includes(activeClassFilter)
                );
            }

            // Sortir berdasarkan tanggal
            filteredSchedule.sort((a, b) => a.date.localeCompare(b.date));

            content.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üìÖ Jadwal Belajar ${currentUser.role !== 'Siswa' ? `(${regionFilterTitle})` : ''}</h2>
                        ${isAdminOrSuperAdmin ? '<button onclick="addSchedule()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Jadwal</button>' : ''}
                    </div>

                    <div id="scheduleContent">

                    ${currentUser.role === 'Super Admin' ? renderRegionDropdown(selectedAdminRegion, 'filterScheduleByRegion') : ''}

                    ${isAdminOrSuperAdmin ? `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Filter Kelas</h3>
                            
<!-- Filter Kelas (Dropdown versi clean) -->
<div class="mt-3 mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
  <select onchange="filterMaterialByClass(this.value)" 
    class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="all">Semua Kelas</option>
    ${availableClasses
      .filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region)
      .map(c => `<option value="${c.name}">${c.name}</option>`)
      .join('')}
  </select>
</div>

                        </div>
                    ` : ''}

                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="bg-gray-700 text-white px-6 py-3">
                            <h3 class="text-lg font-semibold">Daftar Jadwal Kelas ${!isAdminOrSuperAdmin && studentClass ? `(Kelas ${studentClass})` : ''}</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-blue-800 text-white">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Tanggal</th>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Hari</th>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Nama Materi</th>
                                        ${currentUser.role === 'Super Admin' ? '<th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Regional</th>' : ''}
                                        ${isAdminOrSuperAdmin ? '<th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Kelas Target</th>' : ''}
                                        ${isAdminOrSuperAdmin ? '<th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Aksi</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${filteredSchedule.length > 0 ? filteredSchedule.map(schedule => `
                                        <tr class="border-t border-gray-200 hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm text-gray-900">${schedule.date}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${schedule.day}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${schedule.subject}</td>
                                            ${currentUser.role === 'Super Admin' ? `<td class="px-6 py-4 text-sm text-red-600 font-medium">${schedule.region}</td>` : ''}
                                            ${isAdminOrSuperAdmin ? `<td class="px-6 py-4 text-sm text-blue-600 font-medium">${schedule.classes.join(', ')}</td>` : ''}
                                            ${isAdminOrSuperAdmin ? `
                                                <td class="px-6 py-4 text-sm">
                                                    <button onclick="editSchedule(${schedule.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                                    <button onclick="deleteSchedule(${schedule.id})" class="text-red-600 hover:text-red-800">Hapus</button>
                                                </td>
                                            ` : ''}
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="${isAdminOrSuperAdmin ? 5 : 3}" class="px-6 py-4 text-center text-gray-500">
                                                Tidak ada jadwal kelas yang tersedia untuk regional atau filter kelas ini. Silakan tambah jadwal baru.
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    </div>
                </div>
            `;
        }

        // MODIFIED FUNCTION: loadAddStudent - Menambahkan Kelola Sekolah. Sekarang bisa diakses Admin dan Super Admin.
        
function loadAddStudent() {
  const content = document.getElementById('contentArea');
  if (currentUser.role !== 'Admin' && currentUser.role !== 'Super Admin') {
    content.innerHTML = `<div class="fade-in text-center text-red-600 text-xl font-bold p-10">Akses ditolak. Hanya Admin dan Super Admin yang dapat mengakses modul ini.</div>`;
    return;
  }

  // Determine class options based on role/region
  const classOptions = (currentUser.role === 'Super Admin')
    ? availableClasses
    : availableClasses.filter(c => c.region === currentUser.region);

  // Tentukan daftar siswa yang akan ditampilkan berdasarkan regional
  let studentList = (currentUser.role === 'Super Admin') ? studentsData : studentsData.filter(s => s.region === currentUser.region);

  content.innerHTML = `
    <div class="fade-in">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">üë§ Tambah Siswa</h2>
        <button onclick="openAddStudentModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Siswa</button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6">
        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">Form Tambah Siswa</h3>
          <form id="addStudentForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
              <input id="studentName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
              <input id="studentUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
              <input id="studentPassword" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="siswa123">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Sekolah</label>
              <input id="studentSchool" type="text" placeholder="Masukkan nama sekolah (opsional)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
              ${currentUser.role === 'Super Admin' ? `
                <select id="studentRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">-- Pilih Regional --</option>
                  ${[...new Set(regionalAdmins.map(a=>a.region))].map(r=>`<option value="${r}">${r}</option>`).join('')}
                </select>
              ` : `<input type="text" id="studentRegion" readonly value="${currentUser.region}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">`}
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
              <select id="studentClass" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- Pilih Kelas --</option>
                ${classOptions.map(c=>`<option value="${c.name}">${c.name} (${c.region})</option>`).join('')}
              </select>
            </div>
            <div>
              <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Simpan Siswa</button>
            </div>
          </form>
        </div>

        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">Siswa Terdaftar</h3>

          <!-- Filter Kelas (vertikal, di atas tabel) -->
          <div class="mb-4">
            <label for="filterStudentClass" class="block text-sm font-medium text-gray-700 mb-1">üè´ Filter Kelas</label>
            <select id="filterStudentClass" onchange="filterStudentByClass()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="all">Semua Kelas</option>
              ${classOptions.map(c=>`<option value="${c.name}">${c.name} (${c.region})</option>`).join('')}
            </select>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-blue-800 text-white">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nama</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Username</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Kelas</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Regional</th>
                  <th class="px-4 py-3 text-center text-sm font-semibold text-white-700">Aksi</th>
                </tr>
              </thead>
              <tbody id="studentTableBody" class="bg-white divide-y divide-gray-100">
                ${studentList.map(s=>`
                  <tr data-class="${s.class}" data-region="${s.region}" class="hover:bg-blue-50 transition-colors">
                    <td class="px-4 py-3 text-sm text-gray-900">${s.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${s.username || ''}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${s.class}</td>
                    <td class="px-4 py-3 text-sm text-blue-600">${s.region}</td>
                    <td class="px-4 py-3 text-center text-sm">
                      ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `<button onclick="editStudent('${s.username}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button><button onclick="deleteStudent('${s.username}')" class="text-red-600 hover:text-red-800">Hapus</button>` : '-'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;

  // Hook form submit
  const form = document.getElementById('addStudentForm');
  if (form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const name = document.getElementById('studentName').value.trim();
      const username = document.getElementById('studentUsername').value.trim();
      const password = document.getElementById('studentPassword').value || 'siswa123';
      const school = document.getElementById('studentSchool').value || '';
      const region = document.getElementById('studentRegion').value || currentUser.region;
      const kelas = document.getElementById('studentClass').value;

      if (!name || !username || !kelas) {
        showNotification('Nama, username, dan kelas wajib diisi!', 'error');
        return;
      }
      // prevent duplicate username
      if (studentsData.some(s => s.username === username)) {
        showNotification('Username sudah terdaftar!', 'error');
        return;
      }

      const newId = studentsData.reduce((m,c)=> c.id>m?c.id:m, 0) + 1;
      const newStudent = { id: newId, name, username, password, class: kelas, region, school, artworks: [], attendance: [], skolastikTests: [], tkaTests: []};
      studentsData.push(newStudent);
      saveAllData();
      showNotification('Siswa berhasil ditambahkan!');
      loadAddStudent();
    });
  }
}

// Filter function for students
function filterStudentByClass() {
  const sel = document.getElementById('filterStudentClass');
  if (!sel) return;
  const selected = sel.value;
  const rows = document.querySelectorAll('#studentTableBody tr');
  rows.forEach(r => {
    const studentClass = r.getAttribute('data-class');
    r.style.display = (selected === 'all' || studentClass === selected) ? '' : 'none';
  });
}

// small helper to open the add student modal (re-use existing modal if desired)
function openAddStudentModal() {
  openModal('Tambah Siswa (Cepat)', `
    <form id="addStudentQuickForm" class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama</label><input id="qsName" class="w-full px-3 py-2 border rounded" required></div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Username</label><input id="qsUsername" class="w-full px-3 py-2 border rounded" required></div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label><select id="qsClass" class="w-full px-3 py-2 border rounded">${classOptions.map(c=>`<option value="${c.name}">${c.name}</option>`).join('')}</select></div>
      <div><button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg">Tambah</button></div>
    </form>
  `);
  document.getElementById('addStudentQuickForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const name = document.getElementById('qsName').value.trim();
    const username = document.getElementById('qsUsername').value.trim();
    const kelas = document.getElementById('qsClass').value;
    if (!name || !username || !kelas) { showNotification('Isi semua field!', 'error'); return; }
    if (studentsData.some(s=>s.username===username)){ showNotification('Username sudah ada','error'); return; }
    const newId = studentsData.reduce((m,c)=> c.id>m?c.id:m, 0) + 1;
    studentsData.push({id:newId, name, username, password:'siswa123', class:kelas, region: currentUser.role==='Super Admin'? (classOptions.find(cc=>cc.name===kelas)||{}).region : currentUser.region, artworks:[], attendance:[], skolastikTests:[], tkaTests:[]});
    saveAllData();
    closeModal();
    loadAddStudent();
    showNotification('Siswa berhasil ditambahkan!');
  });
}

        /**
         * FUNGSI MODIFIKASI: editStudent
         * Menggunakan username sebagai kunci pencarian.
         * Memastikan password dapat diubah.
         */
        function editStudent(username) {
            const allUsers = await loadAllData();
            const user = allUsers[username];
            if (!user || user.role !== 'Siswa') {
                showNotification('Pengguna siswa tidak ditemukan!', 'error');
                return;
            }
            // Cari data siswa berdasarkan username
            const studentData = studentsData.find(s => s.username === username);
            
            // Filter available classes for the Edit Student form
            const regionalClassesForForm = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? true : c.region === studentData.region
            );

            openModal('Edit Siswa', `
                <form id="editStudentForm" class="space-y-4">
                    <div>
                        <label for="editStudentUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="editStudentUsername" value="${username}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500">
                        <p class="text-xs text-gray-500 mt-1">Username tidak dapat diubah</p>
                    </div>
                    <div>
                        <label for="editStudentName" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                        <input type="text" id="editStudentName" value="${studentData ? studentData.name : ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editStudentClass" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="editStudentClass" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${regionalClassesForForm.map(classItem => `
                                <option value="${classItem.name}" ${studentData && studentData.class === classItem.name ? 'selected' : ''}>Kelas ${classItem.name} ${currentUser.role === 'Super Admin' ? `(${classItem.region})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="editStudentSchool" class="block text-sm font-medium text-gray-700 mb-1">Sekolah</label>
                        <input type="text" id="editStudentSchool" required value="${studentData ? studentData.school : ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan nama sekolah">
                    </div>
                    ${currentUser.role === 'Super Admin' ? `
                        <div>
                            <label for="editStudentRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional Siswa</label>
                            <select id="editStudentRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                ${regionalAdmins.map(admin => `
                                    <option value="${admin.region}" ${studentData && studentData.region === admin.region ? 'selected' : ''}>${admin.region}</option>
                                `).join('')}
                            </select>
                        </div>
                    `: ''}
                    <div>
                        <label for="editStudentPassword" class="block text-sm font-medium text-gray-700 mb-1">Password Baru (Opsional)</label>
                        <input type="password" id="editStudentPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Kosongkan jika tidak ingin mengubah password</p>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editStudentForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const newName = document.getElementById('editStudentName').value;
                const newClass = document.getElementById('editStudentClass').value;
                const newSchool = document.getElementById('editStudentSchool').value; 
                const newPassword = document.getElementById('editStudentPassword').value;
                const newRegion = currentUser.role === 'Super Admin' ? document.getElementById('editStudentRegion').value : studentData.region;
                
                // Update student data
                if (studentData) {
                     // Periksa kesesuaian kelas dan regional jika Super Admin
                    if (currentUser.role === 'Super Admin') {
                        const selectedClassRegion = availableClasses.find(c => c.name === newClass)?.region;
                        if (selectedClassRegion !== newRegion) {
                            showNotification(`Kelas ${newClass} hanya tersedia di regional ${selectedClassRegion}. Silakan pilih kelas atau regional yang sesuai.`, 'error');
                            return;
                        }
                    }
                    
                    // Update semua properti siswa
                    studentData.name = newName;
                    studentData.class = newClass;
                    studentData.school = newSchool;
                    studentData.region = newRegion; // Update region
                    if (newPassword) {
                        studentData.password = newPassword; // <<< UPDATE PASSWORD
                    }
                }

                closeModal();
                loadAddStudent();
                showNotification('Data siswa berhasil diupdate!');
            });
        }

        /**
         * FUNGSI MODIFIKASI: deleteStudent
         * Menggunakan username sebagai kunci penghapusan.
         */
        function deleteStudent(username) {
            const allUsers = await loadAllData();
            const user = allUsers[username];
             if (!user || user.role !== 'Siswa') {
                showNotification('Pengguna siswa tidak ditemukan!', 'error');
                return;
            }
            openModal('Konfirmasi Hapus Siswa', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Hapus Siswa</h3>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus siswa <strong>${user.name}</strong> (${username})?</p>
                    <p class="text-sm text-red-600 mb-6">Semua data kemajuan siswa akan ikut terhapus!</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteStudent('${username}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        /**
         * FUNGSI MODIFIKASI: confirmDeleteStudent
         * Menghapus siswa dari studentsData berdasarkan username.
         */
        function confirmDeleteStudent(username) {
            // Hapus data siswa berdasarkan username
            studentsData = studentsData.filter(s => s.username !== username);
            
            // Karena getAllUsers sekarang membaca dari studentsData,
            // siswa akan otomatis hilang dari daftar pengguna login dan daftar siswa di loadAddStudent
            
            closeModal();
            loadAddStudent();
            showNotification('Siswa berhasil dihapus!');
        }

        // Modal Functions
        function openModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Artwork Functions
        function addArtwork(studentId) {
            // Find students filterable by current user's role/region
            const filterableStudents = currentUser.role === 'Super Admin' ? studentsData.filter(s => selectedAdminRegion === 'all' || s.region === selectedAdminRegion) : (currentUser.role === 'Admin' ? studentsData.filter(s => s.region === currentUser.region) : []);
            
            if (filterableStudents.length === 0) {
                showNotification('Tidak ada siswa di regional ini untuk ditambahkan karya.', 'error');
                return;
            }

            // Jika studentId diberikan, jadikan siswa tersebut yang terpilih secara default
            let defaultSelectedId = studentId;
            if (defaultSelectedId === null) {
                // Ambil id siswa pertama di daftar filterable jika tidak ada yang dipilih
                defaultSelectedId = filterableStudents[0]?.id;
            }

            openModal('Tambah Karya Siswa', `
                <form id="artworkForm" class="space-y-4">
                    <div>
                        <label for="artworkStudentId" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                        <select id="artworkStudentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${filterableStudents.map(student => `
                                <option value="${student.id}" ${student.id === defaultSelectedId ? 'selected' : ''}>${student.name} (${student.class}) ${currentUser.role === 'Super Admin' ? `(${student.region})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="artworkTitle" class="block text-sm font-medium text-gray-700 mb-1">Nama Karya</label>
                        <input type="text" id="artworkTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="artworkDescription" class="block text-sm font-medium text-gray-700 mb-1">Keterangan Karya</label>
                        <textarea id="artworkDescription" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="artworkDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Karya</label>
                        <input type="date" id="artworkDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="artworkImage" class="block text-sm font-medium text-gray-700 mb-1">Tambah Gambar</label>
                        <input type="file" id="artworkImage" accept="image/*" capture required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Format: JPG, PNG (tanpa batas resolusi)</p>
                    </div>
                    <div>
                        <label for="artworkComment" class="block text-sm font-medium text-gray-700 mb-1">Komentar Pengajar</label>
                        <textarea id="artworkComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('artworkForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const selectedStudentId = parseInt(document.getElementById('artworkStudentId').value);
                const student = studentsData.find(s => s.id === selectedStudentId);
                const fileInput = document.getElementById('artworkImage');
                const file = fileInput.files[0];

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const newArtwork = {
                            id: student.artworks.length + 1,
                            title: document.getElementById('artworkTitle').value,
                            description: document.getElementById('artworkDescription').value,
                            date: document.getElementById('artworkDate').value,
                            image: event.target.result,
                            comment: document.getElementById('artworkComment').value
                        };
                        student.artworks.push(newArtwork);
                        closeModal();
                        loadArtProgress();
                        showNotification('Karya siswa berhasil ditambahkan!');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function editArtwork(studentId, artworkId) {
            const student = studentsData.find(s => s.id === studentId);
            const artwork = student.artworks.find(a => a.id === artworkId);
            
            openModal('Edit Karya Siswa', `
                <form id="editArtworkForm" class="space-y-4">
                    <div>
                        <label for="editArtworkTitle" class="block text-sm font-medium text-gray-700 mb-1">Nama Karya</label>
                        <input type="text" id="editArtworkTitle" value="${artwork.title}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editArtworkDescription" class="block text-sm font-medium text-gray-700 mb-1">Keterangan Karya</label>
                        <textarea id="editArtworkDescription" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${artwork.description}</textarea>
                    </div>
                    <div>
                        <label for="editArtworkDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Karya</label>
                        <input type="date" id="editArtworkDate" value="${artwork.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editArtworkComment" class="block text-sm font-medium text-gray-700 mb-1">Komentar Pengajar</label>
                        <textarea id="editArtworkComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${artwork.comment}</textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editArtworkForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                artwork.title = document.getElementById('editArtworkTitle').value;
                artwork.description = document.getElementById('editArtworkDescription').value;
                artwork.date = document.getElementById('editArtworkDate').value;
                artwork.comment = document.getElementById('editArtworkComment').value;
                closeModal();
                loadArtProgress();
                showNotification('Karya siswa berhasil diupdate!');
            });
        }

        function editArtworkImage(studentId, artworkId) {
            const student = studentsData.find(s => s.id === studentId);
            const artwork = student.artworks.find(a => a.id === artworkId);
            
            openModal('Edit Gambar Karya', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gambar Saat Ini</label>
                        <img src="${artwork.image}" alt="${artwork.title}" class="w-full h-64 object-cover rounded-lg border border-gray-300">
                    </div>
                    <form id="editImageForm">
                        <div>
                            <label for="newArtworkImage" class="block text-sm font-medium text-gray-700 mb-1">Upload Gambar Baru</label>
                            <input type="file" id="newArtworkImage" accept="image/*" capture required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Format: JPG, PNG (tanpa batas resolusi)</p>
                        </div>
                        <button type="submit" class="w-full mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update Gambar</button>
                    </form>
                </div>
            `);

            document.getElementById('editImageForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const fileInput = document.getElementById('newArtworkImage');
                const file = fileInput.files[0];

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        artwork.image = event.target.result;
                        closeModal();
                        loadArtProgress();
                        showNotification('Gambar karya berhasil diupdate!');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function deleteArtwork(studentId, artworkId) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus karya ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteArtwork(${studentId}, ${artworkId})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteArtwork(studentId, artworkId) {
            const student = studentsData.find(s => s.id === studentId);
            student.artworks = student.artworks.filter(a => a.id !== artworkId);
            closeModal();
            loadArtProgress();
            showNotification('Karya siswa berhasil dihapus!');
        }

        // Attendance Functions
        function addAttendance(studentId) {
            const filterableStudents = currentUser.role === 'Super Admin' ? studentsData.filter(s => selectedAdminRegion === 'all' || s.region === selectedAdminRegion) : (currentUser.role === 'Admin' ? studentsData.filter(s => s.region === currentUser.region) : []);
            
            if (filterableStudents.length === 0) {
                showNotification('Tidak ada siswa di regional ini untuk ditambahkan kehadiran.', 'error');
                return;
            }

            // Jika studentId diberikan, jadikan siswa tersebut yang terpilih secara default
            let defaultSelectedId = studentId;
            if (defaultSelectedId === null) {
                // Ambil id siswa pertama di daftar filterable jika tidak ada yang dipilih
                defaultSelectedId = filterableStudents[0]?.id;
            }

            openModal('Tambah Kehadiran', `
                <form id="attendanceForm" class="space-y-4">
                    <div>
                        <label for="attendanceStudentId" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                        <select id="attendanceStudentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${filterableStudents.map(student => `
                                <option value="${student.id}" ${student.id === defaultSelectedId ? 'selected' : ''}>${student.name} (${student.class}) ${currentUser.role === 'Super Admin' ? `(${student.region})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="attendanceDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="attendanceDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="attendanceStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="attendanceStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Hadir">Hadir</option>
                            <option value="Izin">Izin</option>
                            <option value="Sakit">Sakit</option>
                            <option value="Alpa">Alpa</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const selectedStudentId = parseInt(document.getElementById('attendanceStudentId').value);
                const student = studentsData.find(s => s.id === selectedStudentId);
                const newAttendance = {
                    date: document.getElementById('attendanceDate').value,
                    status: document.getElementById('attendanceStatus').value
                };
                student.attendance.push(newAttendance);
                closeModal();
                loadArtProgress();
                showNotification('Data kehadiran berhasil ditambahkan!');
            });
        }

        function editAttendance(studentId, attendanceIndex) {
            const student = studentsData.find(s => s.id === studentId);
            const attendance = student.attendance[attendanceIndex];
            
            openModal('Edit Kehadiran', `
                <form id="editAttendanceForm" class="space-y-4">
                    <div>
                        <label for="editAttendanceDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="editAttendanceDate" value="${attendance.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editAttendanceStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="editAttendanceStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Hadir" ${attendance.status === 'Hadir' ? 'selected' : ''}>Hadir</option>
                            <option value="Izin" ${attendance.status === 'Izin' ? 'selected' : ''}>Izin</option>
                            <option value="Sakit" ${attendance.status === 'Sakit' ? 'selected' : ''}>Sakit</option>
                            <option value="Alpa" ${attendance.status === 'Alpa' ? 'selected' : ''}>Alpa</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editAttendanceForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                attendance.date = document.getElementById('editAttendanceDate').value;
                attendance.status = document.getElementById('editAttendanceStatus').value;
                closeModal();
                loadArtProgress();
                showNotification('Data kehadiran berhasil diupdate!');
            });
        }
        
        // --- NEW: Delete Attendance Functions ---

        function deleteAttendance(studentId, attendanceIndex) {
            const student = studentsData.find(s => s.id === studentId);
            const attendanceDate = student.attendance[attendanceIndex].date;

            openModal('Konfirmasi Hapus Kehadiran', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl text-red-500">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus data kehadiran siswa <strong>${student.name}</strong> pada tanggal <strong>${attendanceDate}</strong>?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteAttendance(${studentId}, ${attendanceIndex})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteAttendance(studentId, attendanceIndex) {
            const student = studentsData.find(s => s.id === studentId);
            
            // Remove the attendance record at the specified index
            student.attendance.splice(attendanceIndex, 1);
            
            closeModal();
            loadArtProgress(); // Reload the module to reflect the change
            showNotification('Data kehadiran berhasil dihapus!', 'success');
        }

        // --- END: Delete Attendance Functions ---

        // Test Functions
        function addSkolastikTest(studentId) {
            const filterableStudents = currentUser.role === 'Super Admin' ? studentsData.filter(s => selectedAdminRegion === 'all' || s.region === selectedAdminRegion) : (currentUser.role === 'Admin' ? studentsData.filter(s => s.region === currentUser.region) : []);
            
            if (filterableStudents.length === 0) {
                showNotification('Tidak ada siswa di regional ini untuk ditambahkan tes.', 'error');
                return;
            }

            // Jika studentId diberikan, jadikan siswa tersebut yang terpilih secara default
            let defaultSelectedId = studentId;
            if (defaultSelectedId === null) {
                defaultSelectedId = filterableStudents[0]?.id;
            }

            openModal('Tambah Tes Skolastik', `
                <form id="skolastikTestForm" class="space-y-4">
                    <div>
                        <label for="skolastikTestStudentId" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                        <select id="skolastikTestStudentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${filterableStudents.map(student => `
                                <option value="${student.id}" ${student.id === defaultSelectedId ? 'selected' : ''}>${student.name} (${student.class}) ${currentUser.role === 'Super Admin' ? `(${student.region})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="testDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Tes</label>
                        <input type="date" id="testDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="testSubject" class="block text-sm font-medium text-gray-700 mb-1">Materi</label>
                        <input type="text" id="testSubject" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Matematika Dasar">
                    </div>
                    <div>
                        <label for="testScore" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label>
                        <input type="number" id="testScore" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="testComment" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <textarea id="testComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('skolastikTestForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const selectedStudentId = parseInt(document.getElementById('skolastikTestStudentId').value);
                const student = studentsData.find(s => s.id === selectedStudentId);
                const newTest = {
                    date: document.getElementById('testDate').value,
                    subject: document.getElementById('testSubject').value,
                    score: parseInt(document.getElementById('testScore').value),
                    comment: document.getElementById('testComment').value
                };
                student.skolastikTests.push(newTest);
                closeModal();
                loadSkolastikProgress();
                showNotification('Tes skolastik berhasil ditambahkan!');
            });
        }

        function editSkolastikTest(studentId, testIndex) {
            const student = studentsData.find(s => s.id === studentId);
            const test = student.skolastikTests[testIndex];
            
            openModal('Edit Tes Skolastik', `
                <form id="editSkolastikTestForm" class="space-y-4">
                    <div>
                        <label for="editTestDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Tes</label>
                        <input type="date" id="editTestDate" value="${test.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTestSubject" class="block text-sm font-medium text-gray-700 mb-1">Materi</label>
                        <input type="text" id="editTestSubject" value="${test.subject}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTestScore" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label>
                        <input type="number" id="editTestScore" value="${test.score}" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTestComment" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <textarea id="editTestComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${test.comment}</textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editSkolastikTestForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                test.date = document.getElementById('editTestDate').value;
                test.subject = document.getElementById('editTestSubject').value;
                test.score = parseInt(document.getElementById('editTestScore').value);
                test.comment = document.getElementById('editTestComment').value;
                closeModal();
                loadSkolastikProgress();
                showNotification('Tes skolastik berhasil diupdate!');
            });
        }

        function deleteSkolastikTest(studentId, testIndex) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus data tes ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteSkolastikTest(${studentId}, ${testIndex})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteSkolastikTest(studentId, testIndex) {
            const student = studentsData.find(s => s.id === studentId);
            student.skolastikTests.splice(testIndex, 1);
            closeModal();
            loadSkolastikProgress();
            showNotification('Tes skolastik berhasil dihapus!');
        }

        function addTkaTest(studentId) {
            const filterableStudents = currentUser.role === 'Super Admin' ? studentsData.filter(s => selectedAdminRegion === 'all' || s.region === selectedAdminRegion) : (currentUser.role === 'Admin' ? studentsData.filter(s => s.region === currentUser.region) : []);
            
            if (filterableStudents.length === 0) {
                showNotification('Tidak ada siswa di regional ini untuk ditambahkan tes.', 'error');
                return;
            }

            // Jika studentId diberikan, jadikan siswa tersebut yang terpilih secara default
            let defaultSelectedId = studentId;
            if (defaultSelectedId === null) {
                defaultSelectedId = filterableStudents[0]?.id;
            }

            openModal('Tambah Tes TKA', `
                <form id="tkaTestForm" class="space-y-4">
                    <div>
                        <label for="tkaTestStudentId" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                        <select id="tkaTestStudentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${filterableStudents.map(student => `
                                <option value="${student.id}" ${student.id === defaultSelectedId ? 'selected' : ''}>${student.name} (${student.class}) ${currentUser.role === 'Super Admin' ? `(${student.region})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="tkaTestDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Tes</label>
                        <input type="date" id="tkaTestDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="tkaTestSubject" class="block text-sm font-medium text-gray-700 mb-1">Materi</label>
                        <input type="text" id="tkaTestSubject" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Penalaran Umum">
                    </div>
                    <div>
                        <label for="tkaTestScore" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label>
                        <input type="number" id="tkaTestScore" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="tkaTestComment" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <textarea id="tkaTestComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('tkaTestForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const selectedStudentId = parseInt(document.getElementById('tkaTestStudentId').value);
                const student = studentsData.find(s => s.id === selectedStudentId);
                const newTest = {
                    date: document.getElementById('tkaTestDate').value,
                    subject: document.getElementById('tkaTestSubject').value,
                    score: parseInt(document.getElementById('tkaTestScore').value),
                    comment: document.getElementById('tkaTestComment').value
                };
                student.tkaTests.push(newTest);
                closeModal();
                loadTkaProgress();
                showNotification('Tes TKA berhasil ditambahkan!');
            });
        }

        function editTkaTest(studentId, testIndex) {
            const student = studentsData.find(s => s.id === studentId);
            const test = student.tkaTests[testIndex];
            
            openModal('Edit Tes TKA', `
                <form id="editTkaTestForm" class="space-y-4">
                    <div>
                        <label for="editTkaTestDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Tes</label>
                        <input type="date" id="editTkaTestDate" value="${test.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTkaTestSubject" class="block text-sm font-medium text-gray-700 mb-1">Materi</label>
                        <input type="text" id="editTkaTestSubject" value="${test.subject}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTkaTestScore" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label>
                        <input type="number" id="editTkaTestScore" value="${test.score}" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTkaTestComment" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <textarea id="editTkaTestComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${test.comment}</textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editTkaTestForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                test.date = document.getElementById('editTkaTestDate').value;
                test.subject = document.getElementById('editTkaTestSubject').value;
                test.score = parseInt(document.getElementById('editTkaTestScore').value);
                test.comment = document.getElementById('editTkaTestComment').value;
                closeModal();
                loadTkaProgress();
                showNotification('Tes TKA berhasil diupdate!');
            });
        }

        function deleteTkaTest(studentId, testIndex) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus data tes ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteTkaTest(${studentId}, ${testIndex})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteTkaTest(studentId, testIndex) {
            const student = studentsData.find(s => s.id === studentId);
            student.tkaTests.splice(testIndex, 1);
            closeModal();
            loadTkaProgress();
            showNotification('Tes TKA berhasil dihapus!');
        }

        // Education Info Functions
        function addEducationInfo() {
            openModal('Tambah Informasi Pendidikan', `
                <form id="educationInfoForm" class="space-y-4">
                    <div>
                        <label for="infoTitle" class="block text-sm font-medium text-gray-700 mb-1">Judul</label>
                        <input type="text" id="infoTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="infoContent" class="block text-sm font-medium text-gray-700 mb-1">Isi Informasi</label>
                        <textarea id="infoContent" required rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="infoDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="infoDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('educationInfoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const newInfo = {
                    id: educationInfo.length + 1,
                    title: document.getElementById('infoTitle').value,
                    content: document.getElementById('infoContent').value,
                    date: document.getElementById('infoDate').value
                };
                educationInfo.push(newInfo);
                closeModal();
                loadEducationInfo();
                showNotification('Informasi pendidikan berhasil ditambahkan!');
            });
        }

        function editEducationInfo(id) {
            const info = educationInfo.find(i => i.id === id);
            openModal('Edit Informasi Pendidikan', `
                <form id="editEducationInfoForm" class="space-y-4">
                    <div>
                        <label for="editInfoTitle" class="block text-sm font-medium text-gray-700 mb-1">Judul</label>
                        <input type="text" id="editInfoTitle" value="${info.title}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editInfoContent" class="block text-sm font-medium text-gray-700 mb-1">Isi Informasi</label>
                        <textarea id="editInfoContent" required rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${info.content}</textarea>
                    </div>
                    <div>
                        <label for="editInfoDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="editInfoDate" value="${info.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editEducationInfoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                info.title = document.getElementById('editInfoTitle').value;
                info.content = document.getElementById('editInfoContent').value;
                info.date = document.getElementById('editInfoDate').value;
                closeModal();
                loadEducationInfo();
                showNotification('Informasi pendidikan berhasil diupdate!');
            });
        }

        function deleteEducationInfo(id) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus informasi ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteEducationInfo(${id})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteEducationInfo(id) {
            educationInfo = educationInfo.filter(i => i.id !== id);
            closeModal();
            loadEducationInfo();
            showNotification('Informasi pendidikan berhasil dihapus!');
        }

        // Material Functions - MODIFIED
        function addMaterial() {
            
            // Tentukan regional untuk Super Admin
            let regionSelectHtml = '';
            
            // Filter kelas yang tersedia di regional Admin saat ini
            const regionalClassesForForm = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? (selectedAdminRegion === 'all' || c.region === selectedAdminRegion) : c.region === currentUser.region
            );

            if (currentUser.role === 'Super Admin') {
                const regions = [...new Set([
    ...availableClasses.map(c => c.region),
    ...studentsData.map(s => s.region),
    ...regionalAdmins.map(a => a.region)
].filter(Boolean))];
                regions.push(...studentsData.map(s => s.region).filter(r => !regions.includes(r)));
                regionSelectHtml = `
                    <div>
                        <label for="materialRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional Target</label>
                        <select id="materialRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">--- Pilih Regional ---</option>
                            ${regions.sort().map(regionName => `
                                <option value="${regionName}" ${selectedAdminRegion === regionName ? 'selected' : ''}>${regionName}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            } else if (regionalClassesForForm.length === 0) {
                 showNotification('Tambahkan Kelas terlebih dahulu di regional Anda sebelum menambah materi.', 'error');
                 return;
            }

            openModal('Tambah Materi', `
                <form id="materialForm" class="space-y-4">
                    <div>
                        <label for="materialTopic" class="block text-sm font-medium text-gray-700 mb-1">Topik</label>
                        <input type="text" id="materialTopic" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="materialDescription" class="block text-sm font-medium text-gray-700 mb-1">Penjelasan Materi</label>
                        <textarea id="materialDescription" required rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Relevan (Regional ${currentUser.role === 'Admin' ? currentUser.region : (selectedAdminRegion === 'all' ? 'Semua' : selectedAdminRegion)})</label>
                        <div class="space-y-1 p-2 border border-gray-300 rounded-lg">
                            ${regionalClassesForForm.map(classItem => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="materialClass-${classItem.id}" name="materialClasses" value="${classItem.name}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="materialClass-${classItem.id}" class="ml-2 text-sm text-gray-700">Kelas ${classItem.name} (${classItem.region})</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ${regionSelectHtml}
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('materialForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const selectedClasses = Array.from(document.querySelectorAll('input[name="materialClasses"]:checked')).map(cb => cb.value);

                if (selectedClasses.length === 0) {
                    showNotification('Pilih minimal satu kelas untuk materi ini!', 'error');
                    return;
                }
                
                // Tentukan regional berdasarkan role
                let targetRegion;
                if (currentUser.role === 'Super Admin') {
                    targetRegion = document.getElementById('materialRegion').value;
                    if (!targetRegion) {
                        showNotification('Super Admin harus memilih Regional Target!', 'error');
                        return;
                    }
                } else {
                    targetRegion = currentUser.region;
                }

                const newMaterial = {
                    id: classMaterials.length > 0 ? classMaterials[classMaterials.length - 1].id + 1 : 1,
                    topic: document.getElementById('materialTopic').value,
                    description: document.getElementById('materialDescription').value,
                    classes: selectedClasses,
                    region: targetRegion // <<--- PROPERTI REGION BARU
                };
                classMaterials.push(newMaterial);
                closeModal();
                loadMaterials();
                showNotification('Materi berhasil ditambahkan!');
            });
        }

        function editMaterial(id) {
            const material = classMaterials.find(m => m.id === id);
            
            // Filter kelas yang tersedia di regional material
            const regionalClassesForForm = availableClasses.filter(c => 
                c.region === material.region
            );

            openModal('Edit Materi', `
                <form id="editMaterialForm" class="space-y-4">
                    <div>
                        <label for="editMaterialTopic" class="block text-sm font-medium text-gray-700 mb-1">Topik</label>
                        <input type="text" id="editMaterialTopic" value="${material.topic}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editMaterialDescription" class="block text-sm font-medium text-gray-700 mb-1">Penjelasan Materi</label>
                        <textarea id="editMaterialDescription" required rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${material.description}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Relevan (Regional ${material.region})</label>
                        <div class="space-y-1 p-2 border border-gray-300 rounded-lg">
                            ${regionalClassesForForm.map(classItem => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="editMaterialClass-${classItem.id}" name="editMaterialClasses" value="${classItem.name}" 
                                           class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                           ${material.classes.includes(classItem.name) ? 'checked' : ''}>
                                    <label for="editMaterialClass-${classItem.id}" class="ml-2 text-sm text-gray-700">Kelas ${classItem.name}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editMaterialForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const updatedClasses = Array.from(document.querySelectorAll('input[name="editMaterialClasses"]:checked')).map(cb => cb.value);

                if (updatedClasses.length === 0) {
                    showNotification('Pilih minimal satu kelas untuk materi ini!', 'error');
                    return;
                }

                material.topic = document.getElementById('editMaterialTopic').value;
                material.description = document.getElementById('editMaterialDescription').value;
                material.classes = updatedClasses;
                closeModal();
                loadMaterials();
                showNotification('Materi berhasil diupdate!');
            });
        }

        function deleteMaterial(id) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus materi ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteMaterial(${id})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteMaterial(id) {
            classMaterials = classMaterials.filter(m => m.id !== id);
            closeModal();
            loadMaterials();
            showNotification('Materi berhasil dihapus!');
        }

        // Schedule Functions
        function addSchedule() {

             // Tentukan regional untuk Super Admin
            let regionSelectHtml = '';
            
            // Filter kelas yang tersedia di regional Admin saat ini
            const regionalClassesForForm = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? (selectedAdminRegion === 'all' || c.region === selectedAdminRegion) : c.region === currentUser.region
            );

            if (currentUser.role === 'Super Admin') {
                const regions = [...new Set([
    ...availableClasses.map(c => c.region),
    ...studentsData.map(s => s.region),
    ...regionalAdmins.map(a => a.region)
].filter(Boolean))];
                regions.push(...studentsData.map(s => s.region).filter(r => !regions.includes(r)));
                regionSelectHtml = `
                    <div>
                        <label for="scheduleRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional Target</label>
                        <select id="scheduleRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">--- Pilih Regional ---</option>
                            ${regions.sort().map(regionName => `
                                <option value="${regionName}" ${selectedAdminRegion === regionName ? 'selected' : ''}>${regionName}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            } else if (regionalClassesForForm.length === 0) {
                 showNotification('Tambahkan Kelas terlebih dahulu di regional Anda sebelum menambah jadwal.', 'error');
                 return;
            }

            openModal('Tambah Jadwal', `
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label for="scheduleDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="scheduleDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="scheduleDay" class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
                        <select id="scheduleDay" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                            <option value="Sabtu">Sabtu</option>
                            <option value="Minggu">Minggu</option>
                        </select>
                    </div>
                    <div>
                        <label for="scheduleSubject" class="block text-sm font-medium text-gray-700 mb-1">Nama Materi</label>
                        <input type="text" id="scheduleSubject" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Pengenalan Alat Gambar">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Relevan (Regional ${currentUser.role === 'Admin' ? currentUser.region : (selectedAdminRegion === 'all' ? 'Semua' : selectedAdminRegion)})</label>
                        <div class="space-y-1 p-2 border border-gray-300 rounded-lg">
                            ${regionalClassesForForm.map(classItem => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="scheduleClass-${classItem.id}" name="scheduleClasses" value="${classItem.name}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="scheduleClass-${classItem.id}" class="ml-2 text-sm text-gray-700">Kelas ${classItem.name} (${classItem.region})</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ${regionSelectHtml}
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('scheduleForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const selectedClasses = Array.from(document.querySelectorAll('input[name="scheduleClasses"]:checked')).map(cb => cb.value);

                if (selectedClasses.length === 0) {
                    showNotification('Pilih minimal satu kelas untuk jadwal ini!', 'error');
                    return;
                }
                
                // Tentukan regional berdasarkan role
                let targetRegion;
                if (currentUser.role === 'Super Admin') {
                    targetRegion = document.getElementById('scheduleRegion').value;
                    if (!targetRegion) {
                        showNotification('Super Admin harus memilih Regional Target!', 'error');
                        return;
                    }
                } else {
                    targetRegion = currentUser.region;
                }

                const newSchedule = {
                    id: scheduleData.length > 0 ? scheduleData[scheduleData.length - 1].id + 1 : 1,
                    date: document.getElementById('scheduleDate').value,
                    day: document.getElementById('scheduleDay').value,
                    subject: document.getElementById('scheduleSubject').value,
                    classes: selectedClasses,
                    region: targetRegion
                };
                scheduleData.push(newSchedule);
                closeModal();
                loadSchedule();
                showNotification('Jadwal berhasil ditambahkan!');
            });
        }

        function editSchedule(id) {
            const schedule = scheduleData.find(s => s.id === id);
            
            // Filter kelas yang tersedia di regional jadwal
            const regionalClassesForForm = availableClasses.filter(c => 
                c.region === schedule.region
            );

            openModal('Edit Jadwal', `
                <form id="editScheduleForm" class="space-y-4">
                    <div>
                        <label for="editScheduleDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="editScheduleDate" value="${schedule.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editScheduleDay" class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
                        <select id="editScheduleDay" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Senin" ${schedule.day === 'Senin' ? 'selected' : ''}>Senin</option>
                            <option value="Selasa" ${schedule.day === 'Selasa' ? 'selected' : ''}>Selasa</option>
                            <option value="Rabu" ${schedule.day === 'Rabu' ? 'selected' : ''}>Rabu</option>
                            <option value="Kamis" ${schedule.day === 'Kamis' ? 'selected' : ''}>Kamis</option>
                            <option value="Jumat" ${schedule.day === 'Jumat' ? 'selected' : ''}>Jumat</option>
                            <option value="Sabtu" ${schedule.day === 'Sabtu' ? 'selected' : ''}>Sabtu</option>
                            <option value="Minggu" ${schedule.day === 'Minggu' ? 'selected' : ''}>Minggu</option>
                        </select>
                    </div>
                    <div>
                        <label for="editScheduleSubject" class="block text-sm font-medium text-gray-700 mb-1">Nama Materi</label>
                        <input type="text" id="editScheduleSubject" value="${schedule.subject}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Relevan (Regional ${schedule.region})</label>
                        <div class="space-y-1 p-2 border border-gray-300 rounded-lg">
                            ${regionalClassesForForm.map(classItem => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="editScheduleClass-${classItem.id}" name="editScheduleClasses" value="${classItem.name}" 
                                           class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                           ${schedule.classes.includes(classItem.name) ? 'checked' : ''}>
                                    <label for="editScheduleClass-${classItem.id}" class="ml-2 text-sm text-gray-700">Kelas ${classItem.name}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editScheduleForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const updatedClasses = Array.from(document.querySelectorAll('input[name="editScheduleClasses"]:checked')).map(cb => cb.value);

                if (updatedClasses.length === 0) {
                    showNotification('Pilih minimal satu kelas untuk jadwal ini!', 'error');
                    return;
                }
                
                schedule.date = document.getElementById('editScheduleDate').value;
                schedule.day = document.getElementById('editScheduleDay').value;
                schedule.subject = document.getElementById('editScheduleSubject').value;
                schedule.classes = updatedClasses;
                closeModal();
                loadSchedule();
                showNotification('Jadwal berhasil diupdate!');
            });
        }

        function deleteSchedule(id) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus jadwal ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteSchedule(${id})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteSchedule(id) {
            scheduleData = scheduleData.filter(s => s.id !== id);
            closeModal();
            loadSchedule();
            showNotification('Jadwal berhasil dihapus!');
        }

        // Class Filter Functions (Used by Admin Regional)
        function filterArtProgressByClass(className) {
            selectedClass = className;
            loadArtProgress();
        }

        function filterSkolastikByClass(className) {
            selectedClass = className;
            loadSkolastikProgress();
        }

        function filterTkaByClass(className) {
            selectedClass = className;
            loadTkaProgress();
        }
        
        // Region Filter Functions (NEW: Used by Super Admin)
        function filterArtProgressByRegion(regionName) {
            selectedAdminRegion = regionName;
            loadArtProgress();
        }

        function filterSkolastikByRegion(regionName) {
            selectedAdminRegion = regionName;
            loadSkolastikProgress();
        }

        function filterTkaByRegion(regionName) {
            selectedAdminRegion = regionName;
            loadTkaProgress();
        }
        
        // Region Filter Functions for Materials (NEW: Used by Super Admin)
        function filterMaterialByRegion(regionName) {
            selectedAdminRegion = regionName;
            loadMaterials();
        }

        // Region Filter Functions for Schedule (NEW: Used by Super Admin)
        function filterScheduleByRegion(regionName) {
            selectedAdminRegion = regionName;
            loadSchedule();
        }

        // Class Filter Functions for Materials (TAMBAHAN BARU)
        function filterMaterialByClass(className) {
            selectedClassMaterial = className;
            loadMaterials();
        }

        // Class Filter Functions for Schedule (TAMBAHAN BARU)
        function filterScheduleByClass(className) {
            selectedClassSchedule = className;
            loadSchedule();
        }

        // --- NEW SCHOOL MANAGEMENT FUNCTIONS ---

        function editSchool(schoolId) {
            const school = availableSchools.find(s => s.id === schoolId);
            
            openModal('Edit Sekolah', `
                <form id="editSchoolForm" class="space-y-4">
                    <div>
                        <label for="editSchoolName" class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah</label>
                        <input type="text" id="editSchoolName" value="${school.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editSchoolForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const newName = document.getElementById('editSchoolName').value.trim();
                
                if (availableSchools.some(s => s.id !== schoolId && s.name.toLowerCase() === newName.toLowerCase())) {
                    showNotification('Nama sekolah sudah ada!', 'error');
                    return;
                }

                const oldName = school.name;
                school.name = newName;
                
                // Update students who are currently registered with this school name
                studentsData.forEach(student => {
                    if (student.school === oldName) {
                        student.school = newName;
                    }
                });

                closeModal();
                loadAddStudent();
                showNotification('Nama sekolah berhasil diupdate!');
            });
        }

        function deleteSchool(schoolId) {
            const school = availableSchools.find(s => s.id === schoolId);
            const studentsInSchool = studentsData.filter(s => s.school === school.name);

            if (studentsInSchool.length > 0) {
                openModal('Tidak Dapat Menghapus Sekolah', `
                    <div class="text-center">
                        <div class="mb-4">
                            <span class="text-6xl">‚ùå</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Sekolah Tidak Dapat Dihapus</h3>
                        <p class="text-gray-700 mb-4">Sekolah <strong>${school.name}</strong> masih memiliki <strong>${studentsInSchool.length} siswa</strong> yang terdaftar.</p>
                        <p class="text-sm text-gray-600 mb-6">Silakan pindahkan atau hapus siswa terlebih dahulu sebelum menghapus sekolah ini.</p>
                        <button onclick="closeModal()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Mengerti</button>
                    </div>
                `);
                return;
            }

            openModal('Konfirmasi Hapus Sekolah', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Hapus Sekolah</h3>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus sekolah <strong>${school.name}</strong>?</p>
                    <p class="text-sm text-red-600 mb-6">Tindakan ini tidak dapat dibatalkan!</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteSchool(${schoolId})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteSchool(schoolId) {
            availableSchools = availableSchools.filter(s => s.id !== schoolId);
            closeModal();
            loadAddStudent();
            showNotification('Sekolah berhasil dihapus!');
        }

        // --- END NEW SCHOOL MANAGEMENT FUNCTIONS ---

        // MODIFIED FUNCTION: loadManageClasses - Class management is now regional
        
function loadManageClasses() {
  const content = document.getElementById('contentArea');

  // Pastikan user punya akses
  if (currentUser.role !== 'Admin' && currentUser.role !== 'Super Admin') {
    content.innerHTML = `
      <div class="fade-in text-center text-red-600 text-xl font-bold p-10">
        Akses ditolak. Hanya Admin dan Super Admin yang dapat mengakses modul ini.
      </div>`;
    return;
  }

  // Filter kelas berdasarkan region user (jika bukan Super Admin)
  const filteredClasses = currentUser.role === 'Super Admin'
    ? availableClasses
    : availableClasses.filter(c => c.region === currentUser.region);

  content.innerHTML = `
    <div class="fade-in">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">üè´ Kelola Kelas</h2>
        ${ (currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `<button onclick="addClass()" 
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">
          + Tambah Kelas
        </button>` : '' }
      </div>

      <!-- üîΩ Filter Region & Kelas (sejajar) -->
      <div class="flex flex-wrap gap-4 mb-6 items-end">
        ${currentUser.role === 'Super Admin' ? `
        <div>
          <label for="filterRegion" class="block text-sm font-medium text-gray-700 mb-1">üåç Filter Region</label>
          <select id="filterRegion" onchange="filterRegionChange()" 
            class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="all">Semua Region</option>
            ${[...new Set(regionalAdmins.map(a => a.region))]
              .map(r => `<option value="${r}">${r}</option>`)
              .join('')}
          </select>
        </div>` : ''}

        <div>
          <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-1">üè´ Filter Kelas</label>
          <select id="filterClass" onchange="filterClasses()" 
            class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="all">Semua Kelas</option>
            ${filteredClasses.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
          </select>
        </div>
      </div>

      <!-- üîΩ Daftar Kelas -->
      <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-blue-800 text-white">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nama Kelas</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Deskripsi</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Regional</th>
              <th class="px-4 py-3 text-center text-sm font-semibold text-white-700">Aksi</th>
            </tr>
          </thead>
          <tbody id="classTableBody" class="bg-white divide-y divide-gray-100">
            ${filteredClasses.map(c => `
              <tr data-class="${c.name}" data-region="${c.region}" class="hover:bg-blue-50 transition-colors">
                <td class="px-4 py-3 text-sm font-medium text-gray-900">${c.name}</td>
                <td class="px-4 py-3 text-sm text-gray-600">${c.description}</td>
                <td class="px-4 py-3 text-sm text-blue-600 font-medium">${c.region}</td>
                <td class="px-4 py-3 text-center text-sm">
                  ${ (currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `<button onclick="editClass(${c.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                  <button onclick="deleteClass(${c.id})" class="text-red-600 hover:text-red-800">Hapus</button>` : '-' }
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// === üîß Fungsi Tambahan Filter ===
function filterRegionChange() {
  const region = document.getElementById('filterRegion').value;
  const classDropdown = document.getElementById('filterClass');

  const classes = region === 'all'
    ? availableClasses
    : availableClasses.filter(c => c.region === region);

  classDropdown.innerHTML = `
    <option value="all">Semua Kelas</option>
    ${classes.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
  `;
  filterClasses();
}

function filterClasses() {
  const regionSelect = document.getElementById('filterRegion');
  const region = regionSelect ? regionSelect.value : currentUser.region;
  const kelas = document.getElementById('filterClass').value;
  const rows = document.querySelectorAll('#classTableBody tr');

  rows.forEach(row => {
    const classRegion = row.getAttribute('data-region');
    const className = row.getAttribute('data-class');
    const matchRegion = region === 'all' || classRegion === region;
    const matchClass = kelas === 'all' || className === kelas;
    row.style.display = (matchRegion && matchClass) ? '' : 'none';
  });
}

        function addClass() {
             // Tentukan regional untuk Super Admin
            let regionSelectHtml = '';
            
            if (currentUser.role === 'Super Admin') {
                regionSelectHtml = `
                    <div>
                        <label for="modalNewClassRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional Target</label>
                        <select id="modalNewClassRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                            <option value="">--- Pilih Regional ---</option>
                            ${regionalAdmins.map(admin => `
                                <option value="${admin.region}">${admin.region}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }

            openModal('Tambah Kelas Baru', `
                <form id="addClassModalForm" class="space-y-4">
                    ${regionSelectHtml}
                    <div>
                        <label for="modalClassName" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
                        <input type="text" id="modalClassName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Premium">
                    </div>
                    <div>
                        <label for="modalClassDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Kelas</label>
                        <textarea id="modalClassDescription" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Deskripsi singkat tentang kelas ini"></textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Tambah Kelas</button>
                </form>
            `);

            document.getElementById('addClassModalForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('modalClassName').value;
                const description = document.getElementById('modalClassDescription').value;
                const targetRegion = currentUser.role === 'Super Admin' ? document.getElementById('modalNewClassRegion').value : currentUser.region;

                if (!targetRegion) {
                    showNotification('Silakan pilih Regional Target.', 'error');
                    return;
                }

                // Check if class name already exists in the target region
                if (availableClasses.some(c => c.name.toLowerCase() === name.toLowerCase() && c.region === targetRegion)) {
                    showNotification(`Nama kelas "${name}" sudah ada di regional ${targetRegion}!`, 'error');
                    return;
                }

                const maxId = availableClasses.reduce((max, c) => (c.id > max ? c.id : max), 0);
                const newClass = {
                    id: maxId + 1,
                    name: name,
                    description: description,
                    region: targetRegion // Add region property
                };
                availableClasses.push(newClass);

                closeModal();
                loadManageClasses();
                showNotification('Kelas berhasil ditambahkan!');
            });
        }

        function editClass(classId) {
            const classItem = availableClasses.find(c => c.id === classId);
            
            openModal('Edit Kelas', `
                <form id="editClassForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
                        <input type="text" value="${classItem.region}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500">
                    </div>
                    <div>
                        <label for="editClassName" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
                        <input type="text" id="editClassName" value="${classItem.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editClassDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Kelas</label>
                        <textarea id="editClassDescription" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${classItem.description}</textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editClassForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const newName = document.getElementById('editClassName').value;
                const newDescription = document.getElementById('editClassDescription').value;

                // Check if new name conflicts with other classes IN THE SAME REGION
                if (availableClasses.some(c => c.id !== classId && c.name.toLowerCase() === newName.toLowerCase() && c.region === classItem.region)) {
                    showNotification(`Nama kelas "${newName}" sudah ada di regional ${classItem.region}!`, 'error');
                    return;
                }

                const oldName = classItem.name;
                const targetRegion = classItem.region;

                classItem.name = newName;
                classItem.description = newDescription;

                // Update all students in this region with the old class name
                studentsData.forEach(student => {
                    if (student.class === oldName && student.region === targetRegion) {
                        student.class = newName;
                    }
                });

                // Update class name in materials in this region
                classMaterials.forEach(material => {
                    if (material.region === targetRegion) {
                         if (material.classes.includes(oldName)) {
                            material.classes = material.classes.map(c => c === oldName ? newName : c);
                        }
                    }
                });

                // Update class name in schedules in this region
                scheduleData.forEach(schedule => {
                    if (schedule.region === targetRegion) {
                        if (schedule.classes.includes(oldName)) {
                            schedule.classes = schedule.classes.map(c => c === oldName ? newName : c);
                        }
                    }
                });

                closeModal();
                loadManageClasses();
                showNotification('Kelas berhasil diupdate!');
            });
        }

        function deleteClass(classId) {
            const classItem = availableClasses.find(c => c.id === classId);
            const targetRegion = classItem.region;
            const studentsInClass = studentsData.filter(s => s.class === classItem.name && s.region === targetRegion);

            if (studentsInClass.length > 0) {
                openModal('Tidak Dapat Menghapus Kelas', `
                    <div class="text-center">
                        <div class="mb-4">
                            <span class="text-6xl">‚ùå</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Kelas Tidak Dapat Dihapus</h3>
                        <p class="text-gray-700 mb-4">Kelas <strong>${classItem.name}</strong> di regional <strong>${targetRegion}</strong> masih memiliki <strong>${studentsInClass.length} siswa</strong> yang terdaftar.</p>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 text-left">
                            <h4 class="font-semibold text-yellow-800 mb-2">Siswa yang terdaftar:</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                ${studentsInClass.map(student => `<li>‚Ä¢ ${student.name}</li>`).join('')}
                            </ul>
                        </div>
                        <p class="text-sm text-gray-600 mb-6">Silakan pindahkan atau hapus siswa terlebih dahulu sebelum menghapus kelas ini.</p>
                        <button onclick="closeModal()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Mengerti</button>
                    </div>
                `);
                return;
            }

            openModal('Konfirmasi Hapus Kelas', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Hapus Kelas</h3>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus kelas <strong>${classItem.name}</strong> di regional <strong>${targetRegion}</strong>?</p>
                    <p class="text-sm text-red-600 mb-6">Tindakan ini akan menghapus referensi kelas dari Materi dan Jadwal di regional ini!</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteClass(${classId})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteClass(classId) {
            const classItem = availableClasses.find(c => c.id === classId);
            const className = classItem.name;
            const targetRegion = classItem.region;

            // Remove class from materials in the same region
            classMaterials.forEach(material => {
                if (material.region === targetRegion) {
                    material.classes = material.classes.filter(c => c !== className);
                }
            });

            // Remove class from schedules in the same region
            scheduleData.forEach(schedule => {
                if (schedule.region === targetRegion) {
                    schedule.classes = schedule.classes.filter(c => c !== className);
                }
            });

            availableClasses = availableClasses.filter(c => c.id !== classId);
            closeModal();
            loadManageClasses();
            showNotification('Kelas berhasil dihapus!');
        }

        // Fungsi-fungsi lama editStudent dan deleteStudent sudah digantikan dengan editUser dan deleteUser
    </script>
<script type="module">
   (function() {
    function c() {
     var b = a.contentDocument || a.contentWindow.document;
     if (b) {
      var d = b.createElement('script');
      d.innerHTML = "window.__CF$cv$params={r:'997b7cd1a61d0566',t:'MTc2MjAwMTEwOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
      b.getElementsByTagName('head')[0].appendChild(d)
     }
    }
    if (document.body) {
     var a = document.createElement('iframe');
     a.height = 1;
     a.width = 1;
     a.style.position = 'absolute';
     a.style.top = 0;
     a.style.left = 0;
     a.style.border = 'none';
     a.style.visibility = 'hidden';
     document.body.appendChild(a);
     if ('loading' !== document.readyState) c();
     else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c);
     else {
      var e = document.onreadystatechange || function() {};
      document.onreadystatechange = function(b) {
       e(b);
       'loading' !== document.readyState && (document.onreadystatechange = e, c())
      }
     }
    }
   })();
  
// --- Added CRUD helpers for classMaterials and availableSchools (ensure persistence) ---
function addSchool(name){
  if(!name) return;
  const id = Date.now();
  availableSchools.push({id, name});
  saveAllData();
}
function updateSchool(id, name){
  const idx = availableSchools.findIndex(s=>s.id===id);
  if(idx!==-1){ availableSchools[idx].name = name; saveAllData(); }
}
function deleteSchoolById(id){
  availableSchools = availableSchools.filter(s=>s.id!==id);
  // unset student.school references with that id/name (best effort)
  saveAllData();
}

// Material helpers
function addMaterialObj(obj){
  obj.id = Date.now();
  if(currentUser.role === 'Admin') obj.region = currentUser.region;
  classMaterials.push(obj);
  saveAllData();
}
function updateMaterialObj(id, patch){
  const idx = classMaterials.findIndex(m=>m.id===id);
  if(idx===-1) return;
  if(currentUser.role === 'Admin' && classMaterials[idx].region !== currentUser.region){ showNotification('Akses ditolak: region lain','error'); return; }
  classMaterials[idx] = {...classMaterials[idx], ...patch};
  saveAllData();
}
function deleteMaterialById(id){
  const idx = classMaterials.findIndex(m=>m.id===id);
  if(idx===-1) return;
  if(currentUser.role === 'Admin' && classMaterials[idx].region !== currentUser.region){ showNotification('Akses ditolak: region lain','error'); return; }
  classMaterials.splice(idx,1);
  saveAllData();
}
// Call saveAllData when page unloads to reduce risk of lost data
window.addEventListener('beforeunload', saveAllData);

// === MODUL JADWAL KEGIATAN (SAMA SEPERTI JADWAL BELAJAR) ===
function loadActivitySchedule() {
    const content = document.getElementById('contentArea');
    const userRegion = currentUser.region;
    let regionActivities = currentUser.role === 'Super Admin' ? activityScheduleData : activityScheduleData.filter(a => a.region === userRegion);

    let classOptions = availableClasses
        .filter(c => currentUser.role === 'Super Admin' || c.region === userRegion)
        .map(c => `<option value="${c.name}">${c.name}</option>`)
        .join('');

    content.innerHTML = `
        <div class="fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">üìÜ Jadwal Kegiatan</h2>
                ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? 
                    `<button onclick="openAddActivity()" class='px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm'>+ Tambah Kegiatan</button>` : ''}
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-blue-800 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Tanggal</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nama Kegiatan</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Tujuan</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Kelas</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="activityTableBody">
                            ${regionActivities.map(a => `
                                <tr class="border-t border-gray-200 hover:bg-blue-50">
                                    <td class="px-4 py-3 text-sm text-gray-700">${a.date}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${a.name}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${a.goal}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${a.classes.join(', ')}</td>
                                    <td class="px-4 py-3 text-sm">
                                        ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `
                                            <button onclick="editActivity(${a.id})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                            <button onclick="deleteActivity(${a.id})" class="text-red-600 hover:text-red-800">Hapus</button>` : '-'}
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function openAddActivity() {
    openModal('Tambah Jadwal Kegiatan', `
        <form id="addActivityForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Kegiatan</label>
                <input type="date" id="activityDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
                <input type="text" id="activityName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tujuan</label>
                <textarea id="activityGoal" required class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                <select multiple id="activityClasses" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    ${availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                </select>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
        </form>
    `);

    document.getElementById('addActivityForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const newAct = {
            id: Date.now(),
            date: document.getElementById('activityDate').value,
            name: document.getElementById('activityName').value,
            goal: document.getElementById('activityGoal').value,
            classes: Array.from(document.getElementById('activityClasses').selectedOptions).map(o => o.value),
            region: currentUser.region
        };
        activityScheduleData.push(newAct);
        saveAllData();
        closeModal();
        loadActivitySchedule();
        showNotification('Kegiatan berhasil ditambahkan!', 'success');
    });
}

function deleteActivity(id) {
    if (!confirm('Hapus kegiatan ini?')) return;
    activityScheduleData = activityScheduleData.filter(a => a.id !== id);
    saveAllData();
    loadActivitySchedule();
    showNotification('Kegiatan dihapus!', 'success');
}

function editActivity(id) {
    const act = activityScheduleData.find(a => a.id === id);
    if (!act) return;

    openModal('Edit Jadwal Kegiatan', `
        <form id="editActivityForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Kegiatan</label>
                <input type="date" id="editActivityDate" value="${act.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
                <input type="text" id="editActivityName" value="${act.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tujuan</label>
                <textarea id="editActivityGoal" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">${act.goal}</textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                <select multiple id="editActivityClasses" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    ${availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region)
                        .map(c => `<option value="${c.name}" ${act.classes.includes(c.name) ? 'selected' : ''}>${c.name}</option>`).join('')}
                </select>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan Perubahan</button>
        </form>
    `);

    document.getElementById('editActivityForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        act.date = document.getElementById('editActivityDate').value;
        act.name = document.getElementById('editActivityName').value;
        act.goal = document.getElementById('editActivityGoal').value;
        act.classes = Array.from(document.getElementById('editActivityClasses').selectedOptions).map(o => o.value);
        saveAllData();
        closeModal();
        loadActivitySchedule();
        showNotification('Kegiatan berhasil diperbarui!', 'success');
    });
}

function filterActivityByClass(className) {
    const userRegion = currentUser.region;
    let filtered = currentUser.role === 'Super Admin' ? activityScheduleData : activityScheduleData.filter(a => a.region === userRegion);
    if (className !== 'all') filtered = filtered.filter(a => a.classes.includes(className));
    const tbody = document.getElementById('activityTableBody');
    tbody.innerHTML = filtered.map(a => `
        <tr class="border-t border-gray-200 hover:bg-blue-50">
            <td class="px-4 py-3 text-sm text-gray-700">${a.date}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${a.name}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${a.goal}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${a.classes.join(', ')}</td>
            <td class="px-4 py-3 text-sm">
                ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `
                    <button onclick="editActivity(${a.id})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                    <button onclick="deleteActivity(${a.id})" class="text-red-600 hover:text-red-800">Hapus</button>` : '-'}
            </td>
        </tr>`).join('');
}
</script>
<!-- BEGIN: Injected by assistant ‚Äî Activity & Schedule modules upgrade -->
<script type="module">
// Ensure data arrays exist
if (typeof activityScheduleData === 'undefined') activityScheduleData = [];
if (typeof scheduleData === 'undefined') scheduleData = [];

// Utility: compute day name from YYYY-MM-DD
function getDayNameFromDate(isoDate) {
  const d = new Date(isoDate);
  if (isNaN(d)) return '';
  const days = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
  return days[d.getDay()];
}

// -------------------- Jadwal Kegiatan (table, filter, CRUD, auto-day) --------------------
function loadActivitySchedule() {
  const content = document.getElementById("contentArea");
  const canEdit = currentUser && (currentUser.role === "Super Admin" || currentUser.role === "Admin");
  const regionTitle = (currentUser && currentUser.role === "Super Admin") ? "(Semua Regional)" : (currentUser ? `(Regional ${currentUser.region})` : "");

  // class options - try to infer from availableClasses, fallback to defaults
  const classOptions = (typeof availableClasses !== 'undefined' ? 
    (Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))).map(n=>n)) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);
  classOptions.unshift("Semua Kelas");

  const currentFilter = localStorage.getItem("selectedClassFilter_activity") || "Semua Kelas";

  // Normalize items for rendering (support older shapes)
  const normalized = activityScheduleData.map(item => {
    return {
      id: item.id || item.date + Math.random(),
      date: item.date || item.tanggal || '',
      day: item.day || item.hari || getDayNameFromDate(item.date || item.tanggal || ''),
      time: item.time || item.waktu || (item.timeRange || ''),
      name: item.name || item.nama || item.kegiatan || item.title || '',
      place: item.place || item.tempat || item.location || '',
      classTarget: item.classTarget || item.classTarget || (item.classes && item.classes.length ? item.classes[0] : "Semua Kelas"),
      region: item.region || item.regionName || ''
    };
  });

  // Filter by region for non-superadmin
  let filteredData = normalized;
  if (!currentUser || currentUser.role !== "Super Admin") {
    const userRegion = currentUser ? currentUser.region : '';
    filteredData = filteredData.filter(a => !a.region || a.region === userRegion);
  }

  // Filter by class target
  if (currentFilter && currentFilter !== "Semua Kelas") {
    filteredData = filteredData.filter(a => a.classTarget === currentFilter);
  }

  // Sort by date asc
  filteredData.sort((a,b) => new Date(a.date) - new Date(b.date));

  content.innerHTML = `
    <div class="fade-in">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
          <span class="text-3xl mr-2">üìÜ</span> Jadwal Kegiatan ${regionTitle}
        </h2>
        <div class="flex items-center space-x-3">
          ${canEdit ? `<button onclick="openAddActivityModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm">+ Tambah Kegiatan</button>` : ''}
        </div>
      </div>

      ${canEdit ? `
      <div class="mb-4 flex items-end space-x-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
          <select id="classFilterDropdownActivity" class="w-48 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            ${classOptions.map(opt => `<option ${opt === currentFilter ? 'selected' : ''} value="${opt}">${opt}</option>`).join('')}
          </select>
        </div>
      </div>` : ''}

      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-blue-800 text-white">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Tanggal</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Hari</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Waktu</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nama Kegiatan</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Tempat</th>
              ${canEdit ? '<th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>' : ''}
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100" id="activityTableBody">
            ${filteredData.map(item => `
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-700">${item.date || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.day || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.time || ''}</td>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.place || ''}</td>
                ${canEdit ? `<td class="px-4 py-3 text-sm">
                  <button onclick="editActivity('${item.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                  <button onclick="deleteActivity('${item.id}')" class="text-red-600 hover:text-red-800">Hapus</button>
                </td>` : ''}
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;

  if (canEdit) {
    const sel = document.getElementById("classFilterDropdownActivity");
    sel.addEventListener("change", () => {
      localStorage.setItem("selectedClassFilter_activity", sel.value);
      loadActivitySchedule();
    });
  }
}

function openAddActivityModal() {
  const regionText = (currentUser && currentUser.role === "Super Admin") ? "Semua Regional" : (currentUser ? `Regional ${currentUser.region}` : '');
  // infer class options
  const classOptions = (typeof availableClasses !== 'undefined' ? Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);

  openModal("Tambah Jadwal Kegiatan", `
    <form id="addActivityForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
        <input type="date" id="activityDate" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
        <input type="text" id="activityDay" readonly placeholder="Otomatis dari tanggal" class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
        <input type="text" id="activityTime" placeholder="Contoh: 09.00 - 11.00" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
        <input type="text" id="activityName" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tempat Kegiatan</label>
        <input type="text" id="activityPlace" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Target</label>
        <select id="activityClassTarget" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
          <option value="">Pilih Kelas</option>
          ${classOptions.map(c=>`<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="text-sm text-gray-600 mt-2"><span class="font-semibold">Relevan:</span> ${regionText}</div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition w-full">Simpan</button>
      </div>
    </form>
  `);

  const dateEl = document.getElementById("activityDate");
  dateEl.addEventListener("change", ()=>{
    document.getElementById("activityDay").value = getDayNameFromDate(dateEl.value);
  });

  document.getElementById("addActivityForm").onsubmit = e => {
    e.preventDefault();
    const newAct = {
      id: String(Date.now()),
      date: document.getElementById("activityDate").value,
      day: document.getElementById("activityDay").value || getDayNameFromDate(document.getElementById("activityDate").value),
      time: document.getElementById("activityTime").value,
      name: document.getElementById("activityName").value,
      place: document.getElementById("activityPlace").value,
      classTarget: document.getElementById("activityClassTarget").value || "Semua Kelas",
      region: currentUser ? currentUser.region : ''
    };
    activityScheduleData.push(newAct);
    try { saveAllData(); } catch(e){ console.warn(e); }
    closeModal();
    showNotification("Kegiatan berhasil ditambahkan!", "success");
    loadActivitySchedule();
  };
}

function editActivity(id) {
  const idx = activityScheduleData.findIndex(a => String(a.id) === String(id));
  if (idx === -1) return;
  const a = activityScheduleData[idx];
  const classOptions = (typeof availableClasses !== 'undefined' ? Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);

  openModal("Edit Jadwal Kegiatan", `
    <form id="editActivityForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
        <input type="date" id="editActivityDate" value="${a.date || ''}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
        <input type="text" id="editActivityDay" value="${a.day || getDayNameFromDate(a.date || '')}" readonly class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
        <input type="text" id="editActivityTime" value="${a.time || ''}" placeholder="Contoh: 09.00 - 11.00" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
        <input type="text" id="editActivityName" value="${a.name || ''}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tempat Kegiatan</label>
        <input type="text" id="editActivityPlace" value="${a.place || ''}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Target</label>
        <select id="editActivityClassTarget" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
          ${classOptions.map(c=>`<option value="${c}" ${a.classTarget===c ? 'selected' : ''}>${c}</option>`).join('')}
        </select>
      </div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition w-full">Update</button>
      </div>
    </form>
  `);

  const dateEl = document.getElementById("editActivityDate");
  dateEl.addEventListener("change", ()=> {
    document.getElementById("editActivityDay").value = getDayNameFromDate(dateEl.value);
  });

  document.getElementById("editActivityForm").onsubmit = e => {
    e.preventDefault();
    activityScheduleData[idx] = {
      ...activityScheduleData[idx],
      date: document.getElementById("editActivityDate").value,
      day: document.getElementById("editActivityDay").value || getDayNameFromDate(document.getElementById("editActivityDate").value),
      time: document.getElementById("editActivityTime").value,
      name: document.getElementById("editActivityName").value,
      place: document.getElementById("editActivityPlace").value,
      classTarget: document.getElementById("editActivityClassTarget").value
    };
    try { saveAllData(); } catch(e){ console.warn(e); }
    closeModal();
    showNotification("Kegiatan berhasil diperbarui!", "success");
    loadActivitySchedule();
  };
}

function deleteActivity(id) {
  if (!confirm("Apakah Anda yakin ingin menghapus kegiatan ini?")) return;
  activityScheduleData = activityScheduleData.filter(a => String(a.id) !== String(id));
  try { saveAllData(); } catch(e){ console.warn(e); }
  showNotification("Kegiatan berhasil dihapus!", "success");
  loadActivitySchedule();
}

// -------------------- Jadwal Belajar updates: table + dropdown + add/edit with auto-day --------------------
function loadSchedule() {
  const content = document.getElementById("contentArea");
  const canEdit = currentUser && (currentUser.role === "Super Admin" || currentUser.role === "Admin");
  const regionTitle = (currentUser && currentUser.role === "Super Admin") ? "(Semua Regional)" : (currentUser ? `(Regional ${currentUser.region})` : "");

  // class options
  const classOptions = (typeof availableClasses !== 'undefined' ? Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);
  classOptions.unshift("Semua Kelas");

  const currentFilter = localStorage.getItem("selectedClassFilter_schedule") || "Semua Kelas";

  // normalize scheduleData items
  const normalized = scheduleData.map(item => ({
    id: item.id || (item.date + Math.random()),
    date: item.date || '',
    day: item.day || getDayNameFromDate(item.date || ''),
    time: item.time || item.time || '',
    subject: item.subject || item.title || item.subjectName || '',
    classTarget: item.classTarget || item.classTarget || (item.classes && item.classes.length ? item.classes[0] : '')
  }));

  // filter by region
  let filtered = normalized;
  if (!currentUser || currentUser.role !== "Super Admin") {
    const userRegion = currentUser ? currentUser.region : '';
    filtered = filtered.filter(s => (s.region ? s.region === userRegion : true));
  }

  if (currentFilter && currentFilter !== "Semua Kelas") {
    filtered = filtered.filter(s => s.classTarget === currentFilter);
  }

  // sort by date
  filtered.sort((a,b) => new Date(a.date) - new Date(b.date));

  content.innerHTML = `
    <div class="fade-in">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center"><span class="text-3xl mr-2">üìö</span> Jadwal Belajar ${regionTitle}</h2>
        ${canEdit ? `<button onclick="openAddScheduleModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">+ Tambah Jadwal</button>` : ''}
      </div>

      ${canEdit ? `
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
        <select id="classFilterSchedule" class="w-48 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          ${classOptions.map(opt => `<option ${opt === currentFilter ? 'selected' : ''} value="${opt}">${opt}</option>`).join('')}
        </select>
      </div>` : ''}

      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-blue-800 text-white">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Tanggal</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Waktu</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Hari</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nama Materi</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Kelas Target</th>
              
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100" id="scheduleTableBody">
            ${filtered.map(item => `
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-700">${item.date || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.time || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.day || ''}</td>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.subject || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.classTarget || ''}</td>
                ${canEdit ? `<td class="px-4 py-3 text-sm">
                  <button onclick="editSchedule('${item.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                  <button onclick="deleteSchedule('${item.id}')" class="text-red-600 hover:text-red-800">Hapus</button>
                </td>` : ''}
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;

  if (canEdit) {
    document.getElementById("classFilterSchedule").addEventListener("change", (e)=> {
      localStorage.setItem("selectedClassFilter_schedule", e.target.value);
      loadSchedule();
    });
  }
}

// add schedule modal (with auto-day)
function openAddScheduleModal() {
  const regionText = (currentUser && currentUser.role === "Super Admin") ? "Semua Regional" : (currentUser ? `Regional ${currentUser.region}` : '');
  const classOptions = (typeof availableClasses !== 'undefined' ? Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);

  openModal("Tambah Jadwal Belajar", `
    <form id="addScheduleForm_v2" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
        <input type="date" id="scheduleDateNew" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
        <input type="text" id="scheduleTimeNew" placeholder="Contoh: 09.00 - 11.00" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
        <input type="text" id="scheduleDayNew" readonly placeholder="Otomatis dari tanggal" class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Materi</label>
        <input type="text" id="scheduleSubjectNew" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Target</label>
        <select id="scheduleClassTargetNew" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
          <option value="">Pilih Kelas</option>
          ${classOptions.map(c=>`<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="text-sm text-gray-600 mt-2"><span class="font-semibold">Relevan:</span> ${regionText}</div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition w-full">Simpan</button>
      </div>
    </form>
  `);

  document.getElementById("scheduleDateNew").addEventListener("change", ()=>{
    document.getElementById("scheduleDayNew").value = getDayNameFromDate(document.getElementById("scheduleDateNew").value);
  });

  document.getElementById("addScheduleForm_v2").onsubmit = e => {
    e.preventDefault();
    const newS = {
      id: String(Date.now()),
      date: document.getElementById("scheduleDateNew").value,
      time: document.getElementById("scheduleTimeNew").value,
      day: document.getElementById("scheduleDayNew").value || getDayNameFromDate(document.getElementById("scheduleDateNew").value),
      subject: document.getElementById("scheduleSubjectNew").value,
      classTarget: document.getElementById("scheduleClassTargetNew").value,
      region: currentUser ? currentUser.region : ''
    };
    scheduleData.push(newS);
    try { saveAllData(); } catch(e){ console.warn(e); }
    closeModal();
    showNotification("Jadwal belajar berhasil ditambahkan!", "success");
    loadSchedule();
  };
}

function editSchedule(id) {
  const idx = scheduleData.findIndex(s => String(s.id) === String(id));
  if (idx === -1) return;
  const s = scheduleData[idx];
  const classOptions = (typeof availableClasses !== 'undefined' ? Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);

  openModal("Edit Jadwal Belajar", `
    <form id="editScheduleForm_v2" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
        <input type="date" id="editScheduleDate" value="${s.date || ''}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
        <input type="text" id="editScheduleTime" value="${s.time || ''}" placeholder="Contoh: 09.00 - 11.00" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
        <input type="text" id="editScheduleDay" value="${s.day || getDayNameFromDate(s.date || '')}" readonly class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Materi</label>
        <input type="text" id="editScheduleSubject" value="${s.subject || ''}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Target</label>
        <select id="editScheduleClassTarget" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
          ${classOptions.map(c=>`<option value="${c}" ${s.classTarget===c ? 'selected' : ''}>${c}</option>`).join('')}
        </select>
      </div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition w-full">Update</button>
      </div>
    </form>
  `);

  document.getElementById("editScheduleDate").addEventListener("change", ()=>{
    document.getElementById("editScheduleDay").value = getDayNameFromDate(document.getElementById("editScheduleDate").value);
  });

  document.getElementById("editScheduleForm_v2").onsubmit = e => {
    e.preventDefault();
    scheduleData[idx] = {
      ...scheduleData[idx],
      date: document.getElementById("editScheduleDate").value,
      time: document.getElementById("editScheduleTime").value,
      day: document.getElementById("editScheduleDay").value || getDayNameFromDate(document.getElementById("editScheduleDate").value),
      subject: document.getElementById("editScheduleSubject").value,
      classTarget: document.getElementById("editScheduleClassTarget").value
    };
    try { saveAllData(); } catch(e){ console.warn(e); }
    closeModal();
    showNotification("Jadwal belajar berhasil diperbarui!", "success");
    loadSchedule();
  };
}

// Delete schedule helper for schedule module
function deleteSchedule(id) {
  if (!confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) return;
  scheduleData = scheduleData.filter(s => String(s.id) !== String(id));
  try { saveAllData(); } catch(e){ console.warn(e); }
  showNotification("Jadwal belajar berhasil dihapus!", "success");
  loadSchedule();
}

// Ensure initial modules exist - don't override if other functions present elsewhere
if (typeof window.loadActivitySchedule === 'undefined' || window.loadActivitySchedule.toString().includes('BEGIN: Injected') ) {
  window.loadActivitySchedule = loadActivitySchedule;
}
window.openAddActivityModal = openAddActivityModal;
window.editActivity = editActivity;
window.deleteActivity = deleteActivity;

window.loadSchedule = loadSchedule;
window.openAddScheduleModal = openAddScheduleModal;
window.editSchedule = editSchedule;
window.deleteSchedule = deleteSchedule;

// If currently viewing relevant module, refresh it
if (typeof currentModule !== 'undefined') {
  if (currentModule === 'activitySchedule') loadActivitySchedule();
  if (currentModule === 'schedule') loadSchedule();
}
</script>
<!-- END: Injected by assistant -->
<script type="module">
function smoothUpdateTable(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) return;
  section.style.opacity = 0;
  section.style.transition = "opacity 0.4s ease";
  setTimeout(() => {
    section.style.opacity = 1;
  }, 200);
  section.scrollIntoView({ behavior: "smooth", block: "start" });
}

// Integrate smooth update into filter functions
const originalFilterArt = window.filterArtProgressByClass;
window.filterArtProgressByClass = function(cls) {
  originalFilterArt(cls);
  smoothUpdateTable('artProgressSection');
};
const originalFilterSkol = window.filterSkolastikByClass;
window.filterSkolastikByClass = function(cls) {
  originalFilterSkol(cls);
  smoothUpdateTable('skolastikSection');
};
const originalFilterTka = window.filterTkaByClass;
window.filterTkaByClass = function(cls) {
  originalFilterTka(cls);
  smoothUpdateTable('tkaSection');
};
const originalFilterMaterial = window.filterMaterialByClass;
window.filterMaterialByClass = function(cls) {
  originalFilterMaterial(cls);
  smoothUpdateTable('materialSection');
};

// Responsive tweaks for dropdowns
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('select').forEach(sel => {
    sel.classList.add('w-full', 'sm:w-1/2', 'md:w-1/3');
  });
});
</script>
<!-- === FITUR ZOOM INTERAKTIF PRO (KHUSUS SISWA) 
<style>
  #zoomModal {
    display: none;
    position: fixed;
    z-index: 9999;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    justify-content: center;
    align-items: center;
    transition: opacity 0.3s ease;
  }
  #zoomModal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(255,255,255,0.4);
    transition: transform 0.3s ease;
  }
  #zoomPrev, #zoomNext {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: white;
    font-size: 3rem;
    cursor: pointer;
    user-select: none;
    padding: 0 20px;
    transition: opacity 0.2s;
  }
  #zoomPrev:hover, #zoomNext:hover {
    opacity: 0.7;
  }
  #zoomPrev { left: 20px; }
  #zoomNext { right: 20px; }
</style>

<div id="zoomModal" onclick="closeZoom(event)">
  <span id="zoomPrev" onclick="prevZoom(event)">&#10094;</span>
  <img id="zoomImage" src="" alt="Zoomed Artwork" />
  <span id="zoomNext" onclick="nextZoom(event)">&#10095;</span>
</div>

<script>
  let currentZoomIndex = 0;
  let zoomImages = [];

  function enableZoomForStudent() {
    if (currentUser && currentUser.role === 'Siswa') {
      zoomImages = Array.from(document.querySelectorAll('#contentArea img'));
      zoomImages.forEach((img, index) => {
        img.dataset.index = index;
        img.style.cursor = 'zoom-in';
        img.addEventListener('click', () => openZoom(index));
      });
    }
  }

  function openZoom(index) {
    currentZoomIndex = index;
    const zoomModal = document.getElementById('zoomModal');
    const zoomImage = document.getElementById('zoomImage');
    zoomImage.src = zoomImages[index].src;
    zoomModal.style.display = 'flex';
  }

  function closeZoom(event) {
    if (event.target.id === 'zoomModal' || event.key === 'Escape') {
      document.getElementById('zoomModal').style.display = 'none';
    }
  }

  function prevZoom(event) {
    event.stopPropagation();
    if (zoomImages.length === 0) return;
    currentZoomIndex = (currentZoomIndex - 1 + zoomImages.length) % zoomImages.length;
    document.getElementById('zoomImage').src = zoomImages[currentZoomIndex].src;
  }

  function nextZoom(event) {
    event.stopPropagation();
    if (zoomImages.length === 0) return;
    currentZoomIndex = (currentZoomIndex + 1) % zoomImages.length;
    document.getElementById('zoomImage').src = zoomImages[currentZoomIndex].src;
  }

  document.addEventListener('keydown', e => {
    if (document.getElementById('zoomModal').style.display === 'flex') {
      if (e.key === 'ArrowLeft') prevZoom(e);
      if (e.key === 'ArrowRight') nextZoom(e);
      if (e.key === 'Escape') closeZoom(e);
    }
  });

  const originalLoadArtProgress = window.loadArtProgress;
  window.loadArtProgress = function() {
    originalLoadArtProgress();
    setTimeout(() => enableZoomForStudent(), 500);
  };
</script>
<!-- === AKHIR FITUR ZOOM INTERAKTIF PRO 
  
<style>
  #zoomModal {
    display: none;
    position: fixed;
    z-index: 9999;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    justify-content: center;
    align-items: center;
  }
  #zoomModal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 10px;
    box-shadow: 0 0 25px rgba(255,255,255,0.3);
  }
</style>

<div id="zoomModal" onclick="closeZoom()">
  <img id="zoomImage" src="" alt="Zoomed Artwork" />
</div>

<script>
  function enableZoomForStudent() {
    if (currentUser && currentUser.role === 'Siswa') {
      document.querySelectorAll('#contentArea img').forEach(img => {
        img.style.cursor = 'zoom-in';
        img.addEventListener('click', () => openZoom(img.src));
      });
    }
  }

  function openZoom(src) {
    const zoomModal = document.getElementById('zoomModal');
    const zoomImage = document.getElementById('zoomImage');
    zoomImage.src = src;
    zoomModal.style.display = 'flex';
  }

  function closeZoom() {
    document.getElementById('zoomModal').style.display = 'none';
  }

  // Integrasi otomatis dengan modul Kemajuan Gambar
  const originalLoadArtProgress = window.loadArtProgress;
  window.loadArtProgress = function() {
    originalLoadArtProgress();
    setTimeout(() => enableZoomForStudent(), 500);
  };
</script>
<!-- === AKHIR FITUR ZOOM KHUSUS SISWA 


<!-- === FITUR ZOOM INTERAKTIF PRO (KHUSUS SISWA) === -->
<style>
  #zoomModal {
    display: none;
    position: fixed;
    z-index: 9999;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    justify-content: center;
    align-items: center;
    transition: opacity 0.3s ease;
  }
  #zoomModal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(255,255,255,0.4);
    transition: transform 0.3s ease;
  }
  #zoomPrev, #zoomNext {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: white;
    font-size: 3rem;
    cursor: pointer;
    user-select: none;
    padding: 0 20px;
    transition: opacity 0.2s;
  }
  #zoomPrev:hover, #zoomNext:hover { opacity: 0.7; }
  #zoomPrev { left: 20px; }
  #zoomNext { right: 20px; }
</style>
<div id="zoomModal" onclick="closeZoom(event)">
<span id="zoomPrev" onclick="prevZoom(event)">‚ùÆ</span>
<img alt="Zoomed Artwork" id="zoomImage" src=""/>
<span id="zoomNext" onclick="nextZoom(event)">‚ùØ</span>
</div>
<script type="module">
  let currentZoomIndex = 0;
  let zoomImages = [];

  function enableZoomForStudent() {
    if (currentUser && currentUser.role === 'Siswa') {
      zoomImages = Array.from(document.querySelectorAll('#contentArea img'));
      zoomImages.forEach((img, index) => {
        img.dataset.index = index;
        img.style.cursor = 'zoom-in';
        img.addEventListener('click', () => openZoom(index));
      });
    }
  }

  function openZoom(index) {
    currentZoomIndex = index;
    const zoomModal = document.getElementById('zoomModal');
    const zoomImage = document.getElementById('zoomImage');
    zoomImage.src = zoomImages[index].src;
    zoomModal.style.display = 'flex';
  }

  function closeZoom(event) {
    if (event.target.id === 'zoomModal' || event.key === 'Escape') {
      document.getElementById('zoomModal').style.display = 'none';
    }
  }

  function prevZoom(event) {
    event.stopPropagation();
    if (zoomImages.length === 0) return;
    currentZoomIndex = (currentZoomIndex - 1 + zoomImages.length) % zoomImages.length;
    document.getElementById('zoomImage').src = zoomImages[currentZoomIndex].src;
  }

  function nextZoom(event) {
    event.stopPropagation();
    if (zoomImages.length === 0) return;
    currentZoomIndex = (currentZoomIndex + 1) % zoomImages.length;
    document.getElementById('zoomImage').src = zoomImages[currentZoomIndex].src;
  }

  document.addEventListener('keydown', e => {
    if (document.getElementById('zoomModal').style.display === 'flex') {
      if (e.key === 'ArrowLeft') prevZoom(e);
      if (e.key === 'ArrowRight') nextZoom(e);
      if (e.key === 'Escape') closeZoom(e);
    }
  });

  const originalLoadArtProgress = window.loadArtProgress;
  window.loadArtProgress = function() {
    originalLoadArtProgress();
    setTimeout(() => enableZoomForStudent(), 500);
  };
</script>
<!-- === AKHIR FITUR ZOOM INTERAKTIF PRO === -->
<!-- === FITUR FILTER KELAS & BATASAN VISIBILITAS SISWA === -->
<script type="module">
  // Daftar kelas contoh (bisa diganti dari database nanti)
  const daftarKelas = ['SR GOLD A', 'SR GOLD B', 'SR SILVER', 'SR PLATINUM'];

  // Utility render dropdown kelas
  function renderDropdownKelas(targetId) {
    const container = document.getElementById(targetId);
    if (!container) return;
    let html = '<label class="block mb-1 text-sm font-medium">Filter Kelas:</label>';
    html += '<select id="filterKelasSelect" class="border rounded p-2 w-full mb-2">';
    daftarKelas.forEach(kls => html += `<option value="${kls}">${kls}</option>`);
    html += '</select>';
    html += '<label class="flex items-center gap-2"><input type="checkbox" id="showAllKelas"> Tampilkan semua kelas</label>';
    container.innerHTML = html;

    document.getElementById('filterKelasSelect').addEventListener('change', applyKelasFilter);
    document.getElementById('showAllKelas').addEventListener('change', applyKelasFilter);
  }

  // Terapkan filter ke modul sesuai kelas siswa atau pilihan admin
  function applyKelasFilter() {
    const select = document.getElementById('filterKelasSelect');
    const showAll = document.getElementById('showAllKelas').checked;
    const kelasDipilih = select ? select.value : null;
    const userRole = currentUser?.role || '';
    const userKelas = currentUser?.kelas || '';

    document.querySelectorAll('[data-kelas]').forEach(row => {
      const kelasData = row.dataset.kelas;
      if (userRole === 'Admin Regional') {
        row.style.display = showAll || kelasData === kelasDipilih ? '' : 'none';
      } else if (userRole === 'Siswa') {
        row.style.display = kelasData === userKelas ? '' : 'none';
      }
    });
  }

  // Injek filter ke 3 modul target
  const originalLoadJadwalBelajar = window.loadJadwalBelajar;
  window.loadJadwalBelajar = function() {
    originalLoadJadwalBelajar();
    renderDropdownKelas('filterKelasJadwalBelajar');
    setTimeout(applyKelasFilter, 500);
  };

  const originalLoadJadwalKegiatan = window.loadJadwalKegiatan;
  window.loadJadwalKegiatan = function() {
    originalLoadJadwalKegiatan();
    renderDropdownKelas('filterKelasJadwalKegiatan');
    setTimeout(applyKelasFilter, 500);
  };

  const originalLoadMateriKelas = window.loadMateriKelas;
  window.loadMateriKelas = function() {
    originalLoadMateriKelas();
    renderDropdownKelas('filterKelasMateriKelas');
    setTimeout(applyKelasFilter, 500);
  };
</script>
<!-- === AKHIR FITUR FILTER KELAS === -->
<!-- === PENYEMPURNAAN FILTER KELAS UNTUK SEMUA MODUL === -->
<script type="module">
  const daftarKelas_2 = ['SR GOLD A', 'SR GOLD B', 'SR SILVER', 'SR PLATINUM'];

  function renderDropdownKelas(targetId, modulName) {
    const container = document.getElementById(targetId);
    if (!container) return;

    let html = '<label class="block mb-1 text-sm font-medium">Filter Kelas:</label>';
    html += '<select id="filterKelasSelect_' + modulName + '" class="border rounded p-2 w-full mb-2">';
    daftarKelas.forEach(kls => html += `<option value="${kls}">${kls}</option>`);
    html += '</select>';
    html += '<label class="flex items-center gap-2"><input type="checkbox" id="showAllKelas_' + modulName + '"> Tampilkan semua kelas</label>';
    container.innerHTML = html;

    document.getElementById('filterKelasSelect_' + modulName).addEventListener('change', () => applyKelasFilter(modulName));
    document.getElementById('showAllKelas_' + modulName).addEventListener('change', () => applyKelasFilter(modulName));
  }

  function applyKelasFilter(modulName) {
    const select = document.getElementById('filterKelasSelect_' + modulName);
    const showAll = document.getElementById('showAllKelas_' + modulName)?.checked;
    const kelasDipilih = select ? select.value : null;
    const userRole = currentUser?.role || '';
    const userKelas = currentUser?.kelas || '';

    document.querySelectorAll('[data-modul="' + modulName + '"][data-kelas]').forEach(row => {
      const kelasData = row.dataset.kelas;
      if (userRole === 'Admin Regional') {
        row.style.display = showAll || kelasData === kelasDipilih ? '' : 'none';
      } else if (userRole === 'Siswa') {
        row.style.display = kelasData === userKelas ? '' : 'none';
      }
    });
  }

  // Integrasi ke tiga modul dengan gaya Materi Kelas
  const originalLoadJadwalBelajar_2 = window.loadJadwalBelajar;
  window.loadJadwalBelajar = function() {
    originalLoadJadwalBelajar();
    renderDropdownKelas('filterKelasJadwalBelajar', 'jadwalBelajar');
    setTimeout(() => applyKelasFilter('jadwalBelajar'), 500);
  };

  const originalLoadJadwalKegiatan_2 = window.loadJadwalKegiatan;
  window.loadJadwalKegiatan = function() {
    originalLoadJadwalKegiatan();
    renderDropdownKelas('filterKelasJadwalKegiatan', 'jadwalKegiatan');
    setTimeout(() => applyKelasFilter('jadwalKegiatan'), 500);
  };

  const originalLoadMateriKelas_2 = window.loadMateriKelas;
  window.loadMateriKelas = function() {
    originalLoadMateriKelas();
    renderDropdownKelas('filterKelasMateriKelas', 'materiKelas');
    setTimeout(() => applyKelasFilter('materiKelas'), 500);
  };
</script>
<!-- === AKHIR PENYEMPURNAAN FILTER KELAS === -->
<!-- === FINAL FILTER DROPDOWN + CHECKLIST UNTUK SEMUA MODUL === -->
<script type="module">
const daftarKelas_3as = [
    'Kelas SR GOLD A (Cabang Jakarta Selatan)',
    'Kelas SR GOLD B (Cabang Jakarta Selatan)',
    'Kelas SR SILVER (Cabang Bandung)',
    'Kelas SR PLATINUM (Cabang Surabaya)'
  ];

  function renderFilterKelas(containerId, modulName) {
    const container = document.getElementById(containerId);
    if (!container) return;

    let html = '<div class="mb-2">';
    html += '<label class="block mb-1 text-sm font-medium">Kelas Relevan</label>';
    daftarKelas.forEach(kls => {
      const id = `${modulName}_${kls.replace(/\s+/g, '_')}`;
      html += `<div class='flex items-center gap-2 mb-1'><input type='checkbox' id='${id}' value='${kls}' class='kelasCheckbox_${modulName}'> <label for='${id}'>${kls}</label></div>`;
    });
    html += '</div>';
    container.innerHTML = html;

    // Tambah event listener agar otomatis filter
    document.querySelectorAll('.kelasCheckbox_' + modulName).forEach(cb => {
      cb.addEventListener('change', () => applyFilterKelas(modulName));
    });
  }

  function applyFilterKelas(modulName) {
    const userRole = currentUser?.role || '';
    const userKelas = currentUser?.kelas || '';
    const selected = Array.from(document.querySelectorAll('.kelasCheckbox_' + modulName + ':checked')).map(cb => cb.value);

    document.querySelectorAll('[data-modul="' + modulName + '"][data-kelas]').forEach(row => {
      const kelasData = row.dataset.kelas;
      if (userRole === 'Admin Regional') {
        row.style.display = selected.length === 0 || selected.includes(kelasData) ? '' : 'none';
      } else if (userRole === 'Siswa') {
        row.style.display = kelasData === userKelas ? '' : 'none';
      }
    });
  }

  // Integrasi ke tiga modul: belajar, kegiatan, materi
const originalLoadJadwalBelajar_3ar = window.loadJadwalBelajar;
  window.loadJadwalBelajar = function() {
    originalLoadJadwalBelajar();
    renderFilterKelas('filterKelasJadwalBelajar', 'jadwalBelajar');
    setTimeout(() => applyFilterKelas('jadwalBelajar'), 500);
  };

const originalLoadJadwalKegiatan_3an = window.loadJadwalKegiatan;
  window.loadJadwalKegiatan = function() {
    originalLoadJadwalKegiatan();
    renderFilterKelas('filterKelasJadwalKegiatan', 'jadwalKegiatan');
    setTimeout(() => applyFilterKelas('jadwalKegiatan'), 500);
  };

const originalLoadMateriKelas_3as = window.loadMateriKelas;
  window.loadMateriKelas = function() {
    originalLoadMateriKelas();
    renderFilterKelas('filterKelasMateriKelas', 'materiKelas');
    setTimeout(() => applyFilterKelas('materiKelas'), 500);
  };
</script>
<!-- === AKHIR FILTER DROPDOWN + CHECKLIST FINAL === -->
<!-- === PERBAIKAN FINAL MODUL JADWAL BELAJAR (FILTER KELAS AKTIF) === -->
<script type="module">
  const daftarKelasBelajar = [
    'Kelas SR GOLD A (Cabang Jakarta Selatan)',
    'Kelas SR GOLD B (Cabang Jakarta Selatan)',
    'Kelas SR SILVER (Cabang Bandung)',
    'Kelas SR PLATINUM (Cabang Surabaya)'
  ];

  function renderFilterKelasBelajar(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    let html = '<div class="mb-2">';
    html += '<label class="block mb-1 text-sm font-medium">Kelas Relevan</label>';
    daftarKelasBelajar.forEach(kls => {
      const id = 'jadwalBelajar_' + kls.replace(/\s+/g, '_');
      html += `<div class='flex items-center gap-2 mb-1'><input type='checkbox' id='${id}' value='${kls}' class='kelasCheckbox_jadwalBelajar'> <label for='${id}'>${kls}</label></div>`;
    });
    html += '</div>';
    container.innerHTML = html;

    document.querySelectorAll('.kelasCheckbox_jadwalBelajar').forEach(cb => {
      cb.addEventListener('change', applyFilterKelasBelajar);
    });
  }

  function applyFilterKelasBelajar() {
    const userRole = currentUser?.role || '';
    const userKelas = currentUser?.kelas || '';
    const selected = Array.from(document.querySelectorAll('.kelasCheckbox_jadwalBelajar:checked')).map(cb => cb.value);

    document.querySelectorAll('[data-modul="jadwalBelajar"][data-kelas]').forEach(row => {
      const kelasData = row.dataset.kelas;
      if (userRole === 'Admin Regional') {
        row.style.display = selected.length === 0 || selected.includes(kelasData) ? '' : 'none';
      } else if (userRole === 'Siswa') {
        row.style.display = kelasData === userKelas ? '' : 'none';
      }
    });
  }

  // Rebuild fungsi loadSchedule agar gunakan filter baru
  const originalLoadSchedule = window.loadSchedule;
  window.loadSchedule = function() {
    originalLoadSchedule();
    renderFilterKelasBelajar('filterKelasJadwalBelajar');
    setTimeout(applyFilterKelasBelajar, 500);
  };
</script>
<!-- === AKHIR PERBAIKAN MODUL JADWAL BELAJAR === -->
<!-- === PERBAIKAN AKHIR MODUL JADWAL BELAJAR (SAMA DENGAN JADWAL KEGIATAN) === -->
<script type="module">
  const daftarKelasSchedule = [
    'Kelas SR GOLD A (Cabang Jakarta Selatan)',
    'Kelas SR GOLD B (Cabang Jakarta Selatan)',
    'Kelas SR SILVER (Cabang Bandung)',
    'Kelas SR PLATINUM (Cabang Surabaya)'
  ];

  function renderFilterKelasSchedule(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    let html = '<div class="mb-2">';
    html += '<label class="block mb-1 text-sm font-medium">Filter Kelas Jadwal Belajar</label>';
    daftarKelasSchedule.forEach(kls => {
      const id = 'jadwalBelajar_' + kls.replace(/\s+/g, '_');
      html += `<div class='flex items-center gap-2 mb-1'>
                 <input type='checkbox' id='${id}' value='${kls}' class='kelasCheckbox_jadwalBelajar'> 
                 <label for='${id}'>${kls}</label>
               </div>`;
    });
    html += '</div>';
    container.innerHTML = html;

    document.querySelectorAll('.kelasCheckbox_jadwalBelajar').forEach(cb => {
      cb.addEventListener('change', applyFilterKelasSchedule);
    });
  }

  function applyFilterKelasSchedule() {
    const userRole = currentUser?.role || '';
    const userKelas = currentUser?.kelas || '';
    const selected = Array.from(document.querySelectorAll('.kelasCheckbox_jadwalBelajar:checked')).map(cb => cb.value);

    document.querySelectorAll('[data-modul="jadwalBelajar"][data-kelas]').forEach(row => {
      const kelasData = row.dataset.kelas;
      if (userRole === 'Admin Regional') {
        row.style.display = selected.length === 0 || selected.includes(kelasData) ? '' : 'none';
      } else if (userRole === 'Siswa') {
        row.style.display = kelasData === userKelas ? '' : 'none';
      }
    });
  }

  // Perbarui fungsi loadSchedule agar identik dengan loadJadwalKegiatan
  const originalLoadSchedule_2 = window.loadSchedule;
  window.loadSchedule = function() {
    originalLoadSchedule();
    renderFilterKelasSchedule('filterKelasJadwalBelajar');
    setTimeout(() => applyFilterKelasSchedule(), 500);
  };
</script>
<!-- === AKHIR PERBAIKAN MODUL JADWAL BELAJAR === -->
<!-- BEGIN: Injected Fix ‚Äî Regionalize Jadwal Belajar (LKS_141_ScheduleFix) -->
<script type="module">
(function(){
  // Safety: ensure arrays exist
  if (typeof scheduleData === 'undefined') scheduleData = [];
  if (typeof availableClasses === 'undefined') availableClasses = [];
  if (typeof studentsData === 'undefined') studentsData = [];

  function getDayNameFromDate(isoDate){
    const d = new Date(isoDate);
    if (isNaN(d)) return '';
    const days = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
    return days[d.getDay()];
  }

  // Helper notification (uses existing showNotification if present)
  function notify(msg, type){
    if (typeof showNotification === 'function') return showNotification(msg, type || 'success');
    alert(msg);
  }

  // Enforce: Admin regional hanya melihat/CRUD untuk region sendiri.
  // Siswa hanya melihat jadwal yang ada di schedule.classes === siswa.class AND schedule.region === siswa.region
  window.loadSchedule = function(){
    const content = document.getElementById("contentArea");
    if(!content) return;
    const isAdminOrSuperAdmin = currentUser && (currentUser.role === 'Admin' || currentUser.role === 'Super Admin');
    const isStudent = currentUser && currentUser.role === 'Siswa';

    // Prepare regional filtering
    let regionalSchedule = scheduleData;
    let regionTitle = '';
    if (currentUser && currentUser.role === 'Admin') {
      regionalSchedule = scheduleData.filter(s => s.region === currentUser.region);
      regionTitle = `Regional ${currentUser.region}`;
    } else if (currentUser && currentUser.role === 'Super Admin') {
      regionalSchedule = scheduleData;
      regionTitle = 'Semua Regional';
    } else if (currentUser && currentUser.role === 'Siswa') {
      regionalSchedule = scheduleData.filter(s => s.region === currentUser.region);
      regionTitle = `Regional ${currentUser.region}`;
    }

    // For students, filter further by their class
    let filtered = regionalSchedule.slice();
    if (isStudent) {
      const stu = studentsData.find(s => s.username === currentUser.username || s.name === currentUser.name);
      const stuClass = stu ? stu.class : null;
      if (stuClass) {
        filtered = filtered.filter(s => Array.isArray(s.classes) ? s.classes.includes(stuClass) : (s.classTarget ? s.classTarget === stuClass : true));
      } else {
        // if no class info, show none
        filtered = [];
      }
    }

    // For admins/superadmin we can optionally filter by selectedClassSchedule (keeps existing behavior)
    const selectedFilter = window.selectedClassSchedule || 'all';
    if (isAdminOrSuperAdmin && selectedFilter && selectedFilter !== 'all') {
      filtered = filtered.filter(s => (s.classes && s.classes.includes(selectedFilter)) || s.classTarget === selectedFilter);
    }

    // Normalize and sort
    filtered = filtered.map(s => ({
      id: s.id,
      date: s.date || '',
      day: s.day || getDayNameFromDate(s.date || ''),
      time: s.time || s.time || '',
      subject: s.subject || s.title || '',
      classes: s.classes || (s.classTarget ? [s.classTarget] : []),
      region: s.region || ''
    })).sort((a,b) => (a.date || '').localeCompare(b.date || ''));

    // Render
    content.innerHTML = `
      <div class="fade-in">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900 flex items-center"><span class="text-3xl mr-2">üìö</span> Jadwal Belajar ${regionTitle ? '('+regionTitle+')' : ''}</h2>
          ${(currentUser && (currentUser.role === 'Admin' || currentUser.role === 'Super Admin')) ? '<button onclick="openAddScheduleModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">+ Tambah Jadwal</button>' : ''}
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-blue-800 text-white">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Tanggal</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-white-700text-gray-900">Hari</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-white-700text-gray-900">Waktu</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Materi</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Kelas</th>
                  
                  <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>
                 
                </tr>
              </thead>
              <tbody id="scheduleTableBody" class="bg-white">
                ${filtered.map(s => `
                  <tr class="border-t border-gray-200 hover:bg-blue-50">
                    <td class="px-4 py-3 text-sm text-gray-700">${s.date}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${s.day}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${s.time || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${s.subject}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${(s.classes && s.classes.length) ? s.classes.join(', ') : '-'}</td>
                    
                    <td class="px-4 py-3 text-sm">
                      ${ (currentUser && (currentUser.role === 'Admin' || currentUser.role === 'Super Admin')) ? 
                        `<button onclick="editSchedule(${s.id})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                         <button onclick="deleteSchedule(${s.id})" class="text-red-600 hover:text-red-800">Hapus</button>` : '-' }
                    </td>
                    
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  };

  // When creating a schedule, Admin regional's schedule.region must be their region.
  window.openAddScheduleModal = function() {
    // Build class options limited to current region (for admin) or all for superadmin
    const classesForRegion = (availableClasses || []).filter(c => !currentUser || currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c => c.name);
    const classOptionsHtml = classesForRegion.map(c => `<option value="${c}">${c}</option>`).join('');
    const defaultRegion = currentUser && currentUser.region ? currentUser.region : '';

    const modalHtml = `
      <form id="addScheduleForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
          <input type="date" id="scheduleDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
          <input type="text" id="scheduleTime" placeholder="Contoh: 09.00 - 11.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Materi</label>
          <input type="text" id="scheduleSubject" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Kelas (opsional - pilih untuk menargetkan kelas tertentu)</label>
          <select id="scheduleClasses" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            ${classOptionsHtml}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
          <input type="text" id="scheduleRegion" value="${defaultRegion}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
        </div>
        <div>
          <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
        </div>
      </form>
    `;
    openModal('Tambah Jadwal Belajar', modalHtml);

    document.getElementById('addScheduleForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const newObj = {
        id: Date.now(),
        date: document.getElementById('scheduleDate').value,
        day: getDayNameFromDate(document.getElementById('scheduleDate').value),
        time: document.getElementById('scheduleTime').value,
        subject: document.getElementById('scheduleSubject').value,
        classes: Array.from(document.getElementById('scheduleClasses').selectedOptions).map(o=>o.value),
        region: currentUser && currentUser.role === 'Admin' ? currentUser.region : (document.getElementById('scheduleRegion').value || '')
      };
      // Save
      scheduleData.push(newObj);
      try{ saveAllData(); } catch(e){ console.warn(e); }
      closeModal();
      notify('Jadwal berhasil ditambahkan!', 'success');
      if (typeof loadSchedule === 'function') loadSchedule();
    });
  };

  // Edit schedule but restrict editing to own region for Admins
  window.editSchedule = function(id){
    const idx = scheduleData.findIndex(s => String(s.id) === String(id));
    if (idx === -1) { notify('Jadwal tidak ditemukan','error'); return; }
    const s = scheduleData[idx];
    if (currentUser && currentUser.role === 'Admin' && s.region !== currentUser.region) {
      notify('Akses ditolak: Anda hanya dapat mengedit jadwal di regional Anda sendiri','error');
      return;
    }

    const classesForRegion = (availableClasses || []).filter(c => !currentUser || currentUser.role === 'Super Admin' || c.region === s.region).map(c => c.name);
    const classOptionsHtml = classesForRegion.map(c => `<option value="${c}" ${ (s.classes||[]).includes(c) ? 'selected' : '' }>${c}</option>`).join('');

    const modalHtml = `
      <form id="editScheduleForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
          <input type="date" id="editScheduleDate" value="${s.date || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
          <input type="text" id="editScheduleTime" value="${s.time || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Materi</label>
          <input type="text" id="editScheduleSubject" value="${s.subject || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Kelas (opsional)</label>
          <select id="editScheduleClasses" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            ${classOptionsHtml}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
          <input type="text" id="editScheduleRegion" value="${s.region || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
        </div>
        <div>
          <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
        </div>
      </form>
    `;
    openModal('Edit Jadwal Belajar', modalHtml);

    document.getElementById('editScheduleForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      scheduleData[idx] = {
        ...scheduleData[idx],
        date: document.getElementById('editScheduleDate').value,
        day: getDayNameFromDate(document.getElementById('editScheduleDate').value),
        time: document.getElementById('editScheduleTime').value,
        subject: document.getElementById('editScheduleSubject').value,
        classes: Array.from(document.getElementById('editScheduleClasses').selectedOptions).map(o=>o.value),
        // region must not be changed by admin (readonly)
        region: scheduleData[idx].region || (currentUser && currentUser.region ? currentUser.region : '')
      };
      try{ saveAllData(); } catch(e){ console.warn(e); }
      closeModal();
      notify('Jadwal berhasil diperbarui!', 'success');
      if (typeof loadSchedule === 'function') loadSchedule();
    });
  };

  // Delete schedule - restrict to admin's region
  window.deleteSchedule = function(id){
    const idx = scheduleData.findIndex(s => String(s.id) === String(id));
    if (idx === -1) return;
    const s = scheduleData[idx];
    if (currentUser && currentUser.role === 'Admin' && s.region !== currentUser.region) {
      notify('Akses ditolak: Anda hanya dapat menghapus jadwal di regional Anda sendiri','error');
      return;
    }
    if (!confirm('Apakah Anda yakin ingin menghapus jadwal ini?')) return;
    scheduleData.splice(idx,1);
    try{ saveAllData(); } catch(e){ console.warn(e); }
    notify('Jadwal belajar berhasil dihapus!', 'success');
    if (typeof loadSchedule === 'function') loadSchedule();
  };

  // If page currently on schedule, refresh
  try {
    if (currentModule === 'schedule') loadSchedule();
  } catch(e){}
})();
</script>
<!-- END: Injected Fix ‚Äî Regionalize Jadwal Belajar -->
<script type="module">
// --- FIX: Modul Kelola Kelas ---
function loadManageClasses() {
  const content = document.getElementById('contentArea');
  let filteredClasses = availableClasses;

  if (currentUser.role === 'Admin') {
    filteredClasses = availableClasses.filter(cls => cls.region === currentUser.region);
  }

  content.innerHTML = `
    <div class="fade-in">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">üè´ Kelola Kelas</h2>
        <button onclick="addClass()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Kelas</button>
      </div>

      <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Daftar Kelas (${filteredClasses.length})</h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-blue-800 text-white">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nama Kelas</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Deskripsi</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Regional</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>
              </tr>
            </thead>
            <tbody class="bg-white">
              ${filteredClasses.map(cls => `
                <tr class="border-t border-gray-200 hover:bg-blue-50">
                  <td class="px-4 py-3 text-sm font-medium text-gray-900">${cls.name}</td>
                  <td class="px-4 py-3 text-sm text-gray-600">${cls.description}</td>
                  <td class="px-4 py-3 text-sm text-blue-600 font-medium">${cls.region}</td>
                  <td class="px-4 py-3 text-sm">
                    ${ (currentUser.role === 'Super Admin' || cls.region === currentUser.region) ? `<button onclick="editClass(${cls.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                    <button onclick="deleteClass(${cls.id})" class="text-red-600 hover:text-red-800">Hapus</button>` : `<span class="text-gray-400">-</span>`}
                  </td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
}

// Fungsi Tambah Kelas
function addClass() {
  openModal('Tambah Kelas Baru', `
    <form id="addClassForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
        <input type="text" id="className" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
        <textarea id="classDesc" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
        <input type="text" id="classRegion" value="${currentUser.role === 'Admin' ? currentUser.region : ''}" ${currentUser.role === 'Admin' ? 'readonly' : ''} class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
    </form>`);

  document.getElementById('addClassForm').addEventListener('submit', e => {
    e.preventDefault();
    const name = document.getElementById('className').value.trim();
    const description = document.getElementById('classDesc').value.trim();
    const region = document.getElementById('classRegion').value.trim();
    
    if (!name || !description || !region) {
      showNotification('Semua field wajib diisi', 'error');
      return;
    }

    const newClass = { id: Date.now(), name, description, region };
    availableClasses.push(newClass);
    saveAllData();
    // dispatch real-time update
    document.dispatchEvent(new CustomEvent('kelasUpdated', { detail: { availableClasses: availableClasses } }));
    closeModal();
    loadManageClasses();
    showNotification('Kelas baru berhasil ditambahkan!', 'success');
  });
}

// Fungsi Edit Kelas
window.editClass = function(id) {
  const cls = availableClasses.find(c => c.id === id);
  if (!cls) return;
  openModal('Edit Kelas', `
    <form id="editClassForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
        <input type="text" id="editName" value="${cls.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
        <textarea id="editDesc" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">${cls.description}</textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
        <input type="text" id="editRegion" value="${cls.region}" ${currentUser.role === 'Admin' ? 'readonly' : ''} class="w-full px-3 py-2 border border-gray-300 rounded-lg">
      </div>
      <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
    </form>`);

  document.getElementById('editClassForm').addEventListener('submit', e => {
    e.preventDefault();
    cls.name = document.getElementById('editName').value.trim();
    cls.description = document.getElementById('editDesc').value.trim();
    if (currentUser.role !== 'Admin') {
      cls.region = document.getElementById('editRegion').value.trim();
    }
    saveAllData();
    // dispatch real-time update
    document.dispatchEvent(new CustomEvent('kelasUpdated', { detail: { availableClasses: availableClasses } }));
    closeModal();
    loadManageClasses();
    showNotification('Kelas berhasil diperbarui!', 'success');
  });
};

// Fungsi Hapus Kelas
window.deleteClass = function(id) {
  const cls = availableClasses.find(c => c.id === id);
  if (!cls) return;
  openModal('Konfirmasi Hapus', `
    <div class="text-center">
      <p class="mb-4 text-gray-700">Apakah Anda yakin ingin menghapus kelas <strong>${cls.name}</strong>?</p>
      <div class="flex space-x-3">
        <button id="confirmDelete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Batal</button>
      </div>
    </div>`);

  document.getElementById('confirmDelete').addEventListener('click', () => {
    availableClasses = availableClasses.filter(c => c.id !== id);
    saveAllData();
    // dispatch real-time update
    document.dispatchEvent(new CustomEvent('kelasUpdated', { detail: { availableClasses: availableClasses } }));
    closeModal();
    loadManageClasses();
    showNotification('Kelas berhasil dihapus!', 'success');
  });
};
</script>
<script type="module">
// Real-time sync: listener untuk memperbarui dropdown di modul Jadwal Kegiatan / Jadwal Kegiatan (Activity)
function buildClassOptionsForRegion(region, includeAllOption = true) {
    const classes = (availableClasses || []).filter(c => region === 'all' || !region ? true : c.region === region);
    let opts = '';
    if (includeAllOption) opts += '<option value="all">Semua Kelas</option>';
    classes.forEach(c => {
        opts += `<option value="${c.name}">${c.name}</option>`;
    });
    return { html: opts, classes };
}

function refreshActivityClassDropdown() {
    // update any select elements that depend on availableClasses
    // common IDs used in schedule/activity modules: classFilterSchedule, classFilterActivity, activityClassSelect, filterClass
    const region = (currentUser && currentUser.role === 'Admin') ? currentUser.region : (document.getElementById('filterRegion') ? document.getElementById('filterRegion').value : 'all');
    const opts = buildClassOptionsForRegion(region, true).html;
    ['classFilterSchedule','classFilterActivity','activityClassSelect','filterClass','classFilterSchedule'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) {
            el.innerHTML = opts;
        }
    });
}

// Dengarkan event update kelas
document.addEventListener('kelasUpdated', function(e) {
    // rebuild dropdowns where necessary
    refreshActivityClassDropdown();
});

// Pastikan dropdown tersinkron ketika halaman siap dan setelah loadManageClasses dipanggil
document.addEventListener('DOMContentLoaded', function(){
    refreshActivityClassDropdown();
});
</script>
<script type="module">
// === FILTER REGIONAL FIX v2 ===

// Ambil daftar region unik + fallback manual
function getAllRegions() {
  const regionSet = new Set();
  if (typeof availableRegions !== 'undefined' && availableRegions.length > 0) {
    availableRegions.forEach(r => regionSet.add(r.name || r));
  }
  if (typeof availableClasses !== 'undefined' && availableClasses.length > 0) {
    availableClasses.forEach(c => regionSet.add(c.region));
  }
  // Tambah fallback region default
  regionSet.add('Pusat Bandung');
  return Array.from(regionSet);
}

// Bangun dropdown regional
function buildRegionDropdown() {
  const regions = getAllRegions();
  let options = '<option value="all">Semua Regional</option>';
  regions.forEach(r => options += `<option value="${r}">${r}</option>`);
  return `<select id="filterRegion" onchange="applyRegionFilter(this.value)" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 ml-3">${options}</select>`;
}

// Terapkan filter hanya untuk modul aktif
function applyRegionFilter(region) {
  window.selectedRegion = region;
  const activeTitle = document.querySelector('#contentArea h2')?.textContent || '';
  if (activeTitle.includes('Kelola Kelas')) {
    if (typeof loadManageClasses === 'function') loadManageClasses();
  } else if (activeTitle.includes('Jadwal Belajar')) {
    if (typeof loadLearningSchedule === 'function') loadLearningSchedule();
  } else if (activeTitle.includes('Jadwal Kegiatan')) {
    if (typeof loadActivitySchedule === 'function') loadActivitySchedule();
  }
}

// === Patch Modul Kelola Kelas ===
function loadManageClasses() {
  const content = document.getElementById('contentArea');
  let filteredClasses = availableClasses;
  let selectedRegion = window.selectedRegion || 'all';

  if (currentUser.role === 'Admin') {
    filteredClasses = availableClasses.filter(cls => cls.region === currentUser.region);
  } else if (currentUser.role === 'Super Admin' && selectedRegion !== 'all') {
    filteredClasses = availableClasses.filter(cls => cls.region === selectedRegion);
  }

  const regionFilterHTML = currentUser.role === 'Super Admin' ? buildRegionDropdown() : '';

  content.innerHTML = `
    <div class="fade-in">
      <div class="flex justify-between items-center mb-6">
        <div class="flex items-center">
          <h2 class="text-2xl font-bold text-gray-900">üè´ Kelola Kelas</h2>
          ${regionFilterHTML}
        </div>
        <button onclick="addClass()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Kelas</button>
      </div>
      <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Daftar Kelas (${filteredClasses.length})</h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-blue-800 text-white">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nama Kelas</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Deskripsi</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Regional</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>
              </tr>
            </thead>
            <tbody class="bg-white">
              ${filteredClasses.map(cls => `
                <tr class="border-t border-gray-200 hover:bg-blue-50">
                  <td class="px-4 py-3 text-sm font-medium text-gray-900">${cls.name}</td>
                  <td class="px-4 py-3 text-sm text-gray-600">${cls.description}</td>
                  <td class="px-4 py-3 text-sm text-blue-600 font-medium">${cls.region}</td>
                  <td class="px-4 py-3 text-sm">
                    ${(currentUser.role === 'Super Admin' || cls.region === currentUser.region) ? 
                      `<button onclick="editClass(${cls.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                      <button onclick="deleteClass(${cls.id})" class="text-red-600 hover:text-red-800">Hapus</button>` :
                      `<span class='text-gray-400'>-</span>`}
                  </td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;

  if (currentUser.role === 'Super Admin' && document.getElementById('filterRegion')) {
    document.getElementById('filterRegion').value = selectedRegion;
  }
}

// === Tambahkan dropdown regional di Jadwal Belajar & Kegiatan ===
function patchScheduleModules() {
  if (currentUser.role !== 'Super Admin') return;
  const title = document.querySelector('#contentArea h2')?.textContent || '';
  if (title.includes('Jadwal Belajar') || title.includes('Jadwal Kegiatan')) {
    if (!document.getElementById('filterRegion')) {
      const header = document.querySelector('.flex.justify-between.items-center.mb-6') || document.querySelector('.schedule-header, .activity-header');
      if (header) header.insertAdjacentHTML('beforeend', buildRegionDropdown());
    }
    if (document.getElementById('filterRegion')) {
      document.getElementById('filterRegion').value = window.selectedRegion || 'all';
    }
  }
}

// Patch fungsi jadwal belajar
const _oldLoadLearningSchedule = window.loadLearningSchedule;
window.loadLearningSchedule = function() {
  if (_oldLoadLearningSchedule) _oldLoadLearningSchedule();
  patchScheduleModules();
};

// Patch fungsi jadwal kegiatan
const _oldLoadActivitySchedule = window.loadActivitySchedule;
window.loadActivitySchedule = function() {
  if (_oldLoadActivitySchedule) _oldLoadActivitySchedule();
  patchScheduleModules();
};
</script>
</body>
</html>
<!-- === Materi Kelas UI Override (FINAL FIX) 
<script>
// Override aman: hanya ganti tampilan modul Materi Kelas tanpa ganggu modul lain
function loadMaterials() {
    const content = document.getElementById('contentArea');
    if (!content) return;

    let regionalMaterials = classMaterials.filter(m => currentUser.role === 'Super Admin' || m.region === currentUser.region);

    if (selectedClassMaterial !== 'all') {
        regionalMaterials = regionalMaterials.filter(m => m.classes.includes(selectedClassMaterial));
    }

    const classOptions = [...new Set(classMaterials.flatMap(m => m.classes))];

    content.innerHTML = `
        <div class="fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
                    <select id="filterClassMaterial" onchange="filterMaterials()" 
                        class="border border-blue-500 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">Semua Kelas</option>
                        ${classOptions.map(c => `<option value="${c}" ${selectedClassMaterial === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `
                    <button onclick="addMaterial()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition">
                        + Tambah Materi
                    </button>` : ''}
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                    <span class="text-3xl mr-3">üìö</span> Daftar Materi Kelas
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-blue-800 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Topik</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Deskripsi</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Kelas</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Regional</th>
                                ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? 
                                    '<th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>' : ''}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            ${regionalMaterials.map(m => `
                                <tr>
                                    <td class="px-4 py-3 text-sm text-gray-800 font-medium">${m.topic}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${m.description}</td>
                                    <td class="px-4 py-3 text-sm text-blue-600 font-semibold">${m.classes.join(', ')}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${m.region}</td>
                                    ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `
                                        <td class="px-4 py-3 text-sm">
                                            <button onclick="editMaterial(${m.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                            <button onclick="deleteMaterial(${m.id})" class="text-red-600 hover:text-red-800">Hapus</button>
                                        </td>` : ''}
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function filterMaterials() {
    const selected = document.getElementById('filterClassMaterial').value;
    selectedClassMaterial = selected;
    loadMaterials();
}
</script>
<!-- === Materi Kelas UI Override (FINAL FIX v2) 
<script>
// Versi dengan pembatasan: siswa tidak punya filter, admin regional lihat kelas di region-nya
function loadMaterials() {
    const content = document.getElementById('contentArea');
    if (!content) return;

    let regionalMaterials = classMaterials.filter(m => 
        currentUser.role === 'Super Admin' || m.region === currentUser.region
    );

    if (selectedClassMaterial !== 'all') {
        regionalMaterials = regionalMaterials.filter(m => m.classes.includes(selectedClassMaterial));
    }

    // Daftar kelas tergantung role
    let classOptions = [];
    if (currentUser.role === 'Super Admin') {
        classOptions = [...new Set(classMaterials.flatMap(m => m.classes))];
    } else if (currentUser.role === 'Admin' || currentUser.role === 'Admin Regional') {
        classOptions = [...new Set(
            classMaterials.filter(m => m.region === currentUser.region).flatMap(m => m.classes)
        )];
    }

    let filterUI = '';
    if (currentUser.role === 'Admin' || currentUser.role === 'Admin Regional' || currentUser.role === 'Super Admin') {
        filterUI = `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
                <select id="filterClassMaterial" onchange="filterMaterials()" 
                    class="border border-blue-500 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">Semua Kelas</option>
                    ${classOptions.map(c => `<option value="${c}" ${selectedClassMaterial === c ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
            </div>
        `;
    }

    const addButton = (currentUser.role === 'Admin' || currentUser.role === 'Admin Regional' || currentUser.role === 'Super Admin') ? `
        <button onclick="addMaterial()" 
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition">
            + Tambah Materi
        </button>` : '';

    content.innerHTML = `
        <div class="fade-in">
            <div class="flex justify-between items-center mb-6">
                ${filterUI}
                ${addButton}
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                    <span class="text-3xl mr-3">üìö</span> Daftar Materi Kelas
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-blue-800 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Topik</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Deskripsi</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Kelas</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Regional</th>
                                ${(currentUser.role === 'Admin' || currentUser.role === 'Admin Regional' || currentUser.role === 'Super Admin') ? 
                                    '<th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>' : ''}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            ${regionalMaterials.map(m => `
                                <tr>
                                    <td class="px-4 py-3 text-sm text-gray-800 font-medium">${m.topic}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${m.description}</td>
                                    <td class="px-4 py-3 text-sm text-blue-600 font-semibold">${m.classes.join(', ')}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${m.region}</td>
                                    ${(currentUser.role === 'Admin' || currentUser.role === 'Admin Regional' || currentUser.role === 'Super Admin') ? `
                                        <td class="px-4 py-3 text-sm">
                                            <button onclick="editMaterial(${m.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                            <button onclick="deleteMaterial(${m.id})" class="text-red-600 hover:text-red-800">Hapus</button>
                                        </td>` : ''}
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function filterMaterials() {
    const selected = document.getElementById('filterClassMaterial')?.value || 'all';
    selectedClassMaterial = selected;
    loadMaterials();
}
</script>

<!-- === PATCH ADMIN REGIONAL FIX === -->
<script type="module">
// === PATCH: Super Admin dapat menambah beberapa admin di regional yang sama ===

// --- Fungsi Tambah Admin Regional ---
function addRegionalAdmin() {
    const studentRegions = studentsData.map(s => s.region).filter(r => r);
    const adminRegions = regionalAdmins.map(a => a.region).filter(r => r);
    const existingRegions = [...new Set([...studentRegions, ...adminRegions])];

    openModal('Tambah Admin Regional Baru', `
        <form id="addAdminForm" class="space-y-4">
            <div>
                <label for="adminName" class="block text-sm font-medium text-gray-700 mb-1">Nama Admin</label>
                <input type="text" id="adminName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
            </div>
            <div>
                <label for="adminUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <input type="text" id="adminUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
            </div>
            <div>
                <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" id="adminPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
            </div>
            
            <div>
                <label for="adminRegionSelect" class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
                <select id="adminRegionSelect" onchange="toggleNewRegionInput(this.value)" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    <option value="">--- Pilih Regional yang Sudah Ada ---</option>
                    ${[...new Set(studentsData.map(s => s.region).concat(regionalAdmins.map(a => a.region)))].sort().map(regionName => `
                        <option value="${regionName}">${regionName}</option>
                    `).join('')}
                    <option value="NEW_REGION">--- Tambah Regional Baru ---</option>
                </select>
            </div>

            <div id="newRegionInputContainer" class="hidden">
                <label for="adminRegionInput" class="block text-sm font-medium text-gray-700 mb-1">Regional Baru</label>
                <input type="text" id="adminRegionInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Contoh: Jakarta Pusat">
            </div>

            <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Tambah Admin</button>
        </form>
    `);

    document.getElementById('addAdminForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = document.getElementById('adminUsername').value;
        const name = document.getElementById('adminName').value;
        const password = document.getElementById('adminPassword').value;

        const selectedRegion = document.getElementById('adminRegionSelect').value;
        let region = '';

        if (selectedRegion === 'NEW_REGION') {
            region = document.getElementById('adminRegionInput').value.trim();
        } else if (selectedRegion) {
            region = selectedRegion;
        }

        if (!region) {
            showNotification('Silakan pilih atau masukkan Regional!', 'error');
            return;
        }

        if (await loadAllData()[username]) {
            showNotification('Username sudah digunakan!', 'error');
            return;
        }

        // üîß Tidak ada lagi pembatasan 1 admin per regional

        const newAdmin = { username, password, role: 'Admin', name, region };
        regionalAdmins.push(newAdmin);

        showNotification('Admin Regional berhasil ditambahkan!');
        this.reset();
        closeModal();
        loadManageAdmins();
    });
}

// --- Perbaikan Tabel di loadManageAdmins() ---
function loadManageAdmins() {
    const content = document.getElementById('contentArea');
    if (currentUser.role !== 'Super Admin') {
        content.innerHTML = '<div class="fade-in text-center text-red-600 text-xl font-bold p-10">Akses Ditolak. Hanya Super Admin yang dapat mengakses modul ini.</div>';
        return;
    }

        // === NEW MODULE: LOG ACTIVITY ===
        window.loadLogActivity = function() {
            const content = document.getElementById('contentArea');
            if (currentUser.role !== 'Super Admin') {
                content.innerHTML = '<div class="fade-in text-center text-red-600 text-xl font-bold p-10">Akses Ditolak. Hanya Super Admin yang dapat mengakses modul ini.</div>';
                return;
            }

            let logs = JSON.parse(localStorage.getItem('loginActivityLogs') || '[]');

            content.innerHTML = `
                <div class='fade-in'>
                    <div class='flex justify-between items-center mb-6'>
                        <h2 class='text-2xl font-bold text-gray-900'>üìú Log Aktivitas Login</h2>
                        <button onclick='clearActivityLogs()' class='px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all shadow-md'>Hapus Log</button>
                    </div>

                    <div class='bg-white border border-gray-200 rounded-xl shadow-md overflow-hidden'>
                        <table class='min-w-full divide-y divide-gray-200'>
                            <thead class='bg-blue-800 text-white'>
                                <tr>
                                    <th class='px-6 py-3 text-left text-xs font-semibold text-white-700 uppercase tracking-wider'>No</th>
                                    <th class='px-6 py-3 text-left text-xs font-semibold text-white-700text-gray-600 uppercase tracking-wider'>Nama</th>
                                    <th class='px-6 py-3 text-left text-xs font-semibold text-white-700 uppercase tracking-wider'>Role</th>
                                    <th class='px-6 py-3 text-left text-xs font-semibold text-white-700 uppercase tracking-wider'>Regional</th>
                                    <th class='px-6 py-3 text-left text-xs font-semibold text-white-700 uppercase tracking-wider'>Waktu Login</th>
                                </tr>
                            </thead>
                            <tbody class='bg-white divide-y divide-gray-100'>
                                ${logs.length > 0 ? logs.map((log, i) => `
                                    <tr class='hover:bg-blue-50 transition-all'>
                                        <td class='px-6 py-3 text-sm text-gray-700'>${i + 1}</td>
                                        <td class='px-6 py-3 text-sm font-medium text-gray-900'>${log.name}</td>
                                        <td class='px-6 py-3 text-sm text-blue-600 font-semibold'>${log.role}</td>
                                        <td class='px-6 py-3 text-sm text-gray-700'>${log.region}</td>
                                        <td class='px-6 py-3 text-sm text-gray-500'>${log.time}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan='5' class='text-center py-6 text-gray-500'>Belum ada aktivitas login.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        window.clearActivityLogs = function() {
            localStorage.removeItem('loginActivityLogs');
            showNotification('Log aktivitas berhasil dihapus!', 'success');
            loadLogActivity();
        }


    content.innerHTML = `
        <div class="fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">üõ°Ô∏è Kelola Admin Regional</h2>
                <button onclick="addRegionalAdmin()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">+ Tambah Admin Regional</button>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Daftar Akun Admin Regional (${regionalAdmins.length})</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-blue-800 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">No</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Nama Admin</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Username</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Regional</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Jml Siswa</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white">
                            ${regionalAdmins.map((admin, i) => {
                                const studentsInRegion = studentsData.filter(s => s.region === admin.region).length;
                                return `
                                    <tr class="border-t border-gray-200 hover:bg-red-50">
                                        <td class="px-4 py-3 text-sm text-gray-600">${i + 1}</td>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${admin.name}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${admin.username}</td>
                                        <td class="px-4 py-3 text-sm text-red-600 font-medium">${admin.region}</td>
                                        <td class="px-4 py-3 text-sm text-blue-600 font-bold">${studentsInRegion}</td>
                                        <td class="px-4 py-3 text-sm">
                                            <button onclick="editRegionalAdmin('${admin.username}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                            <button onclick="deleteRegionalAdmin('${admin.username}')" class="text-red-600 hover:text-red-800">Hapus</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}
</script>
<!-- === END PATCH === -->
