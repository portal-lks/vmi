<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistem Informasi Laporan Kemajuan Siswa - Bimbel Gambar Villa Merah (Supabase)</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Supabase JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.28.0/dist/supabase.min.js"></script>
<style>
/* --- Minimal styling & animations (keperluan file final) --- */
body { box-sizing: border-box; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
.fade-in { animation: fadeIn 0.25s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
.sidebar-active { background-color:#1e40af;color:white; }
.notification { position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 12px 20px; border-radius: 8px; color: white; font-weight: 600; }
.success { background-color:#10b981; } .error { background-color:#ef4444; }
</style>
</head>
<body class="bg-white">
<!-- =========== LOGIN PAGE =========== -->
<div id="loginPage" class="min-h-screen flex items-center justify-center p-6">
  <div class="max-w-md w-full bg-white/95 p-8 rounded-2xl shadow-xl">
    <div class="text-center mb-4">
      <img src="https://www.villamerah.com/assets/images/logo/logo-2.png" alt="logo" class="mx-auto w-28 h-20"/>
      <h1 class="text-2xl font-bold text-red-600">Bimbel Gambar Villa Merah</h1>
      <p class="text-sm text-gray-600">Laporan Kemajuan Siswa — Terhubung ke Supabase</p>
    </div>
    <form id="loginForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Username</label>
        <input id="username" required class="w-full px-3 py-2 border rounded-lg" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Password</label>
        <input id="password" type="password" required class="w-full px-3 py-2 border rounded-lg" />
      </div>
      <div>
        <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-lg">Masuk</button>
      </div>
    </form>
    <p id="loginNote" class="text-xs text-gray-500 mt-3">Gunakan akun siswa/admin yang ada di database.</p>
  </div>
</div>

<!-- =========== DASHBOARD PAGE (hidden awalnya) =========== -->
<div id="dashboardPage" class="hidden min-h-screen">
<header class="bg-white shadow p-4 flex items-center justify-between">
  <div class="flex items-center space-x-4">
    <img src="https://bimbelgambar.id/wp-content/uploads/2023/06/favicon-20200601113259.png" class="w-10 h-10" />
    <div>
      <h2 id="hTitle" class="text-lg font-bold text-red-600">Bimbel Gambar Villa Merah</h2>
      <p id="hSub" class="text-sm text-gray-600">Laporan Kemajuan Siswa</p>
    </div>
  </div>
  <div>
    <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg">Keluar</button>
  </div>
</header>

<div class="flex">
  <aside class="w-64 p-4 border-r min-h-[600px]">
    <nav id="sidebarMenu" class="space-y-2"></nav>
  </aside>

  <main class="flex-1 p-6">
    <div id="contentArea" class="fade-in"></div>
  </main>
</div>
</div>

<!-- Notification container -->
<div id="notifContainer"></div>

<script>
/* -------------------------
   Supabase Initialization
   ------------------------- */
const SUPABASE_URL = "https://zuvrwmjxwpazacxcniyv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1dnJ3bWp4d3BhemFjeGNuaXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTYxNTMsImV4cCI6MjA3ODYzMjE1M30.4lCr2B7OUkwKBVMflw6eUoMtm81xYLf4cnSFj5rWcbA";

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------------------------
   Local caches (fallback)
   ------------------------- */
let studentsData = [];
let classMaterials = [];
let scheduleData = [];
let activityScheduleData = [];
let usersCache = []; // admin / superadmin entries
let currentUser = null;
let currentModule = 'home';

/* -------------------------
   Utilities
   ------------------------- */
function showNotification(msg, type='success', timeout=3000) {
  const id = 'n'+Date.now();
  const div = document.createElement('div');
  div.id = id;
  div.className = `notification ${type==='success' ? 'success' : 'error'}`;
  div.textContent = msg;
  document.getElementById('notifContainer').appendChild(div);
  setTimeout(()=>{ try{div.remove()}catch(e){} }, timeout);
}

/* -------------------------
   Data load/save — Supabase
   ------------------------- */
async function loadAllData() {
  try {
    // students + nested relations
    const { data: students, error: err1 } = await supabase
      .from('students')
      .select(`id, name, username, password, class, region, school, artworks:artworks(*), attendance:attendance(*), skolastik_tests(*), tka_tests(*)`);
    if (err1) console.warn('students load err', err1);
    studentsData = students || [];

    // class materials
    const { data: cm } = await supabase.from('class_materials').select('*');
    classMaterials = cm || [];

    // schedules
    const { data: sch } = await supabase.from('schedules').select('*');
    scheduleData = sch || [];

    // activity schedules
    const { data: act } = await supabase.from('activity_schedules').select('*');
    activityScheduleData = act || [];

    // users (admin / super)
    const { data: users } = await supabase.from('users').select('*');
    usersCache = users || [];

    showNotification('Sinkronisasi data selesai', 'success');
    return true;
  } catch (err) {
    console.error('loadAllData error', err);
    showNotification('Gagal mengambil data dari Supabase', 'error', 5000);
    return false;
  }
}

async function saveAllData() {
  try {
    // Upsert students basic fields
    const studentsToUpsert = studentsData.map(s => {
      const {artworks, attendance, skolastikTests, tkaTests, ...base} = s;
      return base;
    });
    if (studentsToUpsert.length) {
      const { error: e1 } = await supabase.from('students').upsert(studentsToUpsert);
      if (e1) console.warn('upsert students base err', e1);
    }

    // Upsert nested arrays: artworks / attendance / tests (flatten)
    for (const s of studentsData) {
      const sid = s.id;
      if (Array.isArray(s.artworks) && s.artworks.length) {
        const toArt = s.artworks.map(a => ({ ...a, student_id: sid }));
        const { error: e2 } = await supabase.from('artworks').upsert(toArt);
        if (e2) console.warn('artworks upsert err', e2);
      }
      if (Array.isArray(s.attendance) && s.attendance.length) {
        const toAtt = s.attendance.map(a => ({ ...a, student_id: sid }));
        const { error: e3 } = await supabase.from('attendance').upsert(toAtt);
        if (e3) console.warn('attendance upsert err', e3);
      }
      if (Array.isArray(s.skolastikTests) && s.skolastikTests.length) {
        const toSk = s.skolastikTests.map(t => ({ ...t, student_id: sid }));
        const { error: e4 } = await supabase.from('skolastik_tests').upsert(toSk);
        if (e4) console.warn('skolastik upsert err', e4);
      }
      if (Array.isArray(s.tkaTests) && s.tkaTests.length) {
        const toTka = s.tkaTests.map(t => ({ ...t, student_id: sid }));
        const { error: e5 } = await supabase.from('tka_tests').upsert(toTka);
        if (e5) console.warn('tka upsert err', e5);
      }
    }

    // class materials / schedules / activity schedules
    if (classMaterials.length) {
      const { error: em } = await supabase.from('class_materials').upsert(classMaterials);
      if (em) console.warn('class_materials upsert err', em);
    }
    if (scheduleData.length) {
      const { error: es } = await supabase.from('schedules').upsert(scheduleData);
      if (es) console.warn('schedules upsert err', es);
    }
    if (activityScheduleData.length) {
      const { error: ea } = await supabase.from('activity_schedules').upsert(activityScheduleData);
      if (ea) console.warn('activity schedule upsert err', ea);
    }

    showNotification('Semua data tersimpan di Supabase', 'success');
    return true;
  } catch (err) {
    console.error('saveAllData err', err);
    showNotification('Gagal menyimpan ke Supabase', 'error', 5000);
    return false;
  }
}

/* -------------------------
   Authentication (table-based)
   ------------------------- */
async function attemptLogin(username, password) {
  // 1. check users table (admin / superadmin)
  const { data: udata, error: e1 } = await supabase
    .from('users')
    .select('*')
    .eq('username', username)
    .limit(1)
    .maybeSingle();
  if (e1) console.warn('users fetch err', e1);
  if (udata && udata.password === password) {
    return { username, ...udata };
  }

  // 2. check students
  const { data: sdata, error: e2 } = await supabase
    .from('students')
    .select('*')
    .eq('username', username)
    .limit(1)
    .maybeSingle();
  if (e2) console.warn('students fetch err', e2);
  if (sdata && sdata.password === password) {
    return { username, role: 'Siswa', name: sdata.name, ...sdata };
  }

  // 3. fallback: cached arrays (if present)
  const localUser = usersCache.find(u=>u.username===username && u.password===password);
  if (localUser) return { username, ...localUser };

  const localStudent = studentsData.find(s=>s.username===username && s.password===password);
  if (localStudent) return { username, role: 'Siswa', name: localStudent.name, ...localStudent };

  return null;
}

/* -------------------------
   UI functions (minimal)
   ------------------------- */
function setActiveMenu(id) {
  document.querySelectorAll('#sidebarMenu button').forEach(b => b.classList.remove('sidebar-active'));
  const el = document.getElementById('menu-'+id);
  if (el) el.classList.add('sidebar-active');
}

function loadSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  let menuItems = [
    { id:'home', label:'Home' },
    { id:'artProgress', label:'Kemajuan Gambar' },
    { id:'skolastikProgress', label:'Kemajuan Tes Skolastik' },
    { id:'tkaProgress', label:'Kemajuan TKA' },
    { id:'schedule', label:'Jadwal Belajar' },
    { id:'activitySchedule', label:'Jadwal Kegiatan' },
    { id:'materials', label:'Materi Kelas' },
    { id:'educationInfo', label:'Informasi Pendidikan' }
  ];
  // add admin items if role
  if (currentUser && currentUser.role === 'Admin') {
    menuItems.push({ id:'addStudent', label:'Tambah Siswa' }, { id:'manageClasses', label:'Kelola Kelas' });
  }
  if (currentUser && currentUser.role === 'Super Admin') {
    menuItems = [
      { id:'home', label:'Home' }, { id:'manageAdmins', label:'Kelola Admin Regional' },
      { id:'addStudent', label:'Tambah Siswa (Global)' }, { id:'manageClasses', label:'Kelola Kelas (Global)' },
      { id:'logActivity', label:'Log Activity' }
    ];
  }
  sidebar.innerHTML = menuItems.map(it=>`<button id="menu-${it.id}" class="w-full text-left px-4 py-2 rounded-lg hover:bg-blue-100" onclick="loadModule('${it.id}')">${it.label}</button>`).join('');
  setActiveMenu('home');
}

function loadModule(moduleId) {
  currentModule = moduleId;
  setActiveMenu(moduleId);
  switch(moduleId) {
    case 'home': loadHome(); break;
    case 'artProgress': loadArtProgress(); break;
    case 'skolastikProgress': loadSkolastikProgress(); break;
    case 'tkaProgress': loadTkaProgress(); break;
    case 'schedule': loadSchedule(); break;
    case 'activitySchedule': loadActivitySchedule(); break;
    case 'materials': loadMaterials(); break;
    default: loadHome(); break;
  }
}

/* -------------------------
   Module renderers (basic)
   ------------------------- */
function loadHome() {
  const content = document.getElementById('contentArea');
  if (!currentUser) { content.innerHTML = '<div class="p-6">No user</div>'; return; }
  if (currentUser.role === 'Super Admin' || currentUser.role === 'Admin') {
    const totalStudents = studentsData.length;
    const schools = {};
    studentsData.forEach(s=>{ if (s.school) schools[s.school]=(schools[s.school]||0)+1; });
    const topSchool = Object.entries(schools).sort((a,b)=>b[1]-a[1])[0];
    content.innerHTML = `
      <div class="p-6">
        <h2 class="text-2xl font-bold">Selamat Datang, ${currentUser.name}</h2>
        <p class="text-sm text-gray-600 mb-4">${currentUser.role} - ${currentUser.region || '-'}</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 border rounded-lg"><h3>Total Siswa</h3><p class="text-3xl font-bold">${totalStudents}</p></div>
          <div class="p-4 border rounded-lg"><h3>Sekolah Terbanyak</h3><p>${topSchool ? topSchool[0] + ' ('+topSchool[1]+')' : '-'}</p></div>
          <div class="p-4 border rounded-lg"><h3>Materi Tersedia</h3><p>${classMaterials.length}</p></div>
        </div>
      </div>`;
  } else {
    // student
    const st = studentsData.find(s => s.username === currentUser.username) || {};
    const karya = (st.artworks||[]).length;
    const hadir = (st.attendance||[]).filter(a=>a.status==='Hadir').length;
    content.innerHTML = `
      <div class="p-6">
        <h2 class="text-2xl font-bold">Halo, ${st.name || currentUser.name}</h2>
        <p class="text-sm text-gray-600 mb-4">${st.class || '-'}</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 border rounded-lg"><h3>Total Karya</h3><p class="text-3xl font-bold">${karya}</p></div>
          <div class="p-4 border rounded-lg"><h3>Kehadiran (Hadir)</h3><p>${hadir}</p></div>
          <div class="p-4 border rounded-lg"><h3>Sekolah</h3><p>${st.school || '-'}</p></div>
        </div>
      </div>`;
  }
}

function loadArtProgress() {
  const content = document.getElementById('contentArea');
  content.innerHTML = `<div class="p-6"><h2 class="text-xl font-semibold">Kemajuan Gambar</h2>
    <p class="text-sm text-gray-500">Daftar karya siswa (diambil dari Supabase)</p>
    <div class="mt-4 overflow-x-auto">
      <table class="min-w-full border"><thead class="bg-gray-50"><tr><th class="p-2">No</th><th class="p-2">Nama</th><th class="p-2">Judul Karya</th><th class="p-2">Tanggal</th></tr></thead>
      <tbody>${studentsData.map((s, i)=> (s.artworks||[]).map((a, j)=>`<tr><td class="p-2">${i+1}.${j+1}</td><td class="p-2">${s.name}</td><td class="p-2">${a.title}</td><td class="p-2">${a.date || '-'}</td></tr>`).join('')).join('')}</tbody></table>
    </div></div>`;
}

function loadSkolastikProgress() {
  const content = document.getElementById('contentArea');
  content.innerHTML = `<div class="p-6"><h2 class="text-xl">Kemajuan Tes Skolastik</h2><p class="text-sm text-gray-500">Daftar skor skolastik</p>
    <div class="mt-4">${studentsData.map(s=>`<div class="mb-3"><strong>${s.name}</strong><div>${(s.skolastikTests||[]).map(t=>`<div>${t.date} — ${t.subject}: ${t.score}</div>`).join('')}</div></div>`).join('')}</div></div>`;
}

function loadTkaProgress() {
  const content = document.getElementById('contentArea');
  content.innerHTML = `<div class="p-6"><h2 class="text-xl">Kemajuan TKA</h2>${studentsData.map(s=>`<div class="mb-3"><strong>${s.name}</strong><div>${(s.tkaTests||[]).map(t=>`<div>${t.date} — ${t.subject}: ${t.score}</div>`).join('')}</div></div>`).join('')}</div>`;
}

function loadSchedule() {
  const content = document.getElementById('contentArea');
  content.innerHTML = `<div class="p-6"><h2 class="text-xl">Jadwal Belajar</h2><div class="mt-4">${scheduleData.map(s=>`<div class="mb-2">${s.date} — ${s.subject} (${s.region||'-'})</div>`).join('')}</div></div>`;
}

function loadActivitySchedule() {
  const content = document.getElementById('contentArea');
  content.innerHTML = `<div class="p-6"><h2 class="text-xl">Jadwal Kegiatan</h2><div class="mt-4">${activityScheduleData.map(a=>`<div class="mb-2">${a.date} — ${a.name} (${a.region||'-'})</div>`).join('')}</div></div>`;
}

function loadMaterials() {
  const content = document.getElementById('contentArea');
  content.innerHTML = `<div class="p-6"><h2 class="text-xl">Materi Kelas</h2><div class="mt-4">${classMaterials.map(m=>`<div class="mb-3"><strong>${m.topic}</strong><div>${m.description}</div></div>`).join('')}</div></div>`;
}

/* -------------------------
   Login / Logout handlers
   ------------------------- */
document.getElementById('loginForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  if (!username || !password) return showNotification('Isi username & password', 'error');

  // load db first
  await loadAllData();

  showNotification('Mencoba login...', 'success', 1200);
  const user = await attemptLogin(username, password);
  if (!user) {
    showNotification('Username / password salah', 'error', 3000);
    return;
  }

  currentUser = user;
  // record login activity (non-blocking)
  try {
    await supabase.from('login_activity').insert([{ username: user.username, name: user.name || '-', role: user.role || 'Siswa', region: user.region || '-', time: new Date().toISOString() }]);
  } catch (err) { console.warn('log activity err', err); }

  // show dashboard
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('dashboardPage').classList.remove('hidden');
  loadSidebar();
  loadHome();
  showNotification('Login sukses', 'success');
});

document.getElementById('logoutBtn').addEventListener('click', async function() {
  // ensure saveAllData finishes before logout hide
  showNotification('Menyimpan data sebelum logout...', 'success', 2500);
  await saveAllData();
  currentUser = null;
  document.getElementById('dashboardPage').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('loginForm').reset();
});

/* -------------------------
   Initial load (try sync)
   ------------------------- */
(async function init() {
  // try to load cached data first (no localStorage reliance here) then sync from supabase
  await loadAllData();
})();
</script>

</body>
</html>
