<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal LKS — Supabase Online</title>
  <style>
    :root{font-family:system-ui,Segoe UI,Roboto,Arial;--card-bg:#fff}
    body{max-width:1100px;margin:18px auto;padding:14px;background:#f4f6f8}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px;background:var(--card-bg);margin-bottom:12px}
    nav button{margin-right:8px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #eee;padding:6px;text-align:left}
    .hidden{display:none}
    .muted{color:#666;font-size:13px}
    .danger{color:#b00020}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    input[type="text"],input[type="date"],select,textarea{padding:6px;border:1px solid #ccc;border-radius:4px}
    button{padding:8px 10px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer}
    form.inline{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    pre{background:#fff;padding:8px;overflow:auto;border:1px solid #eee}
    .small{font-size:13px}
  </style>
</head>
<body>
<header>
  <div>
    <h2>Portal LKS — Supabase Online</h2>
    <div class="muted small">Terhubung ke Supabase — Mode: Full Online</div>
  </div>
  <div id="userBar" class="muted">Belum login</div>
</header>

<div id="loginCard" class="card">
  <h3>Login</h3>
  <div id="loginErr" class="danger hidden"></div>
  <div class="controls">
    <input id="u_usr" placeholder="username" />
    <input id="u_pwd" type="password" placeholder="password" />
    <button id="btn_login">Login</button>
    <button id="btn_demo">Demo (ambil user pertama)</button>
  </div>
  <div class="muted small" style="margin-top:8px">Opsi: autentikasi pakai tabel users (username/password).</div>
</div>

<div id="app" class="hidden">
  <div class="card">
    <nav>
      <button data-view="dashboard" class="navbtn">Dashboard</button>
      <button data-view="students" class="navbtn">Students</button>
      <button data-view="schedule" class="navbtn">Schedule</button>
      <button data-view="activities" class="navbtn">Activities</button>
      <button data-view="materials" class="navbtn">Materials</button>
      <button data-view="classes" class="navbtn">Classes</button>
      <button data-view="app_state" class="navbtn">App State</button>
      <button id="btn_logout" style="float:right">Logout</button>
    </nav>
  </div>

  <div id="views">
    <div id="view_dashboard" class="card view">
      <h3>Dashboard</h3>
      <div id="dash_stats">Memuat...</div>
    </div>

    <div id="view_students" class="card view hidden">
      <h3>Students <button id="add_student">Tambah</button></h3>
      <div id="students_table">Memuat...</div>
    </div>

    <div id="view_schedule" class="card view hidden">
      <h3>Schedule <button id="add_schedule">Tambah</button></h3>
      <div id="schedule_table">Memuat...</div>
    </div>

    <div id="view_activities" class="card view hidden">
      <h3>Activities <button id="add_activity">Tambah</button></h3>
      <div id="activity_table">Memuat...</div>
    </div>

    <div id="view_materials" class="card view hidden">
      <h3>Materials <button id="add_material">Tambah</button></h3>
      <div id="materials_table">Memuat...</div>
    </div>

    <div id="view_classes" class="card view hidden">
      <h3>Classes <button id="add_class">Tambah</button></h3>
      <div id="classes_table">Memuat...</div>
    </div>

    <div id="view_app_state" class="card view hidden">
      <h3>App State Preview</h3>
      <pre id="app_state_json">Memuat...</pre>
      <button id="btn_reload_state">Reload app_state</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://zdyxkdghexhnmvklucfa.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkeXhrZGdoZXhobm12a2x1Y2ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNzEyNjgsImV4cCI6MjA3ODc0NzI2OH0.rMpEn7koPPWAu3jQxRUGEPP3lO9TsLAklvYC9giP1Bg";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
function $(id){return document.getElementById(id)}
function fmtDateDisplay(iso){if(!iso) return ''; const p = iso.split('T')[0].split('-'); if(p.length!==3) return iso; return p[2].padStart(2,'0') + '/' + p[1].padStart(2,'0') + '/' + p[0]}
async function supabaseSelectAll(table){ const { data, error } = await supabase.from(table).select('*'); if(error) throw error; return data||[] }
async function supabaseInsert(table, obj){ const { data, error } = await supabase.from(table).insert([obj]); if(error) throw error; return data }
async function supabaseUpdate(table, id, obj){ const { data, error } = await supabase.from(table).update(obj).eq('id', id); if(error) throw error; return data }
async function supabaseDelete(table, id){ const { data, error } = await supabase.from(table).delete().eq('id', id); if(error) throw error; return data }

let currentUser = null
$('btn_login').addEventListener('click', async ()=>{
  const u = $('u_usr').value.trim(), p = $('u_pwd').value.trim()
  $('loginErr').classList.add('hidden'); $('loginErr').textContent=''
  if(!u||!p){ $('loginErr').textContent='Isi username & password'; $('loginErr').classList.remove('hidden'); return; }
  try{
    const { data, error } = await supabase.from('users').select('*').eq('username', u).limit(1)
    if(error) throw error
    if(!data || data.length===0){ $('loginErr').textContent='User tidak ditemukan'; $('loginErr').classList.remove('hidden'); return; }
    const user = data[0]
    if(user.password !== p){ $('loginErr').textContent='Password salah'; $('loginErr').classList.remove('hidden'); return; }
    currentUser = user
    $('userBar').textContent = `${user.username} — ${user.role||'-'}`
    $('loginCard').classList.add('hidden'); $('app').classList.remove('hidden')
    await refreshAll()
    subscribeRealtime()
  }catch(err){ console.error(err); $('loginErr').textContent = 'Gagal: '+(err.message||err); $('loginErr').classList.remove('hidden') }
})
$('btn_demo').addEventListener('click', async ()=>{
  try{
    const { data } = await supabase.from('users').select('*').limit(1)
    if(data && data.length){ const u = data[0]; currentUser = u; $('userBar').textContent = `${u.username} — ${u.role||'-'}`; $('loginCard').classList.add('hidden'); $('app').classList.remove('hidden'); await refreshAll(); subscribeRealtime() }
  }catch(e){ console.error(e); alert('Demo login gagal: '+e.message) }
})
$('btn_logout').addEventListener('click', ()=>{ currentUser=null; $('userBar').textContent='Belum login'; $('app').classList.add('hidden'); $('loginCard').classList.remove('hidden'); if(realtimeChannel) realtimeChannel.unsubscribe() })

async function loadTable(name){ return await supabaseSelectAll(name) }
async function refreshAll(){
  try{
    window.users = await loadTable('users')
    window.students = await loadTable('students')
    window.classes = await loadTable('classes')
    window.schedule = await loadTable('schedule')
    window.activity_schedule = await loadTable('activity_schedule')
    window.materials = await loadTable('materials')
    window.education_info = await loadTable('education_info')
    const appRows = await loadTable('app_state')
    const appObj = {}
    (appRows||[]).forEach(r=>{ try{ appObj[r.key]=r.value }catch(e){ appObj[r.key]=r.value } })
    window.app_state = appObj
    renderAll()
  }catch(e){ console.error('refreshAll', e); alert('Gagal refresh: '+(e.message||e)) }
}

function renderAll(){ renderDashboard(); renderStudents(); renderSchedule(); renderActivities(); renderMaterials(); renderClasses(); renderAppState() }

function renderStudents(){
  const data = window.students||[]
  if(!data.length){ $('students_table').innerHTML = '<i>Tidak ada siswa</i>'; return }
  let html = '<table><thead><tr><th>Nama</th><th>Kelas</th><th>Region</th><th>Aksi</th></tr></thead><tbody>'
  data.forEach(r=>{ html += `<tr><td>${r.full_name||''}</td><td>${r.class_id||''}</td><td>${r.region||''}</td><td><button onclick="editStudent('${r.id}')">Edit</button> <button onclick="delStudent('${r.id}')">Hapus</button></td></tr>` })
  html += '</tbody></table>'
  $('students_table').innerHTML = html
}
async function addStudent(){ const name = prompt('Nama siswa:'); if(!name) return; const cls = prompt('Kelas:')||''; const region = prompt('Region:')||''; await supabaseInsert('students',{ full_name:name, class_id:cls, region }); await refreshAll() }
async function editStudent(id){ const item = (window.students||[]).find(x=>x.id===id); if(!item) return alert('Tidak ditemukan'); const name = prompt('Nama siswa:', item.full_name)||item.full_name; const cls = prompt('Kelas:', item.class_id)||item.class_id; const region = prompt('Region:', item.region)||item.region; await supabaseUpdate('students', id, { full_name:name, class_id:cls, region }); await refreshAll() }
async function delStudent(id){ if(!confirm('Hapus siswa?')) return; await supabaseDelete('students', id); await refreshAll() }
$('add_student').addEventListener('click', addStudent)

function renderSchedule(){
  const data = window.schedule||[]
  if(!data.length){ $('schedule_table').innerHTML = '<i>Tidak ada jadwal</i>'; return }
  let html = '<table><thead><tr><th>Tanggal</th><th>Class</th><th>Subject</th><th>Aksi</th></tr></thead><tbody>'
  data.forEach(r=>{ const d = r.date ? fmtDateDisplay(r.date) : ''; html += `<tr><td>${d}</td><td>${r.class_id||''}</td><td>${r.subject||''}</td><td><button onclick="editSchedule('${r.id}')">Edit</button> <button onclick="delSchedule('${r.id}')">Hapus</button></td></tr>` })
  html += '</tbody></table>'
  $('schedule_table').innerHTML = html
}
async function addSchedule(){ const cls = prompt('Class:')||''; const date = prompt('Tanggal (yyyy-mm-dd):')||''; const subject = prompt('Subject:')||''; await supabaseInsert('schedule',{ class_id:cls, date:date, subject }); await refreshAll() }
async function editSchedule(id){ const item = (window.schedule||[]).find(x=>x.id===id); if(!item) return alert('Tidak ditemukan'); const cls = prompt('Class:', item.class_id)||item.class_id; const date = prompt('Tanggal (yyyy-mm-dd):', item.date||'')||item.date; const subject = prompt('Subject:', item.subject)||item.subject; await supabaseUpdate('schedule', id, { class_id:cls, date, subject }); await refreshAll() }
async function delSchedule(id){ if(!confirm('Hapus jadwal?')) return; await supabaseDelete('schedule', id); await refreshAll() }
$('add_schedule').addEventListener('click', addSchedule)

function renderActivities(){
  const data = window.activity_schedule||[]
  if(!data.length){ $('activity_table').innerHTML = '<i>Tidak ada kegiatan</i>'; return }
  let html = '<table><thead><tr><th>Tanggal</th><th>Class</th><th>Activity</th><th>Aksi</th></tr></thead><tbody>'
  data.forEach(r=>{ const d = r.date ? fmtDateDisplay(r.date) : ''; html += `<tr><td>${d}</td><td>${r.class_id||''}</td><td>${r.activity||''}</td><td><button onclick="editActivity('${r.id}')">Edit</button> <button onclick="delActivity('${r.id}')">Hapus</button></td></tr>` })
  html += '</tbody></table>'
  $('activity_table').innerHTML = html
}
async function addActivity(){ const cls = prompt('Class:')||''; const date = prompt('Tanggal (yyyy-mm-dd):')||''; const title = prompt('Activity:')||''; await supabaseInsert('activity_schedule',{ class_id:cls, date, activity:title }); await refreshAll() }
async function editActivity(id){ const item = (window.activity_schedule||[]).find(x=>x.id===id); if(!item) return alert('Tidak ditemukan'); const cls = prompt('Class:', item.class_id)||item.class_id; const date = prompt('Tanggal (yyyy-mm-dd):', item.date)||item.date; const title = prompt('Activity:', item.activity)||item.activity; await supabaseUpdate('activity_schedule', id, { class_id:cls, date, activity:title }); await refreshAll() }
async function delActivity(id){ if(!confirm('Hapus kegiatan?')) return; await supabaseDelete('activity_schedule', id); await refreshAll() }
$('add_activity').addEventListener('click', addActivity)

function renderMaterials(){
  const data = window.materials||[]
  if(!data.length){ $('materials_table').innerHTML = '<i>Tidak ada materi</i>'; return }
  let html = '<table><thead><tr><th>Topic</th><th>Class</th><th>Video</th><th>Aksi</th></tr></thead><tbody>'
  data.forEach(r=>{ html += `<tr><td>${r.topic||''}</td><td>${r.class_id||''}</td><td>${r.video_url?'<a target="_blank" href="'+r.video_url+'">Link</a>':''}</td><td><button onclick="editMaterial('${r.id}')">Edit</button> <button onclick="delMaterial('${r.id}')">Hapus</button></td></tr>` })
  html += '</tbody></table>'
  $('materials_table').innerHTML = html
}
async function addMaterial(){ const topic = prompt('Topic:')||''; const cls = prompt('Class:')||''; const video = prompt('Video URL:')||''; await supabaseInsert('materials',{ topic, class_id:cls, video_url:video }); await refreshAll() }
async function editMaterial(id){ const item = (window.materials||[]).find(x=>x.id===id); if(!item) return alert('Tidak ditemukan'); const topic = prompt('Topic:', item.topic)||item.topic; const cls = prompt('Class:', item.class_id)||item.class_id; const video = prompt('Video URL:', item.video_url)||item.video_url; await supabaseUpdate('materials', id, { topic, class_id:cls, video_url:video }); await refreshAll() }
async function delMaterial(id){ if(!confirm('Hapus materi?')) return; await supabaseDelete('materials', id); await refreshAll() }
$('add_material').addEventListener('click', addMaterial)

function renderClasses(){
  const data = window.classes||[]
  if(!data.length){ $('classes_table').innerHTML = '<i>Tidak ada class</i>'; return }
  let html = '<table><thead><tr><th>Class Name</th><th>Region</th><th>Aksi</th></tr></thead><tbody>'
  data.forEach(r=>{ html += `<tr><td>${r.name||''}</td><td>${r.region||''}</td><td><button onclick="editClass('${r.id}')">Edit</button> <button onclick="delClass('${r.id}')">Hapus</button></td></tr>` })
  html += '</tbody></table>'
  $('classes_table').innerHTML = html
}
async function addClass(){ const name = prompt('Nama class:')||''; const region = prompt('Region:')||''; await supabaseInsert('classes',{ id:name, name, region }); await refreshAll() }
async function editClass(id){ const item = (window.classes||[]).find(x=>x.id===id); if(!item) return alert('Tidak ditemukan'); const name = prompt('Nama class:', item.name)||item.name; const region = prompt('Region:', item.region)||item.region; await supabaseUpdate('classes', id, { name, region }); await refreshAll() }
async function delClass(id){ if(!confirm('Hapus class?')) return; await supabaseDelete('classes', id); await refreshAll() }
$('add_class').addEventListener('click', addClass)

function renderAppState(){
  const rows = window.app_state || {}
  $('app_state_json').textContent = JSON.stringify(rows, null, 2)
}
$('btn_reload_state').addEventListener('click', async ()=>{ await refreshAll(); alert('Reloaded') })

function renderDashboard(){
  const students = window.students||[]; const classes = window.classes||[]
  const stats = []
  stats.push('Jumlah siswa: ' + students.length)
  stats.push('Jumlah kelas: ' + classes.length)
  $('dash_stats').innerHTML = stats.map(s=>'<div>'+s+'</div>').join('')
}

document.querySelectorAll('.navbtn').forEach(b=>{ b.addEventListener('click', ()=>{ document.querySelectorAll('.view').forEach(v=> v.classList.add('hidden')); document.getElementById('view_'+b.dataset.view).classList.remove('hidden') }) })

let realtimeChannel = null
function subscribeRealtime(){
  try{
    if(realtimeChannel) realtimeChannel.unsubscribe()
    realtimeChannel = supabase.channel('public:all_tables')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'students' }, payload=> refreshAll())
      .on('postgres_changes', { event: '*', schema: 'public', table: 'classes' }, payload=> refreshAll())
      .on('postgres_changes', { event: '*', schema: 'public', table: 'schedule' }, payload=> refreshAll())
      .on('postgres_changes', { event: '*', schema: 'public', table: 'activity_schedule' }, payload=> refreshAll())
      .on('postgres_changes', { event: '*', schema: 'public', table: 'materials' }, payload=> refreshAll())
      .subscribe()
  }catch(e){ console.error('subscribeRealtime', e) }
}

(function(){ try{ loadAllDataFromSupabase ? loadAllDataFromSupabase() : null }catch(e){} })()
</script>
</body>
</html>
