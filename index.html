<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Informasi Laporan Kemajuan Siswa - Bimbel Gambar Villa Merah</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body, * { box-sizing: border-box; }
    .sidebar-active { background-color: #1e40af; color: white; }
    .fade-in { animation: fadeIn 0.28s ease-in; }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(8px);} to {opacity: 1; transform: translateY(0);} }
    .modal-backdrop { background-color: rgba(0,0,0,0.5); }
    table { border-collapse: collapse; }
    th, td { border: 1px solid #e5e7eb; }
    .notification { position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 12px 20px; border-radius: 8px; color: white; font-weight: 600; }
    .success { background: #10b981; }
    .error { background: #ef4444; }
    .hidden-el { display: none !important; }
  </style>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    const SUPABASE_URL = 'https://uwigghirpvlnzqhruglq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3aWdnaGlycHZsbnpxaHJ1Z2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTE3NTksImV4cCI6MjA3ODYyNzc1OX0.P--M4TysIdMfwvM1KTd9fAkqyt2hg5WWdmKNuE67psk';
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body class="bg-white">
  <!-- LOGIN -->
  <div id="loginPage" class="min-h-screen flex items-center justify-center bg-[url('FSRD.jpeg')] bg-cover bg-center relative">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative z-10 bg-white/90 p-8 rounded-2xl shadow-2xl backdrop-blur-md w-full max-w-md">
      <div class="text-center mb-6">
        <img src="https://www.villamerah.com/assets/images/logo/logo-2.png" class="mx-auto w-32 mb-4" alt="Logo" />
        <h2 class="text-2xl font-bold text-red-600">Bimbel Gambar Villa Merah</h2>
        <p class="text-blue-600 font-semibold">Laporan Kemajuan Siswa</p>
      </div>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Username</label>
          <input id="username" name="username" type="text" required class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Password</label>
          <input id="password" name="password" type="password" required class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Masuk</button>
      </form>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardPage" class="hidden min-h-screen">
    <header class="bg-white shadow fixed top-0 left-0 w-full z-10">
      <div class="flex justify-between items-center p-4 border-b">
        <div class="flex items-center space-x-3">
          <img src="https://bimbelgambar.id/wp-content/uploads/2023/06/favicon-20200601113259.png" class="w-10 h-10" />
          <div>
            <h1 class="text-xl font-bold text-red-600">Bimbel Gambar Villa Merah</h1>
            <p id="userRole" class="text-sm text-gray-500"></p>
            <p id="userRegion" class="text-xs text-blue-600"></p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="saveBtn" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700">Sinkron</button>
          <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Keluar</button>
        </div>
      </div>
    </header>
    <div class="flex pt-20">
      <aside id="sidebarMenu" class="w-64 bg-gradient-to-b from-blue-700 to-blue-900 text-white min-h-screen p-4 space-y-2"></aside>
      <main id="contentArea" class="flex-1 p-8 fade-in"></main>
    </div>
  </div>

  <div id="notification" class="notification hidden-el"></div>

  <script>
    // ---------- App State ----------
    let currentUser = null;
    let studentsData = [];
    let regionalAdmins = [];
    let availableClasses = [];
    let classMaterials = [];
    let scheduleData = [];
    let activityScheduleData = [];
    let educationInfo = [];

    // ---------- Helpers ----------
    function showNotification(msg, type='success'){
      const el = document.getElementById('notification');
      el.className = 'notification ' + (type==='success'? 'success' : 'error');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display = 'none'; }, 3000);
    }

    function saveSession(){ localStorage.setItem('currentUser', JSON.stringify(currentUser)); }
    function loadSession(){ const cu = localStorage.getItem('currentUser'); if (cu) currentUser = JSON.parse(cu); }

    // ---------- Supabase Sync (safe, idempotent) ----------
    async function loadAllData(){
      try{
        const { data: students, error: se } = await window.supabase.from('students').select('*');
        if (se) console.warn('supabase students err', se);
        studentsData = students || [];

        const { data: users, error: ue } = await window.supabase.from('users').select('*');
        if (ue) console.warn('supabase users err', ue);
        regionalAdmins = users ? users.filter(u => u.role === 'Admin') : [];

        const { data: classesData } = await window.supabase.from('classes').select('*');
        availableClasses = classesData || [];

        const { data: mats } = await window.supabase.from('materials').select('*');
        classMaterials = mats || [];

        const { data: sch } = await window.supabase.from('schedule').select('*');
        scheduleData = sch || [];

        const { data: act } = await window.supabase.from('activity_schedule').select('*');
        activityScheduleData = act || [];

        const { data: edu } = await window.supabase.from('education_info').select('*');
        educationInfo = edu || [];

        console.log('Data loaded from supabase');
        showNotification('Data berhasil diambil dari server.', 'success');

        // Re-render current view if dashboard active
        if (currentUser) {
          loadSidebar();
          loadHome();
        }
      } catch (err) {
        console.error('loadAllData failed', err);
        showNotification('Gagal mengambil data dari server.', 'error');
      }
    }

    async function saveAllData(){
      try{
        // Upsert students
        if (Array.isArray(studentsData)){
          for (const s of studentsData){
            const payload = { id: s.id || undefined, name: s.name || null, username: s.username || null, password: s.password || null, class: s.class || null, region: s.region || null, school: s.school || null };
            await window.supabase.from('students').upsert(payload, { onConflict: 'username' });
          }
        }
        // Upsert users (admin)
        if (Array.isArray(regionalAdmins)){
          for (const a of regionalAdmins){
            await window.supabase.from('users').upsert({ username: a.username, password: a.password, role: a.role, name: a.name, region: a.region }, { onConflict: 'username' });
          }
        }
        // classes
        if (Array.isArray(availableClasses)){
          for (const c of availableClasses) await window.supabase.from('classes').upsert(c, { onConflict: 'id' });
        }
        // materials
        if (Array.isArray(classMaterials)){
          for (const m of classMaterials) await window.supabase.from('materials').upsert(m, { onConflict: 'id' });
        }
        // schedule
        if (Array.isArray(scheduleData)){
          for (const s of scheduleData) await window.supabase.from('schedule').upsert(s, { onConflict: ['subject','date'] });
        }
        // activity schedule
        if (Array.isArray(activityScheduleData)){
          for (const a of activityScheduleData) await window.supabase.from('activity_schedule').upsert(a, { onConflict: ['name','date'] });
        }

        showNotification('Sinkronisasi berhasil.', 'success');
      } catch (err){
        console.error('saveAllData failed', err);
        showNotification('Sinkronisasi gagal.', 'error');
      }
    }

    // ---------- Local demo data (fallback) ----------
    function seedLocalData(){
      if (studentsData.length) return; // don't override loaded server data

      regionalAdmins = [
        { username: 'admin_jaksel', password: 'admin123', role: 'Admin', name: 'Admin Jakarta Selatan', region: 'Cabang Jakarta Selatan' },
        { username: 'admin_bandung', password: 'admin123', role: 'Admin', name: 'Admin Bandung', region: 'Pusat Bandung' }
      ];

      studentsData = [
        { id: 1, name: 'Budi Santoso', username: 'siswa1', password: 'siswa123', class: 'Gold', region: 'Cabang Jakarta Selatan', school: 'SMA Negeri 1 Jakarta', artworks: [], attendance: [], skolastikTests: [], tkaTests: [] },
        { id: 2, name: 'Sari Dewi', username: 'siswa2', password: 'siswa123', class: 'Advance', region: 'Cabang Jakarta Timur', school: 'SMA Swasta 7 Bandung', artworks: [], attendance: [], skolastikTests: [], tkaTests: [] }
      ];

      availableClasses = [ { id: 1, name: 'Gold', region: 'Cabang Jakarta Selatan' }, { id:2, name: 'Advance', region: 'Cabang Jakarta Timur' } ];

      classMaterials = [ { id:1, topic:'Pengenalan Alat Gambar', classes: ['Gold','Advance'], region:'Cabang Jakarta Selatan' } ];

      scheduleData = [ { id:1, date:'2025-11-05', day:'Selasa', subject:'Pengenalan Alat Gambar', classes:['Gold'], region:'Cabang Jakarta Selatan' } ];

      activityScheduleData = [ { id:1, date:'2025-11-10', name:'Workshop Arsitektur', classes:['Arsitek'], region:'Pusat Bandung' } ];

      educationInfo = [ { id:1, title:'SNBP 2026', content:'Informasi...', date:'2024-01-15' } ];

      console.log('Seeded local demo data');
    }

    // ---------- Users utility ----------
    const superAdminUser = { username: 'superadmin', password: 'super123', role: 'Super Admin', name: 'Super Admin Utama', region: 'Pusat' };
    function getAllUsers(){
      const users = {};
      users[superAdminUser.username] = superAdminUser;
      (regionalAdmins || []).forEach(a => users[a.username] = a);
      (studentsData || []).forEach(s => { if (s.username) users[s.username] = { password: s.password || 'siswa123', role: 'Siswa', name: s.name, region: s.region }; });
      return users;
    }

    // ---------- UI: Sidebar + Modules ----------
    function loadSidebar(){
      const sidebar = document.getElementById('sidebarMenu');
      sidebar.innerHTML = '';
      const menuItems = [
        { id: 'home', label: 'Home', icon: 'üè†' },
        { id: 'artProgress', label: 'Kemajuan Gambar', icon: 'üé®' },
        { id: 'skolastikProgress', label: 'Kemajuan Tes Skolastik', icon: 'üìä' },
        { id: 'tkaProgress', label: 'Kemajuan TKA', icon: 'üìà' },
        { id: 'schedule', label: 'Jadwal Belajar', icon: 'üìÖ' },
        { id: 'activitySchedule', label: 'Jadwal Kegiatan', icon: 'üìÜ' },
        { id: 'materials', label: 'Materi Kelas', icon: 'üìö' },
        { id: 'educationInfo', label: 'Informasi Pendidikan', icon: 'üì∞' }
      ];

      if (currentUser.role === 'Admin'){
        menuItems.push({ id: 'addStudent', label: 'Tambah Siswa', icon: 'üë§' });
        menuItems.push({ id: 'manageClasses', label: 'Kelola Kelas', icon: 'üè´' });
      }
      if (currentUser.role === 'Super Admin'){
        menuItems.push({ id: 'manageAdmins', label: 'Kelola Admin Regional', icon: 'üõ°Ô∏è' });
        menuItems.push({ id: 'logActivity', label: 'Log Activity', icon: 'üìú' });
      }

      menuItems.forEach(item => {
        const btn = document.createElement('button');
        btn.id = 'menu-' + item.id;
        btn.className = 'w-full text-left px-5 py-3 rounded-xl hover:bg-blue-800 transition-all flex items-center gap-3';
        btn.innerHTML = `<span class='text-xl'>${item.icon}</span><span>${item.label}</span>`;
        btn.onclick = () => loadModule(item.id);
        sidebar.appendChild(btn);
      });
    }

    function clearActiveMenu(){ document.querySelectorAll('[id^="menu-"]').forEach(b => b.classList.remove('sidebar-active')); }
    function setActiveMenu(id){ clearActiveMenu(); const el = document.getElementById('menu-' + id); if (el) el.classList.add('sidebar-active'); }

    function loadModule(id){
      setActiveMenu(id);
      const content = document.getElementById('contentArea');
      // clear listeners and content
      content.innerHTML = '';
      switch(id){
        case 'home': loadHome(); break;
        case 'artProgress': loadArtProgress(); break;
        case 'skolastikProgress': loadSkolastikProgress(); break;
        case 'tkaProgress': loadTkaProgress(); break;
        case 'schedule': loadSchedule(); break;
        case 'activitySchedule': loadActivitySchedule(); break;
        case 'materials': loadMaterials(); break;
        case 'educationInfo': loadEducationInfo(); break;
        case 'addStudent': loadAddStudent(); break;
        case 'manageClasses': loadManageClasses(); break;
        case 'manageAdmins': loadManageAdmins(); break;
        case 'logActivity': loadLogActivity(); break;
        default: loadHome();
      }
    }

    // ---------- Module Renderers (kept minimal & performant) ----------
    function loadHome(){
      const content = document.getElementById('contentArea');
      if (!currentUser) return;
      if (currentUser.role === 'Super Admin'){
        const totalStudents = studentsData.length;
        const schools = {};
        studentsData.forEach(s => { if (s.school) schools[s.school] = (schools[s.school]||0)+1; });
        const topSchool = Object.entries(schools).sort((a,b)=>b[1]-a[1])[0] || ['-','-'];
        content.innerHTML = `
          <div class='ml-6 mr-6'>
            <div class='bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg p-6 mb-6 text-white shadow-lg'>
              <h2 class='text-3xl font-bold'>Selamat Datang, ${currentUser.name}</h2>
              <p class='text-blue-100 mt-1'>Dashboard Kontrol Pusat - Semua Regional</p>
            </div>
            <div class='grid grid-cols-1 md:grid-cols-3 gap-5'>
              <div class='p-6 rounded-2xl shadow bg-blue-50'>
                <h4 class='font-semibold'>Total Siswa</h4><p class='text-3xl font-bold'>${totalStudents}</p>
              </div>
              <div class='p-6 rounded-2xl shadow bg-green-50'>
                <h4 class='font-semibold'>Sekolah Terbanyak</h4><p class='text-2xl font-bold'>${topSchool[0]||'-'}</p>
              </div>
              <div class='p-6 rounded-2xl shadow bg-purple-50'>
                <h4 class='font-semibold'>Kelas Tersedia</h4><p class='text-2xl font-bold'>${availableClasses.length}</p>
              </div>
            </div>
          </div>`;
      } else if (currentUser.role === 'Admin'){
        const adminStudents = studentsData.filter(s => s.region === currentUser.region);
        content.innerHTML = `
          <div class='ml-6 mr-6'>
            <h2 class='text-2xl font-bold mb-3'>Selamat Datang, ${currentUser.name}</h2>
            <p class='text-gray-700 mb-4'>Regional: ${currentUser.region}</p>
            <div class='grid grid-cols-1 md:grid-cols-3 gap-4'>
              <div class='p-4 rounded bg-blue-50'>Total Siswa <div class='text-2xl font-bold'>${adminStudents.length}</div></div>
              <div class='p-4 rounded bg-green-50'>Kelas <div class='text-2xl font-bold'>${[...new Set(adminStudents.map(s=>s.class))].length}</div></div>
              <div class='p-4 rounded bg-purple-50'>Sekolah Teratas<div class='text-2xl font-bold'>${(function(){ const sc={}; adminStudents.forEach(s=>{if(s.school)sc[s.school]=(sc[s.school]||0)+1}); return Object.entries(sc).sort((a,b)=>b[1]-a[1])[0]?.[0]||'-' })()}</div></div>
            </div>
          </div>`;
      } else {
        const student = studentsData.find(s => s.username === currentUser.username) || {};
        const totalAttendance = (student.attendance||[]).length;
        const hadirCount = (student.attendance||[]).filter(a=>a.status==='Hadir').length;
        const hadirPercent = totalAttendance? Math.round((hadirCount/totalAttendance)*100) : 0;
        const avgSkol = (student.skolastikTests||[]).reduce((a,b)=>a+b.score||0,0) / ((student.skolastikTests||[]).length||1);
        content.innerHTML = `
          <div class='ml-6 mr-6'>
            <h2 class='text-2xl font-bold mb-2'>Halo, ${student.name||currentUser.name}</h2>
            <div class='grid grid-cols-1 md:grid-cols-3 gap-4'>
              <div class='p-4 rounded bg-blue-50 text-center'>Kehadiran<div class='text-3xl font-bold'>${hadirPercent}%</div></div>
              <div class='p-4 rounded bg-green-50 text-center'>Skolastik<div class='text-3xl font-bold'>${Math.round(avgSkol)||0}</div></div>
              <div class='p-4 rounded bg-purple-50 text-center'>Total Karya<div class='text-3xl font-bold'>${(student.artworks||[]).length}</div></div>
            </div>
          </div>`;
      }
    }

    function loadArtProgress(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üé® Kemajuan Gambar</h2><p class="text-sm text-gray-600">Filter berdasarkan kelas/region.</p>'; }
    function loadSkolastikProgress(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üìä Kemajuan Tes Skolastik</h2>'; }
    function loadTkaProgress(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üìà Kemajuan TKA</h2>'; }
    function loadSchedule(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üìÖ Jadwal Belajar</h2>'; }
    function loadActivitySchedule(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üìÜ Jadwal Kegiatan</h2>'; }
    function loadMaterials(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üìö Materi Kelas</h2>'; }
    function loadEducationInfo(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üì∞ Informasi Pendidikan</h2>'; }
    function loadAddStudent(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üë§ Tambah Siswa</h2>'; }
    function loadManageClasses(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üè´ Kelola Kelas</h2>'; }
    function loadManageAdmins(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üõ°Ô∏è Kelola Admin Regional</h2>'; }
    function loadLogActivity(){ const content = document.getElementById('contentArea'); content.innerHTML = '<h2 class="text-xl font-bold">üìú Log Aktivitas</h2>'; }

    // ---------- Auth & Lifecycle (single source of truth) ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      // Try load session and server data
      loadSession();
      seedLocalData();
      await loadAllData();

      const loginForm = document.getElementById('loginForm');
      loginForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        const users = getAllUsers();
        if (users[u] && users[u].password === p){
          currentUser = { username: u, ...users[u] };
          saveSession();
          document.getElementById('loginPage').classList.add('hidden');
          document.getElementById('dashboardPage').classList.remove('hidden');
          loadSidebar(); loadHome();
          showNotification('Login berhasil', 'success');
        } else {
          showNotification('Username atau password salah', 'error');
        }
      });

      document.getElementById('logoutBtn').addEventListener('click', ()=>{
        // Save data before logout
        saveAllData();
        localStorage.removeItem('currentUser');
        currentUser = null;
        document.getElementById('dashboardPage').classList.add('hidden');
        document.getElementById('loginPage').classList.remove('hidden');
      });

      document.getElementById('saveBtn').addEventListener('click', ()=> saveAllData());

      // If session exists, auto-show dashboard
      if (currentUser){
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('dashboardPage').classList.remove('hidden');
        loadSidebar(); loadHome();
      }
    });

  </script>
</body>
</html>
