<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Informasi Laporan Kemajuan Siswa - Bimbel Gambar Villa Merah</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        * {
            box-sizing: border-box;
        }

        .sidebar-active {
            background-color: #1e40af;
            color: white;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .editable-image {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .editable-image:hover {
            transform: scale(1.05);
        }

        table {
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #e5e7eb;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .success { background-color: #10b981; }
        .error { background-color: #ef4444; }

        .student-card {
            transition: all 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            height: 8px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        /* Custom colors for Super Admin Home */
        .super-admin-card-1 { background: linear-gradient(135deg, #F97316 0%, #EA580C 100%); } /* Orange */
        .super-admin-card-2 { background: linear-gradient(135deg, #10B981 0%, #059669 100%); } /* Green */
        .super-admin-card-3 { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); } /* Blue */
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBCMZlKFzLvWlBgb4lGd4RpDnBBmxadhYM",
  authDomain: "portal-lks.firebaseapp.com",
  databaseURL: "https://portal-lks-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "portal-lks",
  storageBucket: "portal-lks.firebasestorage.app",
  messagingSenderId: "839732443021",
  appId: "1:839732443021:web:efed4fa039f57c3bce2fc4",
  measurementId: "G-T3PCLKPJQM"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function saveAllData() {}
);
    return Promise.all(promises);
  }
  await Promise.all([
    writeCollection('studentsData', studentsData || []),
    writeCollection('regionalAdmins', regionalAdmins || []),
    writeCollection('availableClasses', availableClasses || []),
    writeCollection('educationInfo', educationInfo || []),
    writeCollection('scheduleData', scheduleData || []),
    writeCollection('activityScheduleData', activityScheduleData || []),
    writeCollection('classMaterials', classMaterials || []),
    writeCollection('availableSchools', availableSchools || [])
  ]);
  // refresh current view if on home for Admin/Super Admin
  if (currentUser && currentModule === 'home' && (currentUser.role === 'Admin' || currentUser.role === 'Super Admin')) {
    loadHome();
  }
}

async function loadAllData() {}
try {
    studentsData = await readCollection('studentsData');
    regionalAdmins = await readCollection('regionalAdmins');
    availableClasses = await readCollection('availableClasses');
    educationInfo = await readCollection('educationInfo');
    scheduleData = await readCollection('scheduleData');
    activityScheduleData = await readCollection('activityScheduleData');
    classMaterials = await readCollection('classMaterials');
    availableSchools = await readCollection('availableSchools');
  } catch (err) {
    console.error('loadAllData error', err);
  }
}

// Realtime listeners to keep UI in sync
db.collection('studentsData').onSnapshot(snap => {
  studentsData = snap.docs.map(d => d.data());
  if (currentModule === 'home') loadHome();
});
db.collection('regionalAdmins').onSnapshot(snap => {
  regionalAdmins = snap.docs.map(d => d.data());
  if (currentModule === 'home') loadHome();
});
db.collection('availableClasses').onSnapshot(snap => {
  availableClasses = snap.docs.map(d => d.data());
  if (currentModule === 'home') loadHome();
});
db.collection('educationInfo').onSnapshot(snap => {
  educationInfo = snap.docs.map(d => d.data());
});
db.collection('scheduleData').onSnapshot(snap => {
  scheduleData = snap.docs.map(d => d.data());
});
db.collection('activityScheduleData').onSnapshot(snap => {
  activityScheduleData = snap.docs.map(d => d.data());
});
db.collection('classMaterials').onSnapshot(snap => {
  classMaterials = snap.docs.map(d => d.data());
});
db.collection('availableSchools').onSnapshot(snap => {
  availableSchools = snap.docs.map(d => d.data());
});

// expose for console/debug
window.db = db;
</script>

</head>
 <body class="bg-white">
  <div id="loginPage" class="min-h-full flex items-center justify-center py-12 px-4">
   <div class="max-w-md w-full space-y-8">
    <div class="text-center">
     <div class="bg-white-600 w-24 h-24 mx-auto rounded-lg flex items-center justify-center mb-4 shadow-lg">
      <img src="https://www.villamerah.com/assets/images/logo/logo-2.png" alt="Logo Bimbel Gambar Villa Merah" class="w-20 h-20 p-2">
     </div>
     <h2 class="text-3xl font-bold text-gray-900 mb-2" style="color: red;">Bimbel Gambar Villa Merah</h2>
     <h3 class="text-3xl font-semibold text-blue-600">Laporan Kemajuan Siswa</h3>
    </div>
    <form id="loginForm" class="mt-8 space-y-6">
     <div class="space-y-4">
      <div><label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label> <input id="username" name="username" type="text" required class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
      </div>
      <div><label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label> <input id="password" name="password" type="password" required class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
      </div>
     </div>
     <div><button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"> Masuk </button>
     </div>
    </form>
    <div class="mt-4 text-center text-sm text-gray-600">
     
    </div>
   </div>
  </div>
  <div id="dashboardPage" class="hidden min-h-full">
   <header class="bg-white border-b border-gray-200 fixed w-full top-0 z-10 shadow-sm">
    <div class="flex items-center justify-between px-6 py-4">
     <div class="flex items-center space-x-4">
      <div class="bg-white-600 w-12 h-12 rounded-lg flex items-center justify-center shadow-lg">
       <img src="https://bimbelgambar.id/wp-content/uploads/2023/06/favicon-20200601113259.png" alt="Logo Bimbel Gambar Villa Merah" class="w-10 h-10 p-1">
      </div>
      <div>
       <h1 class="text-xl font-bold text-red-600">Bimbel Gambar Villa Merah</h1>
       <p class="text-sm text-gray-600" id="userRole"></p>
       <p class="text-xs text-blue-600" id="userRegion"></p>
      </div>
     </div>
     <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow-sm"> Keluar </button>
    </div>
   </header>
   <div class="flex pt-20">
    <aside class="w-64 bg-blue-600 min-h-full fixed left-0 text-white shadow-lg">
     <nav class="p-4 space-y-2" id="sidebarMenu"></nav>
    </aside>
    <main class="ml-64 flex-1 p-8 w-full">
     <div id="contentArea" class="fade-in"></div>
    </main>
   </div>
  </div>
  <div id="modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
   <div class="flex items-center justify-center min-h-full p-4">
    <div class="modal-backdrop fixed inset-0" onclick="closeModal()"></div>
    <div class="bg-white rounded-lg shadow-xl relative z-10 max-w-4xl w-full max-h-full overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-4">
       <h3 id="modalTitle" class="text-xl font-bold text-gray-900"></h3><button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">√ó</span> </button>
      </div>
      <div id="modalContent"></div>
     </div>
    </div>
   </div>
  </div>
  <script>

        
function saveAllData() {
  localStorage.setItem("studentsData", JSON.stringify(studentsData));
  localStorage.setItem("regionalAdmins", JSON.stringify(regionalAdmins));
  localStorage.setItem("availableClasses", JSON.stringify(availableClasses));
  localStorage.setItem("educationInfo", JSON.stringify(educationInfo));
  localStorage.setItem("scheduleData", JSON.stringify(scheduleData));
  localStorage.setItem("activityScheduleData", JSON.stringify(activityScheduleData));
  localStorage.setItem("classMaterials", JSON.stringify(classMaterials));
  localStorage.setItem("availableSchools", JSON.stringify(availableSchools));

  // üîÅ Auto Refresh Dashboard jika di halaman Home (Super Admin / Admin)
  if (currentUser && currentModule === 'home' && (currentUser.role === 'Admin' || currentUser.role === 'Super Admin')) {
      loadHome();
  }
}

function loadAllData() {
  const sd = localStorage.getItem("studentsData");
  const ra = localStorage.getItem("regionalAdmins");
  const ac = localStorage.getItem("availableClasses");
  const ei = localStorage.getItem("educationInfo");
  const sch = localStorage.getItem("scheduleData");
  if (sd) studentsData = JSON.parse(sd);
  if (ra) regionalAdmins = JSON.parse(ra);
  if (ac) availableClasses = JSON.parse(ac);
  if (ei) educationInfo = JSON.parse(ei);
  if (sch) scheduleData = JSON.parse(sch);
  const act = localStorage.getItem("activityScheduleData");
  if (act) activityScheduleData = JSON.parse(act);
  const cm = localStorage.getItem('classMaterials');
  const sc = localStorage.getItem('availableSchools');
  if (cm) classMaterials = JSON.parse(cm);
  if (sc) availableSchools = JSON.parse(sc);
}
function saveSession() {
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
}
function loadSession() {
  const cu = localStorage.getItem("currentUser");
  if (cu) {
    currentUser = JSON.parse(cu);
    showDashboard();
  }
}
window.addEventListener("DOMContentLoaded", () => {
  loadAllData();
  loadSession();
});
document.addEventListener("DOMContentLoaded", () => {
  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', function(e) {
      setTimeout(() => {
        if (currentUser) saveSession();
      }, 200);
    });
  }
});
const originalLogout = logout;
logout = function() {
  saveAllData();
  localStorage.removeItem("currentUser");
  originalLogout();
};
window.saveAllData = saveAllData;

        // Data Storage
        let currentUser = null;
        let currentModule = 'home';
        let selectedClass = 'all'; 
        let selectedClassMaterial = 'all'; // Filter untuk Materi (TAMBAHAN BARU)
        let selectedClassSchedule = 'all'; // Filter untuk Jadwal (TAMBAHAN BARU)
        let selectedAdminRegion = 'all'; // NEW: Filter Global Admin
        
        // Data Admin Regional yang terpisah - MODIFIED REGIONAL NAMES
        let regionalAdmins = [
            { username: 'admin_jaksel', password: 'admin123', role: 'Admin', name: 'Admin Jakarta Selatan', region: 'Cabang Jakarta Selatan' },
            { username: 'admin_jaktim', password: 'admin123', role: 'Admin', name: 'Admin Jakarta Timur', region: 'Cabang Jakarta Timur' },
            { username: 'admin_bandung', password: 'admin123', role: 'Admin', name: 'Admin Bandung', region: 'Pusat Bandung' }
        ];

        // Gabungan semua users, termasuk Super Admin
        const superAdminUser = { username: 'superadmin', password: 'super123', role: 'Super Admin', name: 'Super Admin Utama', region: 'Pusat' };
        
        /**
         * FUNGSI MODIFIKASI: Mengambil semua pengguna dari Super Admin, Admin Regional, dan Siswa (studentsData).
         * Akun Siswa sekarang sepenuhnya diurus oleh studentsData.
         */
        function getAllUsers() {
            const users = {};
            
            // Tambahkan Super Admin
            users[superAdminUser.username] = superAdminUser;
            
            // Tambahkan Admin Regional
            regionalAdmins.forEach(admin => {
                users[admin.username] = admin;
            });
            
            // Tambahkan Siswa dari studentsData
            studentsData.forEach(student => {
                // Gunakan username dan password dari studentsData (yang kini sudah dimodifikasi)
                if (student.username) { 
                    users[student.username] = { 
                        password: student.password || 'siswa123', // Gunakan password yang tersimpan, default ke 'siswa123' jika tidak ada
                        role: 'Siswa', 
                        name: student.name, 
                        region: student.region 
                    };
                }
            });

            return users;
        }

        // Data Sekolah Baru
        let availableSchools = [
            { id: 1, name: 'SMA Negeri 1 Jakarta' },
            { id: 2, name: 'SMA Swasta 7 Bandung' },
            { id: 3, name: 'SMK Seni Rupa' }
        ];

        // MODIFIED: availableClasses kini memiliki properti region
        let availableClasses = [
            { id: 1, name: 'Gold', description: 'Kelas dasar intensif.', region: 'Cabang Jakarta Selatan' },
            { id: 2, name: 'Advance', description: 'Kelas lanjutan untuk persiapan kompetisi.', region: 'Cabang Jakarta Selatan' },
            { id: 3, name: 'Minat Seni', description: 'Kelas santai untuk hobi.', region: 'Cabang Jakarta Timur' },
            { id: 4, name: 'Arsitek', description: 'Kelas khusus persiapan masuk jurusan Arsitektur.', region: 'Pusat Bandung' }
        ];


        // MODIFIED REGIONAL NAMES IN STUDENTS DATA (MENAMBAH USERNAME DAN PASSWORD)
        let studentsData = [
            {
                id: 1,
                name: 'Budi Santoso',
                username: 'siswa1', // <<< TAMBAH USERNAME
                password: 'siswa123', // <<< TAMBAH PASSWORD
                class: 'Gold',
                region: 'Cabang Jakarta Selatan',
                school: 'SMA Negeri 1 Jakarta', // Data Sekolah
                artworks: [
                    {
                        id: 1,
                        title: 'Sketsa Pemandangan Gunung',
                        description: 'Gambar pemandangan gunung dengan teknik pensil',
                        date: '2024-01-15',
                        image: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%2387CEEB" width="400" height="300"/%3E%3Ccircle cx="320" cy="60" r="40" fill="%23FFD700"/%3E%3Cpath d="M0,200 Q100,150 200,200 T400,200 L400,300 L0,300 Z" fill="%234CAF50"/%3E%3Cpath d="M80,120 L120,200 L40,200 Z" fill="%238B4513"/%3E%3Cpath d="M80,80 Q60,100 40,120 Q100,110 120,120 Q100,100 80,80" fill="%232E7D32"/%3E%3Ctext x="200" y="280" text-anchor="middle" fill="%23333" font-size="14"%3EPemandangan Gunung%3C/text%3E%3C/svg%3E',
                        comment: 'Komposisi bagus, perhatikan detail bayangan pada gunung'
                    },
                    {
                        id: 2,
                        title: 'Potret Wajah',
                        description: 'Latihan menggambar proporsi wajah manusia',
                        date: '2024-01-20',
                        image: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23F5F5DC" width="400" height="300"/%3E%3Cellipse cx="200" cy="150" rx="80" ry="100" fill="%23FFE4C4"/%3E%3Cellipse cx="180" cy="130" rx="10" ry="15" fill="%23000"/%3E%3Cellipse cx="220" cy="130" rx="10" ry="15" fill="%23000"/%3Cpath d="M185,160 Q200,170 215,160" stroke="%23000" fill="none" stroke-width="2"/%3E%3Cpath d="M190,180 Q200,190 210,180" stroke="%23000" fill="none" stroke-width="2"/%3E%3Ctext x="200" y="280" text-anchor="middle" fill="%23333" font-size="14"%3EPotret Wajah%3C/text%3E%3C/text%3E%3C/svg%3E',
                        comment: 'Proporsi wajah sudah baik, tingkatkan detail pada mata dan hidung'
                    }
                ],
                attendance: [
                    { date: '2024-01-08', status: 'Hadir' },
                    { date: '2024-01-15', status: 'Hadir' },
                    { date: '2024-01-22', status: 'Izin' },
                    { date: '2024-01-29', status: 'Hadir' }
                ],
                skolastikTests: [
                    { date: '2024-01-10', subject: 'Matematika Dasar', score: 85, comment: 'Pemahaman konsep sudah baik, tingkatkan latihan soal' },
                    { date: '2024-01-17', subject: 'Bahasa Indonesia', score: 90, comment: 'Kemampuan membaca dan menulis sangat baik' },
                    { date: '2024-01-24', subject: 'Bahasa Inggris', score: 78, comment: 'Perlu latihan lebih pada grammar dan vocabulary' }
                ],
                tkaTests: [
                    { date: '2024-01-12', subject: 'Penalaran Umum', score: 82, comment: 'Logika berpikir sudah berkembang dengan baik' },
                    { date: '2024-01-19', subject: 'Pengetahuan Kuantitatif', score: 75, comment: 'Perlu latihan lebih pada soal-soal hitungan cepat' },
                    { date: '2024-01-26', subject: 'Literasi Bahasa Indonesia', score: 88, comment: 'Kemampuan memahami teks sangat baik' }
                ]
            },
            {
                id: 2,
                name: 'Sari Dewi',
                username: 'siswa2', // <<< TAMBAH USERNAME
                password: 'siswa123', // <<< TAMBAH PASSWORD
                class: 'Advance',
                region: 'Cabang Jakarta Timur',
                school: 'SMA Swasta 7 Bandung', // Data Sekolah
                artworks: [
                    {
                        id: 1,
                        title: 'Still Life Buah-buahan',
                        description: 'Gambar still life dengan teknik pensil warna',
                        date: '2024-01-18',
                        image: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23FFFAF0" width="400" height="300"/%3E%3Cellipse cx="150" cy="180" rx="40" ry="35" fill="%23FF6347"/%3E%3Cellipse cx="250" cy="170" rx="35" ry="40" fill="%23FFD700"/%3E%3Cellipse cx="200" cy="200" rx="30" ry="25" fill="%23FF4500"/%3E%3Cpath d="M140,150 Q150,140 160,150" stroke="%23228B22" fill="none" stroke-width="3"/%3E%3Cpath d="M240,135 Q250,125 260,135" stroke="%23228B22" fill="none" stroke-width="3"/%E%3Ctext x="200" y="280" text-anchor="middle" fill="%23333" font-size="14"%3EStill Life Buah%3C/text%3E%3C/svg%3E',
                        comment: 'Penggunaan warna sangat bagus, perhatikan pencahayaan dan bayangan'
                    }
                ],
                attendance: [
                    { date: '2024-01-08', status: 'Hadir' },
                    { date: '2024-01-15', status: 'Hadir' },
                    { date: '2024-01-22', status: 'Hadir' },
                    { date: '2024-01-29', status: 'Sakit' }
                ],
                skolastikTests: [
                    { date: '2024-01-11', subject: 'Matematika Dasar', score: 92, comment: 'Kemampuan analisis matematika sangat baik' },
                    { date: '2024-01-18', subject: 'Bahasa Indonesia', score: 95, comment: 'Kemampuan berbahasa luar biasa' }
                ],
                tkaTests: [
                    { date: '2024-01-13', subject: 'Penalaran Umum', score: 90, comment: 'Kemampuan berpikir logis sangat baik' },
                    { date: '2024-01-20', subject: 'Pengetahuan Kuantitatif', score: 85, comment: 'Konsisten dalam mengerjakan soal matematika' }
                ]
            },
            {
                id: 3,
                name: 'Ahmad Rizki',
                username: 'siswa3', // <<< TAMBAH USERNAME
                password: 'siswa123', // <<< TAMBAH PASSWORD
                class: 'Gold', // Mengubah 'Minat Seni' menjadi 'Gold' karena kelas 'Minat Seni' di Jkt Sel telah dihapus dan diganti dengan 'Gold'
                region: 'Cabang Jakarta Selatan',
                school: 'SMA Negeri 1 Jakarta', // Data Sekolah
                artworks: [
                    {
                        id: 1,
                        title: 'Sketsa Arsitektur',
                        description: 'Gambar perspektif bangunan dengan teknik pensil',
                        date: '2024-01-22',
                        image: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23E6F3FF" width="400" height="300"/%3E%3Cpath d="M50,250 L150,100 L350,100 L350,250 Z" fill="%23D3D3D3" stroke="%23000" stroke-width="2"/%3E%3Crect x="100" y="180" width="40" height="70" fill="%23654321"/%3E%3Crect x="200" y="150" width="60" height="40" fill="%234169E1"/%3E%3Crect x="280" y="170" width="50" height="50" fill="%234169E1"/%3E%3Cpath d="M150,100 L200,50 L400,50 L350,100 Z" fill="%23B22222"/%3E%3Ctext x="200" y="280" text-anchor="middle" fill="%23333" font-size="14"%3EArsitektur Bangunan%3C/text%3E%3C/svg%3E',
                        comment: 'Perspektif sudah baik, tingkatkan detail pada elemen arsitektur'
                    }
                ],
                attendance: [
                    { date: '2024-01-08', status: 'Hadir' },
                    { date: '2024-01-15', status: 'Hadir' },
                    { date: '2024-01-22', status: 'Hadir' },
                    { date: '2024-01-29', status: 'Hadir' }
                ],
                skolastikTests: [
                    { date: '2024-01-12', subject: 'Matematika Dasar', score: 88, comment: 'Kemampuan problem solving yang baik' },
                    { date: '2024-01-19', subject: 'Bahasa Indonesia', score: 82, comment: 'Perlu meningkatkan kemampuan analisis teks' }
                ],
                tkaTests: [
                    { date: '2024-01-14', subject: 'Penalaran Umum', score: 86, comment: 'Kemampuan logika berkembang dengan baik' },
                    { date: '2024-01-21', subject: 'Pengetahuan Kuantitatif', score: 79, comment: 'Perlu latihan lebih pada perhitungan cepat' }
                ]
            },
            {
                id: 4,
                name: 'Maya Putri',
                username: 'siswa4', // <<< TAMBAH USERNAME
                password: 'siswa123', // <<< TAMBAH PASSWORD
                class: 'Minat Seni', // Mengubah 'Arsitek' menjadi 'Minat Seni' karena kelas 'Arsitek' di Jkt Timur telah dihapus
                region: 'Cabang Jakarta Timur',
                school: 'SMA Swasta 7 Bandung', // Data Sekolah
                artworks: [
                    {
                        id: 1,
                        title: 'Desain Rumah Minimalis',
                        description: 'Sketsa desain rumah minimalis 2 lantai',
                        date: '2024-01-25',
                        image: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23F0F8FF" width="400" height="300"/%3E%3Crect x="50" y="150" width="300" height="120" fill="%23D3D3D3" stroke="%23000" stroke-width="2"/%3E%3Crect x="80" y="200" width="40" height="70" fill="%23654321"/%3E%3Crect x="150" y="180" width="60" height="40" fill="%234169E1"/%3E%3Crect x="250" y="180" width="60" height="40" fill="%234169E1"/%3E%3Cpath d="M50,150 L200,80 L350,150 Z" fill="%23B22222"/%3E%3Ctext x="200" y="290" text-anchor="middle" fill="%23333" font-size="12"%3ERumah Minimalis 2 Lantai%3C/text%3E%3C/svg%3E',
                        comment: 'Desain arsitektur yang baik, perhatikan proporsi dan detail struktur'
                    }
                ],
                attendance: [
                    { date: '2024-01-08', status: 'Hadir' },
                    { date: '2024-01-15', status: 'Hadir' },
                    { date: '2024-01-22', status: 'Hadir' },
                    { date: '2024-01-29', status: 'Hadir' }
                ],
                skolastikTests: [
                    { date: '2024-01-13', subject: 'Matematika Dasar', score: 91, comment: 'Kemampuan matematika untuk arsitektur sangat baik' },
                    { date: '2024-01-20', subject: 'Fisika Dasar', score: 87, comment: 'Pemahaman konsep fisika bangunan baik' }
                ],
                tkaTests: [
                    { date: '2024-01-15', subject: 'Penalaran Spasial', score: 93, comment: 'Kemampuan visualisasi ruang sangat baik untuk arsitektur' },
                    { date: '2024-01-22', subject: 'Pengetahuan Kuantitatif', score: 88, comment: 'Kemampuan perhitungan teknis baik' }
                ]
            },
            {
                id: 5,
                name: 'Rina Sari',
                username: 'siswa5', // <<< TAMBAH USERNAME
                password: 'siswa123', // <<< TAMBAH PASSWORD
                class: 'Arsitek', // Mengubah 'Gold' menjadi 'Arsitek' karena kelas 'Gold' di Bdg telah dihapus
                region: 'Pusat Bandung',
                school: 'SMK Seni Rupa', // Data Sekolah
                artworks: [
                    {
                        id: 1,
                        title: 'Lukisan Cat Air Bunga',
                        description: 'Lukisan bunga mawar dengan teknik cat air',
                        date: '2024-01-28',
                        image: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23FFF8DC" width="400" height="300"/%3E%3Ccircle cx="200" cy="150" r="60" fill="%23FF69B4" opacity="0.8"/%3E%3Ccircle cx="180" cy="130" r="25" fill="%23FF1493" opacity="0.6"/%3E%3Ccircle cx="220" cy="130" r="25" fill="%23FF1493" opacity="0.6"/%3E%3Ccircle cx="200" cy="170" r="25" fill="%23FF1493" opacity="0.6"/%3E%3Cpath d="M200,210 Q190,240 200,250 Q210,240 200,210" fill="%23228B22"/%3E%3Ctext x="200" y="280" text-anchor="middle" fill="%23333" font-size="14"%3EBunga Mawar Cat Air%3C/text%3E%3C/svg%3E',
                        comment: 'Teknik cat air sudah baik, perhatikan gradasi warna'
                    }
                ],
                attendance: [
                    { date: '2024-01-08', status: 'Hadir' },
                    { date: '2024-01-15', status: 'Hadir' },
                    { date: '2024-01-22', status: 'Hadir' },
                    { date: '2024-01-29', status: 'Hadir' }
                ],
                skolastikTests: [
                    { date: '2024-01-14', subject: 'Matematika Dasar', score: 89, comment: 'Kemampuan analisis yang baik' },
                    { date: '2024-01-21', subject: 'Bahasa Indonesia', score: 93, comment: 'Kemampuan berbahasa sangat baik' }
                ],
                tkaTests: [
                    { date: '2024-01-16', subject: 'Penalaran Umum', score: 87, comment: 'Logika berpikir berkembang baik' },
                    { date: '2024-01-23', subject: 'Literasi Bahasa Indonesia', score: 91, comment: 'Kemampuan memahami teks sangat baik' }
                ]
            },
            {
                id: 6,
                name: 'Doni Pratama',
                username: 'siswa6', // <<< TAMBAH USERNAME
                password: 'siswa123', // <<< TAMBAH PASSWORD
                class: 'Advance',
                region: 'Pusat Bandung',
                school: 'SMK Seni Rupa', // Data Sekolah
                artworks: [
                    {
                        id: 1,
                        title: 'Sketsa Potret Realistis',
                        description: 'Potret wajah dengan teknik pensil realistis',
                        date: '2024-01-30',
                        image: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23F5F5DC" width="400" height="300"/%3E%3Cellipse cx="200" cy="150" rx="70" ry="90" fill="%23FDBCB4"/%3E%3Cellipse cx="180" cy="130" rx="8" ry="12" fill="%23000"/%3E%3Cellipse cx="220" cy="130" rx="8" ry="12" fill="%23000"/%3E%3Cpath d="M185,155 Q200,165 215,155" stroke="%23000" fill="none" stroke-width="2"/%3E%3Cpath d="M190,175 Q200,185 210,175" stroke="%23000" fill="none" stroke-width="2"/%3E%3Cpath d="M170,120 Q180,115 190,120" stroke="%238B4513" fill="none" stroke-width="3"/%E%3Cpath d="M210,120 Q220,115 230,120" stroke="%238B4513" fill="none" stroke-width="3"/%E%3Ctext x="200" y="280" text-anchor="middle" fill="%23333" font-size="14"%3EPotret Realistis%3C/text%3E%3C/svg%3E',
                        comment: 'Detail dan proporsi sangat baik, tingkatkan teknik shading'
                    }
                ],
                attendance: [
                    { date: '2024-01-08', status: 'Hadir' },
                    { date: '2024-01-15', status: 'Hadir' },
                    { date: '2024-01-22', status: 'Izin' },
                    { date: '2024-01-29', status: 'Hadir' }
                ],
                skolastikTests: [
                    { date: '2024-01-15', subject: 'Matematika Dasar', score: 86, comment: 'Kemampuan problem solving baik' },
                    { date: '2024-01-22', subject: 'Bahasa Inggris', score: 84, comment: 'Perlu latihan lebih pada vocabulary' }
                ],
                tkaTests: [
                    { date: '2024-01-17', subject: 'Penalaran Umum', score: 89, comment: 'Kemampuan analisis sangat baik' },
                    { date: '2024-01-24', subject: 'Pengetahuan Kuantitatif', score: 82, comment: 'Konsisten dalam mengerjakan soal' }
                ]
            }
        ];

        let educationInfo = [
            {
                id: 1,
                title: 'Sistem Ujian SNBP 2026',
                content: 'Seleksi Nasional Berdasarkan Prestasi (SNBP) 2026 menggunakan sistem nilai rapor dan prestasi akademik. Bobot penilaian: 50% nilai rapor, 30% prestasi akademik, 20% portofolio. Pendaftaran dibuka mulai Februari 2026 dengan kuota 20% dari total daya tampung perguruan tinggi.',
                date: '2024-01-15'
            },
            {
                id: 2,
                title: 'Sistem Ujian SNBT 2026',
                content: 'Seleksi Nasional Berdasarkan Tes (SNBT) 2026 terdiri dari Tes Skolastik dan Tes Literasi. Materi tes fokus pada kemampuan penalaran dan pemecahan masalah. Tes dilaksanakan secara serentak di seluruh Indonesia pada bulan Mei 2026.',
                date: '2024-01-20'
            },
            {
                id: 3,
                title: 'Sistem Ujian Mandiri 2026',
                content: 'Ujian mandiri perguruan tinggi 2026 memiliki format yang beragam. Beberapa PT menggunakan tes tertulis, wawancara, atau portofolio sesuai program studi. Jadwal ujian mandiri umumnya dilaksanakan setelah pengumuman SNBT.',
                date: '2024-01-25'
            }
        ];

        // MODIFIED: properti 'region' ditambahkan ke setiap materi
        let classMaterials = [
            { id: 1, topic: 'Pengenalan Alat Gambar', description: 'Mengenal berbagai jenis pensil (2H, HB, 2B, 4B, 6B), kertas gambar, penghapus, dan alat gambar dasar lainnya untuk memulai belajar menggambar dengan benar', classes: ['Gold', 'Advance'], region: 'Cabang Jakarta Selatan' },
            { id: 2, topic: 'Teknik Garis Dasar', description: 'Belajar membuat garis lurus, lengkung, dan berbagai jenis garis sebagai dasar menggambar. Latihan kontrol tangan dan tekanan pensil', classes: ['Advance', 'Minat Seni'], region: 'Cabang Jakarta Timur' },
            { id: 3, topic: 'Bentuk Geometri Dasar', description: 'Menggambar lingkaran, persegi, segitiga, dan bentuk geometri dasar lainnya dengan proporsi yang tepat', classes: ['Gold', 'Advance'], region: 'Cabang Jakarta Selatan' },
            { id: 4, topic: 'Perspektif 1 Titik', description: 'Memahami dan menerapkan perspektif satu titik hilang untuk menciptakan kedalaman dalam gambar objek dan bangunan', classes: ['Arsitek', 'Advance'], region: 'Pusat Bandung' },
            { id: 5, topic: 'Shading dan Tekstur', description: 'Teknik membuat bayangan dan tekstur pada objek untuk memberikan dimensi dan realisme. Belajar gradasi dan kontras', classes: ['Minat Seni'], region: 'Cabang Jakarta Timur' },
            { id: 6, topic: 'Perspektif 2 Titik', description: 'Teknik perspektif dua titik hilang untuk menggambar objek dari sudut pandang yang lebih kompleks', classes: ['Arsitek'], region: 'Pusat Bandung' },
            { id: 7, topic: 'Anatomi Manusia', description: 'Mempelajari proporsi dan anatomi tubuh manusia untuk menggambar figur yang akurat dan realistis', classes: ['Gold'], region: 'Cabang Jakarta Selatan' },
            { id: 8, topic: 'Komposisi Lanjutan', description: 'Teknik komposisi untuk karya yang lebih kompleks dengan multiple objek dan elemen. Prinsip rule of thirds dan golden ratio', classes: ['Minat Seni', 'Advance'], region: 'Cabang Jakarta Timur' },
            { id: 9, topic: 'Teknik Rendering', description: 'Teknik finishing dan rendering untuk menghasilkan karya gambar yang profesional dan detail', classes: ['Advance', 'Arsitek'], region: 'Pusat Bandung' }
        ];

        // MODIFIED: Data jadwal diisi dengan properti 'region'
        let scheduleData = [
            { id: 1, date: '2025-11-05', day: 'Selasa', subject: 'Pengenalan Alat Gambar', classes: ['Gold', 'Advance'], region: 'Cabang Jakarta Selatan' },
            { id: 2, date: '2025-11-06', day: 'Rabu', subject: 'Perspektif 1 Titik', classes: ['Minat Seni'], region: 'Cabang Jakarta Timur' },
            { id: 3, date: '2025-11-07', day: 'Kamis', subject: 'Anatomi Manusia', classes: ['Arsitek', 'Advance'], region: 'Pusat Bandung' }
        ];

// === Data Jadwal Kegiatan (Baru) ===
let activityScheduleData = [
  { id: 1, date: '2025-11-10', name: 'Workshop Arsitektur', goal: 'Melatih kemampuan menggambar bangunan', classes: ['Arsitek'], region: 'Pusat Bandung' },
  { id: 2, date: '2025-11-12', name: 'Pameran Seni', goal: 'Menampilkan hasil karya siswa', classes: ['Gold', 'Advance'], region: 'Cabang Jakarta Selatan' }
];


        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const users = getAllUsers();

            if (users[username] && users[username].password === password) {
                currentUser = { username, ...users[username] };
                showDashboard();
            } else {
                showNotification('Username atau password salah!', 'error');
            }
        });

        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            
            // NEW: Menambahkan Sub-Header Universal dan Menghilangkan Role/Region di sini
            const headerInfoDiv = document.querySelector('#dashboardPage header .flex.items-center.space-x-4 div:nth-child(2)');
            
            let subHeader = document.getElementById('bimbelSubHeader');
            if (!subHeader) {
                subHeader = document.createElement('p');
                subHeader.id = 'bimbelSubHeader';
                // PERUBAHAN WARNA TEKS LAPORAN KEMAJUAN SISWA: text-blue-600
                subHeader.className = 'text-lg text-blue-600 font-semibold mb-1'; 
                // Menyisipkan tepat setelah H1
                const h1Element = headerInfoDiv.querySelector('h1');
                headerInfoDiv.insertBefore(subHeader, h1Element.nextSibling); 
            }
            subHeader.textContent = 'Laporan Kemajuan Siswa';
            
            // 1. HILANGKAN ROLE DAN REGION DARI HEADER
            document.getElementById('userRole').textContent = ''; 
            document.getElementById('userRegion').textContent = ''; 
            
            loadSidebar();
            loadHome();
        }

        function logout() {
            currentUser = null;
            currentModule = 'home';
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('loginForm').reset();
        }

        function loadSidebar() {
            const sidebar = document.getElementById('sidebarMenu');
            let menuItems = [
                { id: 'home', label: 'Home', icon: 'üè†' },
                { id: 'artProgress', label: 'Kemajuan Gambar', icon: 'üé®' },
                { id: 'skolastikProgress', label: 'Kemajuan Tes Skolastik', icon: 'üìä' },
                // PERUBAHAN NAMA MODUL: 'Kemajuan TKA'
                { id: 'tkaProgress', label: 'Kemajuan TKA', icon: 'üìà' }, 
                { id: 'schedule', label: 'Jadwal Belajar', icon: 'üìÖ' }, 
                { id: 'activitySchedule', label: 'Jadwal Kegiatan', icon: 'üìÜ' },
                { id: 'materials', label: 'Materi Kelas', icon: 'üìö' },
                { id: 'educationInfo', label: 'Informasi Pendidikan', icon: 'üì∞' }
            ];

            if (currentUser.role === 'Admin') {
                menuItems.push({ id: 'addStudent', label: 'Tambah Siswa', icon: 'üë§' });
                menuItems.push({ id: 'manageClasses', label: 'Kelola Kelas', icon: 'üè´' });
            } else if (currentUser.role === 'Super Admin') {
                // Super Admin memiliki semua modul Admin Regional + modul Tambah Admin Regional
                menuItems.push(
                    { id: 'manageAdmins', label: 'Kelola Admin Regional', icon: 'üõ°Ô∏è' }, // MODUL BARU
                    { id: 'addStudent', label: 'Tambah Siswa (Global)', icon: 'üë§' },
                    { id: 'manageClasses', label: 'Kelola Kelas (Global)', icon: 'üè´' }
                );
            }

            sidebar.innerHTML = menuItems.map(item => `
                <button onclick="loadModule('${item.id}')" id="menu-${item.id}" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-3">
                    <span class="text-xl">${item.icon}</span>
                    <span>${item.label}</span>
                </button>
            `).join('');

            setActiveMenu('home');
        }

        function setActiveMenu(moduleId) {
            document.querySelectorAll('[id^="menu-"]').forEach(btn => {
                btn.classList.remove('sidebar-active');
            });
            const activeBtn = document.getElementById('menu-' + moduleId);
            if (activeBtn) {
                activeBtn.classList.add('sidebar-active');
            }
        }

        function loadModule(moduleId) {
            currentModule = moduleId;
            setActiveMenu(moduleId);
            
            // Reset filters when changing modules (especially Super Admin's class filter for performance)
            if (currentUser.role === 'Super Admin' || currentUser.role === 'Admin') {
                selectedClass = 'all'; // Reset class filter for progress modules
            }
            // Retain material/schedule filters as they are used to render student view as well
            
            switch(moduleId) {
                case 'home':
                    loadHome();
                    break;
                case 'artProgress':
                    loadArtProgress();
                    break;
                case 'skolastikProgress':
                    loadSkolastikProgress();
                    break;
                case 'tkaProgress':
                    loadTkaProgress();
                    break;
                case 'educationInfo':
                    loadEducationInfo();
                    break;
                case 'materials':
                    loadMaterials();
                    break;
                case 'activitySchedule':
                    loadActivitySchedule();
                    break;
                case 'schedule':
                    loadSchedule();
                    break;
                case 'addStudent':
                    loadAddStudent();
                    break;
                case 'manageClasses':
                    loadManageClasses();
                    break;
                case 'manageAdmins': // MODUL BARU
                    loadManageAdmins();
                    break;
            }
        }

        function loadHome() {
            const content = document.getElementById('contentArea');
            const role = currentUser.role;

            if (role === 'Super Admin') {
                // Super Admin Home - Ringkasan Data Admin Regional
                const regions = [...new Set(regionalAdmins.map(a => a.region))];
                const totalStudents = studentsData.length;
                const totalArtworks = studentsData.reduce((total, student) => total + student.artworks.length, 0);

                content.innerHTML = `
                    <div class="fade-in">
                        <div class="bg-gradient-to-r from-red-600 to-red-800 rounded-lg p-8 mb-8 text-white shadow-lg">
                            <h2 class="text-3xl font-bold mb-2">Selamat Datang, ${currentUser.name}!</h2>
                            <p class="text-red-100">Dashboard Kontrol Pusat Seluruh Regional</p>
                            <p class="text-red-100 mt-2">Anda memiliki akses penuh untuk mengelola Admin Regional.</p>
                        </div>

                        <h3 class="text-2xl font-bold text-gray-900 mb-6">üåé Ringkasan Data Regional</h3>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="super-admin-card-1 rounded-lg p-6 text-white shadow-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-orange-100">Total Admin Regional</p>
                                        <p class="text-4xl font-bold">${regionalAdmins.length}</p>
                                    </div>
                                    <span class="text-5xl">üõ°Ô∏è</span>
                                </div>
                            </div>
                            <div class="super-admin-card-2 rounded-lg p-6 text-white shadow-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-green-100">Total Siswa (Global)</p>
                                        <p class="text-4xl font-bold">${totalStudents}</p>
                                    </div>
                                    <span class="text-5xl">üë•</span>
                                </div>
                            </div>
                            <div class="super-admin-card-3 rounded-lg p-6 text-white shadow-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-100">Total Karya Seni</p>
                                        <p class="text-4xl font-bold">${totalArtworks}</p>
                                    </div>
                                    <span class="text-5xl">üé®</span>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-2xl font-bold text-gray-900 mb-4">üìç Detail Data Per Regional</h3>
                        <div class="space-y-4">
                            ${regions.map(regionName => {
                                const adminInRegion = regionalAdmins.filter(a => a.region === regionName).length;
                                const studentsInRegion = studentsData.filter(s => s.region === regionName);
                                const totalStudentInRegion = studentsInRegion.length;
                                const totalArtworksInRegion = studentsInRegion.reduce((total, student) => total + student.artworks.length, 0);
                                
                                return `
                                    <div class="bg-white border-l-4 border-red-500 rounded-lg p-6 shadow-md hover:shadow-lg transition-shadow">
                                        <h4 class="font-bold text-xl text-red-700 mb-3">${regionName}</h4>
                                        <div class="grid grid-cols-3 gap-4 text-gray-700">
                                            <div>
                                                <p class="text-sm font-medium">Admin Aktif</p>
                                                <p class="text-2xl font-bold text-red-600">${adminInRegion}</p>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium">Jumlah Siswa</p>
                                                <p class="text-2xl font-bold text-blue-600">${totalStudentInRegion}</p>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium">Total Karya</p>
                                                <p class="text-2xl font-bold text-green-600">${totalArtworksInRegion}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

            } 


else if (role === 'Admin') {
    let adminStudents = studentsData.filter(s => s.region === currentUser.region);

    const groupsDef = [
        { key: 'SR GOLD', match: name => /sr gold/i.test(name) },
        { key: 'SR ADVANCE', match: name => /sr advance/i.test(name) },
        { key: 'MINAT SENI', match: name => /minat seni/i.test(name) },
        { key: 'ARSITEKTUR', match: name => /arsitektur/i.test(name) && !/minat arsitektur/i.test(name) },
        { key: 'MINAT ARSITEKTUR', match: name => /minat arsitektur/i.test(name) }
    ];

    const classNamesInRegion = [...new Set(adminStudents.map(s => s.class).filter(Boolean))];
    let grouped = {};
    groupsDef.forEach(g => grouped[g.key] = []);
    let remainingClassNames = new Set(classNamesInRegion);

    adminStudents.forEach(s => {
        const className = (s.class || '').toString();
        let assigned = false;
        for (const g of groupsDef) {
            if (g.match(className)) {
                grouped[g.key].push(s);
                assigned = true;
                break;
            }
        }
        if (!assigned) remainingClassNames.add(className);
        else remainingClassNames.delete(className);
    });
    remainingClassNames.forEach(cname => {
        if (!cname) return;
        grouped[cname] = adminStudents.filter(s => s.class === cname);
    });

    let tableRows = [];
    let idx = 1;
    Object.keys(grouped).forEach(key => {
        const studentsInGroup = grouped[key] || [];
        const jumlah = studentsInGroup.length;
        let sekolahTerbanyak = '-';
        if (jumlah > 0) {
            const schoolCount = {};
            studentsInGroup.forEach(st => {
                if (st.school) schoolCount[st.school] = (schoolCount[st.school] || 0) + 1;
            });
            sekolahTerbanyak = Object.entries(schoolCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
        }
        const status = jumlah > 0 ? 'Aktif' : 'Tidak Aktif';
        tableRows.push(`
          <tr class='hover:bg-blue-50 transition-colors'>
            <td class='px-6 py-3 text-sm text-gray-600 text-center font-medium'>${idx}</td>
            <td class='px-6 py-3 text-sm font-semibold text-gray-900'>${key}</td>
            <td class='px-6 py-3 text-sm text-center text-gray-700'>${jumlah}</td>
            <td class='px-6 py-3 text-sm text-gray-600'>${sekolahTerbanyak}</td>
            <td class='px-6 py-3 text-sm text-center font-semibold ${status === 'Aktif' ? 'text-green-600' : 'text-red-500'}'>
              <span class='text-lg mr-1'>${status === 'Aktif' ? 'üü¢' : 'üî¥'}</span>${status}
            </td>
          </tr>
        `);
        idx++;
    });

    const totalStudents = adminStudents.length;
    const schoolCount = {};
    adminStudents.forEach(s => {
        if (s.school) schoolCount[s.school] = (schoolCount[s.school] || 0) + 1;
    });
    const topSchool = Object.entries(schoolCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'Tidak ada data';
    const seniRupaCount = adminStudents.filter(s => /sr|minat seni/i.test(s.class)).length;
    const arsitekturCount = adminStudents.filter(s => /arsitektur|minat arsitektur/i.test(s.class)).length;

    const content = document.getElementById('contentArea');
    content.innerHTML = `
      <main class='max-w-8xl mx-auto py-10 px-10 fade-in'>
        <div class='bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-8 mb-6 text-white shadow-lg'>
          <h2 class='text-3xl font-bold mb-2'>Selamat Datang, ${currentUser.name}!</h2>
          <p class='text-blue-100'>Informasi Laporan Kemajuan Siswa - ${currentUser.region}</p>
        </div>

        <div class='grid grid-cols-1 md:grid-cols-4 gap-6 mb-8'>
          <div class='rounded-xl p-6 shadow-md text-white bg-gradient-to-br from-blue-500 to-blue-700'>
            <p class='text-sm text-blue-100 mb-1'>Total Siswa</p>
            <p class='text-3xl font-bold text-white'>${totalStudents}</p>
          </div>
          <div class='rounded-xl p-6 shadow-md text-white bg-gradient-to-br from-green-500 to-green-700'>
            <p class='text-sm text-green-100 mb-1'>Sekolah Terbanyak</p>
            <p class='text-2xl font-semibold text-white'>${topSchool}</p>
          </div>
          <div class='rounded-xl p-6 shadow-md text-white bg-gradient-to-br from-purple-500 to-purple-700'>
            <p class='text-sm text-purple-100 mb-1'>Siswa Seni Rupa</p>
            <p class='text-3xl font-bold text-white'>${seniRupaCount}</p>
          </div>
          <div class='rounded-xl p-6 shadow-md text-white bg-gradient-to-br from-orange-500 to-orange-700'>
            <p class='text-sm text-orange-100 mb-1'>Siswa Arsitektur</p>
            <p class='text-3xl font-bold text-white'>${arsitekturCount}</p>
          </div>
        </div>

        <h3 class='text-2xl font-bold text-gray-900 mb-4 flex items-center'>
          <span class='text-2xl mr-2'>üìã</span> Data Kelas Aktif
        </h3>

        <div class='bg-white/80 backdrop-blur-sm border border-gray-200 rounded-2xl shadow-xl overflow-hidden'>
          <div class='overflow-x-auto'>
            <table class='min-w-full divide-y divide-gray-200'>
              <thead class='bg-gray-100/70'>
                <tr>
                  <th class='px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider'>No</th>
                  <th class='px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider'>Nama Kelas</th>
                  <th class='px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider'>Jumlah Siswa</th>
                  <th class='px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider'>Sekolah Terbanyak</th>
                  <th class='px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider'>Status Kelas</th>
                </tr>
              </thead>
              <tbody class='bg-white divide-y divide-gray-100'>
                ${tableRows.join('')}
              </tbody>
            </table>
          </div>
        </div>
      </main>`;
}
 else {

                // Student Home - Show individual student data (simplified) (LOGIC DARI FILE ASLI)
                const studentData = studentsData.find(s => s.name === currentUser.name);
                if (!studentData) {
                    content.innerHTML = '<div class="text-center text-gray-500">Data siswa tidak ditemukan</div>';
                    return;
                }

                const avgSkolastik = studentData.skolastikTests.length > 0 ? 
                    (studentData.skolastikTests.reduce((sum, test) => sum + test.score, 0) / studentData.skolastikTests.length).toFixed(1) : 0;
                const avgTka = studentData.tkaTests.length > 0 ? 
                    (studentData.tkaTests.reduce((sum, test) => sum + test.score, 0) / studentData.tkaTests.length).toFixed(1) : 0;
                const attendanceRate = studentData.attendance.length > 0 ? 
                    ((studentData.attendance.filter(att => att.status === 'Hadir').length / studentData.attendance.length) * 100).toFixed(1) : 0;

                content.innerHTML = `
                    <div class="fade-in">
                        <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg p-8 mb-8 text-white shadow-lg">
                            <h2 class="text-3xl font-bold mb-2">Selamat Datang, ${currentUser.name}!</h2>
                            <p class="text-blue-100">Laporan Kemajuan Siswa</p>
                            <p class="text-blue-100 mt-2">Pantau terus perkembangan belajar Anda</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-green-500 rounded-lg p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-green-100">Kehadiran</p>
                                        <p class="text-3xl font-bold">${attendanceRate}%</p>
                                    </div>
                                    <span class="text-4xl">üìã</span>
                                </div>
                            </div>
                            <div class="bg-blue-500 rounded-lg p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-100">Rata-rata Skolastik</p>
                                        <p class="text-3xl font-bold">${avgSkolastik}</p>
                                    </div>
                                    <span class="text-4xl">üìä</span>
                                </div>
                            </div>
                            <div class="bg-purple-500 rounded-lg p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-purple-100">Rata-rata TKA</p>
                                        <p class="text-3xl font-bold">${avgTka}</p>
                                    </div>
                                    <span class="text-4xl">üìà</span>
                                </div>
                            </div>
                            <div class="bg-yellow-500 rounded-lg p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-yellow-100">Total Karya</p>
                                        <p class="text-3xl font-bold">${studentData.artworks.length}</p>
                                    </div>
                                    <span class="text-4xl">üé®</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                <span class="text-2xl mr-3">üé®</span>
                                Ringkasan Kemajuan Gambar
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="text-center p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg">
                                    <div class="bg-blue-500 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                                        <span class="text-2xl text-white">üé®</span>
                                    </div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Total Karya</h4>
                                    <p class="text-3xl font-bold text-blue-600">${studentData.artworks.length}</p>
                                    
                                </div>

                                <div class="text-center p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-lg">
                                    <div class="bg-green-500 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                                        <span class="text-2xl text-white">üìÖ</span>
                                    </div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Karya Terbaru</h4>
                                    ${studentData.artworks.length > 0 ? `
                                        <p class="text-lg font-bold text-green-600">${studentData.artworks[studentData.artworks.length - 1].title}</p>
                                        <p class="text-sm text-gray-600 mt-1">${studentData.artworks[studentData.artworks.length - 1].date}</p>
                                    ` : `
                                        <p class="text-lg font-bold text-gray-500">Belum ada</p>
                                        
                                    `}
                                </div>

                                <div class="text-center p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg">
                                    <div class="bg-purple-500 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                                        <span class="text-2xl text-white">üèÜ</span>
                                    </div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Kelas Saat Ini</h4>
                                    <p class="text-3xl font-bold text-purple-600">${studentData.class}</p>
                                    
                                </div>
                            </div>

                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                                <button onclick="loadModule('artProgress')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                                    <span class="mr-2">üé®</span>
                                    Lihat Semua Karya
                                </button>
                                <button onclick="loadModule('skolastikProgress')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
                                    <span class="mr-2">üìä</span>
                                    Kemajuan Tes Skolastik
                                </button>
                                <button onclick="loadModule('tkaProgress')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center">
                                    <span class="mr-2">üìà</span>
                                    Kemajuan TKA
                                </button>
                                <button onclick="loadModule('materials')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                                    <span class="mr-2">üìö</span>
                                    Materi Belajar
                                </button>
                                <button onclick="loadModule('schedule')" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center">
                                    <span class="mr-2">üìÖ</span>
                                    Jadwal Kelas
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // FUNGSI HELPER BARU: untuk toggle input regional di Super Admin
        window.toggleNewRegionInput = function(selectedValue) {
            const newRegionContainer = document.getElementById('newRegionInputContainer');
            if (newRegionContainer) {
                if (selectedValue === 'NEW_REGION') {
                    newRegionContainer.classList.remove('hidden');
                    document.getElementById('adminRegionInput').setAttribute('required', 'required'); 
                } else {
                    newRegionContainer.classList.add('hidden');
                    document.getElementById('adminRegionInput').removeAttribute('required');
                }
            }
        }

        // --- FUNGSI BARU: MODUL KELOLA ADMIN REGIONAL ---
        function loadManageAdmins() {
            const content = document.getElementById('contentArea');
            if (currentUser.role !== 'Super Admin') {
                content.innerHTML = '<div class="fade-in text-center text-red-600 text-xl font-bold p-10">Akses Ditolak. Hanya Super Admin yang dapat mengakses modul ini.</div>';
                return;
            }

            content.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üõ°Ô∏è Kelola Admin Regional</h2>
                        <button onclick="addRegionalAdmin()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">+ Tambah Admin Regional</button>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Daftar Akun Admin Regional (${regionalAdmins.length})</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Nama Admin</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Username</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Regional</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Jml Siswa</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${regionalAdmins.map(admin => {
                                        const studentsInRegion = studentsData.filter(s => s.region === admin.region).length;
                                        return `
                                            <tr class="border-t border-gray-200 hover:bg-red-50">
                                                <td class="px-4 py-3 text-sm font-medium text-gray-900">${admin.name}</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">${admin.username}</td>
                                                <td class="px-4 py-3 text-sm text-red-600 font-medium">${admin.region}</td>
                                                <td class="px-4 py-3 text-sm text-blue-600 font-bold">${studentsInRegion}</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <button onclick="editRegionalAdmin('${admin.username}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                                    <button onclick="deleteRegionalAdmin('${admin.username}')" class="text-red-600 hover:text-red-800">Hapus</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function addRegionalAdmin() {
            // Dapatkan daftar regional yang sudah ada dan unik
            const studentRegions = studentsData.map(s => s.region).filter(r => r);
            const adminRegions = regionalAdmins.map(a => a.region).filter(r => r);
            const existingRegions = [...new Set([...studentRegions, ...adminRegions])];

            openModal('Tambah Admin Regional Baru', `
                <form id="addAdminForm" class="space-y-4">
                    <div>
                        <label for="adminName" class="block text-sm font-medium text-gray-700 mb-1">Nama Admin</label>
                        <input type="text" id="adminName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label for="adminUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="adminUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="adminPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    
                    <div>
                        <label for="adminRegionSelect" class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
                        <select id="adminRegionSelect" onchange="toggleNewRegionInput(this.value)" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                            <option value="">--- Pilih Regional yang Sudah Ada ---</option>
                            ${existingRegions.sort().map(regionName => `
                                <option value="${regionName}">${regionName}</option>
                            `).join('')}
                            <option value="NEW_REGION">--- Tambah Regional Baru ---</option>
                        </select>
                    </div>

                    <div id="newRegionInputContainer" class="hidden">
                        <label for="adminRegionInput" class="block text-sm font-medium text-gray-700 mb-1">Regional Baru</label>
                        <input type="text" id="adminRegionInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Contoh: Jakarta Pusat">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Tambah Admin</button>
                </form>
            `);

            document.getElementById('addAdminForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('adminUsername').value;
                const name = document.getElementById('adminName').value;
                const password = document.getElementById('adminPassword').value;

                const selectedRegion = document.getElementById('adminRegionSelect').value;
                let region = '';

                if (selectedRegion === 'NEW_REGION') {
                    region = document.getElementById('adminRegionInput').value.trim();
                } else if (selectedRegion) {
                    region = selectedRegion;
                }
                
                if (!region) {
                    showNotification('Silakan pilih atau masukkan Regional!', 'error');
                    return;
                }

                if (getAllUsers()[username]) {
                    showNotification('Username sudah digunakan!', 'error');
                    return;
                }
                
                // Cek konflik regional
                if (regionalAdmins.some(admin => admin.region.toLowerCase() === region.toLowerCase())) {
                     showNotification('Regional ini sudah memiliki Admin. Harap gunakan nama Regional yang berbeda.', 'error');
                    return;
                }

                const newAdmin = { username, password, role: 'Admin', name, region };
                regionalAdmins.push(newAdmin);

                showNotification('Admin Regional berhasil ditambahkan!');
                this.reset();
                closeModal();
                loadManageAdmins();
            });
        }

        function editRegionalAdmin(username) {
            const admin = regionalAdmins.find(a => a.username === username);
            
            openModal('Edit Admin Regional', `
                <form id="editAdminForm" class="space-y-4">
                    <div>
                        <label for="editAdminName" class="block text-sm font-medium text-gray-700 mb-1">Nama Admin</label>
                        <input type="text" id="editAdminName" value="${admin.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label for="editAdminRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
                        <input type="text" id="editAdminRegion" value="${admin.region}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label for="editAdminPassword" class="block text-sm font-medium text-gray-700 mb-1">Password Baru (Opsional)</label>
                        <input type="password" id="editAdminPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <p class="text-xs text-gray-500 mt-1">Kosongkan jika tidak ingin mengubah password</p>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Update Admin</button>
                </form>
            `);

            document.getElementById('editAdminForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newName = document.getElementById('editAdminName').value;
                const newRegion = document.getElementById('editAdminRegion').value;
                const newPassword = document.getElementById('editAdminPassword').value;

                const oldRegion = admin.region;

                // Check if new region conflicts with other regions
                if (regionalAdmins.some(a => a.username !== username && a.region.toLowerCase() === newRegion.toLowerCase())) {
                     showNotification('Regional ini sudah memiliki Admin. Harap gunakan nama Regional yang berbeda.', 'error');
                    return;
                }

                admin.name = newName;
                if (newPassword) {
                    admin.password = newPassword;
                }
                admin.region = newRegion;

                // Update students' region if the region name changed
                if (oldRegion !== newRegion) {
                    studentsData.forEach(student => {
                        if (student.region === oldRegion) {
                            student.region = newRegion;
                        }
                    });
                }
                
                closeModal();
                loadManageAdmins();
                showNotification('Data Admin Regional berhasil diupdate!');
            });
        }

        function deleteRegionalAdmin(username) {
            const admin = regionalAdmins.find(a => a.username === username);
            const studentsInRegion = studentsData.filter(s => s.region === admin.region);

            if (studentsInRegion.length > 0) {
                openModal('Tidak Dapat Menghapus Admin', `
                    <div class="text-center">
                        <div class="mb-4">
                            <span class="text-6xl">‚ùå</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Admin Regional Tidak Dapat Dihapus</h3>
                        <p class="text-gray-700 mb-4">Admin <strong>${admin.name}</strong> masih memiliki <strong>${studentsInRegion.length} siswa</strong> terdaftar di regional <strong>${admin.region}</strong>.</p>
                        <p class="text-sm text-gray-600 mb-6">Pindahkan atau hapus siswa di regional ini terlebih dahulu.</p>
                        <button onclick="closeModal()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Mengerti</button>
                    </div>
                `);
                return;
            }

            openModal('Konfirmasi Hapus Admin', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Hapus Admin Regional</h3>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus Admin <strong>${admin.name}</strong> (${admin.region})?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteRegionalAdmin('${username}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteRegionalAdmin(username) {
            regionalAdmins = regionalAdmins.filter(a => a.username !== username);
            closeModal();
            loadManageAdmins();
            showNotification('Admin Regional berhasil dihapus!');
        }

        // --- END FUNGSI BARU: MODUL KELOLA ADMIN REGIONAL ---


        // --- FUNGSI LAMA DARI FILE ASLI (disimpan untuk kompatibilitas modul admin) ---

        // --- FUNGSI BARU: PDF GENERATOR ---
        function generatePDF(elementId, filename) {
            const element = document.getElementById(elementId);
            
            if (!element) {
                showNotification('Area konten tidak ditemukan!', 'error');
                return;
            }

            // Konfigurasi untuk html2pdf (untuk hasil A4 portrait yang optimal)
            const opt = {
                margin: 0.5, // Margin (dalam inci)
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'in', format: 'A4', orientation: 'portrait' }
            };
            
            // Gunakan fungsi html2pdf untuk membuat dan menyimpan PDF
            html2pdf().set(opt).from(element).save();
            showNotification('PDF sedang dibuat dan akan segera diunduh!', 'success');
        }

        // --- NEW: Helper function to render Region Dropdown for Super Admin ---
        function renderRegionDropdown(currentRegionFilter, filterFunctionName) {
            const regions = [...new Set(regionalAdmins.map(a => a.region))];
            
            // Pastikan regions mencakup semua regional yang ada di studentsData, meskipun adminnya sudah dihapus
            studentsData.forEach(student => {
                if (!regions.includes(student.region) && student.region) {
                    regions.push(student.region);
                }
            });

            return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">Filter Regional</h4>
                    <select onchange="${filterFunctionName}(this.value)" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="all" ${currentRegionFilter === 'all' ? 'selected' : ''}>Semua Regional</option>
                        ${regions.sort().map(regionName => `
                            <option value="${regionName}" ${currentRegionFilter === regionName ? 'selected' : ''}>${regionName}</option>
                        `).join('')}
                    </select>
                </div>
            `;
        }

        // --- NEW: Detail Modal Render Functions ---

        function showStudentArtDetail(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            // Re-use existing render logic for clarity, stripping outer div from renderArtProgressStudent
            const detailContent = renderArtProgressStudent([student], currentUser.role === 'Admin' || currentUser.role === 'Super Admin')
                .replace(/<div class="mb-6">/, '')
                .replace(/<\/div>$/, '');

            openModal(`Detail Kemajuan Gambar: ${student.name}`, detailContent);
        }

        function showStudentSkolastikDetail(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            // Re-use existing render logic, stripping outer div from renderSkolastikProgressStudent
            const detailContent = renderSkolastikProgressStudent([student], isAdminOrSuperAdmin)
                .replace(/<div class="mb-4">/, '') 
                .replace(/<\/div>$/, '');
            
            // Tambahkan judul dan tombol Add Test (yang sudah ada di dalam render function, tapi kita rapikan)
            const finalContent = `
                <div class="mb-4">
                    <h4 class="text-xl font-bold text-gray-900 mb-4">Hasil Tes Skolastik: ${student.name}</h4>
                    <p class="text-sm text-blue-600 font-medium mb-4">Sekolah: ${student.school || 'Belum ditentukan'} ${isAdminOrSuperAdmin ? `| Regional: ${student.region}` : ''}</p>
                </div>
                ${detailContent}`;

            openModal(`Detail Tes Skolastik: ${student.name}`, finalContent);
        }

        function showStudentTkaDetail(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';

            // Re-use existing render logic, stripping outer div from renderTkaProgressStudent
            const detailContent = renderTkaProgressStudent([student], isAdminOrSuperAdmin)
                .replace(/<div class="mb-4">/, '')
                .replace(/<\/div>$/, '');

            // Tambahkan judul dan tombol Add Test (yang sudah ada di dalam render function, tapi kita rapikan)
            const finalContent = `
                <div class="mb-4">
                    <h4 class="text-xl font-bold text-gray-900 mb-4">Hasil Tes TKA: ${student.name}</h4>
                    <p class="text-sm text-blue-600 font-medium mb-4">Sekolah: ${student.school || 'Belum ditentukan'} ${isAdminOrSuperAdmin ? `| Regional: ${student.region}` : ''}</p>
                </div>
                ${detailContent}`;
                
            openModal(`Detail Tes TKA: ${student.name}`, finalContent);
        }

        // NEW: Function to render student list grouped by class
        function renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, currentModule) {
            if (displayData.length === 0) {
                return `<div class="text-center p-6 text-gray-500">Tidak ada data siswa yang ditemukan di regional ini atau filter kelas yang dipilih.</div>`;
            }

            // Get available classes for the current region
            const regionalClasses = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? (selectedAdminRegion === 'all' || c.region === selectedAdminRegion) : c.region === currentUser.region
            );


            // Group students by class
            const groupedStudents = regionalClasses.reduce((groups, classItem) => {
                const students = displayData.filter(s => s.class === classItem.name);
                if (students.length > 0) {
                    groups[classItem.name] = students;
                }
                return groups;
            }, {});

            if (Object.keys(groupedStudents).length === 0) {
                 return `<div class="text-center p-6 text-gray-500">Tidak ada siswa yang terdaftar di kelas yang tersedia atau filter kelas yang dipilih.</div>`;
            }


            let contentHtml = '';

            const detailFunction = currentModule === 'artProgress' 
                ? 'showStudentArtDetail' 
                : currentModule === 'skolastikProgress' 
                ? 'showStudentSkolastikDetail' 
                : 'showStudentTkaDetail';

            for (const className in groupedStudents) {
                const studentsInClass = groupedStudents[className];
                
                // Get overall class stats for the module (if relevant)
                let classStatHtml = '';
                if (currentModule === 'artProgress') {
                    const totalArtworks = studentsInClass.reduce((total, student) => total + student.artworks.length, 0);
                    const totalAttendance = studentsInClass.reduce((total, student) => total + student.attendance.length, 0);
                    const totalHadir = studentsInClass.reduce((total, student) => total + student.attendance.filter(a => a.status === 'Hadir').length, 0);
                    const avgAttendance = totalAttendance > 0 ? ((totalHadir / totalAttendance) * 100).toFixed(1) : 0;
                    classStatHtml = `<p class="text-sm text-gray-600 mt-2">Total Karya: ${totalArtworks} | Rata-rata Kehadiran: ${avgAttendance}%</p>`;
                } else if (currentModule === 'skolastikProgress') {
                    const allScores = studentsInClass.flatMap(s => s.skolastikTests.map(t => t.score));
                    const avgScore = allScores.length > 0 ? (allScores.reduce((sum, score) => sum + score, 0) / allScores.length).toFixed(1) : 0;
                    classStatHtml = `<p class="text-sm text-gray-600 mt-2">Total Tes Skolastik: ${allScores.length} | Rata-rata Nilai: <span class="font-bold text-blue-600">${avgScore}</span></p>`;
                } else if (currentModule === 'tkaProgress') {
                     const allScores = studentsInClass.flatMap(s => s.tkaTests.map(t => t.score));
                    const avgScore = allScores.length > 0 ? (allScores.reduce((sum, score) => sum + score, 0) / allScores.length).toFixed(1) : 0;
                    classStatHtml = `<p class="text-sm text-gray-600 mt-2">Total Tes TKA: ${allScores.length} | Rata-rata Nilai: <span class="font-bold text-purple-600">${avgScore}</span></p>`;
                }

                contentHtml += `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6 shadow-md">
                        <h3 class="text-xl font-bold text-blue-800 mb-2">Kelas ${className} (${studentsInClass.length} Siswa)</h3>
                        ${classStatHtml}
                        <div class="mt-4 space-y-3">
                            ${studentsInClass.map(student => `
                                <div class="flex justify-between items-center p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                                    <div>
                                        <p class="font-semibold text-gray-900">${student.name}</p>
                                        <p class="text-sm text-gray-600">${student.school || 'Sekolah belum ditentukan'}</p>
                                    </div>
                                    <button onclick="${detailFunction}(${student.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                        Lihat Detail
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return contentHtml;
        }

        // Helper function: Groups artworks by Month and Year
        function groupArtworksByMonth(artworks) {
            return artworks.reduce((groups, artwork) => {
                // Get YYYY-MM format from date
                const monthYear = artwork.date.substring(0, 7); 
                if (!groups[monthYear]) {
                    groups[monthYear] = [];
                }
                groups[monthYear].push(artwork);
                return groups;
            }, {});
        }

        // NEW: Helper function to render Art Progress for one student (to be reused) - MODIFIED FOR FOLDER BULAN
        function renderArtProgressStudent(students, isAdminOrSuperAdmin) {
             
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            return students.map(student => {
                const groupedArtworks = groupArtworksByMonth(student.artworks);
                // Sort months in descending order (newest first)
                const sortedMonths = Object.keys(groupedArtworks).sort().reverse();
                
                return `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">${student.name}</h3>
                                <p class="text-sm text-blue-600 font-medium">Sekolah: ${student.school || 'Belum ditentukan'} ${currentUser.role === 'Super Admin' ? `| Regional: ${student.region}` : ''}</p>
                            </div>
                            ${isAdminOrSuperAdmin && currentUser.role !== 'Siswa' ? `<button onclick="addArtwork(${student.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm text-sm">+ Tambah Karya</button>` : ''}
                        </div>

                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-900 mb-3">üñºÔ∏è Karya Siswa (${student.artworks.length})</h4>
                            
                            ${student.artworks.length > 0 ? `
                                <div class="space-y-4">
                                ${sortedMonths.map(monthYear => {
                                    const year = monthYear.substring(0, 4);
                                    const monthIndex = parseInt(monthYear.substring(5, 7)) - 1;
                                    const monthName = monthNames[monthIndex];
                                    const artworksInMonth = groupedArtworks[monthYear];
                                    
                                    return `
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm">
                                            <details>
                                                <summary class="font-bold text-gray-800 cursor-pointer p-2 -m-2">
                                                    üìÅ ${monthName} ${year} (${artworksInMonth.length} Karya)
                                                </summary>
                                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                    ${artworksInMonth.map(art => `
                                                        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                                                            <img src="${art.image}" alt="${art.title}" class="w-full h-48 object-cover ${isAdminOrSuperAdmin ? 'editable-image cursor-pointer' : ''}" ${isAdminOrSuperAdmin ? `onclick="editArtworkImage(${student.id}, ${art.id})"` : ''}>
                                                            <div class="p-4">
                                                                <h5 class="font-semibold text-gray-900">${art.title}</h5>
                                                                <p class="text-sm text-gray-600 mt-1">${art.description}</p>
                                                                <p class="text-sm text-gray-500 mt-1">üìÖ ${art.date}</p>
                                                                <div class="mt-2 p-2 bg-yellow-50 rounded border-l-4 border-yellow-400">
                                                                    <p class="text-sm text-gray-700"><strong>Komentar:</strong> ${art.comment}</p>
                                                                </div>
                                                                ${isAdminOrSuperAdmin ? `
                                                                    <div class="mt-3 flex space-x-2">
                                                                        <button onclick="editArtwork(${student.id}, ${art.id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Edit</button>
                                                                        <button onclick="deleteArtwork(${student.id}, ${art.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Hapus</button>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </details>
                                        </div>
                                    `;
                                }).join('')}
                                </div>
                            ` : '<p class="text-gray-500">Belum ada karya yang dibuat</p>'}
                        </div>

                        <div>
                            <div class="flex justify-between items-center">
                                <h4 class="font-semibold text-gray-900 mb-3">üìã Data Kehadiran (${student.attendance.length})</h4>
                                ${isAdminOrSuperAdmin && currentUser.role !== 'Siswa' ? `<button onclick="addAttendance(${student.id})" class="mb-3 px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-sm text-sm">+ Tambah</button>` : ''}
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Tanggal</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Status</th>
                                            ${isAdminOrSuperAdmin ? '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Aksi</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        ${student.attendance.map((att, idx) => `
                                            <tr class="border-t border-gray-200">
                                                <td class="px-4 py-3 text-sm text-gray-900">${att.date}</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <span class="px-2 py-1 rounded ${att.status === 'Hadir' ? 'bg-green-100 text-green-800' : att.status === 'Izin' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${att.status}</span>
                                                </td>
                                                ${isAdminOrSuperAdmin ? `
                                                    <td class="px-4 py-3 text-sm">
                                                        <button onclick="editAttendance(${student.id}, ${idx})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                                        <button onclick="deleteAttendance(${student.id}, ${idx})" class="text-red-600 hover:text-red-800">Hapus</button>
                                                    </td>
                                                ` : ''}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }).join(''); // Join back the outer array
        }

        // NEW: Helper function to render Skolastik Progress for one student (to be reused)
        function renderSkolastikProgressStudent(students, isAdminOrSuperAdmin) {
            return students.map(student => `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">${student.name}</h3>
                            <p class="text-sm text-blue-600 font-medium">Sekolah: ${student.school || 'Belum ditentukan'} ${currentUser.role === 'Super Admin' ? `| Regional: ${student.region}` : ''}</p>
                        </div>
                        ${isAdminOrSuperAdmin && currentUser.role !== 'Siswa' ? `<button onclick="addSkolastikTest(${student.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm text-sm">+ Tambah Tes</button>` : ''}
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Tanggal Tes</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Materi</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Nilai</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Keterangan</th>
                                    ${isAdminOrSuperAdmin ? '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Aksi</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white">
                                ${student.skolastikTests.map((test, idx) => `
                                    <tr class="border-t border-gray-200">
                                        <td class="px-4 py-3 text-sm text-gray-900">${test.date}</td>
                                        <td class="px-4 py-3 text-sm text-gray-900">${test.subject}</td>
                                        <td class="px-4 py-3 text-sm">
                                            <span class="px-2 py-1 rounded ${test.score >= 85 ? 'bg-green-100 text-green-800' : test.score >= 70 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${test.score}</span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${test.comment}</td>
                                        ${isAdminOrSuperAdmin ? `
                                            <td class="px-4 py-3 text-sm">
                                                <button onclick="editSkolastikTest(${student.id}, ${idx})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                                <button onclick="deleteSkolastikTest(${student.id}, ${idx})" class="text-red-600 hover:text-red-800">Hapus</button>
                                            </td>
                                        ` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }

        // NEW: Helper function to render TKA Progress for one student (to be reused)
        function renderTkaProgressStudent(students, isAdminOrSuperAdmin) {
            return students.map(student => `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">${student.name}</h3>
                            <p class="text-sm text-blue-600 font-medium">Sekolah: ${student.school || 'Belum ditentukan'} ${currentUser.role === 'Super Admin' ? `| Regional: ${student.region}` : ''}</p>
                        </div>
                        ${isAdminOrSuperAdmin && currentUser.role !== 'Siswa' ? `<button onclick="addTkaTest(${student.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm text-sm">+ Tambah Tes</button>` : ''}
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Tanggal Tes</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Materi</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Nilai</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Keterangan</th>
                                    ${isAdminOrSuperAdmin ? '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Aksi</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white">
                                ${student.tkaTests.map((test, idx) => `
                                    <tr class="border-t border-gray-200">
                                        <td class="px-4 py-3 text-sm text-gray-900">${test.date}</td>
                                        <td class="px-4 py-3 text-sm text-gray-900">${test.subject}</td>
                                        <td class="px-4 py-3 text-sm">
                                            <span class="px-2 py-1 rounded ${test.score >= 85 ? 'bg-green-100 text-green-800' : test.score >= 70 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${test.score}</span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${test.comment}</td>
                                        ${isAdminOrSuperAdmin ? `
                                            <td class="px-4 py-3 text-sm">
                                                <button onclick="editTkaTest(${student.id}, ${idx})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                                <button onclick="deleteTkaTest(${student.id}, ${idx})" class="text-red-600 hover:text-red-800">Hapus</button>
                                            </td>
                                        ` : ''}
                            </tr>
                        `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }
        
        // --- MODIFIED FUNCTION 1: Kemajuan Gambar (Super Admin shows Summary, Admin Regional shows Grouped by Class) ---
        function loadArtProgress() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            let displayData = studentsData;
            let displayTitle = 'Global';
            
            if (currentUser.role === 'Siswa') {
                displayData = studentsData.filter(s => s.name === currentUser.name);
                displayTitle = currentUser.name;
            } else if (currentUser.role === 'Admin') {
                displayData = studentsData.filter(s => s.region === currentUser.region);
                displayTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin') {
                if (selectedAdminRegion !== 'all') {
                     displayData = studentsData.filter(s => s.region === selectedAdminRegion);
                     displayTitle = `Regional ${selectedAdminRegion}`;
                } else {
                     displayTitle = 'Global (Semua Regional)';
                }
            }

            // Apply class filter if any (only applies to Admin Regional view)
            if (currentUser.role === 'Admin' && selectedClass !== 'all') {
                displayData = displayData.filter(s => s.class === selectedClass);
            }
             
            // Calculate Global/Regional Stats
            const totalStudents = displayData.length;
            const totalArtworks = displayData.reduce((total, student) => total + student.artworks.length, 0);
            const totalAttendance = displayData.reduce((total, student) => total + student.attendance.length, 0);
            const totalHadir = displayData.reduce((total, student) => total + student.attendance.filter(a => a.status === 'Hadir').length, 0);
            const avgAttendanceRate = totalAttendance > 0 ? ((totalHadir / totalAttendance) * 100).toFixed(1) : 0;


            const pdfFilename = `Kemajuan_Gambar_${currentUser.name.replace(/\s/g, '_')}.pdf`;
            
            let moduleContent;

            if (currentUser.role === 'Super Admin') {
                // --- SUPER ADMIN VIEW: SUMMARY ONLY ---
                moduleContent = `
                    <div class="bg-gradient-to-r from-red-600 to-red-800 rounded-lg p-6 mb-8 text-white shadow-lg">
                        <h3 class="text-xl font-bold">Ringkasan Kemajuan Gambar ${displayTitle}</h3>
                        <p class="text-sm text-red-100 mt-1">Status terbaru dari karya siswa di seluruh regional/regional terpilih</p>
                    </div>

                    ${renderRegionDropdown(selectedAdminRegion, 'filterArtProgressByRegion')}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="super-admin-card-3 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-blue-100">Total Siswa</p>
                            <p class="text-4xl font-bold">${totalStudents}</p>
                        </div>
                        <div class="bg-green-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-green-100">Total Karya Seni</p>
                            <p class="text-4xl font-bold">${totalArtworks}</p>
                        </div>
                        <div class="bg-yellow-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-yellow-100">Rata-rata Kehadiran</p>
                            <p class="text-4xl font-bold">${avgAttendanceRate}%</p>
                        </div>
                    </div>

                    ${selectedAdminRegion !== 'all' ? `
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Detail Per Kelas (${displayTitle})</h3>
                        <div class="space-y-6">
                             ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'artProgress')}
                        </div>
                    ` : `
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-xl font-bold text-gray-900 mb-3">Update Terbaru Karya Siswa</h4>
                            <p class="text-gray-600">Fitur ini menampilkan ringkasan data global. Untuk detail siswa, silakan filter berdasarkan regional di atas.</p>
                            </div>
                    `}
                `;
            } else if (currentUser.role === 'Admin') {
                // Get available classes for the current region
                const regionalClasses = availableClasses.filter(c => c.region === currentUser.region);

                // --- ADMIN REGIONAL VIEW: GROUPED BY CLASS ---
                moduleContent = `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Filter Kelas</h3>
                        
<!-- Filter Kelas (Dropdown versi clean) -->
<div class="mt-3 mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
  <select onchange="filterArtProgressByClass(this.value)" 
    class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="all">Semua Kelas</option>
    ${availableClasses
      .filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region)
      .map(c => `<option value="${c.name}">${c.name}</option>`)
      .join('')}
  </select>
</div>

                    </div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Data Siswa ${displayTitle} (${displayData.length} siswa)</h3>
                         ${selectedClass === 'all' ? `
                            <button onclick="addArtwork(null)" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Karya</button>
                         ` : ''}
                    </div>

                    <div id="artProgressContent">
                        ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'artProgress')}
                    </div>
                `;
            } else {
                 // --- SISWA VIEW: ORIGINAL VIEW ---
                 moduleContent = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üé® Kemajuan Gambar</h2>
                        <button onclick="generatePDF('artProgressContent', '${pdfFilename}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">
                            <span class="text-lg mr-2">‚¨áÔ∏è</span> Download PDF
                        </button>
                    </div>
                    <div id="artProgressContent">
                         ${renderArtProgressStudent(displayData, isAdminOrSuperAdmin)}
                    </div>
                `;
            }

            content.innerHTML = `<div class="fade-in">${moduleContent}</div>`;
        }


        // --- MODIFIED FUNCTION 2: Kemajuan Tes Skolastik (Super Admin shows Summary, Admin Regional shows Grouped by Class) ---
        function loadSkolastikProgress() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            let displayData = studentsData;
            let displayTitle = 'Global';
            
            if (currentUser.role === 'Siswa') {
                displayData = studentsData.filter(s => s.name === currentUser.name);
                displayTitle = currentUser.name;
            } else if (currentUser.role === 'Admin') {
                displayData = studentsData.filter(s => s.region === currentUser.region);
                displayTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin') {
                if (selectedAdminRegion !== 'all') {
                     displayData = studentsData.filter(s => s.region === selectedAdminRegion);
                     displayTitle = `Regional ${selectedAdminRegion}`;
                } else {
                     displayTitle = 'Global (Semua Regional)';
                }
            }

            // Apply class filter if any
            if (currentUser.role === 'Admin' && selectedClass !== 'all') {
                displayData = displayData.filter(s => s.class === selectedClass);
            }
            
            // Calculate Global/Regional Stats
            const totalStudents = displayData.length;
            const allSkolastikScores = displayData.flatMap(s => s.skolastikTests.map(t => t.score));
            const totalTests = allSkolastikScores.length;
            const avgScore = totalTests > 0 ? (allSkolastikScores.reduce((sum, score) => sum + score, 0) / totalTests).toFixed(1) : 0;
            const latestTestDate = displayData.flatMap(s => s.skolastikTests.map(t => t.date)).sort().pop() || 'N/A';
            

            const pdfFilename = `Kemajuan_Skolastik_${currentUser.name.replace(/\s/g, '_')}.pdf`;

            let moduleContent;

            if (currentUser.role === 'Super Admin') {
                // --- SUPER ADMIN VIEW: SUMMARY ONLY ---
                moduleContent = `
                    <div class="bg-gradient-to-r from-red-600 to-red-800 rounded-lg p-6 mb-8 text-white shadow-lg">
                        <h3 class="text-xl font-bold">Ringkasan Kemajuan Tes Skolastik ${displayTitle}</h3>
                        <p class="text-sm text-red-100 mt-1">Status terbaru dari tes skolastik siswa di seluruh regional/regional terpilih</p>
                    </div>

                    ${renderRegionDropdown(selectedAdminRegion, 'filterSkolastikByRegion')}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="super-admin-card-3 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-blue-100">Total Siswa</p>
                            <p class="text-4xl font-bold">${totalStudents}</p>
                        </div>
                        <div class="bg-purple-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-purple-100">Total Tes Dilakukan</p>
                            <p class="text-4xl font-bold">${totalTests}</p>
                        </div>
                        <div class="bg-blue-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-blue-100">Rata-rata Nilai Skolastik</p>
                            <p class="text-4xl font-bold">${avgScore}</p>
                        </div>
                    </div>

                    ${selectedAdminRegion !== 'all' ? `
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Detail Per Kelas (${displayTitle})</h3>
                        <div class="space-y-6">
                             ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'skolastikProgress')}
                        </div>
                    ` : `
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-xl font-bold text-gray-900 mb-3">Update Terbaru Tes Skolastik</h4>
                            <p class="text-gray-600">Fitur ini menampilkan ringkasan data global. Untuk detail siswa, silakan filter berdasarkan regional di atas.</p>
                            <p class="text-sm text-gray-500 mt-2">Tes Terbaru: ${latestTestDate}</p>
                        </div>
                    `}
                `;
            } else if (currentUser.role === 'Admin') {
                // Get available classes for the current region
                const regionalClasses = availableClasses.filter(c => c.region === currentUser.region);

                 // --- ADMIN REGIONAL VIEW: GROUPED BY CLASS ---
                 moduleContent = `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Filter Kelas</h3>
                        
<!-- Filter Kelas (Dropdown versi clean) -->
<div class="mt-3 mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
  <select onchange="filterSkolastikByClass(this.value)" 
    class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="all">Semua Kelas</option>
    ${availableClasses
      .filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region)
      .map(c => `<option value="${c.name}">${c.name}</option>`)
      .join('')}
  </select>
</div>

                    </div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Data Siswa ${displayTitle} (${displayData.length} siswa)</h3>
                    </div>

                    <div id="skolastikContent">
                        ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'skolastikProgress')}
                    </div>
                `;
            } else {
                 // --- SISWA VIEW: ORIGINAL VIEW ---
                 moduleContent = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üìä Kemajuan Tes Skolastik</h2>
                        <button onclick="generatePDF('skolastikContent', '${pdfFilename}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">
                            <span class="text-lg mr-2">‚¨áÔ∏è</span> Download PDF
                        </button>
                    </div>
                    <div id="skolastikContent">
                        ${renderSkolastikProgressStudent(displayData, isAdminOrSuperAdmin)}
                    </div>
                `;
            }
            
            content.innerHTML = `<div class="fade-in">${moduleContent}</div>`;
        }


        // --- MODIFIED FUNCTION 3: Kemajuan Tes TKA (Super Admin shows Summary, Admin Regional shows Grouped by Class) ---
        function loadTkaProgress() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            let displayData = studentsData;
            let displayTitle = 'Global';
            
            if (currentUser.role === 'Siswa') {
                displayData = studentsData.filter(s => s.name === currentUser.name);
                displayTitle = currentUser.name;
            } else if (currentUser.role === 'Admin') {
                displayData = studentsData.filter(s => s.region === currentUser.region);
                displayTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin') {
                if (selectedAdminRegion !== 'all') {
                     displayData = studentsData.filter(s => s.region === selectedAdminRegion);
                     displayTitle = `Regional ${selectedAdminRegion}`;
                } else {
                     displayTitle = 'Global (Semua Regional)';
                }
            }

            // Apply class filter if any
            if (currentUser.role === 'Admin' && selectedClass !== 'all') {
                displayData = displayData.filter(s => s.class === selectedClass);
            }
            
            // Calculate Global/Regional Stats
            const totalStudents = displayData.length;
            const allTkaScores = displayData.flatMap(s => s.tkaTests.map(t => t.score));
            const totalTests = allTkaScores.length;
            const avgScore = totalTests > 0 ? (allTkaScores.reduce((sum, score) => sum + score, 0) / totalTests).toFixed(1) : 0;
            const latestTestDate = displayData.flatMap(s => s.tkaTests.map(t => t.date)).sort().pop() || 'N/A';

            const pdfFilename = `Kemajuan_TKA_${currentUser.name.replace(/\s/g, '_')}.pdf`;

            let moduleContent;

            if (currentUser.role === 'Super Admin') {
                // --- SUPER ADMIN VIEW: SUMMARY ONLY ---
                moduleContent = `
                    <div class="bg-gradient-to-r from-red-600 to-red-800 rounded-lg p-6 mb-8 text-white shadow-lg">
                        <h3 class="text-xl font-bold">Ringkasan Kemajuan Tes TKA ${displayTitle}</h3>
                        <p class="text-sm text-red-100 mt-1">Status terbaru dari tes TKA siswa di seluruh regional/regional terpilih</p>
                    </div>

                    ${renderRegionDropdown(selectedAdminRegion, 'filterTkaByRegion')}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="super-admin-card-3 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-blue-100">Total Siswa</p>
                            <p class="text-4xl font-bold">${totalStudents}</p>
                        </div>
                        <div class="bg-purple-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-purple-100">Total Tes Dilakukan</p>
                            <p class="text-4xl font-bold">${totalTests}</p>
                        </div>
                        <div class="bg-blue-500 rounded-lg p-6 text-white shadow-xl">
                            <p class="text-blue-100">Rata-rata Nilai TKA</p>
                            <p class="text-4xl font-bold">${avgScore}</p>
                        </div>
                    </div>

                    ${selectedAdminRegion !== 'all' ? `
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Detail Per Kelas (${displayTitle})</h3>
                        <div class="space-y-6">
                             ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'tkaProgress')}
                        </div>
                    ` : `
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-xl font-bold text-gray-900 mb-3">Update Terbaru Tes TKA</h4>
                            <p class="text-gray-600">Fitur ini menampilkan ringkasan data global. Untuk detail siswa, silakan filter berdasarkan regional di atas.</p>
                            <p class="text-sm text-gray-500 mt-2">Tes Terbaru: ${latestTestDate}</p>
                        </div>
                    `}
                `;
            } else if (currentUser.role === 'Admin') {
                // Get available classes for the current region
                const regionalClasses = availableClasses.filter(c => c.region === currentUser.region);

                // --- ADMIN REGIONAL VIEW: GROUPED BY CLASS ---
                 moduleContent = `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Filter Kelas</h3>
                        
<!-- Filter Kelas (Dropdown versi clean) -->
<div class="mt-3 mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
  <select onchange="filterTkaByClass(this.value)" 
    class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="all">Semua Kelas</option>
    ${availableClasses
      .filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region)
      .map(c => `<option value="${c.name}">${c.name}</option>`)
      .join('')}
  </select>
</div>

                    </div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Data Siswa ${displayTitle} (${displayData.length} siswa)</h3>
                    </div>

                    <div id="tkaContent">
                        ${renderStudentGroupedByClass(displayData, isAdminOrSuperAdmin, 'tkaProgress')}
                    </div>
                `;
            } else {
                 // --- SISWA VIEW: ORIGINAL VIEW ---
                 moduleContent = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üìà Kemajuan TKA</h2>
                        <button onclick="generatePDF('tkaContent', '${pdfFilename}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">
                            <span class="text-lg mr-2">‚¨áÔ∏è</span> Download PDF
                        </button>
                    </div>
                    <div id="tkaContent">
                        ${renderTkaProgressStudent(displayData, isAdminOrSuperAdmin)}
                    </div>
                `;
            }

            content.innerHTML = `<div class="fade-in">${moduleContent}</div>`;
        }


        function loadEducationInfo() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            let infoTitle = currentUser.role === 'Super Admin' ? 'Global' : currentUser.role === 'Admin' ? `Regional ${currentUser.region}` : 'Anda';

            content.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üì∞ Informasi Pendidikan (${infoTitle})</h2>
                        ${isAdminOrSuperAdmin ? '<button onclick="addEducationInfo()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Informasi</button>' : ''}
                    </div>

                    <div class="space-y-6">
                        ${educationInfo.map(info => `
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${info.title}</h3>
                                        <p class="text-gray-700 mb-3 leading-relaxed">${info.content}</p>
                                        <p class="text-sm text-gray-500">üìÖ ${info.date}</p>
                                    </div>
                                    ${isAdminOrSuperAdmin ? `
                                        <div class="flex space-x-2 ml-4">
                                            <button onclick="editEducationInfo(${info.id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Edit</button>
                                            <button onclick="deleteEducationInfo(${info.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Hapus</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- MODIFIED FUNCTION 4: Materi Kelas (Ditambahkan Filter Berbasis Kelas dan Regional) ---
        function loadMaterials() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            // Filter kelas yang tersedia di regional Admin saat ini
            const regionalAvailableClasses = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? (selectedAdminRegion === 'all' || c.region === selectedAdminRegion) : c.region === currentUser.region
            );


            // START: MODIFIKASI REGIONALISASI DATA
            let regionalMaterials = classMaterials;
            let regionFilterTitle = '';

            if (currentUser.role === 'Admin') {
                regionalMaterials = classMaterials.filter(m => m.region === currentUser.region);
                regionFilterTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin' && selectedAdminRegion !== 'all') {
                regionalMaterials = classMaterials.filter(m => m.region === selectedAdminRegion);
                regionFilterTitle = `Regional ${selectedAdminRegion}`;
            } else if (currentUser.role === 'Super Admin') {
                regionalMaterials = classMaterials; // Global view for Super Admin default
                regionFilterTitle = 'Semua Regional';
            }
            // END: MODIFIKASI REGIONALISASI DATA
            
            let filteredMaterials = regionalMaterials; // Gunakan data yang sudah difilter regional
            const studentClass = studentsData.find(s => s.name === currentUser.name)?.class;
            
            // Jika siswa, activeClassFilter adalah kelasnya. Jika admin, menggunakan filter yang dipilih (default 'all').
            const activeClassFilter = isAdminOrSuperAdmin ? selectedClassMaterial : (studentClass || 'all');
            
            if (activeClassFilter !== 'all') {
                // Filter material yang memiliki nama kelas di dalam array 'classes' mereka
                filteredMaterials = regionalMaterials.filter(material => 
                    material.classes && material.classes.includes(activeClassFilter)
                );
            }
            
            content.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üìö Materi Kelas ${currentUser.role !== 'Siswa' ? `(${regionFilterTitle})` : ''}</h2>
                        ${currentUser.role === 'Siswa' ? `
                            <button onclick="generatePDF('materialsContent', 'Materi_Kelas_Villa_Merah.pdf')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">
                                <span class="text-lg mr-2">‚¨áÔ∏è</span> Download PDF
                            </button>
                        ` : ''}
                        ${isAdminOrSuperAdmin ? '<button onclick="addMaterial()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Materi</button>' : ''}
                    </div>

                    <div id="materialsContent">

                    ${currentUser.role === 'Super Admin' ? renderRegionDropdown(selectedAdminRegion, 'filterMaterialByRegion') : ''}

                    ${isAdminOrSuperAdmin ? `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Filter Kelas</h3>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="filterMaterialByClass('all')" class="px-4 py-2 rounded-lg transition-colors ${activeClassFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                    Semua Materi
                                </button>
                                ${regionalAvailableClasses.map(classItem => `
                                    <button onclick="filterMaterialByClass('${classItem.name}')" class="px-4 py-2 rounded-lg transition-colors ${activeClassFilter === classItem.name ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                                        Kelas ${classItem.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="bg-gray-700 text-white px-6 py-3">
                            <h3 class="text-lg font-semibold">Daftar Materi Pembelajaran ${!isAdminOrSuperAdmin && studentClass ? `(Kelas ${studentClass})` : ''}</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Topik</th>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Penjelasan Materi</th>
                                        ${currentUser.role === 'Super Admin' ? '<th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Regional</th>' : ''}
                                        ${isAdminOrSuperAdmin ? '<th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Kelas Target</th>' : ''}
                                        ${isAdminOrSuperAdmin ? '<th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Aksi</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${filteredMaterials.length > 0 ? filteredMaterials.map(material => `
                                        <tr class="border-t border-gray-200 hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${material.topic}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${material.description}</td>
                                            ${currentUser.role === 'Super Admin' ? `<td class="px-6 py-4 text-sm text-red-600 font-medium">${material.region}</td>` : ''}
                                            ${isAdminOrSuperAdmin ? `<td class="px-6 py-4 text-sm text-blue-600 font-medium">${material.classes.join(', ')}</td>` : ''}
                                            ${isAdminOrSuperAdmin ? `
                                                <td class="px-6 py-4 text-sm">
                                                    <button onclick="editMaterial(${material.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                                    <button onclick="deleteMaterial(${material.id})" class="text-red-600 hover:text-red-800">Hapus</button>
                                                </td>
                                            ` : ''}
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="${isAdminOrSuperAdmin ? 4 : 2}" class="px-6 py-4 text-center text-gray-500">
                                                Tidak ada materi yang tersedia untuk regional atau filter kelas ini.
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    </div> </div>
            `;
        }

        // --- MODIFIED FUNCTION 5: Jadwal Belajar (Ditambahkan Filter Berbasis Kelas dan Regional) ---
        function loadSchedule() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            // Filter kelas yang tersedia di regional Admin saat ini
            const regionalAvailableClasses = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? (selectedAdminRegion === 'all' || c.region === selectedAdminRegion) : c.region === currentUser.region
            );

            // START: MODIFIKASI REGIONALISASI DATA
            let regionalSchedule = scheduleData;
            let regionFilterTitle = '';

            if (currentUser.role === 'Admin') {
                regionalSchedule = scheduleData.filter(s => s.region === currentUser.region);
                regionFilterTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin' && selectedAdminRegion !== 'all') {
                regionalSchedule = scheduleData.filter(s => s.region === selectedAdminRegion);
                regionFilterTitle = `Regional ${selectedAdminRegion}`;
            } else if (currentUser.role === 'Super Admin') {
                regionalSchedule = scheduleData; // Global view for Super Admin default
                regionFilterTitle = 'Semua Regional';
            }
            // END: MODIFIKASI REGIONALISASI DATA

            let filteredSchedule = regionalSchedule; // Gunakan data yang sudah difilter regional
            const studentClass = studentsData.find(s => s.name === currentUser.name)?.class;
            // Jika siswa, activeClassFilter adalah kelasnya. Jika admin, menggunakan filter yang dipilih (default 'all').
            const activeClassFilter = isAdminOrSuperAdmin ? selectedClassSchedule : (studentClass || 'all');

            if (activeClassFilter !== 'all') {
                // Filter jadwal yang memiliki nama kelas di dalam array 'classes' mereka
                filteredSchedule = regionalSchedule.filter(schedule => 
                    schedule.classes && schedule.classes.includes(activeClassFilter)
                );
            }

            // Sortir berdasarkan tanggal
            filteredSchedule.sort((a, b) => a.date.localeCompare(b.date));


            content.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üìÖ Jadwal Belajar ${currentUser.role !== 'Siswa' ? `(${regionFilterTitle})` : ''}</h2>
                        ${isAdminOrSuperAdmin ? '<button onclick="addSchedule()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Jadwal</button>' : ''}
                    </div>

                    <div id="scheduleContent">

                    ${currentUser.role === 'Super Admin' ? renderRegionDropdown(selectedAdminRegion, 'filterScheduleByRegion') : ''}

                    ${isAdminOrSuperAdmin ? `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Filter Kelas</h3>
                            
<!-- Filter Kelas (Dropdown versi clean) -->
<div class="mt-3 mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
  <select onchange="filterMaterialByClass(this.value)" 
    class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="all">Semua Kelas</option>
    ${availableClasses
      .filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region)
      .map(c => `<option value="${c.name}">${c.name}</option>`)
      .join('')}
  </select>
</div>

                        </div>
                    ` : ''}

                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="bg-gray-700 text-white px-6 py-3">
                            <h3 class="text-lg font-semibold">Daftar Jadwal Kelas ${!isAdminOrSuperAdmin && studentClass ? `(Kelas ${studentClass})` : ''}</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Tanggal</th>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Hari</th>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Nama Materi</th>
                                        ${currentUser.role === 'Super Admin' ? '<th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Regional</th>' : ''}
                                        ${isAdminOrSuperAdmin ? '<th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Kelas Target</th>' : ''}
                                        ${isAdminOrSuperAdmin ? '<th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Aksi</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${filteredSchedule.length > 0 ? filteredSchedule.map(schedule => `
                                        <tr class="border-t border-gray-200 hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm text-gray-900">${schedule.date}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${schedule.day}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${schedule.subject}</td>
                                            ${currentUser.role === 'Super Admin' ? `<td class="px-6 py-4 text-sm text-red-600 font-medium">${schedule.region}</td>` : ''}
                                            ${isAdminOrSuperAdmin ? `<td class="px-6 py-4 text-sm text-blue-600 font-medium">${schedule.classes.join(', ')}</td>` : ''}
                                            ${isAdminOrSuperAdmin ? `
                                                <td class="px-6 py-4 text-sm">
                                                    <button onclick="editSchedule(${schedule.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                                    <button onclick="deleteSchedule(${schedule.id})" class="text-red-600 hover:text-red-800">Hapus</button>
                                                </td>
                                            ` : ''}
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="${isAdminOrSuperAdmin ? 5 : 3}" class="px-6 py-4 text-center text-gray-500">
                                                Tidak ada jadwal kelas yang tersedia untuk regional atau filter kelas ini. Silakan tambah jadwal baru.
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    </div>
                </div>
            `;
        }

        // MODIFIED FUNCTION: loadAddStudent - Menambahkan Kelola Sekolah. Sekarang bisa diakses Admin dan Super Admin.
        function loadAddStudent() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            // Tentukan siswa yang akan ditampilkan
            let displayUsersArray = Object.entries(getAllUsers()).filter(([username, user]) => user.role === 'Siswa');
            let regionFilter = '';

            if (currentUser.role === 'Super Admin') {
                // Tampilkan semua siswa
                regionFilter = 'Semua Regional';
            } else if (currentUser.role === 'Admin') {
                // Tampilkan siswa di regional admin yang login
                displayUsersArray = displayUsersArray.filter(([username, user]) => user.region === currentUser.region);
                regionFilter = `Region ${currentUser.region}`;
            } else {
                displayUsersArray = [];
            }
            
            // Filter available classes for the Add Student form
            const regionalClassesForForm = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? true : c.region === currentUser.region
            );


            content.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-900">üë§ Tambah Siswa & Kelola Sekolah</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm h-fit">
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">Tambah Siswa Baru</h3>
                            <form id="addStudentForm" class="space-y-4">
                                <div>
                                    <label for="studentUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                    <input type="text" id="studentUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan username">
                                </div>
                                <div>
                                    <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                                    <input type="text" id="studentName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="studentClass" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                    <select id="studentClass" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">--- Pilih Kelas ---</option>
                                        ${regionalClassesForForm.map(classItem => `
                                            <option value="${classItem.name}">Kelas ${classItem.name} ${currentUser.role === 'Super Admin' ? `(${classItem.region})` : ''}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="studentSchool" class="block text-sm font-medium text-gray-700 mb-1">Sekolah</label>
                                    <select id="studentSchool" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">--- Pilih Sekolah ---</option>
                                        ${availableSchools.map(school => `
                                            <option value="${school.name}">${school.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                ${currentUser.role === 'Super Admin' ? `
                                    <div>
                                        <label for="studentRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional Siswa</label>
                                        <select id="studentRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">--- Pilih Regional ---</option>
                                            ${regionalAdmins.map(admin => `
                                                <option value="${admin.region}">${admin.region}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                `: ''}
                                <div>
                                    <label for="studentPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input type="password" id="studentPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Tambah Siswa</button>
                            </form>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">üè´ Kelola Data Sekolah</h3>
                            
                            <div class="mb-6 pb-4 border-b border-gray-200">
                                <h4 class="font-semibold text-gray-900 mb-2">Tambah Sekolah Baru</h4>
                                <form id="addSchoolForm" class="flex space-x-2">
                                    <input type="text" id="schoolName" required class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Nama Sekolah">
                                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 whitespace-nowrap">Tambah</button>
                                </form>
                            </div>

                            <h4 class="font-semibold text-gray-900 mb-2">Daftar Sekolah Tersedia (${availableSchools.length})</h4>
                            <div id="schoolsList" class="space-y-3 max-h-48 overflow-y-auto">
                                ${availableSchools.map(school => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <p class="font-medium text-gray-900">${school.name}</p>
                                        <div class="flex space-x-2">
                                            <button onclick="editSchool(${school.id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">Edit</button>
                                            <button onclick="deleteSchool(${school.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">Hapus</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="lg:col-span-2 bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">Data Siswa Terdaftar (${regionFilter})</h3>
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${displayUsersArray.map(([username, user]) => {
                                    // Use the user.username property to find the corresponding studentData entry
                                    const studentData = studentsData.find(s => s.username === username);
                                    return `
                                    <div class="flex justify-between items-start p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium text-gray-900">${user.name}</p>
                                            <p class="text-sm text-gray-600">Username: ${username} | Kelas: ${studentData ? studentData.class : 'N/A'} ${currentUser.role === 'Super Admin' ? `| Regional: ${user.region}` : ''}</p>
                                            <p class="text-sm text-green-600">Sekolah: ${studentData ? studentData.school : 'Belum ditentukan'}</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="editStudent('${username}')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Edit</button>
                                            <button onclick="deleteStudent('${username}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Hapus</button>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Event Listener: Tambah Siswa (LOGIC MODIFIED)
            document.getElementById('addStudentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const allUsers = getAllUsers();
                const username = document.getElementById('studentUsername').value;
                const name = document.getElementById('studentName').value;
                const studentClass = document.getElementById('studentClass').value;
                const studentSchool = document.getElementById('studentSchool').value; 
                const password = document.getElementById('studentPassword').value; // <<< Dapatkan Password
                
                // Super Admin can select region, Admin Regional uses their own region
                const studentRegion = currentUser.role === 'Super Admin' ? document.getElementById('studentRegion').value : currentUser.region;

                if (allUsers[username]) {
                    showNotification('Username sudah digunakan!', 'error');
                    return;
                }
                
                if (!studentClass) {
                    showNotification('Silakan pilih kelas untuk siswa!', 'error');
                    return;
                }

                if (!studentSchool) {
                    showNotification('Silakan pilih sekolah untuk siswa!', 'error');
                    return;
                }
                
                if (currentUser.role === 'Super Admin' && !studentRegion) {
                    showNotification('Silakan pilih regional untuk siswa!', 'error');
                    return;
                }
                
                // Periksa apakah kelas yang dipilih ada di regional siswa yang dipilih (untuk Super Admin)
                if (currentUser.role === 'Super Admin') {
                    const selectedClassRegion = availableClasses.find(c => c.name === studentClass)?.region;
                    if (selectedClassRegion !== studentRegion) {
                        showNotification(`Kelas ${studentClass} hanya tersedia di regional ${selectedClassRegion}. Silakan pilih kelas atau regional yang sesuai.`, 'error');
                        return;
                    }
                }

                // Find the highest existing ID or start at 1
                const maxId = studentsData.reduce((max, student) => (student.id > max ? student.id : max), 0);
                const newId = maxId + 1;

                
                studentsData.push({
                    id: newId,
                    name: name,
                    username: username, // <<< SIMPAN USERNAME BARU
                    password: password, // <<< SIMPAN PASSWORD BARU
                    class: studentClass,
                    school: studentSchool,
                    region: studentRegion,
                    artworks: [],
                    attendance: [],
                    skolastikTests: [],
                    tkaTests: []
                });
                
                showNotification('Siswa berhasil ditambahkan!');
                this.reset();
                loadAddStudent();
            });

            // Event Listener BARU: Tambah Sekolah
            document.getElementById('addSchoolForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const schoolName = document.getElementById('schoolName').value.trim();

                if (!schoolName) return;

                if (availableSchools.some(s => s.name.toLowerCase() === schoolName.toLowerCase())) {
                    showNotification('Nama sekolah sudah ada!', 'error');
                    return;
                }

                const newSchool = {
                    id: availableSchools.length > 0 ? availableSchools[availableSchools.length - 1].id + 1 : 1,
                    name: schoolName
                };
                availableSchools.push(newSchool);
                showNotification('Sekolah berhasil ditambahkan!');
                this.reset();
                loadAddStudent(); // Reload modul untuk menampilkan perubahan
            });
        }


        /**
         * FUNGSI MODIFIKASI: editStudent
         * Menggunakan username sebagai kunci pencarian.
         * Memastikan password dapat diubah.
         */
        function editStudent(username) {
            const allUsers = getAllUsers();
            const user = allUsers[username];
            if (!user || user.role !== 'Siswa') {
                showNotification('Pengguna siswa tidak ditemukan!', 'error');
                return;
            }
            // Cari data siswa berdasarkan username
            const studentData = studentsData.find(s => s.username === username);
            
            // Filter available classes for the Edit Student form
            const regionalClassesForForm = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? true : c.region === studentData.region
            );

            openModal('Edit Siswa', `
                <form id="editStudentForm" class="space-y-4">
                    <div>
                        <label for="editStudentUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="editStudentUsername" value="${username}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500">
                        <p class="text-xs text-gray-500 mt-1">Username tidak dapat diubah</p>
                    </div>
                    <div>
                        <label for="editStudentName" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                        <input type="text" id="editStudentName" value="${studentData ? studentData.name : ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editStudentClass" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="editStudentClass" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${regionalClassesForForm.map(classItem => `
                                <option value="${classItem.name}" ${studentData && studentData.class === classItem.name ? 'selected' : ''}>Kelas ${classItem.name} ${currentUser.role === 'Super Admin' ? `(${classItem.region})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="editStudentSchool" class="block text-sm font-medium text-gray-700 mb-1">Sekolah</label>
                        <select id="editStudentSchool" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${availableSchools.map(school => `
                                <option value="${school.name}" ${studentData && studentData.school === school.name ? 'selected' : ''}>${school.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    ${currentUser.role === 'Super Admin' ? `
                        <div>
                            <label for="editStudentRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional Siswa</label>
                            <select id="editStudentRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                ${regionalAdmins.map(admin => `
                                    <option value="${admin.region}" ${studentData && studentData.region === admin.region ? 'selected' : ''}>${admin.region}</option>
                                `).join('')}
                            </select>
                        </div>
                    `: ''}
                    <div>
                        <label for="editStudentPassword" class="block text-sm font-medium text-gray-700 mb-1">Password Baru (Opsional)</label>
                        <input type="password" id="editStudentPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Kosongkan jika tidak ingin mengubah password</p>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editStudentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newName = document.getElementById('editStudentName').value;
                const newClass = document.getElementById('editStudentClass').value;
                const newSchool = document.getElementById('editStudentSchool').value; 
                const newPassword = document.getElementById('editStudentPassword').value;
                const newRegion = currentUser.role === 'Super Admin' ? document.getElementById('editStudentRegion').value : studentData.region;
                
                // Update student data
                if (studentData) {
                     // Periksa kesesuaian kelas dan regional jika Super Admin
                    if (currentUser.role === 'Super Admin') {
                        const selectedClassRegion = availableClasses.find(c => c.name === newClass)?.region;
                        if (selectedClassRegion !== newRegion) {
                            showNotification(`Kelas ${newClass} hanya tersedia di regional ${selectedClassRegion}. Silakan pilih kelas atau regional yang sesuai.`, 'error');
                            return;
                        }
                    }
                    
                    // Update semua properti siswa
                    studentData.name = newName;
                    studentData.class = newClass;
                    studentData.school = newSchool;
                    studentData.region = newRegion; // Update region
                    if (newPassword) {
                        studentData.password = newPassword; // <<< UPDATE PASSWORD
                    }
                }

                closeModal();
                loadAddStudent();
                showNotification('Data siswa berhasil diupdate!');
            });
        }

        /**
         * FUNGSI MODIFIKASI: deleteStudent
         * Menggunakan username sebagai kunci penghapusan.
         */
        function deleteStudent(username) {
            const allUsers = getAllUsers();
            const user = allUsers[username];
             if (!user || user.role !== 'Siswa') {
                showNotification('Pengguna siswa tidak ditemukan!', 'error');
                return;
            }
            openModal('Konfirmasi Hapus Siswa', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Hapus Siswa</h3>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus siswa <strong>${user.name}</strong> (${username})?</p>
                    <p class="text-sm text-red-600 mb-6">Semua data kemajuan siswa akan ikut terhapus!</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteStudent('${username}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        /**
         * FUNGSI MODIFIKASI: confirmDeleteStudent
         * Menghapus siswa dari studentsData berdasarkan username.
         */
        function confirmDeleteStudent(username) {
            // Hapus data siswa berdasarkan username
            studentsData = studentsData.filter(s => s.username !== username);
            
            // Karena getAllUsers sekarang membaca dari studentsData,
            // siswa akan otomatis hilang dari daftar pengguna login dan daftar siswa di loadAddStudent
            
            closeModal();
            loadAddStudent();
            showNotification('Siswa berhasil dihapus!');
        }

        // Modal Functions
        function openModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Artwork Functions
        function addArtwork(studentId) {
            // Find students filterable by current user's role/region
            const filterableStudents = currentUser.role === 'Super Admin' ? studentsData.filter(s => selectedAdminRegion === 'all' || s.region === selectedAdminRegion) : (currentUser.role === 'Admin' ? studentsData.filter(s => s.region === currentUser.region) : []);
            
            if (filterableStudents.length === 0) {
                showNotification('Tidak ada siswa di regional ini untuk ditambahkan karya.', 'error');
                return;
            }

            // Jika studentId diberikan, jadikan siswa tersebut yang terpilih secara default
            let defaultSelectedId = studentId;
            if (defaultSelectedId === null) {
                // Ambil id siswa pertama di daftar filterable jika tidak ada yang dipilih
                defaultSelectedId = filterableStudents[0]?.id;
            }

            openModal('Tambah Karya Siswa', `
                <form id="artworkForm" class="space-y-4">
                    <div>
                        <label for="artworkStudentId" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                        <select id="artworkStudentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${filterableStudents.map(student => `
                                <option value="${student.id}" ${student.id === defaultSelectedId ? 'selected' : ''}>${student.name} (${student.class}) ${currentUser.role === 'Super Admin' ? `(${student.region})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="artworkTitle" class="block text-sm font-medium text-gray-700 mb-1">Nama Karya</label>
                        <input type="text" id="artworkTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="artworkDescription" class="block text-sm font-medium text-gray-700 mb-1">Keterangan Karya</label>
                        <textarea id="artworkDescription" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="artworkDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Karya</label>
                        <input type="date" id="artworkDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="artworkImage" class="block text-sm font-medium text-gray-700 mb-1">Tambah Gambar</label>
                        <input type="file" id="artworkImage" accept="image/*" capture required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Format: JPG, PNG (tanpa batas resolusi)</p>
                    </div>
                    <div>
                        <label for="artworkComment" class="block text-sm font-medium text-gray-700 mb-1">Komentar Pengajar</label>
                        <textarea id="artworkComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('artworkForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const selectedStudentId = parseInt(document.getElementById('artworkStudentId').value);
                const student = studentsData.find(s => s.id === selectedStudentId);
                const fileInput = document.getElementById('artworkImage');
                const file = fileInput.files[0];

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const newArtwork = {
                            id: student.artworks.length + 1,
                            title: document.getElementById('artworkTitle').value,
                            description: document.getElementById('artworkDescription').value,
                            date: document.getElementById('artworkDate').value,
                            image: event.target.result,
                            comment: document.getElementById('artworkComment').value
                        };
                        student.artworks.push(newArtwork);
                        closeModal();
                        loadArtProgress();
                        showNotification('Karya siswa berhasil ditambahkan!');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }


        function editArtwork(studentId, artworkId) {
            const student = studentsData.find(s => s.id === studentId);
            const artwork = student.artworks.find(a => a.id === artworkId);
            
            openModal('Edit Karya Siswa', `
                <form id="editArtworkForm" class="space-y-4">
                    <div>
                        <label for="editArtworkTitle" class="block text-sm font-medium text-gray-700 mb-1">Nama Karya</label>
                        <input type="text" id="editArtworkTitle" value="${artwork.title}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editArtworkDescription" class="block text-sm font-medium text-gray-700 mb-1">Keterangan Karya</label>
                        <textarea id="editArtworkDescription" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${artwork.description}</textarea>
                    </div>
                    <div>
                        <label for="editArtworkDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Karya</label>
                        <input type="date" id="editArtworkDate" value="${artwork.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editArtworkComment" class="block text-sm font-medium text-gray-700 mb-1">Komentar Pengajar</label>
                        <textarea id="editArtworkComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${artwork.comment}</textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editArtworkForm').addEventListener('submit', function(e) {
                e.preventDefault();
                artwork.title = document.getElementById('editArtworkTitle').value;
                artwork.description = document.getElementById('editArtworkDescription').value;
                artwork.date = document.getElementById('editArtworkDate').value;
                artwork.comment = document.getElementById('editArtworkComment').value;
                closeModal();
                loadArtProgress();
                showNotification('Karya siswa berhasil diupdate!');
            });
        }

        function editArtworkImage(studentId, artworkId) {
            const student = studentsData.find(s => s.id === studentId);
            const artwork = student.artworks.find(a => a.id === artworkId);
            
            openModal('Edit Gambar Karya', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gambar Saat Ini</label>
                        <img src="${artwork.image}" alt="${artwork.title}" class="w-full h-64 object-cover rounded-lg border border-gray-300">
                    </div>
                    <form id="editImageForm">
                        <div>
                            <label for="newArtworkImage" class="block text-sm font-medium text-gray-700 mb-1">Upload Gambar Baru</label>
                            <input type="file" id="newArtworkImage" accept="image/*" capture required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Format: JPG, PNG (tanpa batas resolusi)</p>
                        </div>
                        <button type="submit" class="w-full mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update Gambar</button>
                    </form>
                </div>
            `);

            document.getElementById('editImageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const fileInput = document.getElementById('newArtworkImage');
                const file = fileInput.files[0];

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        artwork.image = event.target.result;
                        closeModal();
                        loadArtProgress();
                        showNotification('Gambar karya berhasil diupdate!');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function deleteArtwork(studentId, artworkId) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus karya ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteArtwork(${studentId}, ${artworkId})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteArtwork(studentId, artworkId) {
            const student = studentsData.find(s => s.id === studentId);
            student.artworks = student.artworks.filter(a => a.id !== artworkId);
            closeModal();
            loadArtProgress();
            showNotification('Karya siswa berhasil dihapus!');
        }

        // Attendance Functions
        function addAttendance(studentId) {
            const filterableStudents = currentUser.role === 'Super Admin' ? studentsData.filter(s => selectedAdminRegion === 'all' || s.region === selectedAdminRegion) : (currentUser.role === 'Admin' ? studentsData.filter(s => s.region === currentUser.region) : []);
            
            if (filterableStudents.length === 0) {
                showNotification('Tidak ada siswa di regional ini untuk ditambahkan kehadiran.', 'error');
                return;
            }

            // Jika studentId diberikan, jadikan siswa tersebut yang terpilih secara default
            let defaultSelectedId = studentId;
            if (defaultSelectedId === null) {
                // Ambil id siswa pertama di daftar filterable jika tidak ada yang dipilih
                defaultSelectedId = filterableStudents[0]?.id;
            }

            openModal('Tambah Kehadiran', `
                <form id="attendanceForm" class="space-y-4">
                    <div>
                        <label for="attendanceStudentId" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                        <select id="attendanceStudentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${filterableStudents.map(student => `
                                <option value="${student.id}" ${student.id === defaultSelectedId ? 'selected' : ''}>${student.name} (${student.class}) ${currentUser.role === 'Super Admin' ? `(${student.region})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="attendanceDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="attendanceDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="attendanceStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="attendanceStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Hadir">Hadir</option>
                            <option value="Izin">Izin</option>
                            <option value="Sakit">Sakit</option>
                            <option value="Alpa">Alpa</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('attendanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const selectedStudentId = parseInt(document.getElementById('attendanceStudentId').value);
                const student = studentsData.find(s => s.id === selectedStudentId);
                const newAttendance = {
                    date: document.getElementById('attendanceDate').value,
                    status: document.getElementById('attendanceStatus').value
                };
                student.attendance.push(newAttendance);
                closeModal();
                loadArtProgress();
                showNotification('Data kehadiran berhasil ditambahkan!');
            });
        }

        function editAttendance(studentId, attendanceIndex) {
            const student = studentsData.find(s => s.id === studentId);
            const attendance = student.attendance[attendanceIndex];
            
            openModal('Edit Kehadiran', `
                <form id="editAttendanceForm" class="space-y-4">
                    <div>
                        <label for="editAttendanceDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="editAttendanceDate" value="${attendance.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editAttendanceStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="editAttendanceStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Hadir" ${attendance.status === 'Hadir' ? 'selected' : ''}>Hadir</option>
                            <option value="Izin" ${attendance.status === 'Izin' ? 'selected' : ''}>Izin</option>
                            <option value="Sakit" ${attendance.status === 'Sakit' ? 'selected' : ''}>Sakit</option>
                            <option value="Alpa" ${attendance.status === 'Alpa' ? 'selected' : ''}>Alpa</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editAttendanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                attendance.date = document.getElementById('editAttendanceDate').value;
                attendance.status = document.getElementById('editAttendanceStatus').value;
                closeModal();
                loadArtProgress();
                showNotification('Data kehadiran berhasil diupdate!');
            });
        }
        
        // --- NEW: Delete Attendance Functions ---

        function deleteAttendance(studentId, attendanceIndex) {
            const student = studentsData.find(s => s.id === studentId);
            const attendanceDate = student.attendance[attendanceIndex].date;

            openModal('Konfirmasi Hapus Kehadiran', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl text-red-500">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus data kehadiran siswa <strong>${student.name}</strong> pada tanggal <strong>${attendanceDate}</strong>?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteAttendance(${studentId}, ${attendanceIndex})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteAttendance(studentId, attendanceIndex) {
            const student = studentsData.find(s => s.id === studentId);
            
            // Remove the attendance record at the specified index
            student.attendance.splice(attendanceIndex, 1);
            
            closeModal();
            loadArtProgress(); // Reload the module to reflect the change
            showNotification('Data kehadiran berhasil dihapus!', 'success');
        }

        // --- END: Delete Attendance Functions ---


        // Test Functions
        function addSkolastikTest(studentId) {
            const filterableStudents = currentUser.role === 'Super Admin' ? studentsData.filter(s => selectedAdminRegion === 'all' || s.region === selectedAdminRegion) : (currentUser.role === 'Admin' ? studentsData.filter(s => s.region === currentUser.region) : []);
            
            if (filterableStudents.length === 0) {
                showNotification('Tidak ada siswa di regional ini untuk ditambahkan tes.', 'error');
                return;
            }

            // Jika studentId diberikan, jadikan siswa tersebut yang terpilih secara default
            let defaultSelectedId = studentId;
            if (defaultSelectedId === null) {
                defaultSelectedId = filterableStudents[0]?.id;
            }

            openModal('Tambah Tes Skolastik', `
                <form id="skolastikTestForm" class="space-y-4">
                    <div>
                        <label for="skolastikTestStudentId" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                        <select id="skolastikTestStudentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${filterableStudents.map(student => `
                                <option value="${student.id}" ${student.id === defaultSelectedId ? 'selected' : ''}>${student.name} (${student.class}) ${currentUser.role === 'Super Admin' ? `(${student.region})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="testDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Tes</label>
                        <input type="date" id="testDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="testSubject" class="block text-sm font-medium text-gray-700 mb-1">Materi</label>
                        <input type="text" id="testSubject" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Matematika Dasar">
                    </div>
                    <div>
                        <label for="testScore" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label>
                        <input type="number" id="testScore" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="testComment" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <textarea id="testComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('skolastikTestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const selectedStudentId = parseInt(document.getElementById('skolastikTestStudentId').value);
                const student = studentsData.find(s => s.id === selectedStudentId);
                const newTest = {
                    date: document.getElementById('testDate').value,
                    subject: document.getElementById('testSubject').value,
                    score: parseInt(document.getElementById('testScore').value),
                    comment: document.getElementById('testComment').value
                };
                student.skolastikTests.push(newTest);
                closeModal();
                loadSkolastikProgress();
                showNotification('Tes skolastik berhasil ditambahkan!');
            });
        }

        function editSkolastikTest(studentId, testIndex) {
            const student = studentsData.find(s => s.id === studentId);
            const test = student.skolastikTests[testIndex];
            
            openModal('Edit Tes Skolastik', `
                <form id="editSkolastikTestForm" class="space-y-4">
                    <div>
                        <label for="editTestDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Tes</label>
                        <input type="date" id="editTestDate" value="${test.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTestSubject" class="block text-sm font-medium text-gray-700 mb-1">Materi</label>
                        <input type="text" id="editTestSubject" value="${test.subject}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTestScore" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label>
                        <input type="number" id="editTestScore" value="${test.score}" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTestComment" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <textarea id="editTestComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${test.comment}</textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editSkolastikTestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                test.date = document.getElementById('editTestDate').value;
                test.subject = document.getElementById('editTestSubject').value;
                test.score = parseInt(document.getElementById('editTestScore').value);
                test.comment = document.getElementById('editTestComment').value;
                closeModal();
                loadSkolastikProgress();
                showNotification('Tes skolastik berhasil diupdate!');
            });
        }

        function deleteSkolastikTest(studentId, testIndex) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus data tes ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteSkolastikTest(${studentId}, ${testIndex})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteSkolastikTest(studentId, testIndex) {
            const student = studentsData.find(s => s.id === studentId);
            student.skolastikTests.splice(testIndex, 1);
            closeModal();
            loadSkolastikProgress();
            showNotification('Tes skolastik berhasil dihapus!');
        }

        function addTkaTest(studentId) {
            const filterableStudents = currentUser.role === 'Super Admin' ? studentsData.filter(s => selectedAdminRegion === 'all' || s.region === selectedAdminRegion) : (currentUser.role === 'Admin' ? studentsData.filter(s => s.region === currentUser.region) : []);
            
            if (filterableStudents.length === 0) {
                showNotification('Tidak ada siswa di regional ini untuk ditambahkan tes.', 'error');
                return;
            }

            // Jika studentId diberikan, jadikan siswa tersebut yang terpilih secara default
            let defaultSelectedId = studentId;
            if (defaultSelectedId === null) {
                defaultSelectedId = filterableStudents[0]?.id;
            }

            openModal('Tambah Tes TKA', `
                <form id="tkaTestForm" class="space-y-4">
                    <div>
                        <label for="tkaTestStudentId" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                        <select id="tkaTestStudentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${filterableStudents.map(student => `
                                <option value="${student.id}" ${student.id === defaultSelectedId ? 'selected' : ''}>${student.name} (${student.class}) ${currentUser.role === 'Super Admin' ? `(${student.region})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="tkaTestDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Tes</label>
                        <input type="date" id="tkaTestDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="tkaTestSubject" class="block text-sm font-medium text-gray-700 mb-1">Materi</label>
                        <input type="text" id="tkaTestSubject" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Penalaran Umum">
                    </div>
                    <div>
                        <label for="tkaTestScore" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label>
                        <input type="number" id="tkaTestScore" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="tkaTestComment" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <textarea id="tkaTestComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('tkaTestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const selectedStudentId = parseInt(document.getElementById('tkaTestStudentId').value);
                const student = studentsData.find(s => s.id === selectedStudentId);
                const newTest = {
                    date: document.getElementById('tkaTestDate').value,
                    subject: document.getElementById('tkaTestSubject').value,
                    score: parseInt(document.getElementById('tkaTestScore').value),
                    comment: document.getElementById('tkaTestComment').value
                };
                student.tkaTests.push(newTest);
                closeModal();
                loadTkaProgress();
                showNotification('Tes TKA berhasil ditambahkan!');
            });
        }

        function editTkaTest(studentId, testIndex) {
            const student = studentsData.find(s => s.id === studentId);
            const test = student.tkaTests[testIndex];
            
            openModal('Edit Tes TKA', `
                <form id="editTkaTestForm" class="space-y-4">
                    <div>
                        <label for="editTkaTestDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Tes</label>
                        <input type="date" id="editTkaTestDate" value="${test.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTkaTestSubject" class="block text-sm font-medium text-gray-700 mb-1">Materi</label>
                        <input type="text" id="editTkaTestSubject" value="${test.subject}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTkaTestScore" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label>
                        <input type="number" id="editTkaTestScore" value="${test.score}" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editTkaTestComment" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <textarea id="editTkaTestComment" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${test.comment}</textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editTkaTestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                test.date = document.getElementById('editTkaTestDate').value;
                test.subject = document.getElementById('editTkaTestSubject').value;
                test.score = parseInt(document.getElementById('editTkaTestScore').value);
                test.comment = document.getElementById('editTkaTestComment').value;
                closeModal();
                loadTkaProgress();
                showNotification('Tes TKA berhasil diupdate!');
            });
        }

        function deleteTkaTest(studentId, testIndex) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus data tes ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteTkaTest(${studentId}, ${testIndex})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteTkaTest(studentId, testIndex) {
            const student = studentsData.find(s => s.id === studentId);
            student.tkaTests.splice(testIndex, 1);
            closeModal();
            loadTkaProgress();
            showNotification('Tes TKA berhasil dihapus!');
        }

        // Education Info Functions
        function addEducationInfo() {
            openModal('Tambah Informasi Pendidikan', `
                <form id="educationInfoForm" class="space-y-4">
                    <div>
                        <label for="infoTitle" class="block text-sm font-medium text-gray-700 mb-1">Judul</label>
                        <input type="text" id="infoTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="infoContent" class="block text-sm font-medium text-gray-700 mb-1">Isi Informasi</label>
                        <textarea id="infoContent" required rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="infoDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="infoDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('educationInfoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newInfo = {
                    id: educationInfo.length + 1,
                    title: document.getElementById('infoTitle').value,
                    content: document.getElementById('infoContent').value,
                    date: document.getElementById('infoDate').value
                };
                educationInfo.push(newInfo);
                closeModal();
                loadEducationInfo();
                showNotification('Informasi pendidikan berhasil ditambahkan!');
            });
        }

        function editEducationInfo(id) {
            const info = educationInfo.find(i => i.id === id);
            openModal('Edit Informasi Pendidikan', `
                <form id="editEducationInfoForm" class="space-y-4">
                    <div>
                        <label for="editInfoTitle" class="block text-sm font-medium text-gray-700 mb-1">Judul</label>
                        <input type="text" id="editInfoTitle" value="${info.title}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editInfoContent" class="block text-sm font-medium text-gray-700 mb-1">Isi Informasi</label>
                        <textarea id="editInfoContent" required rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${info.content}</textarea>
                    </div>
                    <div>
                        <label for="editInfoDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="editInfoDate" value="${info.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editEducationInfoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                info.title = document.getElementById('editInfoTitle').value;
                info.content = document.getElementById('editInfoContent').value;
                info.date = document.getElementById('editInfoDate').value;
                closeModal();
                loadEducationInfo();
                showNotification('Informasi pendidikan berhasil diupdate!');
            });
        }

        function deleteEducationInfo(id) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus informasi ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteEducationInfo(${id})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteEducationInfo(id) {
            educationInfo = educationInfo.filter(i => i.id !== id);
            closeModal();
            loadEducationInfo();
            showNotification('Informasi pendidikan berhasil dihapus!');
        }

        // Material Functions - MODIFIED
        function addMaterial() {
            
            // Tentukan regional untuk Super Admin
            let regionSelectHtml = '';
            
            // Filter kelas yang tersedia di regional Admin saat ini
            const regionalClassesForForm = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? (selectedAdminRegion === 'all' || c.region === selectedAdminRegion) : c.region === currentUser.region
            );

            if (currentUser.role === 'Super Admin') {
                const regions = [...new Set(regionalAdmins.map(a => a.region))];
                regions.push(...studentsData.map(s => s.region).filter(r => !regions.includes(r)));
                regionSelectHtml = `
                    <div>
                        <label for="materialRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional Target</label>
                        <select id="materialRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">--- Pilih Regional ---</option>
                            ${regions.sort().map(regionName => `
                                <option value="${regionName}" ${selectedAdminRegion === regionName ? 'selected' : ''}>${regionName}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            } else if (regionalClassesForForm.length === 0) {
                 showNotification('Tambahkan Kelas terlebih dahulu di regional Anda sebelum menambah materi.', 'error');
                 return;
            }


            openModal('Tambah Materi', `
                <form id="materialForm" class="space-y-4">
                    <div>
                        <label for="materialTopic" class="block text-sm font-medium text-gray-700 mb-1">Topik</label>
                        <input type="text" id="materialTopic" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="materialDescription" class="block text-sm font-medium text-gray-700 mb-1">Penjelasan Materi</label>
                        <textarea id="materialDescription" required rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Relevan (Regional ${currentUser.role === 'Admin' ? currentUser.region : (selectedAdminRegion === 'all' ? 'Semua' : selectedAdminRegion)})</label>
                        <div class="space-y-1 p-2 border border-gray-300 rounded-lg">
                            ${regionalClassesForForm.map(classItem => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="materialClass-${classItem.id}" name="materialClasses" value="${classItem.name}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="materialClass-${classItem.id}" class="ml-2 text-sm text-gray-700">Kelas ${classItem.name} (${classItem.region})</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ${regionSelectHtml}
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('materialForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const selectedClasses = Array.from(document.querySelectorAll('input[name="materialClasses"]:checked')).map(cb => cb.value);

                if (selectedClasses.length === 0) {
                    showNotification('Pilih minimal satu kelas untuk materi ini!', 'error');
                    return;
                }
                
                // Tentukan regional berdasarkan role
                let targetRegion;
                if (currentUser.role === 'Super Admin') {
                    targetRegion = document.getElementById('materialRegion').value;
                    if (!targetRegion) {
                        showNotification('Super Admin harus memilih Regional Target!', 'error');
                        return;
                    }
                } else {
                    targetRegion = currentUser.region;
                }

                const newMaterial = {
                    id: classMaterials.length > 0 ? classMaterials[classMaterials.length - 1].id + 1 : 1,
                    topic: document.getElementById('materialTopic').value,
                    description: document.getElementById('materialDescription').value,
                    classes: selectedClasses,
                    region: targetRegion // <<--- PROPERTI REGION BARU
                };
                classMaterials.push(newMaterial);
                closeModal();
                loadMaterials();
                showNotification('Materi berhasil ditambahkan!');
            });
        }

        function editMaterial(id) {
            const material = classMaterials.find(m => m.id === id);
            
            // Filter kelas yang tersedia di regional material
            const regionalClassesForForm = availableClasses.filter(c => 
                c.region === material.region
            );

            openModal('Edit Materi', `
                <form id="editMaterialForm" class="space-y-4">
                    <div>
                        <label for="editMaterialTopic" class="block text-sm font-medium text-gray-700 mb-1">Topik</label>
                        <input type="text" id="editMaterialTopic" value="${material.topic}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editMaterialDescription" class="block text-sm font-medium text-gray-700 mb-1">Penjelasan Materi</label>
                        <textarea id="editMaterialDescription" required rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${material.description}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Relevan (Regional ${material.region})</label>
                        <div class="space-y-1 p-2 border border-gray-300 rounded-lg">
                            ${regionalClassesForForm.map(classItem => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="editMaterialClass-${classItem.id}" name="editMaterialClasses" value="${classItem.name}" 
                                           class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                           ${material.classes.includes(classItem.name) ? 'checked' : ''}>
                                    <label for="editMaterialClass-${classItem.id}" class="ml-2 text-sm text-gray-700">Kelas ${classItem.name}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editMaterialForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const updatedClasses = Array.from(document.querySelectorAll('input[name="editMaterialClasses"]:checked')).map(cb => cb.value);

                if (updatedClasses.length === 0) {
                    showNotification('Pilih minimal satu kelas untuk materi ini!', 'error');
                    return;
                }

                material.topic = document.getElementById('editMaterialTopic').value;
                material.description = document.getElementById('editMaterialDescription').value;
                material.classes = updatedClasses;
                closeModal();
                loadMaterials();
                showNotification('Materi berhasil diupdate!');
            });
        }

        function deleteMaterial(id) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus materi ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteMaterial(${id})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteMaterial(id) {
            classMaterials = classMaterials.filter(m => m.id !== id);
            closeModal();
            loadMaterials();
            showNotification('Materi berhasil dihapus!');
        }

        // Schedule Functions
        function addSchedule() {

             // Tentukan regional untuk Super Admin
            let regionSelectHtml = '';
            
            // Filter kelas yang tersedia di regional Admin saat ini
            const regionalClassesForForm = availableClasses.filter(c => 
                currentUser.role === 'Super Admin' ? (selectedAdminRegion === 'all' || c.region === selectedAdminRegion) : c.region === currentUser.region
            );

            if (currentUser.role === 'Super Admin') {
                const regions = [...new Set(regionalAdmins.map(a => a.region))];
                regions.push(...studentsData.map(s => s.region).filter(r => !regions.includes(r)));
                regionSelectHtml = `
                    <div>
                        <label for="scheduleRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional Target</label>
                        <select id="scheduleRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">--- Pilih Regional ---</option>
                            ${regions.sort().map(regionName => `
                                <option value="${regionName}" ${selectedAdminRegion === regionName ? 'selected' : ''}>${regionName}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            } else if (regionalClassesForForm.length === 0) {
                 showNotification('Tambahkan Kelas terlebih dahulu di regional Anda sebelum menambah jadwal.', 'error');
                 return;
            }

            openModal('Tambah Jadwal', `
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label for="scheduleDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="scheduleDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="scheduleDay" class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
                        <select id="scheduleDay" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                            <option value="Sabtu">Sabtu</option>
                            <option value="Minggu">Minggu</option>
                        </select>
                    </div>
                    <div>
                        <label for="scheduleSubject" class="block text-sm font-medium text-gray-700 mb-1">Nama Materi</label>
                        <input type="text" id="scheduleSubject" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Pengenalan Alat Gambar">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Relevan (Regional ${currentUser.role === 'Admin' ? currentUser.region : (selectedAdminRegion === 'all' ? 'Semua' : selectedAdminRegion)})</label>
                        <div class="space-y-1 p-2 border border-gray-300 rounded-lg">
                            ${regionalClassesForForm.map(classItem => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="scheduleClass-${classItem.id}" name="scheduleClasses" value="${classItem.name}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="scheduleClass-${classItem.id}" class="ml-2 text-sm text-gray-700">Kelas ${classItem.name} (${classItem.region})</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ${regionSelectHtml}
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </form>
            `);

            document.getElementById('scheduleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const selectedClasses = Array.from(document.querySelectorAll('input[name="scheduleClasses"]:checked')).map(cb => cb.value);

                if (selectedClasses.length === 0) {
                    showNotification('Pilih minimal satu kelas untuk jadwal ini!', 'error');
                    return;
                }
                
                // Tentukan regional berdasarkan role
                let targetRegion;
                if (currentUser.role === 'Super Admin') {
                    targetRegion = document.getElementById('scheduleRegion').value;
                    if (!targetRegion) {
                        showNotification('Super Admin harus memilih Regional Target!', 'error');
                        return;
                    }
                } else {
                    targetRegion = currentUser.region;
                }


                const newSchedule = {
                    id: scheduleData.length > 0 ? scheduleData[scheduleData.length - 1].id + 1 : 1,
                    date: document.getElementById('scheduleDate').value,
                    day: document.getElementById('scheduleDay').value,
                    subject: document.getElementById('scheduleSubject').value,
                    classes: selectedClasses,
                    region: targetRegion
                };
                scheduleData.push(newSchedule);
                closeModal();
                loadSchedule();
                showNotification('Jadwal berhasil ditambahkan!');
            });
        }

        function editSchedule(id) {
            const schedule = scheduleData.find(s => s.id === id);
            
            // Filter kelas yang tersedia di regional jadwal
            const regionalClassesForForm = availableClasses.filter(c => 
                c.region === schedule.region
            );

            openModal('Edit Jadwal', `
                <form id="editScheduleForm" class="space-y-4">
                    <div>
                        <label for="editScheduleDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="editScheduleDate" value="${schedule.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editScheduleDay" class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
                        <select id="editScheduleDay" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Senin" ${schedule.day === 'Senin' ? 'selected' : ''}>Senin</option>
                            <option value="Selasa" ${schedule.day === 'Selasa' ? 'selected' : ''}>Selasa</option>
                            <option value="Rabu" ${schedule.day === 'Rabu' ? 'selected' : ''}>Rabu</option>
                            <option value="Kamis" ${schedule.day === 'Kamis' ? 'selected' : ''}>Kamis</option>
                            <option value="Jumat" ${schedule.day === 'Jumat' ? 'selected' : ''}>Jumat</option>
                            <option value="Sabtu" ${schedule.day === 'Sabtu' ? 'selected' : ''}>Sabtu</option>
                            <option value="Minggu" ${schedule.day === 'Minggu' ? 'selected' : ''}>Minggu</option>
                        </select>
                    </div>
                    <div>
                        <label for="editScheduleSubject" class="block text-sm font-medium text-gray-700 mb-1">Nama Materi</label>
                        <input type="text" id="editScheduleSubject" value="${schedule.subject}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Relevan (Regional ${schedule.region})</label>
                        <div class="space-y-1 p-2 border border-gray-300 rounded-lg">
                            ${regionalClassesForForm.map(classItem => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="editScheduleClass-${classItem.id}" name="editScheduleClasses" value="${classItem.name}" 
                                           class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                           ${schedule.classes.includes(classItem.name) ? 'checked' : ''}>
                                    <label for="editScheduleClass-${classItem.id}" class="ml-2 text-sm text-gray-700">Kelas ${classItem.name}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editScheduleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const updatedClasses = Array.from(document.querySelectorAll('input[name="editScheduleClasses"]:checked')).map(cb => cb.value);

                if (updatedClasses.length === 0) {
                    showNotification('Pilih minimal satu kelas untuk jadwal ini!', 'error');
                    return;
                }
                
                schedule.date = document.getElementById('editScheduleDate').value;
                schedule.day = document.getElementById('editScheduleDay').value;
                schedule.subject = document.getElementById('editScheduleSubject').value;
                schedule.classes = updatedClasses;
                closeModal();
                loadSchedule();
                showNotification('Jadwal berhasil diupdate!');
            });
        }

        function deleteSchedule(id) {
            openModal('Konfirmasi Hapus', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus jadwal ini?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteSchedule(${id})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteSchedule(id) {
            scheduleData = scheduleData.filter(s => s.id !== id);
            closeModal();
            loadSchedule();
            showNotification('Jadwal berhasil dihapus!');
        }

        // Class Filter Functions (Used by Admin Regional)
        function filterArtProgressByClass(className) {
            selectedClass = className;
            loadArtProgress();
        }

        function filterSkolastikByClass(className) {
            selectedClass = className;
            loadSkolastikProgress();
        }

        function filterTkaByClass(className) {
            selectedClass = className;
            loadTkaProgress();
        }
        
        // Region Filter Functions (NEW: Used by Super Admin)
        function filterArtProgressByRegion(regionName) {
            selectedAdminRegion = regionName;
            loadArtProgress();
        }

        function filterSkolastikByRegion(regionName) {
            selectedAdminRegion = regionName;
            loadSkolastikProgress();
        }

        function filterTkaByRegion(regionName) {
            selectedAdminRegion = regionName;
            loadTkaProgress();
        }
        
        // Region Filter Functions for Materials (NEW: Used by Super Admin)
        function filterMaterialByRegion(regionName) {
            selectedAdminRegion = regionName;
            loadMaterials();
        }

        // Region Filter Functions for Schedule (NEW: Used by Super Admin)
        function filterScheduleByRegion(regionName) {
            selectedAdminRegion = regionName;
            loadSchedule();
        }

        // Class Filter Functions for Materials (TAMBAHAN BARU)
        function filterMaterialByClass(className) {
            selectedClassMaterial = className;
            loadMaterials();
        }

        // Class Filter Functions for Schedule (TAMBAHAN BARU)
        function filterScheduleByClass(className) {
            selectedClassSchedule = className;
            loadSchedule();
        }

        // --- NEW SCHOOL MANAGEMENT FUNCTIONS ---

        function editSchool(schoolId) {
            const school = availableSchools.find(s => s.id === schoolId);
            
            openModal('Edit Sekolah', `
                <form id="editSchoolForm" class="space-y-4">
                    <div>
                        <label for="editSchoolName" class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah</label>
                        <input type="text" id="editSchoolName" value="${school.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editSchoolForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newName = document.getElementById('editSchoolName').value.trim();
                
                if (availableSchools.some(s => s.id !== schoolId && s.name.toLowerCase() === newName.toLowerCase())) {
                    showNotification('Nama sekolah sudah ada!', 'error');
                    return;
                }

                const oldName = school.name;
                school.name = newName;
                
                // Update students who are currently registered with this school name
                studentsData.forEach(student => {
                    if (student.school === oldName) {
                        student.school = newName;
                    }
                });

                closeModal();
                loadAddStudent();
                showNotification('Nama sekolah berhasil diupdate!');
            });
        }

        function deleteSchool(schoolId) {
            const school = availableSchools.find(s => s.id === schoolId);
            const studentsInSchool = studentsData.filter(s => s.school === school.name);

            if (studentsInSchool.length > 0) {
                openModal('Tidak Dapat Menghapus Sekolah', `
                    <div class="text-center">
                        <div class="mb-4">
                            <span class="text-6xl">‚ùå</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Sekolah Tidak Dapat Dihapus</h3>
                        <p class="text-gray-700 mb-4">Sekolah <strong>${school.name}</strong> masih memiliki <strong>${studentsInSchool.length} siswa</strong> yang terdaftar.</p>
                        <p class="text-sm text-gray-600 mb-6">Silakan pindahkan atau hapus siswa terlebih dahulu sebelum menghapus sekolah ini.</p>
                        <button onclick="closeModal()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Mengerti</button>
                    </div>
                `);
                return;
            }

            openModal('Konfirmasi Hapus Sekolah', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Hapus Sekolah</h3>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus sekolah <strong>${school.name}</strong>?</p>
                    <p class="text-sm text-red-600 mb-6">Tindakan ini tidak dapat dibatalkan!</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteSchool(${schoolId})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteSchool(schoolId) {
            availableSchools = availableSchools.filter(s => s.id !== schoolId);
            closeModal();
            loadAddStudent();
            showNotification('Sekolah berhasil dihapus!');
        }

        // --- END NEW SCHOOL MANAGEMENT FUNCTIONS ---


        // MODIFIED FUNCTION: loadManageClasses - Class management is now regional
        function loadManageClasses() {
            const content = document.getElementById('contentArea');
            const isAdminOrSuperAdmin = currentUser.role === 'Admin' || currentUser.role === 'Super Admin';
            
            let regionalClasses = availableClasses;
            let regionFilterTitle = 'Semua Regional';

            if (currentUser.role === 'Admin') {
                regionalClasses = availableClasses.filter(c => c.region === currentUser.region);
                regionFilterTitle = `Regional ${currentUser.region}`;
            } else if (currentUser.role === 'Super Admin' && selectedAdminRegion !== 'all') {
                regionalClasses = availableClasses.filter(c => c.region === selectedAdminRegion);
                regionFilterTitle = `Regional ${selectedAdminRegion}`;
            } else if (currentUser.role === 'Super Admin') {
                // If Super Admin and 'all', show all, default filter title is fine.
            }

            content.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">üè´ Kelola Kelas (${regionFilterTitle})</h2>
                        ${isAdminOrSuperAdmin ? '<button onclick="addClass()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">+ Tambah Kelas</button>' : ''}
                    </div>

                    ${currentUser.role === 'Super Admin' ? renderRegionDropdown(selectedAdminRegion, 'filterManageClassesByRegion') : ''}
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm h-fit">
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">Tambah Kelas Baru</h3>
                            <form id="addClassForm" class="space-y-4">
                                ${currentUser.role === 'Super Admin' ? `
                                    <div>
                                        <label for="newClassRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional Target</label>
                                        <select id="newClassRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                            <option value="">--- Pilih Regional ---</option>
                                            ${regionalAdmins.map(admin => `
                                                <option value="${admin.region}">${admin.region}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                `: ''}
                                <div>
                                    <label for="className" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
                                    <input type="text" id="className" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Premium">
                                </div>
                                <div>
                                    <label for="classDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Kelas</label>
                                    <textarea id="classDescription" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Deskripsi singkat tentang kelas ini"></textarea>
                                </div>
                                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Tambah Kelas</button>
                            </form>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h3 class="text-xl font-semibold text-gray-900 mb-4">Daftar Kelas Tersedia (${regionalClasses.length})</h3>
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${regionalClasses.map(classItem => {
                                    const studentsInClassAndRegion = studentsData.filter(s => s.class === classItem.name && s.region === classItem.region);
                                    return `
                                    <div class="flex justify-between items-start p-4 bg-gray-50 rounded-lg">
                                        <div class="flex-1">
                                            <h4 class="font-medium text-gray-900">Kelas ${classItem.name}</h4>
                                            <p class="text-sm text-gray-600 mt-1">${classItem.description}</p>
                                            <p class="text-sm text-blue-600 mt-2">
                                                <span class="font-medium">${studentsInClassAndRegion.length} siswa</span> terdaftar
                                                ${currentUser.role === 'Super Admin' ? `(${classItem.region})` : ''}
                                            </p>
                                        </div>
                                        <div class="flex space-x-2 ml-4">
                                            <button onclick="editClass(${classItem.id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Edit</button>
                                            <button onclick="deleteClass(${classItem.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Hapus</button>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">üìä Statistik Kelas (${regionFilterTitle})</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${regionalClasses.map(classItem => {
                                const studentsInClassAndRegion = studentsData.filter(s => s.class === classItem.name && s.region === classItem.region);
                                const totalArtworks = studentsInClassAndRegion.reduce((total, student) => total + student.artworks.length, 0);
                                const avgAttendance = studentsInClassAndRegion.length > 0 ? 
                                    (studentsInClassAndRegion.reduce((total, student) => {
                                        const rate = student.attendance.length > 0 ? 
                                            (student.attendance.filter(att => att.status === 'Hadir').length / student.attendance.length) * 100 : 0;
                                        return total + rate;
                                    }, 0) / studentsInClassAndRegion.length).toFixed(1) : 0;
                                
                                return `
                                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                                        <h4 class="font-bold text-lg mb-3">Kelas ${classItem.name}</h4>
                                        <div class="space-y-2">
                                            <div class="flex items-center justify-between">
                                                <span class="flex items-center">
                                                    <span class="mr-2">üë•</span>
                                                    <span class="text-sm">Siswa</span>
                                                </span>
                                                <span class="font-bold">${studentsInClassAndRegion.length}</span>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <span class="flex items-center">
                                                    <span class="mr-2">üé®</span>
                                                    <span class="text-sm">Karya</span>
                                                </span>
                                                <span class="font-bold">${totalArtworks}</span>
                                            </div>
                                            <div class="flex items-center justify-between border-t border-blue-400 pt-2 mt-2">
                                                <span class="flex items-center">
                                                    <span class="mr-2">üìã</span>
                                                    <span class="text-sm">Kehadiran</span>
                                                </span>
                                                <span class="font-bold">${avgAttendance}%</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('addClassForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('className').value;
                const description = document.getElementById('classDescription').value;
                const targetRegion = currentUser.role === 'Super Admin' ? document.getElementById('newClassRegion').value : currentUser.region;

                if (!targetRegion) {
                    showNotification('Silakan pilih Regional Target.', 'error');
                    return;
                }
                
                // Check if class name already exists in the target region
                if (availableClasses.some(c => c.name.toLowerCase() === name.toLowerCase() && c.region === targetRegion)) {
                    showNotification(`Nama kelas "${name}" sudah ada di regional ${targetRegion}!`, 'error');
                    return;
                }

                const maxId = availableClasses.reduce((max, c) => (c.id > max ? c.id : max), 0);
                const newClass = {
                    id: maxId + 1,
                    name: name,
                    description: description,
                    region: targetRegion // Add region property
                };
                availableClasses.push(newClass);

                showNotification('Kelas berhasil ditambahkan!');
                this.reset();
                loadManageClasses();
            });
        }

        function addClass() {
             // Tentukan regional untuk Super Admin
            let regionSelectHtml = '';
            
            if (currentUser.role === 'Super Admin') {
                regionSelectHtml = `
                    <div>
                        <label for="modalNewClassRegion" class="block text-sm font-medium text-gray-700 mb-1">Regional Target</label>
                        <select id="modalNewClassRegion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                            <option value="">--- Pilih Regional ---</option>
                            ${regionalAdmins.map(admin => `
                                <option value="${admin.region}">${admin.region}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }

            openModal('Tambah Kelas Baru', `
                <form id="addClassModalForm" class="space-y-4">
                    ${regionSelectHtml}
                    <div>
                        <label for="modalClassName" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
                        <input type="text" id="modalClassName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Premium">
                    </div>
                    <div>
                        <label for="modalClassDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Kelas</label>
                        <textarea id="modalClassDescription" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Deskripsi singkat tentang kelas ini"></textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Tambah Kelas</button>
                </form>
            `);

            document.getElementById('addClassModalForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('modalClassName').value;
                const description = document.getElementById('modalClassDescription').value;
                const targetRegion = currentUser.role === 'Super Admin' ? document.getElementById('modalNewClassRegion').value : currentUser.region;

                if (!targetRegion) {
                    showNotification('Silakan pilih Regional Target.', 'error');
                    return;
                }

                // Check if class name already exists in the target region
                if (availableClasses.some(c => c.name.toLowerCase() === name.toLowerCase() && c.region === targetRegion)) {
                    showNotification(`Nama kelas "${name}" sudah ada di regional ${targetRegion}!`, 'error');
                    return;
                }

                const maxId = availableClasses.reduce((max, c) => (c.id > max ? c.id : max), 0);
                const newClass = {
                    id: maxId + 1,
                    name: name,
                    description: description,
                    region: targetRegion // Add region property
                };
                availableClasses.push(newClass);

                closeModal();
                loadManageClasses();
                showNotification('Kelas berhasil ditambahkan!');
            });
        }

        function editClass(classId) {
            const classItem = availableClasses.find(c => c.id === classId);
            
            openModal('Edit Kelas', `
                <form id="editClassForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Regional</label>
                        <input type="text" value="${classItem.region}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500">
                    </div>
                    <div>
                        <label for="editClassName" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
                        <input type="text" id="editClassName" value="${classItem.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="editClassDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Kelas</label>
                        <textarea id="editClassDescription" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">${classItem.description}</textarea>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update</button>
                </form>
            `);

            document.getElementById('editClassForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newName = document.getElementById('editClassName').value;
                const newDescription = document.getElementById('editClassDescription').value;

                // Check if new name conflicts with other classes IN THE SAME REGION
                if (availableClasses.some(c => c.id !== classId && c.name.toLowerCase() === newName.toLowerCase() && c.region === classItem.region)) {
                    showNotification(`Nama kelas "${newName}" sudah ada di regional ${classItem.region}!`, 'error');
                    return;
                }

                const oldName = classItem.name;
                const targetRegion = classItem.region;

                classItem.name = newName;
                classItem.description = newDescription;

                // Update all students in this region with the old class name
                studentsData.forEach(student => {
                    if (student.class === oldName && student.region === targetRegion) {
                        student.class = newName;
                    }
                });

                // Update class name in materials in this region
                classMaterials.forEach(material => {
                    if (material.region === targetRegion) {
                         if (material.classes.includes(oldName)) {
                            material.classes = material.classes.map(c => c === oldName ? newName : c);
                        }
                    }
                });

                // Update class name in schedules in this region
                scheduleData.forEach(schedule => {
                    if (schedule.region === targetRegion) {
                        if (schedule.classes.includes(oldName)) {
                            schedule.classes = schedule.classes.map(c => c === oldName ? newName : c);
                        }
                    }
                });

                closeModal();
                loadManageClasses();
                showNotification('Kelas berhasil diupdate!');
            });
        }

        function deleteClass(classId) {
            const classItem = availableClasses.find(c => c.id === classId);
            const targetRegion = classItem.region;
            const studentsInClass = studentsData.filter(s => s.class === classItem.name && s.region === targetRegion);

            if (studentsInClass.length > 0) {
                openModal('Tidak Dapat Menghapus Kelas', `
                    <div class="text-center">
                        <div class="mb-4">
                            <span class="text-6xl">‚ùå</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Kelas Tidak Dapat Dihapus</h3>
                        <p class="text-gray-700 mb-4">Kelas <strong>${classItem.name}</strong> di regional <strong>${targetRegion}</strong> masih memiliki <strong>${studentsInClass.length} siswa</strong> yang terdaftar.</p>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 text-left">
                            <h4 class="font-semibold text-yellow-800 mb-2">Siswa yang terdaftar:</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                ${studentsInClass.map(student => `<li>‚Ä¢ ${student.name}</li>`).join('')}
                            </ul>
                        </div>
                        <p class="text-sm text-gray-600 mb-6">Silakan pindahkan atau hapus siswa terlebih dahulu sebelum menghapus kelas ini.</p>
                        <button onclick="closeModal()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Mengerti</button>
                    </div>
                `);
                return;
            }

            openModal('Konfirmasi Hapus Kelas', `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Hapus Kelas</h3>
                    <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus kelas <strong>${classItem.name}</strong> di regional <strong>${targetRegion}</strong>?</p>
                    <p class="text-sm text-red-600 mb-6">Tindakan ini akan menghapus referensi kelas dari Materi dan Jadwal di regional ini!</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteClass(${classId})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Batal</button>
                    </div>
                </div>
            `);
        }

        function confirmDeleteClass(classId) {
            const classItem = availableClasses.find(c => c.id === classId);
            const className = classItem.name;
            const targetRegion = classItem.region;

            // Remove class from materials in the same region
            classMaterials.forEach(material => {
                if (material.region === targetRegion) {
                    material.classes = material.classes.filter(c => c !== className);
                }
            });

            // Remove class from schedules in the same region
            scheduleData.forEach(schedule => {
                if (schedule.region === targetRegion) {
                    schedule.classes = schedule.classes.filter(c => c !== className);
                }
            });

            availableClasses = availableClasses.filter(c => c.id !== classId);
            closeModal();
            loadManageClasses();
            showNotification('Kelas berhasil dihapus!');
        }

        // Fungsi-fungsi lama editStudent dan deleteStudent sudah digantikan dengan editUser dan deleteUser
    </script>
  <script>
   (function() {
    function c() {
     var b = a.contentDocument || a.contentWindow.document;
     if (b) {
      var d = b.createElement('script');
      d.innerHTML = "window.__CF$cv$params={r:'997b7cd1a61d0566',t:'MTc2MjAwMTEwOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
      b.getElementsByTagName('head')[0].appendChild(d)
     }
    }
    if (document.body) {
     var a = document.createElement('iframe');
     a.height = 1;
     a.width = 1;
     a.style.position = 'absolute';
     a.style.top = 0;
     a.style.left = 0;
     a.style.border = 'none';
     a.style.visibility = 'hidden';
     document.body.appendChild(a);
     if ('loading' !== document.readyState) c();
     else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c);
     else {
      var e = document.onreadystatechange || function() {};
      document.onreadystatechange = function(b) {
       e(b);
       'loading' !== document.readyState && (document.onreadystatechange = e, c())
      }
     }
    }
   })();
  
// --- Added CRUD helpers for classMaterials and availableSchools (ensure persistence) ---
function addSchool(name){
  if(!name) return;
  const id = Date.now();
  availableSchools.push({id, name});
  saveAllData();
}
function updateSchool(id, name){
  const idx = availableSchools.findIndex(s=>s.id===id);
  if(idx!==-1){ availableSchools[idx].name = name; saveAllData(); }
}
function deleteSchoolById(id){
  availableSchools = availableSchools.filter(s=>s.id!==id);
  // unset student.school references with that id/name (best effort)
  saveAllData();
}

// Material helpers
function addMaterialObj(obj){
  obj.id = Date.now();
  if(currentUser.role === 'Admin') obj.region = currentUser.region;
  classMaterials.push(obj);
  saveAllData();
}
function updateMaterialObj(id, patch){
  const idx = classMaterials.findIndex(m=>m.id===id);
  if(idx===-1) return;
  if(currentUser.role === 'Admin' && classMaterials[idx].region !== currentUser.region){ showNotification('Akses ditolak: region lain','error'); return; }
  classMaterials[idx] = {...classMaterials[idx], ...patch};
  saveAllData();
}
function deleteMaterialById(id){
  const idx = classMaterials.findIndex(m=>m.id===id);
  if(idx===-1) return;
  if(currentUser.role === 'Admin' && classMaterials[idx].region !== currentUser.region){ showNotification('Akses ditolak: region lain','error'); return; }
  classMaterials.splice(idx,1);
  saveAllData();
}
// Call saveAllData when page unloads to reduce risk of lost data
window.addEventListener('beforeunload', saveAllData);


// === MODUL JADWAL KEGIATAN (SAMA SEPERTI JADWAL BELAJAR) ===
function loadActivitySchedule() {
    const content = document.getElementById('contentArea');
    const userRegion = currentUser.region;
    let regionActivities = currentUser.role === 'Super Admin' ? activityScheduleData : activityScheduleData.filter(a => a.region === userRegion);

    let classOptions = availableClasses
        .filter(c => currentUser.role === 'Super Admin' || c.region === userRegion)
        .map(c => `<option value="${c.name}">${c.name}</option>`)
        .join('');

    content.innerHTML = `
        <div class="fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">üìÜ Jadwal Kegiatan</h2>
                ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? 
                    `<button onclick="openAddActivity()" class='px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm'>+ Tambah Kegiatan</button>` : ''}
            </div>

            

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Tanggal</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Nama Kegiatan</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Tujuan</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Kelas</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="activityTableBody">
                            ${regionActivities.map(a => `
                                <tr class="border-t border-gray-200 hover:bg-blue-50">
                                    <td class="px-4 py-3 text-sm text-gray-700">${a.date}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${a.name}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${a.goal}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${a.classes.join(', ')}</td>
                                    <td class="px-4 py-3 text-sm">
                                        ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `
                                            <button onclick="editActivity(${a.id})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                            <button onclick="deleteActivity(${a.id})" class="text-red-600 hover:text-red-800">Hapus</button>` : '-'}
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function openAddActivity() {
    openModal('Tambah Jadwal Kegiatan', `
        <form id="addActivityForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Kegiatan</label>
                <input type="date" id="activityDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
                <input type="text" id="activityName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tujuan</label>
                <textarea id="activityGoal" required class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                <select multiple id="activityClasses" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    ${availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                </select>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
        </form>
    `);

    document.getElementById('addActivityForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const newAct = {
            id: Date.now(),
            date: document.getElementById('activityDate').value,
            name: document.getElementById('activityName').value,
            goal: document.getElementById('activityGoal').value,
            classes: Array.from(document.getElementById('activityClasses').selectedOptions).map(o => o.value),
            region: currentUser.region
        };
        activityScheduleData.push(newAct);
        saveAllData();
        closeModal();
        loadActivitySchedule();
        showNotification('Kegiatan berhasil ditambahkan!', 'success');
    });
}

function deleteActivity(id) {
    if (!confirm('Hapus kegiatan ini?')) return;
    activityScheduleData = activityScheduleData.filter(a => a.id !== id);
    saveAllData();
    loadActivitySchedule();
    showNotification('Kegiatan dihapus!', 'success');
}

function editActivity(id) {
    const act = activityScheduleData.find(a => a.id === id);
    if (!act) return;

    openModal('Edit Jadwal Kegiatan', `
        <form id="editActivityForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Kegiatan</label>
                <input type="date" id="editActivityDate" value="${act.date}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
                <input type="text" id="editActivityName" value="${act.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tujuan</label>
                <textarea id="editActivityGoal" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">${act.goal}</textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                <select multiple id="editActivityClasses" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    ${availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region)
                        .map(c => `<option value="${c.name}" ${act.classes.includes(c.name) ? 'selected' : ''}>${c.name}</option>`).join('')}
                </select>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan Perubahan</button>
        </form>
    `);

    document.getElementById('editActivityForm').addEventListener('submit', function(e) {
        e.preventDefault();
        act.date = document.getElementById('editActivityDate').value;
        act.name = document.getElementById('editActivityName').value;
        act.goal = document.getElementById('editActivityGoal').value;
        act.classes = Array.from(document.getElementById('editActivityClasses').selectedOptions).map(o => o.value);
        saveAllData();
        closeModal();
        loadActivitySchedule();
        showNotification('Kegiatan berhasil diperbarui!', 'success');
    });
}

function filterActivityByClass(className) {
    const userRegion = currentUser.region;
    let filtered = currentUser.role === 'Super Admin' ? activityScheduleData : activityScheduleData.filter(a => a.region === userRegion);
    if (className !== 'all') filtered = filtered.filter(a => a.classes.includes(className));
    const tbody = document.getElementById('activityTableBody');
    tbody.innerHTML = filtered.map(a => `
        <tr class="border-t border-gray-200 hover:bg-blue-50">
            <td class="px-4 py-3 text-sm text-gray-700">${a.date}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${a.name}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${a.goal}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${a.classes.join(', ')}</td>
            <td class="px-4 py-3 text-sm">
                ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `
                    <button onclick="editActivity(${a.id})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                    <button onclick="deleteActivity(${a.id})" class="text-red-600 hover:text-red-800">Hapus</button>` : '-'}
            </td>
        </tr>`).join('');
}
</script>
 
<!-- BEGIN: Injected by assistant ‚Äî Activity & Schedule modules upgrade -->
<script>
// Ensure data arrays exist
if (typeof activityScheduleData === 'undefined') activityScheduleData = [];
if (typeof scheduleData === 'undefined') scheduleData = [];

// Utility: compute day name from YYYY-MM-DD
function getDayNameFromDate(isoDate) {
  const d = new Date(isoDate);
  if (isNaN(d)) return '';
  const days = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
  return days[d.getDay()];
}

// -------------------- Jadwal Kegiatan (table, filter, CRUD, auto-day) --------------------
function loadActivitySchedule() {
  const content = document.getElementById("contentArea");
  const canEdit = currentUser && (currentUser.role === "Super Admin" || currentUser.role === "Admin");
  const regionTitle = (currentUser && currentUser.role === "Super Admin") ? "(Semua Regional)" : (currentUser ? `(Regional ${currentUser.region})` : "");

  // class options - try to infer from availableClasses, fallback to defaults
  const classOptions = (typeof availableClasses !== 'undefined' ? 
    (Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))).map(n=>n)) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);
  classOptions.unshift("Semua Kelas");

  const currentFilter = localStorage.getItem("selectedClassFilter_activity") || "Semua Kelas";

  // Normalize items for rendering (support older shapes)
  const normalized = activityScheduleData.map(item => {
    return {
      id: item.id || item.date + Math.random(),
      date: item.date || item.tanggal || '',
      day: item.day || item.hari || getDayNameFromDate(item.date || item.tanggal || ''),
      time: item.time || item.waktu || (item.timeRange || ''),
      name: item.name || item.nama || item.kegiatan || item.title || '',
      place: item.place || item.tempat || item.location || '',
      classTarget: item.classTarget || item.classTarget || (item.classes && item.classes.length ? item.classes[0] : "Semua Kelas"),
      region: item.region || item.regionName || ''
    };
  });

  // Filter by region for non-superadmin
  let filteredData = normalized;
  if (!currentUser || currentUser.role !== "Super Admin") {
    const userRegion = currentUser ? currentUser.region : '';
    filteredData = filteredData.filter(a => !a.region || a.region === userRegion);
  }

  // Filter by class target
  if (currentFilter && currentFilter !== "Semua Kelas") {
    filteredData = filteredData.filter(a => a.classTarget === currentFilter);
  }

  // Sort by date asc
  filteredData.sort((a,b) => new Date(a.date) - new Date(b.date));

  content.innerHTML = `
    <div class="fade-in">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
          <span class="text-3xl mr-2">üìÜ</span> Jadwal Kegiatan ${regionTitle}
        </h2>
        <div class="flex items-center space-x-3">
          ${canEdit ? `<button onclick="openAddActivityModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm">+ Tambah Kegiatan</button>` : ''}
        </div>
      </div>

      ${canEdit ? `
      <div class="mb-4 flex items-end space-x-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
          <select id="classFilterDropdownActivity" class="w-48 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            ${classOptions.map(opt => `<option ${opt === currentFilter ? 'selected' : ''} value="${opt}">${opt}</option>`).join('')}
          </select>
        </div>
      </div>` : ''}

      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-800 text-white">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold">Tanggal</th>
              <th class="px-4 py-3 text-left text-sm font-semibold">Hari</th>
              <th class="px-4 py-3 text-left text-sm font-semibold">Waktu</th>
              <th class="px-4 py-3 text-left text-sm font-semibold">Nama Kegiatan</th>
              <th class="px-4 py-3 text-left text-sm font-semibold">Tempat</th>
              ${canEdit ? '<th class="px-4 py-3 text-left text-sm font-semibold">Aksi</th>' : ''}
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100" id="activityTableBody">
            ${filteredData.map(item => `
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-700">${item.date || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.day || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.time || ''}</td>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.place || ''}</td>
                ${canEdit ? `<td class="px-4 py-3 text-sm">
                  <button onclick="editActivity('${item.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                  <button onclick="deleteActivity('${item.id}')" class="text-red-600 hover:text-red-800">Hapus</button>
                </td>` : ''}
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;

  if (canEdit) {
    const sel = document.getElementById("classFilterDropdownActivity");
    sel.addEventListener("change", () => {
      localStorage.setItem("selectedClassFilter_activity", sel.value);
      loadActivitySchedule();
    });
  }
}

function openAddActivityModal() {
  const regionText = (currentUser && currentUser.role === "Super Admin") ? "Semua Regional" : (currentUser ? `Regional ${currentUser.region}` : '');
  // infer class options
  const classOptions = (typeof availableClasses !== 'undefined' ? Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);

  openModal("Tambah Jadwal Kegiatan", `
    <form id="addActivityForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
        <input type="date" id="activityDate" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
        <input type="text" id="activityDay" readonly placeholder="Otomatis dari tanggal" class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
        <input type="text" id="activityTime" placeholder="Contoh: 09.00 - 11.00" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
        <input type="text" id="activityName" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tempat Kegiatan</label>
        <input type="text" id="activityPlace" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Target</label>
        <select id="activityClassTarget" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
          <option value="">Pilih Kelas</option>
          ${classOptions.map(c=>`<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="text-sm text-gray-600 mt-2"><span class="font-semibold">Relevan:</span> ${regionText}</div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition w-full">Simpan</button>
      </div>
    </form>
  `);

  const dateEl = document.getElementById("activityDate");
  dateEl.addEventListener("change", ()=>{
    document.getElementById("activityDay").value = getDayNameFromDate(dateEl.value);
  });

  document.getElementById("addActivityForm").onsubmit = e => {
    e.preventDefault();
    const newAct = {
      id: String(Date.now()),
      date: document.getElementById("activityDate").value,
      day: document.getElementById("activityDay").value || getDayNameFromDate(document.getElementById("activityDate").value),
      time: document.getElementById("activityTime").value,
      name: document.getElementById("activityName").value,
      place: document.getElementById("activityPlace").value,
      classTarget: document.getElementById("activityClassTarget").value || "Semua Kelas",
      region: currentUser ? currentUser.region : ''
    };
    activityScheduleData.push(newAct);
    try { saveAllData(); } catch(e){ console.warn(e); }
    closeModal();
    showNotification("Kegiatan berhasil ditambahkan!", "success");
    loadActivitySchedule();
  };
}

function editActivity(id) {
  const idx = activityScheduleData.findIndex(a => String(a.id) === String(id));
  if (idx === -1) return;
  const a = activityScheduleData[idx];
  const classOptions = (typeof availableClasses !== 'undefined' ? Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);

  openModal("Edit Jadwal Kegiatan", `
    <form id="editActivityForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
        <input type="date" id="editActivityDate" value="${a.date || ''}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
        <input type="text" id="editActivityDay" value="${a.day || getDayNameFromDate(a.date || '')}" readonly class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
        <input type="text" id="editActivityTime" value="${a.time || ''}" placeholder="Contoh: 09.00 - 11.00" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
        <input type="text" id="editActivityName" value="${a.name || ''}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tempat Kegiatan</label>
        <input type="text" id="editActivityPlace" value="${a.place || ''}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Target</label>
        <select id="editActivityClassTarget" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
          ${classOptions.map(c=>`<option value="${c}" ${a.classTarget===c ? 'selected' : ''}>${c}</option>`).join('')}
        </select>
      </div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition w-full">Update</button>
      </div>
    </form>
  `);

  const dateEl = document.getElementById("editActivityDate");
  dateEl.addEventListener("change", ()=> {
    document.getElementById("editActivityDay").value = getDayNameFromDate(dateEl.value);
  });

  document.getElementById("editActivityForm").onsubmit = e => {
    e.preventDefault();
    activityScheduleData[idx] = {
      ...activityScheduleData[idx],
      date: document.getElementById("editActivityDate").value,
      day: document.getElementById("editActivityDay").value || getDayNameFromDate(document.getElementById("editActivityDate").value),
      time: document.getElementById("editActivityTime").value,
      name: document.getElementById("editActivityName").value,
      place: document.getElementById("editActivityPlace").value,
      classTarget: document.getElementById("editActivityClassTarget").value
    };
    try { saveAllData(); } catch(e){ console.warn(e); }
    closeModal();
    showNotification("Kegiatan berhasil diperbarui!", "success");
    loadActivitySchedule();
  };
}

function deleteActivity(id) {
  if (!confirm("Apakah Anda yakin ingin menghapus kegiatan ini?")) return;
  activityScheduleData = activityScheduleData.filter(a => String(a.id) !== String(id));
  try { saveAllData(); } catch(e){ console.warn(e); }
  showNotification("Kegiatan berhasil dihapus!", "success");
  loadActivitySchedule();
}

// -------------------- Jadwal Belajar updates: table + dropdown + add/edit with auto-day --------------------
function loadSchedule() {
  const content = document.getElementById("contentArea");
  const canEdit = currentUser && (currentUser.role === "Super Admin" || currentUser.role === "Admin");
  const regionTitle = (currentUser && currentUser.role === "Super Admin") ? "(Semua Regional)" : (currentUser ? `(Regional ${currentUser.region})` : "");

  // class options
  const classOptions = (typeof availableClasses !== 'undefined' ? Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);
  classOptions.unshift("Semua Kelas");

  const currentFilter = localStorage.getItem("selectedClassFilter_schedule") || "Semua Kelas";

  // normalize scheduleData items
  const normalized = scheduleData.map(item => ({
    id: item.id || (item.date + Math.random()),
    date: item.date || '',
    day: item.day || getDayNameFromDate(item.date || ''),
    time: item.time || item.time || '',
    subject: item.subject || item.title || item.subjectName || '',
    classTarget: item.classTarget || item.classTarget || (item.classes && item.classes.length ? item.classes[0] : '')
  }));

  // filter by region
  let filtered = normalized;
  if (!currentUser || currentUser.role !== "Super Admin") {
    const userRegion = currentUser ? currentUser.region : '';
    filtered = filtered.filter(s => (s.region ? s.region === userRegion : true));
  }

  if (currentFilter && currentFilter !== "Semua Kelas") {
    filtered = filtered.filter(s => s.classTarget === currentFilter);
  }

  // sort by date
  filtered.sort((a,b) => new Date(a.date) - new Date(b.date));

  content.innerHTML = `
    <div class="fade-in">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center"><span class="text-3xl mr-2">üìö</span> Jadwal Belajar ${regionTitle}</h2>
        ${canEdit ? `<button onclick="openAddScheduleModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">+ Tambah Jadwal</button>` : ''}
      </div>

      ${canEdit ? `
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
        <select id="classFilterSchedule" class="w-48 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          ${classOptions.map(opt => `<option ${opt === currentFilter ? 'selected' : ''} value="${opt}">${opt}</option>`).join('')}
        </select>
      </div>` : ''}

      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-800 text-white">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold">Tanggal</th>
              <th class="px-4 py-3 text-left text-sm font-semibold">Waktu</th>
              <th class="px-4 py-3 text-left text-sm font-semibold">Hari</th>
              <th class="px-4 py-3 text-left text-sm font-semibold">Nama Materi</th>
              <th class="px-4 py-3 text-left text-sm font-semibold">Kelas Target</th>
              ${canEdit ? '<th class="px-4 py-3 text-left text-sm font-semibold">Aksi</th>' : ''}
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100" id="scheduleTableBody">
            ${filtered.map(item => `
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-700">${item.date || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.time || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.day || ''}</td>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.subject || ''}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.classTarget || ''}</td>
                ${canEdit ? `<td class="px-4 py-3 text-sm">
                  <button onclick="editSchedule('${item.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                  <button onclick="deleteSchedule('${item.id}')" class="text-red-600 hover:text-red-800">Hapus</button>
                </td>` : ''}
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;

  if (canEdit) {
    document.getElementById("classFilterSchedule").addEventListener("change", (e)=> {
      localStorage.setItem("selectedClassFilter_schedule", e.target.value);
      loadSchedule();
    });
  }
}

// add schedule modal (with auto-day)
function openAddScheduleModal() {
  const regionText = (currentUser && currentUser.role === "Super Admin") ? "Semua Regional" : (currentUser ? `Regional ${currentUser.region}` : '');
  const classOptions = (typeof availableClasses !== 'undefined' ? Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);

  openModal("Tambah Jadwal Belajar", `
    <form id="addScheduleForm_v2" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
        <input type="date" id="scheduleDateNew" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
        <input type="text" id="scheduleTimeNew" placeholder="Contoh: 09.00 - 11.00" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
        <input type="text" id="scheduleDayNew" readonly placeholder="Otomatis dari tanggal" class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Materi</label>
        <input type="text" id="scheduleSubjectNew" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Target</label>
        <select id="scheduleClassTargetNew" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
          <option value="">Pilih Kelas</option>
          ${classOptions.map(c=>`<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="text-sm text-gray-600 mt-2"><span class="font-semibold">Relevan:</span> ${regionText}</div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition w-full">Simpan</button>
      </div>
    </form>
  `);

  document.getElementById("scheduleDateNew").addEventListener("change", ()=>{
    document.getElementById("scheduleDayNew").value = getDayNameFromDate(document.getElementById("scheduleDateNew").value);
  });

  document.getElementById("addScheduleForm_v2").onsubmit = e => {
    e.preventDefault();
    const newS = {
      id: String(Date.now()),
      date: document.getElementById("scheduleDateNew").value,
      time: document.getElementById("scheduleTimeNew").value,
      day: document.getElementById("scheduleDayNew").value || getDayNameFromDate(document.getElementById("scheduleDateNew").value),
      subject: document.getElementById("scheduleSubjectNew").value,
      classTarget: document.getElementById("scheduleClassTargetNew").value,
      region: currentUser ? currentUser.region : ''
    };
    scheduleData.push(newS);
    try { saveAllData(); } catch(e){ console.warn(e); }
    closeModal();
    showNotification("Jadwal belajar berhasil ditambahkan!", "success");
    loadSchedule();
  };
}

function editSchedule(id) {
  const idx = scheduleData.findIndex(s => String(s.id) === String(id));
  if (idx === -1) return;
  const s = scheduleData[idx];
  const classOptions = (typeof availableClasses !== 'undefined' ? Array.from(new Set(availableClasses.filter(c => currentUser.role === 'Super Admin' || c.region === currentUser.region).map(c=>c.name))) : ["Kelas GOLD","Kelas SILVER","Kelas BRONZE"]);

  openModal("Edit Jadwal Belajar", `
    <form id="editScheduleForm_v2" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
        <input type="date" id="editScheduleDate" value="${s.date || ''}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
        <input type="text" id="editScheduleTime" value="${s.time || ''}" placeholder="Contoh: 09.00 - 11.00" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
        <input type="text" id="editScheduleDay" value="${s.day || getDayNameFromDate(s.date || '')}" readonly class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Materi</label>
        <input type="text" id="editScheduleSubject" value="${s.subject || ''}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas Target</label>
        <select id="editScheduleClassTarget" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
          ${classOptions.map(c=>`<option value="${c}" ${s.classTarget===c ? 'selected' : ''}>${c}</option>`).join('')}
        </select>
      </div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition w-full">Update</button>
      </div>
    </form>
  `);

  document.getElementById("editScheduleDate").addEventListener("change", ()=>{
    document.getElementById("editScheduleDay").value = getDayNameFromDate(document.getElementById("editScheduleDate").value);
  });

  document.getElementById("editScheduleForm_v2").onsubmit = e => {
    e.preventDefault();
    scheduleData[idx] = {
      ...scheduleData[idx],
      date: document.getElementById("editScheduleDate").value,
      time: document.getElementById("editScheduleTime").value,
      day: document.getElementById("editScheduleDay").value || getDayNameFromDate(document.getElementById("editScheduleDate").value),
      subject: document.getElementById("editScheduleSubject").value,
      classTarget: document.getElementById("editScheduleClassTarget").value
    };
    try { saveAllData(); } catch(e){ console.warn(e); }
    closeModal();
    showNotification("Jadwal belajar berhasil diperbarui!", "success");
    loadSchedule();
  };
}

// Delete schedule helper for schedule module
function deleteSchedule(id) {
  if (!confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) return;
  scheduleData = scheduleData.filter(s => String(s.id) !== String(id));
  try { saveAllData(); } catch(e){ console.warn(e); }
  showNotification("Jadwal belajar berhasil dihapus!", "success");
  loadSchedule();
}

// Ensure initial modules exist - don't override if other functions present elsewhere
if (typeof window.loadActivitySchedule === 'undefined' || window.loadActivitySchedule.toString().includes('BEGIN: Injected') ) {
  window.loadActivitySchedule = loadActivitySchedule;
}
window.openAddActivityModal = openAddActivityModal;
window.editActivity = editActivity;
window.deleteActivity = deleteActivity;

window.loadSchedule = loadSchedule;
window.openAddScheduleModal = openAddScheduleModal;
window.editSchedule = editSchedule;
window.deleteSchedule = deleteSchedule;

// If currently viewing relevant module, refresh it
if (typeof currentModule !== 'undefined') {
  if (currentModule === 'activitySchedule') loadActivitySchedule();
  if (currentModule === 'schedule') loadSchedule();
}
</script>
<!-- END: Injected by assistant -->


<script>
function smoothUpdateTable(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) return;
  section.style.opacity = 0;
  section.style.transition = "opacity 0.4s ease";
  setTimeout(() => {
    section.style.opacity = 1;
  }, 200);
  section.scrollIntoView({ behavior: "smooth", block: "start" });
}

// Integrate smooth update into filter functions
const originalFilterArt = window.filterArtProgressByClass;
window.filterArtProgressByClass = function(cls) {
  originalFilterArt(cls);
  smoothUpdateTable('artProgressSection');
};
const originalFilterSkol = window.filterSkolastikByClass;
window.filterSkolastikByClass = function(cls) {
  originalFilterSkol(cls);
  smoothUpdateTable('skolastikSection');
};
const originalFilterTka = window.filterTkaByClass;
window.filterTkaByClass = function(cls) {
  originalFilterTka(cls);
  smoothUpdateTable('tkaSection');
};
const originalFilterMaterial = window.filterMaterialByClass;
window.filterMaterialByClass = function(cls) {
  originalFilterMaterial(cls);
  smoothUpdateTable('materialSection');
};

// Responsive tweaks for dropdowns
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('select').forEach(sel => {
    sel.classList.add('w-full', 'sm:w-1/2', 'md:w-1/3');
  });
});
</script>

</body>
</html>
<!-- === Materi Kelas UI Override (FINAL FIX) === -->
<script>
// Override aman: hanya ganti tampilan modul Materi Kelas tanpa ganggu modul lain
function loadMaterials() {
    const content = document.getElementById('contentArea');
    if (!content) return;

    let regionalMaterials = classMaterials.filter(m => currentUser.role === 'Super Admin' || m.region === currentUser.region);

    if (selectedClassMaterial !== 'all') {
        regionalMaterials = regionalMaterials.filter(m => m.classes.includes(selectedClassMaterial));
    }

    const classOptions = [...new Set(classMaterials.flatMap(m => m.classes))];

    content.innerHTML = `
        <div class="fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
                    <select id="filterClassMaterial" onchange="filterMaterials()" 
                        class="border border-blue-500 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">Semua Kelas</option>
                        ${classOptions.map(c => `<option value="${c}" ${selectedClassMaterial === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `
                    <button onclick="addMaterial()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition">
                        + Tambah Materi
                    </button>` : ''}
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                    <span class="text-3xl mr-3">üìö</span> Daftar Materi Kelas
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-blue-50 border-b border-blue-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Topik</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Deskripsi</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Kelas</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Regional</th>
                                ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? 
                                    '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Aksi</th>' : ''}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            ${regionalMaterials.map(m => `
                                <tr>
                                    <td class="px-4 py-3 text-sm text-gray-800 font-medium">${m.topic}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${m.description}</td>
                                    <td class="px-4 py-3 text-sm text-blue-600 font-semibold">${m.classes.join(', ')}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${m.region}</td>
                                    ${(currentUser.role === 'Admin' || currentUser.role === 'Super Admin') ? `
                                        <td class="px-4 py-3 text-sm">
                                            <button onclick="editMaterial(${m.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                            <button onclick="deleteMaterial(${m.id})" class="text-red-600 hover:text-red-800">Hapus</button>
                                        </td>` : ''}
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function filterMaterials() {
    const selected = document.getElementById('filterClassMaterial').value;
    selectedClassMaterial = selected;
    loadMaterials();
}
</script>

<!-- === Materi Kelas UI Override (FINAL FIX v2) === -->
<script>
// Versi dengan pembatasan: siswa tidak punya filter, admin regional lihat kelas di region-nya
function loadMaterials() {
    const content = document.getElementById('contentArea');
    if (!content) return;

    let regionalMaterials = classMaterials.filter(m => 
        currentUser.role === 'Super Admin' || m.region === currentUser.region
    );

    if (selectedClassMaterial !== 'all') {
        regionalMaterials = regionalMaterials.filter(m => m.classes.includes(selectedClassMaterial));
    }

    // Daftar kelas tergantung role
    let classOptions = [];
    if (currentUser.role === 'Super Admin') {
        classOptions = [...new Set(classMaterials.flatMap(m => m.classes))];
    } else if (currentUser.role === 'Admin' || currentUser.role === 'Admin Regional') {
        classOptions = [...new Set(
            classMaterials.filter(m => m.region === currentUser.region).flatMap(m => m.classes)
        )];
    }

    let filterUI = '';
    if (currentUser.role === 'Admin' || currentUser.role === 'Admin Regional' || currentUser.role === 'Super Admin') {
        filterUI = `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter Kelas</label>
                <select id="filterClassMaterial" onchange="filterMaterials()" 
                    class="border border-blue-500 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">Semua Kelas</option>
                    ${classOptions.map(c => `<option value="${c}" ${selectedClassMaterial === c ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
            </div>
        `;
    }

    const addButton = (currentUser.role === 'Admin' || currentUser.role === 'Admin Regional' || currentUser.role === 'Super Admin') ? `
        <button onclick="addMaterial()" 
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition">
            + Tambah Materi
        </button>` : '';

    content.innerHTML = `
        <div class="fade-in">
            <div class="flex justify-between items-center mb-6">
                ${filterUI}
                ${addButton}
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                    <span class="text-3xl mr-3">üìö</span> Daftar Materi Kelas
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-blue-50 border-b border-blue-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Topik</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Deskripsi</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Kelas</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Regional</th>
                                ${(currentUser.role === 'Admin' || currentUser.role === 'Admin Regional' || currentUser.role === 'Super Admin') ? 
                                    '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Aksi</th>' : ''}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            ${regionalMaterials.map(m => `
                                <tr>
                                    <td class="px-4 py-3 text-sm text-gray-800 font-medium">${m.topic}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${m.description}</td>
                                    <td class="px-4 py-3 text-sm text-blue-600 font-semibold">${m.classes.join(', ')}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${m.region}</td>
                                    ${(currentUser.role === 'Admin' || currentUser.role === 'Admin Regional' || currentUser.role === 'Super Admin') ? `
                                        <td class="px-4 py-3 text-sm">
                                            <button onclick="editMaterial(${m.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                            <button onclick="deleteMaterial(${m.id})" class="text-red-600 hover:text-red-800">Hapus</button>
                                        </td>` : ''}
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function filterMaterials() {
    const selected = document.getElementById('filterClassMaterial')?.value || 'all';
    selectedClassMaterial = selected;
    loadMaterials();
}
</script>
