<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sistem Informasi Laporan Kemajuan Siswa - Bimbel Gambar Villa Merah (Patched v2)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Supabase UMD client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script>
  const SUPABASE_URL = 'https://xopxgeexxptomzvegvmf.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvcHhnZWV4eHB0b216dmVndm1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDAyNjMsImV4cCI6MjA3ODYxNjI2M30.GLUEjYeqaDwyl21uds2t58RYVqNez-4onbbtPyVXZ0w';
  window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>
<style>
        body { box-sizing: border-box; }
        * { box-sizing: border-box; }
        .sidebar-active { background-color: #1e40af; color: white; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .editable-image { cursor: pointer; transition: transform 0.2s; }
        .editable-image:hover { transform: scale(1.05); }
        table { border-collapse: collapse; }
        th, td { border: 1px solid #e5e7eb; }
        .notification { position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .success { background-color: #10b981; }
        .error { background-color: #ef4444; }
</style>
</head>
<body class="bg-white">
<style>
.login-bg { background: url('FSRD.jpeg') no-repeat center center fixed; background-size: cover; position: relative; }
.login-overlay { position: absolute; inset: 0; background-color: rgba(0, 0, 0, 0.5); }
.login-container { position: relative; z-index: 10; }
</style>

<div id="loginPage" class="login-bg min-h-screen flex items-center justify-center py-15 px-4 relative">
  <div class="login-overlay"></div>
  <div class="login-container max-w-md  w-full space-y-8 bg-white/90 p-8 rounded-2xl shadow-2xl backdrop-blur-md">
<div class="max-w-md w-full space-y-8">
<div class="text-center">
<div class="bg-white-600 w-24 h-24 mx-auto rounded-lg flex items-center justify-center mb-4 shadow-lg">
<img alt="Logo Bimbel Gambar Villa Merah" class="w-50 h-20 p-2" src="https://www.villamerah.com/assets/images/logo/logo-2.png"/>
</div>
<h2 class="text-2xl text-center font-bold text-gray-900 mb-2" style="color: red;">Bimbel Gambar Villa Merah</h2>
<h3 class="text-1xl text-center font-semibold text-blue-600">Laporan Kemajuan Siswa</h3>
</div>
<form class="mt-8 space-y-6" id="loginForm">
<div class="space-y-4">
<div><label class="block text-sm font-medium text-gray-700 mb-1" for="username">Username</label> <input class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="username" name="username" placeholder="Masukkan username" required type="text"/></div>
<div><label class="block text-sm font-medium text-gray-700 mb-1" for="password">Password</label> <input class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="password" name="password" placeholder="Masukkan password" required type="password"/></div>
</div>
<div><button class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors" type="submit"> Masuk </button>
</div>
</form>
</div>
</div>
</div>

<div class="hidden min-h-full" id="dashboardPage">
<header class="bg-white border-b border-gray-200 fixed w-full top-0 z-10 shadow-sm">
<div class="flex items-center justify-between px-6 py-4">
<div class="flex items-center space-x-4">
<div class="bg-white-600 w-12 h-12 rounded-lg flex items-center justify-center shadow-lg">
<img alt="Logo Bimbel Gambar Villa Merah" class="w-10 h-10 p-1" src="https://bimbelgambar.id/wp-content/uploads/2023/06/favicon-20200601113259.png"/>
</div>
<div>
<h1 class="text-xl font-bold text-red-600">Bimbel Gambar Villa Merah</h1>
<p class="text-sm text-gray-600" id="userRole"></p>
<p class="text-xs text-blue-600" id="userRegion"></p>
</div>
</div>
<button class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow-sm" id="logoutBtn"> Keluar </button>
</div>
</header>
<div class="flex pt-20">
<aside class="w-64 fixed left-0 min-h-full text-white bg-gradient-to-b from-blue-700 to-blue-900 shadow-xl border-r border-blue-950/20 transition-all duration-300">
<nav class="p-4 space-y-2" id="sidebarMenu"></nav>
</aside>
<main class="ml-64 flex-1 p-8 w-full">
<div class="fade-in" id="contentArea"></div>
</main>
</div>
</div>

<div class="hidden fixed inset-0 z-50 overflow-y-auto" id="modal">
<div class="flex items-center justify-center min-h-full p-4">
<div class="modal-backdrop fixed inset-0" onclick="closeModal()"></div>
<div class="bg-white rounded-lg shadow-xl relative z-10 max-w-4xl w-full max-h-full overflow-y-auto">
<div class="p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-bold text-gray-900" id="modalTitle"></h3><button class="text-gray-400 hover:text-gray-600" onclick="closeModal()"> <span class="text-2xl">Ã—</span> </button>
</div>
<div id="modalContent"></div>
</div>
</div>
</div>
</div>

<script>
// -----------------------------
// Global state & data arrays
// -----------------------------
let currentUser = null;
let currentModule = 'home';
let selectedClass = 'all';
let selectedClassMaterial = 'all';
let selectedClassSchedule = 'all';
let selectedAdminRegion = 'all';
let regionalAdmins = [];
let availableClasses = [];
let studentsData = [];
let educationInfo = [];
let classMaterials = [];
let scheduleData = [];
let activityScheduleData = [];
let availableSchools = [];

// -----------------------------
// Utility: notification
// -----------------------------
function showNotification(text, type='success', timeout=3000) {
  const n = document.createElement('div');
  n.className = `notification ${type==='success' ? 'success' : 'error'}`;
  n.textContent = text;
  document.body.appendChild(n);
  setTimeout(()=> n.remove(), timeout);
}

// -----------------------------
// Local storage helpers (local-only fallback)
// -----------------------------
function saveLocalData() {
  try {
    localStorage.setItem("studentsData", JSON.stringify(studentsData));
    localStorage.setItem("regionalAdmins", JSON.stringify(regionalAdmins));
    localStorage.setItem("availableClasses", JSON.stringify(availableClasses));
    localStorage.setItem("educationInfo", JSON.stringify(educationInfo));
    localStorage.setItem("scheduleData", JSON.stringify(scheduleData));
    localStorage.setItem("activityScheduleData", JSON.stringify(activityScheduleData));
    localStorage.setItem("classMaterials", JSON.stringify(classMaterials));
    localStorage.setItem("availableSchools", JSON.stringify(availableSchools));
  } catch(e){ console.warn('saveLocalData failed', e); }
}

function loadLocalData() {
  try {
    const sd = localStorage.getItem("studentsData");
    const ra = localStorage.getItem("regionalAdmins");
    const ac = localStorage.getItem("availableClasses");
    const ei = localStorage.getItem("educationInfo");
    const sch = localStorage.getItem("scheduleData");
    if (sd) studentsData = JSON.parse(sd);
    if (ra) regionalAdmins = JSON.parse(ra);
    if (ac) availableClasses = JSON.parse(ac);
    if (ei) educationInfo = JSON.parse(ei);
    if (sch) scheduleData = JSON.parse(sch);
    const act = localStorage.getItem("activityScheduleData"); if (act) activityScheduleData = JSON.parse(act);
    const cm = localStorage.getItem('classMaterials'); if (cm) classMaterials = JSON.parse(cm);
    const sc = localStorage.getItem('availableSchools'); if (sc) availableSchools = JSON.parse(sc);
  } catch(e){ console.warn('loadLocalData failed', e); }
}

// -----------------------------
// Supabase data sync (async)
// -----------------------------
function sb(){ return window.supabaseClient; }

async function fetchAllFromSupabase() {
  try {
    const { data: admins, error: aErr } = await sb().from('admins').select('*');
    if (!aErr) regionalAdmins = admins || [];
    const { data: students, error: sErr } = await sb().from('students').select('*');
    if (!sErr) studentsData = students || [];
    const { data: classes, error: cErr } = await sb().from('classes').select('*');
    if (!cErr) availableClasses = classes || [];
    const { data: edu, error: eiErr } = await sb().from('education_info').select('*');
    if (!eiErr) educationInfo = edu || [];
    const { data: mats, error: mErr } = await sb().from('class_materials').select('*');
    if (!mErr) classMaterials = mats || [];
    const { data: sch, error: schErr } = await sb().from('schedules').select('*');
    if (!schErr) scheduleData = sch || [];
    const { data: acts, error: actErr } = await sb().from('activity_schedules').select('*');
    if (!actErr) activityScheduleData = acts || [];
    // derive available schools
    availableSchools = [...new Set((studentsData || []).map(s => s.school).filter(Boolean))];
    console.log('fetchAllFromSupabase: loaded data');
  } catch(err){ console.error('fetchAllFromSupabase failed', err); }
}

// Upsert/save to Supabase (best-effort)
async function syncAllToSupabase() {
  try{
    for(const s of studentsData) await sb().from('students').upsert(s, { onConflict: 'id' });
    for(const a of regionalAdmins) await sb().from('admins').upsert(a, { onConflict: 'username' });
    for(const c of availableClasses) await sb().from('classes').upsert(c, { onConflict: 'id' });
    for(const e of educationInfo) await sb().from('education_info').upsert(e, { onConflict: 'id' });
    for(const m of classMaterials) await sb().from('class_materials').upsert(m, { onConflict: 'id' });
    for(const s of scheduleData) await sb().from('schedules').upsert(s, { onConflict: 'id' });
    for(const a of activityScheduleData) await sb().from('activity_schedules').upsert(a, { onConflict: 'id' });
    console.log('syncAllToSupabase: attempted upserts');
  } catch(e){ console.error('syncAllToSupabase failed', e); }
}

// -----------------------------
// Auth: check credentials in Supabase
// -----------------------------
async function checkCredentials(username, password) {
  try {
    const { data: admin } = await sb().from('admins').select('*').eq('username', username).eq('password', password).maybeSingle();
    if (admin) return { ...admin, role: admin.role || 'Admin' };
    const { data: student } = await sb().from('students').select('*').eq('username', username).eq('password', password).maybeSingle();
    if (student) return { ...student, role: 'Siswa' };
    return null;
  } catch(err){ console.error('checkCredentials failed', err); return null; }
}

// -----------------------------
// Session management (async-safe)
// -----------------------------
function saveSession() { try { localStorage.setItem('currentUser', JSON.stringify(currentUser)); } catch(e){console.warn(e);} }

async function loadSession() {
  try{
    const cu = localStorage.getItem('currentUser');
    if (cu) {
      currentUser = JSON.parse(cu);
      showDashboard();
      // record login activity (local log)
      try{
        let logs = JSON.parse(localStorage.getItem('loginActivityLogs')||'[]');
        const now = new Date().toLocaleString('id-ID', { hour12:false });
        // attempt to record name/role/region based on loaded arrays
        const found = (regionalAdmins.find(a=>a.username===currentUser.username) || studentsData.find(s=>s.username===currentUser.username) || {});
        if (found && found.role !== 'Super Admin'){
          logs.unshift({ name: found.name||currentUser.name||currentUser.username, role: found.role||currentUser.role||'Siswa', region: found.region||'-', time: now });
          localStorage.setItem('loginActivityLogs', JSON.stringify(logs.slice(0,100)));
        }
      } catch(e){console.warn('log save failed', e);}    
    }
  } catch(e){ console.warn('loadSession failed', e); }
}

// -----------------------------
// Login handler (fixed)
// -----------------------------
document.addEventListener('DOMContentLoaded', async function(){
  // load local fallback quickly so UI doesn't break
  loadLocalData();
  // Then try to fetch online data (non-blocking)
  await fetchAllFromSupabase();
  // Restore session if exists
  await loadSession();

  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      try{
        const user = await checkCredentials(username, password);
        if (user) {
          currentUser = user;
          saveSession();
          showNotification(`Selamat datang, ${currentUser.name || currentUser.username}!`, 'success');
          // refresh data after login
          await fetchAllFromSupabase();
          showDashboard();
        } else {
          showNotification('Username atau password salah!', 'error');
        }
      } catch(err){ console.error(err); showNotification('Terjadi kesalahan saat login.', 'error'); }
    });
  }

  // logout button
  const lb = document.getElementById('logoutBtn');
  if (lb) lb.addEventListener('click', logout);
});

// -----------------------------
// showDashboard / logout
// -----------------------------
function showDashboard(){
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('dashboardPage').classList.remove('hidden');
  // hide role/region in header (as earlier)
  document.getElementById('userRole').textContent = '';
  document.getElementById('userRegion').textContent = '';
  loadSidebar();
  loadHome();
}

function logout(){
  try{ syncAllToSupabase(); saveLocalData(); } catch(e){console.warn(e);} 
  currentUser = null;
  currentModule = 'home';
  localStorage.removeItem('currentUser');
  document.getElementById('loginForm').reset();
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('dashboardPage').classList.add('hidden');
}

// -----------------------------
// Sidebar / navigation helpers
// -----------------------------
function loadSidebar(){
  const sidebar = document.getElementById('sidebarMenu');
  let menuItems = [ { id: 'home', label: 'Home', icon: 'ðŸ ' }, { id: 'artProgress', label: 'Kemajuan Gambar', icon: 'ðŸŽ¨' }, { id: 'skolastikProgress', label: 'Kemajuan Tes Skolastik', icon: 'ðŸ“Š' }, { id: 'tkaProgress', label: 'Kemajuan TKA', icon: 'ðŸ“ˆ' }, { id: 'schedule', label: 'Jadwal Belajar', icon: 'ðŸ“…' }, { id: 'activitySchedule', label: 'Jadwal Kegiatan', icon: 'ðŸ“†' }, { id: 'materials', label: 'Materi Kelas', icon: 'ðŸ“š' }, { id: 'educationInfo', label: 'Informasi Pendidikan', icon: 'ðŸ“°' } ];
  if (currentUser && currentUser.role === 'Admin') { menuItems.push({ id: 'addStudent', label: 'Tambah Siswa', icon: 'ðŸ‘¤' }); menuItems.push({ id: 'manageClasses', label: 'Kelola Kelas', icon: 'ðŸ«' }); }
  else if (currentUser && currentUser.role === 'Super Admin') { menuItems = [ { id: 'home', label: 'Home', icon: 'ðŸ ' }, { id: 'manageAdmins', label: 'Kelola Admin Regional', icon: 'ðŸ›¡ï¸' }, { id: 'addStudent', label: 'Tambah Siswa (Global)', icon: 'ðŸ‘¤' }, { id: 'manageClasses', label: 'Kelola Kelas (Global)', icon: 'ðŸ«' }, { id: 'logActivity', label: 'Log Activity', icon: 'ðŸ“œ' } ]; }
  sidebar.innerHTML = menuItems.map(item=>`<button onclick="loadModule('${item.id}')" id="menu-${item.id}" class="w-full text-left px-5 py-3 rounded-xl hover:bg-blue-800 hover:shadow-lg hover:shadow-blue-900/30 transition-all duration-300 flex items-center space-x-3 tracking-wide font-medium" style="text-shadow: 0 1px 2px rgba(0,0,0,0.4);"><span class="text-xl">${item.icon}</span><span>${item.label}</span></button>`).join('');
  setActiveMenu('home');
}
function setActiveMenu(moduleId){ document.querySelectorAll('[id^="menu-"]').forEach(btn=>btn.classList.remove('sidebar-active')); const activeBtn = document.getElementById('menu-'+moduleId); if (activeBtn) activeBtn.classList.add('sidebar-active'); }
function loadModule(moduleId){ currentModule = moduleId; setActiveMenu(moduleId); if (currentUser && (currentUser.role==='Super Admin' || currentUser.role==='Admin')) selectedClass='all'; switch(moduleId){ case 'home': loadHome(); break; case 'artProgress': loadArtProgress(); break; case 'skolastikProgress': loadSkolastikProgress(); break; case 'tkaProgress': loadTkaProgress(); break; case 'educationInfo': loadEducationInfo(); break; case 'materials': loadMaterials(); break; case 'activitySchedule': loadActivitySchedule(); break; case 'schedule': loadSchedule(); break; case 'addStudent': loadAddStudent(); break; case 'manageClasses': loadManageClasses(); break; case 'logActivity': loadLogActivity(); break; case 'manageAdmins': loadManageAdmins(); break; } }

// -----------------------------
// Minimal implementations for modules used in showHome to avoid errors
// (these should be replaced by your full implementations; we keep placeholders)
function loadHome(){
  const content = document.getElementById('contentArea');
  if (!currentUser) { content.innerHTML = '<div class="text-center p-6 text-gray-500">Silakan login terlebih dahulu.</div>'; return; }
  const role = currentUser.role;
  content.innerHTML = `<div class="fade-in ml-6 mr-6"><div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg p-6 mb-6 text-white shadow-lg"><h2 class="text-4xl font-bold mb-2">Selamat Datang, ${currentUser.name || currentUser.username}!</h2><p class="text-blue-100 text-lg">Dashboard</p></div></div>`;
}
function loadArtProgress(){ document.getElementById('contentArea').innerHTML='<div class="p-6">Art Progress (placeholder)</div>'; }
function loadSkolastikProgress(){ document.getElementById('contentArea').innerHTML='<div class="p-6">Skolastik Progress (placeholder)</div>'; }
function loadTkaProgress(){ document.getElementById('contentArea').innerHTML='<div class="p-6">TKA Progress (placeholder)</div>'; }
function loadEducationInfo(){ document.getElementById('contentArea').innerHTML='<div class="p-6">Education Info (placeholder)</div>'; }
function loadMaterials(){ document.getElementById('contentArea').innerHTML='<div class="p-6">Materials (placeholder)</div>'; }
function loadActivitySchedule(){ document.getElementById('contentArea').innerHTML='<div class="p-6">Activity Schedule (placeholder)</div>'; }
function loadSchedule(){ document.getElementById('contentArea').innerHTML='<div class="p-6">Schedule (placeholder)</div>'; }
function loadAddStudent(){ document.getElementById('contentArea').innerHTML='<div class="p-6">Add Student (placeholder)</div>'; }
function loadManageClasses(){ document.getElementById('contentArea').innerHTML='<div class="p-6">Manage Classes (placeholder)</div>'; }
function loadLogActivity(){ const content=document.getElementById('contentArea'); let logs=JSON.parse(localStorage.getItem('loginActivityLogs')||'[]'); content.innerHTML = '<div class="p-6">'+(logs.length? 'Log found':'No logs')+'</div>'; }
function loadManageAdmins(){ document.getElementById('contentArea').innerHTML='<div class="p-6">Manage Admins (placeholder)</div>'; }

// -----------------------------
// Modal helpers
// -----------------------------
function openModal(title, html){ document.getElementById('modalTitle').textContent = title; document.getElementById('modalContent').innerHTML = html; document.getElementById('modal').classList.remove('hidden'); }
function closeModal(){ document.getElementById('modal').classList.add('hidden'); }

</script>
</body>
</html>
