<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal VMI - Admin (Supabase)</title>
  <meta name="description" content="Portal VMI - Dashboard admin (Supabase realtime)" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .max-width-container { max-width: 1200px; margin: 0 auto; }
    .table-scroll { max-height: 420px; overflow:auto; }
    @media (max-width: 768px) {
      .max-width-container { padding-left: 12px; padding-right: 12px; }
    }
    /* small modal input style for login */
    #loginModal .input{ width:100%; padding:.5rem; border:1px solid #e5e7eb; border-radius:.375rem }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-30">
    <div class="max-width-container px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-r from-indigo-600 to-blue-500 rounded-lg flex items-center justify-center text-white font-bold">V</div>
        <div>
          <div class="font-semibold text-lg">Portal VMI</div>
          <div class="text-xs text-gray-500">Admin Dashboard â€” Supabase Realtime</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="backupBtn" class="hidden md:inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg">ðŸ’¾ Backup JSON</button>
        <button id="refreshBtn" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 hidden md:inline">Refresh</button>
        <div id="userBox" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Admin</div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="py-8">
    <div class="max-width-container px-4">

      <!-- Top controls -->
      <section class="bg-white rounded-xl shadow p-4 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h1 class="text-2xl font-bold">Dashboard Admin â€” Full CRUD</h1>
            <div class="text-sm text-gray-500">Pilih tabel di sidebar / menu untuk kelola data. Realtime sync via Supabase.</div>
          </div>

          <div class="flex items-center gap-2 overflow-x-auto">
            <!-- Action buttons per table -->
            <select id="tableSelector" class="px-3 py-2 border rounded">
              <option value="studentsData">Students</option>
              <option value="regionalAdmins">Regional Admins</option>
              <option value="availableClasses">Available Classes</option>
              <option value="educationInfo">Education Info</option>
              <option value="scheduleData">Schedule</option>
              <option value="activityScheduleData">Activity Schedule</option>
              <option value="classMaterials">Class Materials</option>
              <option value="availableSchools">Available Schools</option>
            </select>

            <button id="btnCreate" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700">+ Tambah</button>
            <button id="btnExport" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Export JSON</button>
          </div>
        </div>
      </section>

      <!-- Content area -->
      <section id="contentArea" class="bg-white rounded-xl shadow p-4">
        <!-- Table header -->
        <div id="tableHeader" class="flex items-center justify-between mb-3">
          <div class="text-lg font-semibold" id="tableTitle">Students</div>
          <div>
            <input id="globalSearch" placeholder="Cari..." class="px-3 py-2 border rounded w-64" />
          </div>
        </div>

        <!-- Data table -->
        <div class="table-scroll border rounded">
          <table id="dataTable" class="min-w-full text-sm">
            <thead id="dataThead" class="bg-gray-50 text-left text-xs text-gray-500"></thead>
            <tbody id="dataTbody"></tbody>
          </table>
        </div>
      </section>

      <div class="text-sm text-gray-500 mt-4">Realtime via Supabase â€¢ Responsive untuk desktop & HP</div>
    </div>
  </main>

  <!-- Generic Modal (create/edit) -->
  <div id="modalGeneric" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg w-full max-w-2xl p-5">
      <div class="flex items-center justify-between">
        <h3 id="modalTitle" class="font-semibold text-lg">Form</h3>
        <button id="modalClose" class="text-gray-500">âœ•</button>
      </div>
      <div id="modalBody" class="mt-3 space-y-3"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modalCancel" class="px-3 py-2 rounded border">Batal</button>
        <button id="modalSave" class="px-3 py-2 rounded bg-blue-600 text-white">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Login Modal (dummy local auth) -->
  <div id="loginModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg w-full max-w-sm p-5">
      <h3 class="font-semibold text-lg mb-3">Login Portal VMI</h3>
      <div class="space-y-2">
        <input id="loginUsername" class="input" placeholder="username" />
        <input id="loginPassword" type="password" class="input" placeholder="password" />
        <div id="loginError" class="text-sm text-red-500 hidden"></div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="loginCancel" class="px-3 py-2 rounded border">Batal</button>
        <button id="loginSubmit" class="px-3 py-2 rounded bg-indigo-600 text-white">Masuk</button>
      </div>
    </div>
  </div>

<script>
/* ===== Supabase config (user-provided) ===== */
const SUPABASE_URL = "https://dufvyblfljkpokkgfymy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1ZnZ5YmxmbGprcG9ra2dmeW15Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3Nzk0NjIsImV4cCI6MjA3ODM1NTQ2Mn0.W5lC8MnxTeZcpJjGnGFR0QrdVn6JdYqSlJ_qWAKJ4PA";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* =========================================== */

/* Tables */
const TABLES = [
  'studentsData','regionalAdmins','availableClasses','educationInfo',
  'scheduleData','activityScheduleData','classMaterials','availableSchools'
];

/* Local caches */
const cache = {
  studentsData: [],
  regionalAdmins: [],
  availableClasses: [],
  educationInfo: [],
  scheduleData: [],
  activityScheduleData: [],
  classMaterials: [],
  availableSchools: []
};

/* UI refs */
const tableSelector = document.getElementById('tableSelector');
const tableTitle = document.getElementById('tableTitle');
const dataThead = document.getElementById('dataThead');
const dataTbody = document.getElementById('dataTbody');
const globalSearch = document.getElementById('globalSearch');
const btnCreate = document.getElementById('btnCreate');
const btnExport = document.getElementById('btnExport');
const backupBtn = document.getElementById('backupBtn');
const refreshBtn = document.getElementById('refreshBtn');
const modalGeneric = document.getElementById('modalGeneric');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalClose = document.getElementById('modalClose');
const modalCancel = document.getElementById('modalCancel');
const modalSave = document.getElementById('modalSave');

let currentTable = tableSelector.value;
let currentSchema = {}; // holds fields metadata per table
let currentEditId = null;

/* Helpers */
function esc(s){ return String(s||'').replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c])); }
function createEl(tag, attrs={}, inner=''){ const el=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>el.setAttribute(k,v)); el.innerHTML=inner; return el; }

/* Define simple field schemas for our tables (used for forms & rendering) */
const SCHEMAS = {
  studentsData: [
    {key:'id', label:'ID', type:'number', readonly:true},
    {key:'name', label:'Name', type:'text'},
    {key:'class', label:'Class', type:'text'},
    {key:'regional', label:'Regional', type:'text'}
  ],
  regionalAdmins: [
    {key:'id', label:'ID', type:'number', readonly:true},
    {key:'username', label:'Username', type:'text'},
    {key:'region', label:'Region', type:'text'},
    {key:'role', label:'Role', type:'text'}
  ],
  availableClasses: [
    {key:'id', label:'ID', type:'number', readonly:true},
    {key:'name', label:'Name', type:'text'},
    {key:'description', label:'Description', type:'text'}
  ],
  educationInfo: [
    {key:'id', label:'ID', type:'number', readonly:true},
    {key:'title', label:'Title', type:'text'},
    {key:'content', label:'Content', type:'textarea'}
  ],
  scheduleData: [
    {key:'id', label:'ID', type:'number', readonly:true},
    {key:'day', label:'Day', type:'text'},
    {key:'time', label:'Time', type:'text'},
    {key:'class', label:'Class', type:'text'}
  ],
  activityScheduleData: [
    {key:'id', label:'ID', type:'number', readonly:true},
    {key:'activity', label:'Activity', type:'text'},
    {key:'date', label:'Date', type:'text'}
  ],
  classMaterials: [
    {key:'id', label:'ID', type:'number', readonly:true},
    {key:'title', label:'Title', type:'text'},
    {key:'url', label:'URL', type:'text'},
    {key:'class', label:'Class', type:'text'}
  ],
  availableSchools: [
    {key:'id', label:'ID', type:'number', readonly:true},
    {key:'name', label:'Name', type:'text'},
    {key:'region', label:'Region', type:'text'}
  ]
};

/* Init: set schema for current table */
function setCurrentSchema(table){
  currentTable = table;
  currentSchema = SCHEMAS[table] || [];
  tableTitle.textContent = prettyTableName(table);
  renderTableHeader();
}

/* Pretty name */
function prettyTableName(t){
  const map = {
    studentsData:'Students',
    regionalAdmins:'Regional Admins',
    availableClasses:'Available Classes',
    educationInfo:'Education Info',
    scheduleData:'Schedule',
    activityScheduleData:'Activity Schedule',
    classMaterials:'Class Materials',
    availableSchools:'Available Schools'
  };
  return map[t] || t;
}

/* Render table header based on schema */
function renderTableHeader(){
  dataThead.innerHTML = '';
  const tr = document.createElement('tr');
  currentSchema.forEach(f => {
    const th = createEl('th', {class:'p-2 text-xs text-gray-600'}, esc(f.label));
    tr.appendChild(th);
  });
  // actions
  tr.appendChild(createEl('th', {class:'p-2 text-xs text-gray-600'}, 'Aksi'));
  dataThead.appendChild(tr);
}

/* Render table body for currentTable */
function renderTableBody(filter=''){
  const list = (cache[currentTable] || []).slice();
  const q = (filter||'').trim().toLowerCase();
  dataTbody.innerHTML = '';
  list.forEach(item=>{
    // filter search
    if(q){
      const combined = currentSchema.map(f=>String(item[f.key]||'')).join(' ').toLowerCase();
      if(!combined.includes(q)) return;
    }
    const tr = document.createElement('tr');
    currentSchema.forEach(f=>{
      tr.appendChild(createEl('td',{class:'p-2 align-top'}, esc(item[f.key])));
    });
    const actionsTd = document.createElement('td'); actionsTd.className='p-2 align-top';
    actionsTd.innerHTML = `
      <button class="text-sm px-2 py-1 bg-yellow-400 rounded mr-1" onclick="openEdit('${currentTable}', ${item.id})">Edit</button>
      <button class="text-sm px-2 py-1 bg-red-500 text-white rounded" onclick="deleteRecord('${currentTable}', ${item.id})">Hapus</button>
    `;
    tr.appendChild(actionsTd);
    dataTbody.appendChild(tr);
  });
}

/* Load data for a table */
async function loadTable(table){
  try{
    const { data, error } = await supabase.from(table).select('*').order('id', { ascending: true });
    if(error){ console.error('loadTable',table,error); return; }
    cache[table] = data || [];
    if(table === currentTable) renderTableBody(globalSearch.value);
  }catch(e){ console.error(e); }
}

/* Load all tables in parallel */
async function loadAll(){
  const promises = TABLES.map(t=>loadTable(t));
  await Promise.all(promises);
}

/* Open create modal (empty) or edit modal (prefill) */
function openCreate(){
  openModal(null);
}
function openEdit(table, id){
  const rec = (cache[table]||[]).find(x=>Number(x.id)===Number(id));
  openModal(rec);
}

/* Build modal body inputs from schema */
function openModal(record){
  modalBody.innerHTML = '';
  currentEditId = record ? record.id : null;
  modalTitle.textContent = (record ? 'Edit' : 'Tambah') + ' â€” ' + prettyTableName(currentTable);

  currentSchema.forEach(field=>{
    // skip id input for create
    if(field.key === 'id' && !record){
      const hidden = createEl('input',{type:'hidden', id:'fld_id'});
      modalBody.appendChild(hidden);
      return;
    }
    const label = createEl('label', {class:'block text-sm font-medium'}, esc(field.label));
    let input;
    if(field.type === 'textarea'){
      input = document.createElement('textarea');
      input.className = 'w-full border px-3 py-2 rounded';
    } else {
      input = document.createElement('input');
      input.type = field.type || 'text';
      input.className = 'w-full border px-3 py-2 rounded';
    }
    input.id = 'fld_' + field.key;
    if(field.readonly) input.readOnly = true;
    input.value = record ? (record[field.key] ?? '') : '';
    modalBody.appendChild(label);
    modalBody.appendChild(input);
  });

  modalGeneric.classList.remove('hidden');
  modalGeneric.classList.add('flex');
}

/* Close modal */
function closeModal(){
  modalGeneric.classList.add('hidden');
  modalGeneric.classList.remove('flex');
}

/* Collect form payload */
function collectPayload(){
  const payload = {};
  currentSchema.forEach(f=>{
    if(f.key === 'id') return; // id handled separately
    const el = document.getElementById('fld_' + f.key);
    if(el) payload[f.key] = (el.value || '').trim();
  });
  return payload;
}

/* Save (create or update) record */
async function saveRecord(){
  const payload = collectPayload();
  try{
    if(currentEditId){
      const { error } = await supabase.from(currentTable).update(payload).eq('id', currentEditId);
      if(error) throw error;
    } else {
      const { error } = await supabase.from(currentTable).insert([payload]);
      if(error) throw error;
    }
    closeModal();
    // realtime listener will refresh
  }catch(e){
    console.error(e);
    alert('Error saat menyimpan: ' + (e.message||JSON.stringify(e)));
  }
}

/* Delete record */
async function deleteRecord(table, id){
  if(!confirm('Hapus data ini?')) return;
  try{
    const { error } = await supabase.from(table).delete().eq('id', id);
    if(error) throw error;
  }catch(e){
    console.error(e);
    alert('Error saat hapus: ' + (e.message||JSON.stringify(e)));
  }
}

/* Realtime subscriptions for all tables */
function setupRealtimeAll(){
  TABLES.forEach(table=>{
    supabase.channel('realtime:' + table)
      .on('postgres_changes', { event: '*', schema: 'public', table }, payload=>{
        loadTable(table);
      })
      .subscribe();
  });
}

/* Export all cache to JSON (backup) */
function exportAllToJSON(){
  const allData = {};
  TABLES.forEach(t=> allData[t] = cache[t] || []);
  const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'portal_vmi_backup_full.json';
  a.click();
}

/* Init UI & events */
document.addEventListener('DOMContentLoaded', async ()=>{
  document.getElementById('backupBtn').classList.remove('hidden');

  setCurrentSchema(currentTable);
  await loadAll();
  setupRealtimeAll();

  renderTableBody();

  tableSelector.addEventListener('change', (e)=>{
    setCurrentSchema(e.target.value);
    renderTableBody(globalSearch.value);
  });

  globalSearch.addEventListener('input', (e)=>{
    renderTableBody(e.target.value);
  });

  btnCreate.addEventListener('click', openCreate);
  btnExport.addEventListener('click', exportAllToJSON);
  backupBtn.addEventListener('click', exportAllToJSON);
  refreshBtn.addEventListener('click', ()=> loadTable(currentTable));

  modalClose.addEventListener('click', closeModal);
  modalCancel.addEventListener('click', closeModal);
  modalSave.addEventListener('click', saveRecord);

  renderTableBody();
});

/* Expose some helpers for debugging in console */
window.loadTable = loadTable;
window.loadAll = loadAll;
window.openEdit = openEdit;

/* ================= DUMMY LOGIN (local auth) ================= */
const USERS = [
  { username: 'superadmin', password: 'admin123', role: 'Super Admin', regional: 'Pusat', name: 'Super Admin' },
  { username: 'admin_jkt', password: 'jkt123', role: 'Admin', regional: 'Jakarta', name: 'Admin JKT' },
  { username: 'admin_bdg', password: 'bdg123', role: 'Admin', regional: 'Bandung', name: 'Admin BDG' },
  { username: 'siswa1', password: 'siswa123', role: 'Siswa', regional: 'Jakarta', name: 'Siswa Contoh' }
];

const loginModal = document.getElementById('loginModal');
const loginUsername = document.getElementById('loginUsername');
const loginPassword = document.getElementById('loginPassword');
const loginError = document.getElementById('loginError');
const loginSubmit = document.getElementById('loginSubmit');
const loginCancel = document.getElementById('loginCancel');
const userBox = document.getElementById('userBox');

function getCurrentUser(){
  try { return JSON.parse(localStorage.getItem('portal_vmi_user')); } catch(e){ return null; }
}
function setCurrentUser(u){
  if(u) localStorage.setItem('portal_vmi_user', JSON.stringify(u));
  else localStorage.removeItem('portal_vmi_user');
  renderAuthUI();
}
function openLoginModal(){ loginError.classList.add('hidden'); loginUsername.value=''; loginPassword.value=''; loginModal.classList.remove('hidden'); loginModal.classList.add('flex'); loginUsername.focus(); }
function closeLoginModal(){ loginModal.classList.add('hidden'); loginModal.classList.remove('flex'); }
function tryLogin(){
  const u = (loginUsername.value||'').trim();
  const p = (loginPassword.value||'').trim();
  const user = USERS.find(x => x.username === u && x.password === p);
  if(!user){
    loginError.textContent = 'Username/password salah';
    loginError.classList.remove('hidden');
    return;
  }
  const session = { username: user.username, role: user.role, regional: user.regional, name: user.name };
  setCurrentUser(session);
  closeLoginModal();
}
function logout(){
  if(confirm('Logout sekarang?')) setCurrentUser(null);
}
function renderAuthUI(){
  const cur = getCurrentUser();
  if(cur){
    userBox.innerHTML = `${cur.name} â€¢ ${cur.role} â€¢ <a href="#" onclick="logout()" class="text-red-500">Logout</a>`;
    enableRoleActions(cur);
  } else {
    userBox.innerHTML = `<button id="openLoginBtn" class="text-sm text-blue-600">Login</button>`;
    enableRoleActions(null);
    const btn = document.getElementById('openLoginBtn');
    if(btn) btn.addEventListener('click', openLoginModal);
  }
}
function enableRoleActions(user){
  const createBtn = document.getElementById('btnCreate');
  if(createBtn){
    if(!user) createBtn.style.display = 'none';
    else if(['Admin','Super Admin'].includes(user.role)) createBtn.style.display = '';
    else createBtn.style.display = 'none';
  }
  const backupBtnEl = document.getElementById('backupBtn');
  if(backupBtnEl){
    if(user && user.role === 'Super Admin') backupBtnEl.style.display = '';
    else backupBtnEl.style.display = 'none';
  }
}
document.addEventListener('DOMContentLoaded', ()=>{
  renderAuthUI();
  loginSubmit?.addEventListener('click', tryLogin);
  loginCancel?.addEventListener('click', ()=>{ closeLoginModal(); });
  [loginUsername, loginPassword].forEach(el=>{
    el?.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') tryLogin(); });
  });
  window.portalLogout = logout;
});
</script>

</body>
</html>
