
<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sistem Informasi Laporan Kemajuan Siswa - Bimbel Gambar Villa Merah</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* minimal styles kept from original */
body { box-sizing: border-box; }
.sidebar-active { background-color: #1e40af; color: white; }
.fade-in { animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
.modal-backdrop { background-color: rgba(0,0,0,0.5); }
</style>

<!-- Supabase init -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  const supabaseUrl = 'https://uwigghirpvlnzqhruglq.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3aWdnaGlycHZsbnpxaHJ1Z2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTE3NTksImV4cCI6MjA3ODYyNzc1OX0.P--M4TysIdMfwvM1KTd9fAkqyt2hg5WWdmKNuE67psk'
  window.supabase = createClient(supabaseUrl, supabaseKey)
</script>
</head>
<body class="bg-white">
<!-- LOGIN PAGE -->
<div id="loginPage" class="min-h-screen flex items-center justify-center p-6">
  <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
    <div class="text-center mb-4">
      <img src="https://www.villamerah.com/assets/images/logo/logo-2.png" alt="logo" class="mx-auto w-36"/>
      <h2 class="text-2xl font-bold text-red-600">Bimbel Gambar Villa Merah</h2>
      <p class="text-sm text-blue-600">Laporan Kemajuan Siswa</p>
    </div>
    <form id="loginForm" class="space-y-4">
      <div>
        <label for="username" class="block text-sm font-medium">Username</label>
        <input id="username" name="username" required class="w-full px-3 py-2 border rounded-lg"/>
      </div>
      <div>
        <label for="password" class="block text-sm font-medium">Password</label>
        <input id="password" name="password" type="password" required class="w-full px-3 py-2 border rounded-lg"/>
      </div>
      <div>
        <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-lg">Masuk</button>
      </div>
    </form>
    <div id="loginMsg" class="mt-3 text-center text-sm text-red-600"></div>
  </div>
</div>

<!-- DASHBOARD (hidden until login) -->
<div id="dashboardPage" class="hidden min-h-screen">
  <header class="bg-white border-b py-4 px-6 fixed w-full z-10">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <img src="https://bimbelgambar.id/wp-content/uploads/2023/06/favicon-20200601113259.png" class="w-10 h-10"/>
        <div>
          <h1 class="text-xl font-bold text-red-600">Bimbel Gambar Villa Merah</h1>
          <p id="bimbelSubHeader" class="text-sm text-blue-600">Laporan Kemajuan Siswa</p>
        </div>
      </div>
      <div>
        <span id="userLabel" class="mr-4 text-sm"></span>
        <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg">Keluar</button>
      </div>
    </div>
  </header>

  <div class="flex pt-20">
    <aside class="w-64 fixed left-0 min-h-full bg-gradient-to-b from-blue-700 to-blue-900 p-4 text-white" id="sidebarMenu"></aside>
    <main class="ml-64 flex-1 p-8" id="contentArea"></main>
  </div>
</div>

<script>
/*
  Core JS: load/save data from Supabase and minimal UI rendering.
  This is an integrated version: uses Supabase for all persistent data.
*/

let currentUser = null;
let studentsData = [];
let usersData = [];
let scheduleData = [];
let activityScheduleData = [];
let materialsData = [];
let educationInfo = [];

async function loadAllData() {
  // Load users (admin + superadmin)
  const { data: users, error: userErr } = await supabase.from('users').select('*')
  if (userErr) console.error('users load error', userErr)
  usersData = users || []

  const { data: students, error: stuErr } = await supabase.from('students').select('*')
  if (stuErr) console.error('students load error', stuErr)
  studentsData = students || []

  const { data: schedule, error: schErr } = await supabase.from('schedule').select('*')
  if (schErr) console.error('schedule load error', schErr)
  scheduleData = schedule || []

  const { data: activity, error: actErr } = await supabase.from('activity_schedule').select('*')
  if (actErr) console.error('activity load error', actErr)
  activityScheduleData = activity || []

  const { data: mats, error: matErr } = await supabase.from('materials').select('*')
  if (matErr) console.error('materials load error', matErr)
  materialsData = mats || []

  const { data: edu, error: eduErr } = await supabase.from('education_info').select('*')
  if (eduErr) console.error('education_info load error', eduErr)
  educationInfo = edu || []
}

function getAllUsersMap() {
  const map = {}
  if (usersData) usersData.forEach(u => map[u.username] = u)
  if (studentsData) studentsData.forEach(s => map[s.username] = {...s, role: 'Siswa'})
  return map
}

document.getElementById('loginForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();

  await loadAllData();
  const all = getAllUsersMap();
  if (all[u] && all[u].password === p) {
    // successful login
    currentUser = {...all[u], username: u};
    // if student record may not have role property; set for uniformity
    if (!currentUser.role) currentUser.role = all[u].role || (studentsData.find(s=>s.username===u)?'Siswa':'User');
    // write login activity
    try {
      await supabase.from('login_activity').insert([{ name: currentUser.name || currentUser.username, role: currentUser.role, region: currentUser.region || currentUser.region, time: new Date().toISOString() }])
    } catch (err) { console.error('log insert err', err) }

    showDashboard();
  } else {
    document.getElementById('loginMsg').textContent = 'Username atau password salah!'
  }
});

function logout(){
  currentUser = null;
  document.getElementById('dashboardPage').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('loginForm').reset();
}

/* Sidebar and module loading */
function loadSidebar(){
  const menuItems = [
    { id: 'home', label: 'Home', icon: 'ðŸ ' },
    { id: 'artProgress', label: 'Kemajuan Gambar', icon: 'ðŸŽ¨' },
    { id: 'skolastikProgress', label: 'Kemajuan Tes Skolastik', icon: 'ðŸ“Š' },
    { id: 'tkaProgress', label: 'Kemajuan TKA', icon: 'ðŸ“ˆ' },
    { id: 'schedule', label: 'Jadwal Belajar', icon: 'ðŸ“…' },
    { id: 'activitySchedule', label: 'Jadwal Kegiatan', icon: 'ðŸ“†' },
    { id: 'materials', label: 'Materi Kelas', icon: 'ðŸ“š' },
    { id: 'educationInfo', label: 'Informasi Pendidikan', icon: 'ðŸ“°' }
  ];
  if (currentUser.role === 'Admin' || currentUser.role === 'Super Admin') {
    menuItems.push({ id: 'addStudent', label: 'Tambah Siswa', icon: 'ðŸ‘¤' });
    if (currentUser.role === 'Super Admin') {
      menuItems.push({ id: 'manageAdmins', label: 'Kelola Admin Regional', icon: 'ðŸ›¡ï¸' });
      menuItems.push({ id: 'logActivity', label: 'Log Activity', icon: 'ðŸ“œ' });
    }
  }

  const sidebar = document.getElementById('sidebarMenu');
  sidebar.innerHTML = menuItems.map(it => `<button onclick="loadModule('${it.id}')" id="menu-${it.id}" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-800 mb-2">${it.icon} ${it.label}</button>`).join('');
}

function showDashboard(){
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('dashboardPage').classList.remove('hidden');
  document.getElementById('userLabel').textContent = currentUser.name + ' â€” ' + (currentUser.region || currentUser.role || '');
  loadSidebar();
  loadHome();
}

function loadModule(id){
  switch(id) {
    case 'home': loadHome(); break;
    case 'schedule': renderSchedule(); break;
    case 'activitySchedule': renderActivitySchedule(); break;
    case 'materials': renderMaterials(); break;
    case 'educationInfo': renderEducationInfo(); break;
    case 'addStudent': renderAddStudent(); break;
    case 'logActivity': renderLogActivity(); break;
    default: document.getElementById('contentArea').innerHTML = '<div>Module '+id+' belum diimplementasi penuh.</div>';
  }
}

/* Home view */
async function loadHome(){
  // ensure latest data
  await loadAllData();
  const content = document.getElementById('contentArea');

  if (currentUser.role === 'Super Admin') {
    const totalStudents = studentsData.length;
    const seniRupaCount = studentsData.filter(s=>/sr|minat seni/i.test(s.class||'')).length;
    const arsitekturCount = studentsData.filter(s=>/arsitektur|minat arsitektur/i.test(s.class||'')).length;

    content.innerHTML = `
      <div class="p-6">
        <div class="bg-blue-600 text-white p-6 rounded-lg mb-6">
          <h2 class="text-2xl font-bold">Selamat Datang, ${currentUser.name}!</h2>
          <p>Dashboard Kontrol Pusat - Semua Regional</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="p-4 bg-white rounded shadow text-center">
            <h4>Total Siswa</h4><p class="text-3xl font-bold">${totalStudents}</p>
          </div>
          <div class="p-4 bg-white rounded shadow text-center">
            <h4>Siswa Seni Rupa</h4><p class="text-3xl font-bold">${seniRupaCount}</p>
          </div>
          <div class="p-4 bg-white rounded shadow text-center">
            <h4>Siswa Arsitektur</h4><p class="text-3xl font-bold">${arsitekturCount}</p>
          </div>
        </div>

        <div class="mt-6 bg-white p-4 rounded shadow">
          <h3 class="font-bold mb-2">Data Kelas Aktif</h3>
          <div id="classesTable"></div>
        </div>
      </div>
    `;
    renderClassesTable('all');
  } else if (currentUser.role === 'Admin') {
    const adminStudents = studentsData.filter(s => s.region === currentUser.region);
    const totalStudents = adminStudents.length;
    const topSchool = (() => { const m={}; adminStudents.forEach(s=>{ if(s.school) m[s.school]=(m[s.school]||0)+1 }); return Object.entries(m).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-' })();
    content.innerHTML = `
      <div class="p-6">
        <div class="bg-blue-600 text-white p-6 rounded-lg mb-6">
          <h2 class="text-2xl font-bold">Selamat Datang, ${currentUser.name}!</h2>
          <p>Informasi Laporan Kemajuan Siswa - ${currentUser.region}</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="p-4 bg-white rounded shadow text-center">
            <h4>Total Siswa</h4><p class="text-3xl font-bold">${totalStudents}</p>
          </div>
          <div class="p-4 bg-white rounded shadow text-center">
            <h4>Sekolah Terbanyak</h4><p class="text-lg">${topSchool}</p>
          </div>
        </div>
      </div>
    `;
  } else {
    // student view
    const s = studentsData.find(st => st.username === currentUser.username);
    if (!s) { content.innerHTML = '<div class="p-6">Data siswa tidak ditemukan.</div>'; return; }
    const artworks = await supabase.from('artworks').select('*').eq('student_id', s.id);
    const totalArt = artworks.data ? artworks.data.length : 0;
    content.innerHTML = `
      <div class="p-6">
        <div class="bg-blue-600 text-white p-6 rounded-lg mb-6">
          <h2 class="text-2xl font-bold">Selamat Datang, ${s.name}!</h2>
          <p>Pantau terus perkembangan belajar Anda</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 bg-white rounded shadow text-center"><h4>Total Karya</h4><p class="text-3xl font-bold">${totalArt}</p></div>
          <div class="p-4 bg-white rounded shadow text-center"><h4>Kelas Saat Ini</h4><p class="text-3xl font-bold">${s.class}</p></div>
        </div>
      </div>
    `;
  }
}

function renderClassesTable(regionFilter) {
  const container = document.getElementById('classesTable');
  const byClass = {};
  (regionFilter === 'all' ? studentsData : studentsData.filter(s=>s.region===regionFilter)).forEach(s=>{
    const k = (s.class||'Unassigned').toUpperCase();
    byClass[k] = (byClass[k]||0)+1;
  });
  const rows = Object.keys(byClass).map((k,i)=>`<div class="p-2 border-b flex justify-between"><div>${i+1}. ${k}</div><div>${byClass[k]}</div></div>`).join('');
  container.innerHTML = rows || '<div>Tidak ada kelas aktif.</div>';
}

/* Render schedule */
function renderSchedule(){
  const c = document.getElementById('contentArea');
  const rows = scheduleData.map(s=>`<tr><td>${s.date}</td><td>${s.day}</td><td>${s.subject}</td><td>${(s.classes||[]).join(',')}</td></tr>`).join('');
  c.innerHTML = `<div class="p-6"><h3 class="font-bold mb-4">Jadwal Belajar</h3><table class="w-full table-auto border">${rows}</table></div>`;
}

/* Activity schedule */
function renderActivitySchedule(){
  const c = document.getElementById('contentArea');
  const rows = activityScheduleData.map(a=>`<div class="p-3 border-b"><strong>${a.name}</strong> â€” ${a.date}<div>${a.goal}</div></div>`).join('');
  c.innerHTML = `<div class="p-6"><h3 class="font-bold mb-4">Jadwal Kegiatan</h3>${rows}</div>`;
}

/* Materials */
function renderMaterials(){
  const c = document.getElementById('contentArea');
  const rows = materialsData.map(m=>`<div class="p-3 border-b"><strong>${m.topic}</strong><div>${m.description}</div></div>`).join('');
  c.innerHTML = `<div class="p-6"><h3 class="font-bold mb-4">Materi Kelas</h3>${rows}</div>`;
}

/* Education info */
function renderEducationInfo(){
  const c = document.getElementById('contentArea');
  const rows = educationInfo.map(e=>`<div class="p-3 border-b"><strong>${e.title}</strong><div>${e.content}</div></div>`).join('');
  c.innerHTML = `<div class="p-6"><h3 class="font-bold mb-4">Informasi Pendidikan</h3>${rows}</div>`;
}

/* Add student (Admin / Super Admin) */
function renderAddStudent(){
  if (!(currentUser.role==='Admin' || currentUser.role==='Super Admin')) {
    document.getElementById('contentArea').innerHTML = '<div class="p-6 text-red-600">Akses ditolak.</div>'; return;
  }
  document.getElementById('contentArea').innerHTML = `
    <div class="p-6">
      <h3 class="font-bold mb-4">Tambah Siswa</h3>
      <form id="addStudentForm" class="space-y-3">
        <input id="new_name" placeholder="Nama" class="w-full px-3 py-2 border rounded"/>
        <input id="new_username" placeholder="Username" class="w-full px-3 py-2 border rounded"/>
        <input id="new_password" placeholder="Password" class="w-full px-3 py-2 border rounded"/>
        <input id="new_class" placeholder="Kelas" class="w-full px-3 py-2 border rounded"/>
        <input id="new_region" placeholder="Region" value="${currentUser.region || ''}" class="w-full px-3 py-2 border rounded"/>
        <input id="new_school" placeholder="Sekolah" class="w-full px-3 py-2 border rounded"/>
        <button class="px-4 py-2 bg-blue-600 text-white rounded" type="submit">Simpan</button>
      </form>
      <div id="addStudentMsg" class="mt-2 text-sm"></div>
    </div>
  `;
  document.getElementById('addStudentForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const payload = {
      name: document.getElementById('new_name').value.trim(),
      username: document.getElementById('new_username').value.trim(),
      password: document.getElementById('new_password').value.trim() || 'siswa123',
      class: document.getElementById('new_class').value.trim(),
      region: document.getElementById('new_region').value.trim(),
      school: document.getElementById('new_school').value.trim()
    };
    // upsert student
    const { data, error } = await supabase.from('students').upsert(payload).select();
    if (error) {
      document.getElementById('addStudentMsg').textContent = 'Gagal menyimpan: '+error.message;
      console.error(error);
    } else {
      document.getElementById('addStudentMsg').textContent = 'Siswa berhasil disimpan.';
      await loadAllData(); loadHome();
    }
  });
}

/* Log activity (Super Admin) */
async function renderLogActivity(){
  if (currentUser.role !== 'Super Admin') { document.getElementById('contentArea').innerHTML = '<div class="p-6 text-red-600">Akses ditolak.</div>'; return; }
  const { data: logs } = await supabase.from('login_activity').select('*').order('time', {ascending:false}).limit(200);
  const html = logs.map((l,i)=>`<div class="p-2 border-b">${i+1}. ${l.name} â€” ${l.role} â€” ${l.region} â€” ${new Date(l.time).toLocaleString()}</div>`).join('');
  document.getElementById('contentArea').innerHTML = '<div class="p-6"><h3 class="font-bold mb-4">Log Aktivitas</h3>'+html+'</div>';
}

/* On initial load, try to maintain session via localStorage (optional) */
window.addEventListener('DOMContentLoaded', async ()=>{
  // try to restore session from localStorage if exists (keeps UI flow)
  const sess = localStorage.getItem('vm_currentUser');
  if (sess) {
    try {
      const parsed = JSON.parse(sess);
      // verify existence
      await loadAllData();
      const all = getAllUsersMap();
      if (all[parsed.username]) {
        currentUser = {...all[parsed.username], username: parsed.username};
        showDashboard();
        return;
      }
    } catch(e){}
  }
  // otherwise show login page
});

/* Save session on login */
function persistSession(){
  if (currentUser) localStorage.setItem('vm_currentUser', JSON.stringify({ username: currentUser.username }));
}

/* Hook showDashboard to persist session */
const originalShowDashboard = showDashboard;
showDashboard = function() { originalShowDashboard(); persistSession(); }

</script>
</body>
</html>
