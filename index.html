<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sistem Informasi Laporan Kemajuan Siswa - Bimbel Gambar Villa Merah (Supabase)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  /* (kept original styles - truncated here for brevity in editor view) */
  body { box-sizing: border-box; }
  * { box-sizing: border-box; }
  .sidebar-active { background-color: #1e40af; color: white; }
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .modal-backdrop { background-color: rgba(0,0,0,0.5); }
  .editable-image { cursor: pointer; transition: transform 0.2s; }
  .editable-image:hover { transform: scale(1.05); }
  table { border-collapse: collapse; }
  th, td { border: 1px solid #e5e7eb; }
  .notification { position: fixed; top:20px; right:20px; z-index:1000; padding:12px 24px; border-radius:8px; color:white; font-weight:500; }
  .success { background-color:#10b981; }
  .error { background-color:#ef4444; }
</style>
</head>
<body class="bg-white">
<!-- (kept original HTML UI -- login page, dashboard, sidebar, modals) -->
<div id="loginPage" class="min-h-screen flex items-center justify-center py-15 px-4 relative">
  <div class="max-w-md  w-full space-y-8 bg-white/90 p-8 rounded-2xl shadow-2xl backdrop-blur-md">
    <div class="text-center">
      <img alt="Logo" class="w-24 h-24 mx-auto mb-4" src="https://www.villamerah.com/assets/images/logo/logo-2.png" />
      <h2 class="text-2xl font-bold text-gray-900" style="color:red">Bimbel Gambar Villa Merah</h2>
      <p class="text-blue-600">Laporan Kemajuan Siswa</p>
    </div>
    <form id="loginForm" class="space-y-4">
      <div>
        <label for="username">Username</label>
        <input id="username" name="username" required class="w-full px-3 py-2 border rounded-lg" />
      </div>
      <div>
        <label for="password">Password</label>
        <input id="password" name="password" type="password" required class="w-full px-3 py-2 border rounded-lg" />
      </div>
      <div>
        <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-lg">Masuk</button>
      </div>
    </form>
  </div>
</div>

<div id="dashboardPage" class="hidden">
  <header class="bg-white border-b p-4 fixed w-full z-10">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-bold text-red-600">Bimbel Gambar Villa Merah</h1>
      </div>
      <div>
        <span id="currentUserDisplay"></span>
        <button onclick="logout()" class="ml-4 px-3 py-1 bg-red-600 text-white rounded">Keluar</button>
      </div>
    </div>
  </header>
  <div class="pt-20 flex">
    <aside class="w-64 fixed left-0 min-h-full bg-gradient-to-b from-blue-700 to-blue-900 p-4 text-white">
      <nav id="sidebarMenu"></nav>
    </aside>
    <main class="ml-64 flex-1 p-8 w-full">
      <div id="contentArea" class="fade-in"></div>
    </main>
  </div>
</div>

<!-- Modal placeholder -->
<div id="modal" class="hidden fixed inset-0 z-50"></div>

<script>
/* ---------------------------
   Supabase configuration
   --------------------------- */
const SUPABASE_URL = "https://oparathwgisnxwxxswza.supabase.co"; // <- project URL (public)
const SUPABASE_KEY = "YOUR_SUPABASE_KEY_HERE"; // <- Ganti sendiri di file hasil patch sebelum upload
const supabase = supabaseJs.createClient ? supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY) : supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Application state
let currentUser = null;
let currentModule = 'home';
let studentsData = [];
let regionalAdmins = []; // admins table
let availableClasses = [];
let educationInfo = [];
let scheduleData = [];
let activityScheduleData = [];

/* ---------------------------
   Utilities: notifications
   --------------------------- */
function showNotification(message, type = 'success') {
  const n = document.createElement('div');
  n.className = `notification ${type === 'error' ? 'error' : 'success'}`;
  n.textContent = message;
  document.body.appendChild(n);
  setTimeout(() => n.remove(), 3500);
}

/* ---------------------------
   LocalStorage fallback helpers
   --------------------------- */
function persistToLocal(name, data) {
  try { localStorage.setItem(name, JSON.stringify(data)); } catch(e){}
}
function loadFromLocal(name, defaultValue) {
  try { const v = localStorage.getItem(name); return v ? JSON.parse(v) : defaultValue; } catch(e) { return defaultValue; }
}

/* ---------------------------
   Load all data from Supabase (or fallback to localStorage)
   --------------------------- */
async function loadAllData() {
  try {
    // students
    const s = await supabase.from('students').select('*');
    if (s.error) throw s.error;
    studentsData = s.data || [];

    // admins
    const a = await supabase.from('admins').select('*');
    if (a.error) throw a.error;
    regionalAdmins = a.data || [];

    // schedule
    const sch = await supabase.from('schedule').select('*');
    if (sch.error) throw sch.error;
    scheduleData = sch.data || [];

    // activities
    const act = await supabase.from('activities').select('*');
    if (act.error) throw act.error;
    activityScheduleData = act.data || [];

    // class materials + education info (optional tables)
    const mat = await supabase.from('class_materials').select('*');
    availableClasses = mat.data || [];
    const edu = await supabase.from('education_info').select('*');
    educationInfo = edu.data || [];

    // persist a local copy for offline fallback
    persistToLocal('studentsData', studentsData);
    persistToLocal('regionalAdmins', regionalAdmins);
    persistToLocal('scheduleData', scheduleData);
    persistToLocal('activityScheduleData', activityScheduleData);

    console.log('Loaded data from Supabase');
  } catch (err) {
    console.warn('Supabase load failed, falling back to localStorage', err);
    // fallback to local
    studentsData = loadFromLocal('studentsData', []);
    regionalAdmins = loadFromLocal('regionalAdmins', []);
    scheduleData = loadFromLocal('scheduleData', []);
    activityScheduleData = loadFromLocal('activityScheduleData', []);
    availableClasses = loadFromLocal('availableClasses', []);
    educationInfo = loadFromLocal('educationInfo', []);
    showNotification('Tidak bisa terhubung ke Supabase â€” menggunakan data lokal.', 'error');
  }
}

/* ---------------------------
   Save all data to Supabase (auto-sync)
   This function upserts whole arrays to tables if possible.
   --------------------------- */
let saveInProgress = false;
async function saveAllData() {
  if (saveInProgress) return;
  saveInProgress = true;
  try {
    // Upsert students (assumes 'id' primary key exists)
    if (studentsData && studentsData.length) {
      const { error } = await supabase.from('students').upsert(studentsData, { onConflict: 'id' });
      if (error) throw error;
    }

    // Upsert admins (use username as unique key if configured)
    if (regionalAdmins && regionalAdmins.length) {
      const { error } = await supabase.from('admins').upsert(regionalAdmins, { onConflict: 'username' });
      if (error) throw error;
    }

    // Upsert schedule and activities
    if (scheduleData && scheduleData.length) {
      const { error } = await supabase.from('schedule').upsert(scheduleData, { onConflict: 'id' });
      if (error) throw error;
    }
    if (activityScheduleData && activityScheduleData.length) {
      const { error } = await supabase.from('activities').upsert(activityScheduleData, { onConflict: 'id' });
      if (error) throw error;
    }

    // persist local copy
    persistToLocal('studentsData', studentsData);
    persistToLocal('regionalAdmins', regionalAdmins);
    persistToLocal('scheduleData', scheduleData);
    persistToLocal('activityScheduleData', activityScheduleData);

    console.log('Saved data to Supabase');
  } catch (err) {
    console.error('Failed saving to Supabase, saved locally', err);
    persistToLocal('studentsData', studentsData);
    showNotification('Gagal menyimpan ke Supabase, data disimpan lokal.', 'error');
  } finally {
    saveInProgress = false;
  }
}

/* ---------------------------
   Real-time subscriptions (auto-sync)
   --------------------------- */
function setupRealtime() {
  try {
    // students
    supabase.channel('public:students')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'students' }, payload => {
        console.log('Realtime students change', payload);
        loadAllData();
      })
      .subscribe();

    // admins
    supabase.channel('public:admins')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'admins' }, payload => loadAllData())
      .subscribe();

    // schedule
    supabase.channel('public:schedule')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'schedule' }, payload => loadAllData())
      .subscribe();

    // activities
    supabase.channel('public:activities')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'activities' }, payload => loadAllData())
      .subscribe();

    console.log('Realtime subscriptions set');
  } catch (err) {
    console.warn('Realtime setup failed', err);
  }
}

/* ---------------------------
   Authentication: login using admins + students tables
   --------------------------- */
async function handleLogin(username, password) {
  // try admins first
  try {
    const { data: adminData, error: adminErr } = await supabase.from('admins').select('*').eq('username', username).limit(1).maybeSingle();
    if (adminErr) throw adminErr;
    if (adminData && adminData.password === password) {
      currentUser = { username: adminData.username, ...adminData };
      saveSession();
      showDashboard();
      return true;
    }

    // try students
    const { data: studentData, error: studentErr } = await supabase.from('students').select('*').eq('username', username).limit(1).maybeSingle();
    if (studentErr) throw studentErr;
    if (studentData && studentData.password === password) {
      currentUser = { username: studentData.username, ...studentData, role: 'Siswa' };
      saveSession();
      showDashboard();
      return true;
    }

    // fallback: try local copies
    const localAdmins = loadFromLocal('regionalAdmins', []);
    const foundAdmin = localAdmins.find(a => a.username === username && a.password === password);
    if (foundAdmin) { currentUser = { username: foundAdmin.username, ...foundAdmin }; saveSession(); showDashboard(); return true; }
    const localStudents = loadFromLocal('studentsData', []);
    const foundStudent = localStudents.find(s => s.username === username && s.password === password);
    if (foundStudent) { currentUser = { username: foundStudent.username, ...foundStudent, role: 'Siswa' }; saveSession(); showDashboard(); return true; }

    showNotification('Username atau password salah!', 'error');
    return false;
  } catch (err) {
    console.error('Login error', err);
    showNotification('Terjadi kesalahan saat login. Cek koneksi.', 'error');
    return false;
  }
}

/* ---------------------------
   Session helpers
   --------------------------- */
function saveSession() { persistToLocal('currentUser', currentUser); }
function loadSession() { const cu = loadFromLocal('currentUser', null); if (cu) { currentUser = cu; showDashboard(); } }

/* ---------------------------
   Basic UI wiring (partial: reuse original functions in full app)
   --------------------------- */
document.getElementById('loginForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  await handleLogin(username, password);
});

function logout() {
  currentUser = null;
  persistToLocal('currentUser', null);
  document.getElementById('dashboardPage').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
}

function showDashboard() {
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('dashboardPage').classList.remove('hidden');
  document.getElementById('currentUserDisplay').textContent = currentUser?.name || currentUser?.username || '';
  loadSidebar();
  loadHome();
}

function loadSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const items = [
    { id: 'home', label: 'Home' },
    { id: 'artProgress', label: 'Kemajuan Gambar' },
    { id: 'skolastikProgress', label: 'Kemajuan Tes Skolastik' },
    { id: 'tkaProgress', label: 'Kemajuan TKA' },
    { id: 'schedule', label: 'Jadwal Belajar' },
    { id: 'activitySchedule', label: 'Jadwal Kegiatan' },
    { id: 'materials', label: 'Materi Kelas' },
    { id: 'educationInfo', label: 'Informasi Pendidikan' }
  ];
  sidebar.innerHTML = items.map(it => `<button onclick="loadModule('${it.id}')" class="w-full text-left px-3 py-2 rounded hover:bg-blue-800">${it.label}</button>`).join('');
}

function setActiveMenu(id) {
  // minimal
}

function loadModule(id) {
  currentModule = id;
  switch(id) {
    case 'home': loadHome(); break;
    case 'artProgress': loadArtProgress(); break;
    default: loadHome(); break;
  }
}

function loadHome() {
  const content = document.getElementById('contentArea');
  if (!currentUser) { content.innerHTML = '<div class="p-6">Tidak ada user</div>'; return; }
  if (currentUser.role === 'Super Admin' || currentUser.role === 'Admin') {
    content.innerHTML = `<div class="p-6">Selamat datang, ${currentUser.name || currentUser.username}</div>`;
  } else {
    // student view
    content.innerHTML = `<div class="p-6">Halo siswa, ${currentUser.name}</div>`;
  }
}

function loadArtProgress() { document.getElementById('contentArea').innerHTML = '<div class="p-6">Kemajuan Gambar (module)</div>'; }

/* ---------------------------
   Init app: load data and start realtime
   --------------------------- */
(async function initApp(){
  // try loading data from Supabase; this will fallback to local if needed
  await loadAllData();
  setupRealtime();
  loadSession();
})();

// Expose saveAllData so other parts of original app can call it when mutating data
window.saveAllData = saveAllData;
window.loadAllData = loadAllData;
window.supabase = supabase;

</script>
</body>
</html>
